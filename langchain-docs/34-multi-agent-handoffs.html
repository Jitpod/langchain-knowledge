<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Multi-Agent äº¤æ¥æœºåˆ¶ - åŠ¨æ€æ§åˆ¶è½¬ç§»å’ŒçŠ¶æ€ä¼ é€’">
    <title>Multi-Agent äº¤æ¥æœºåˆ¶ | LangChain 1.0 Python çŸ¥è¯†æ–‡æ¡£</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <button class="mobile-menu-button" aria-label="æ‰“å¼€èœå•">â˜°</button>

    <div class="container">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">ğŸ¦œ LangChain 1.0</h1>
                <p class="sidebar-subtitle">Python å®Œæ•´å­¦ä¹ æŒ‡å—</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-section">
                    <div class="nav-section-title">å¼€å§‹</div>
                    <ul>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <span class="nav-icon">ğŸ </span>
                                ä¸»é¡µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">åŸºç¡€ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="01-introduction.html" class="nav-link">
                                <span class="nav-icon">ğŸ“–</span>
                                LangChain ç®€ä»‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="02-architecture.html" class="nav-link">
                                <span class="nav-icon">ğŸ—ï¸</span>
                                æ ¸å¿ƒæ¶æ„
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="03-models.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤–</span>
                                æ¨¡å‹æ¥å£
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="04-messages.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¬</span>
                                æ¶ˆæ¯ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="05-tools.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                å·¥å…·ç³»ç»Ÿ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">è¿›é˜¶ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="06-agents.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                Agent åŸºç¡€
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="07-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="08-rag.html" class="nav-link">
                                <span class="nav-icon">ğŸ”</span>
                                RAG è¯¦è§£
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="09-lcel.html" class="nav-link">
                                <span class="nav-icon">ğŸ”—</span>
                                LCEL è¡¨è¾¾å¼
                            </a>
                        </li>
                    </ul>
                </li>

                                <li class="nav-section">
                    <div class="nav-section-title">é«˜çº§åº”ç”¨</div>
                    <ul>
                        <li class="nav-item">
                            <a href="10-runtime.html" class="nav-link">
                                <span class="nav-icon">ğŸ”Œ</span>
                                Runtime ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="11-checkpointer.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¾</span>
                                æŒä¹…åŒ–ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="12-streaming.html" class="nav-link">
                                <span class="nav-icon">ğŸŒŠ</span>
                                æµå¼è¾“å‡º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="13-human-in-loop.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="14-long-term-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ—„ï¸</span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="15-langgraph.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                LangGraph
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="16-context-engineering.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                ä¸Šä¸‹æ–‡å·¥ç¨‹
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="17-mcp.html" class="nav-link">
                                <span class="nav-icon">ğŸ”Œ</span>
                                MCP åè®®
                            </a>
                        </li>
                    </ul>
                </li>


                                <li class="nav-section">
                    <div class="nav-section-title">å®æˆ˜ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="18-customer-service.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å®¢æœæœºå™¨äºº
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="19-best-practices.html" class="nav-link">
                                <span class="nav-icon">âœ¨</span>
                                æœ€ä½³å®è·µ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="38-chat.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¬</span>
                                åœ¨çº¿å¯¹è¯åŠ©æ‰‹
                                <span class="nav-badge">NEW</span>
                            </a>
                        </li>
                    </ul>
                </li>


                                <li class="nav-section">
                    <div class="nav-section-title">å‚è€ƒç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="20-api-reference.html" class="nav-link">
                                <span class="nav-icon">ğŸ“š</span>
                                API é€ŸæŸ¥è¡¨
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="21-troubleshooting.html" class="nav-link">
                                <span class="nav-icon">ğŸ›</span>
                                æ•…éšœæ’é™¤
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="22-migration.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                è¿ç§»æŒ‡å—
                            </a>
                        </li>
                    </ul>
                </li>


                                <li class="nav-section">
                    <div class="nav-section-title">æ‰©å±•ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="23-structured-output.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                ç»“æ„åŒ–è¾“å‡º
                            </a>
                        </li>
                    </ul>
                </li>


                                <li class="nav-section">
                    <div class="nav-section-title">DeepAgents ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="24-deepagents-quickstart.html" class="nav-link">
                                <span class="nav-icon">ğŸš€</span>
                                å¿«é€Ÿå¼€å§‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="25-deepagents-customization.html" class="nav-link">
                                <span class="nav-icon">ğŸ¨</span>
                                å®šåˆ¶åŒ–
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="26-deepagents-harness.html" class="nav-link">
                                <span class="nav-icon">ğŸ›ï¸</span>
                                Harness ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="27-deepagents-backends.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                åç«¯é…ç½®
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="28-deepagents-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="29-deepagents-hitl.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="30-deepagents-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ§ </span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="31-deepagents-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶
                            </a>
                        </li>
                    </ul>
                </li>


                                <li class="nav-section">
                    <div class="nav-section-title">Multi-Agent ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="32-multi-agent-index.html" class="nav-link">
                                <span class="nav-icon">ğŸŒ</span>
                                æ¦‚è¿°
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="33-multi-agent-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item active">
                            <a href="34-multi-agent-handoffs.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                äº¤æ¥æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="35-multi-agent-skills.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="36-multi-agent-router.html" class="nav-link">
                                <span class="nav-icon">ğŸ§­</span>
                                è·¯ç”±æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="37-multi-agent-workflow.html" class="nav-link">
                                <span class="nav-icon">ğŸ”€</span>
                                è‡ªå®šä¹‰å·¥ä½œæµ
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">
                        <a href="index.html" class="breadcrumb-link">ä¸»é¡µ</a>
                    </span>
                    <span class="breadcrumb-item">
                        Multi-Agent ç¯‡
                    </span>
                    <span class="breadcrumb-item">
                        äº¤æ¥æœºåˆ¶
                    </span>
                </nav>

                <!-- é¡µé¢æ ‡é¢˜ -->
                <header class="page-header">
                    <h1 class="page-title">ğŸ”„ Multi-Agent äº¤æ¥æœºåˆ¶</h1>
                    <p class="page-subtitle">
                        å®ç°ä»£ç†ä¹‹é—´çš„åŠ¨æ€æ§åˆ¶è½¬ç§»å’ŒçŠ¶æ€ä¼ é€’ï¼Œæ„å»ºçµæ´»çš„å¤šçº§åä½œæµç¨‹ï¼Œ
                        æ”¯æŒæ™ºèƒ½å‡çº§ã€ä»»åŠ¡å§”æ´¾å’Œä¸Šä¸‹æ–‡ä¿æŒã€‚
                    </p>
                </header>

                <!-- ä»€ä¹ˆæ˜¯ Handoffs -->.
                <section class="content-section">
                    <h2 class="section-title">ğŸ“š ä»€ä¹ˆæ˜¯ Handoffsï¼Ÿ</h2>
                    <p>
                        <strong>Handoffsï¼ˆäº¤æ¥æœºåˆ¶ï¼‰</strong>æ˜¯ Multi-Agent ç³»ç»Ÿä¸­å®ç°<strong>æ§åˆ¶æƒåŠ¨æ€è½¬ç§»</strong>çš„æ ¸å¿ƒæ¨¡å¼ã€‚
                        å½“ä¸€ä¸ªä»£ç†æ— æ³•å®Œå…¨å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œæˆ–éœ€è¦ä¸“ä¸šåŒ–å¤„ç†æ—¶ï¼Œå¯ä»¥å°†æ§åˆ¶æƒå’Œä¸Šä¸‹æ–‡äº¤æ¥ç»™å¦ä¸€ä¸ªæ›´åˆé€‚çš„ä»£ç†ã€‚
                    </p>

                    <div class="info-box note">
                        <div class="info-box-title">ğŸ’¡ æ ¸å¿ƒç‰¹æ€§</div>
                        <table style="margin-top: 0.5rem;">
                            <thead>
                                <tr>
                                    <th>ç‰¹æ€§</th>
                                    <th>è¯´æ˜</th>
                                    <th>ä¼˜åŠ¿</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>åŠ¨æ€å†³ç­–</strong></td>
                                    <td>ä»£ç†åœ¨è¿è¡Œæ—¶å†³å®šæ˜¯å¦äº¤æ¥</td>
                                    <td>çµæ´»åº”å¯¹å¤æ‚åœºæ™¯</td>
                                </tr>
                                <tr>
                                    <td><strong>ä¸Šä¸‹æ–‡ä¿æŒ</strong></td>
                                    <td>äº¤æ¥æ—¶ä¼ é€’å®Œæ•´çš„å¯¹è¯å†å²å’ŒçŠ¶æ€</td>
                                    <td>æ— ç¼è¡”æ¥ï¼Œç”¨æˆ·ä½“éªŒå¥½</td>
                                </tr>
                                <tr>
                                    <td><strong>å¤šå±‚çº§å‡çº§</strong></td>
                                    <td>æ”¯æŒå¤šçº§äº¤æ¥ï¼ˆå®¢æœ â†’ æŠ€æœ¯ â†’ å·¥ç¨‹å¸ˆï¼‰</td>
                                    <td>ä¸“ä¸šåŒ–åˆ†å·¥ï¼Œé€çº§å¤„ç†</td>
                                </tr>
                                <tr>
                                    <td><strong>åŒå‘äº¤æ¥</strong></td>
                                    <td>æ”¯æŒå‘ä¸Šå‡çº§å’Œå‘ä¸‹å›é€€</td>
                                    <td>çµæ´»çš„æµç¨‹æ§åˆ¶</td>
                                </tr>
                                <tr>
                                    <td><strong>æ¡ä»¶è§¦å‘</strong></td>
                                    <td>åŸºäºçŠ¶æ€ã€å…³é”®è¯ã€å·¥å…·ç»“æœè§¦å‘äº¤æ¥</td>
                                    <td>è‡ªåŠ¨åŒ–å†³ç­–</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph TB
    User["ç”¨æˆ·ï¼šè½¯ä»¶å´©æºƒäº†"] --> CS["å®¢æœä»£ç†<br/>å¤„ç†å¸¸è§„é—®é¢˜"]

    CS -->|"è¯†åˆ«ï¼šæŠ€æœ¯é—®é¢˜"| Decision1{"æ˜¯å¦éœ€è¦<br/>æŠ€æœ¯æ”¯æŒï¼Ÿ"}
    Decision1 -->|"æ˜¯"| Handoff1["ğŸ”„ äº¤æ¥<br/>è½¬ç§»æ§åˆ¶æƒ<br/>ä¼ é€’ä¸Šä¸‹æ–‡"]
    Decision1 -->|"å¦"| Resolve1["ç›´æ¥è§£å†³<br/>è¿”å›ç”¨æˆ·"]

    Handoff1 --> TS["æŠ€æœ¯æ”¯æŒä»£ç†<br/>è¯Šæ–­æŠ€æœ¯é—®é¢˜"]

    TS -->|"è¯†åˆ«ï¼šä¸¥é‡æ•…éšœ"| Decision2{"æ˜¯å¦éœ€è¦<br/>å·¥ç¨‹å¸ˆä»‹å…¥ï¼Ÿ"}
    Decision2 -->|"æ˜¯"| Handoff2["ğŸ”„ äº¤æ¥<br/>è½¬ç§»æ§åˆ¶æƒ<br/>ä¼ é€’æŠ€æœ¯ç»†èŠ‚"]
    Decision2 -->|"å¦"| Resolve2["æŠ€æœ¯è§£å†³æ–¹æ¡ˆ<br/>è¿”å›ç”¨æˆ·"]

    Handoff2 --> ENG["å·¥ç¨‹å¸ˆä»£ç†<br/>æ·±åº¦æ’æŸ¥å’Œä¿®å¤"]
    ENG --> Resolve3["é—®é¢˜å·²ä¿®å¤<br/>è¿”å›ç”¨æˆ·"]

    Resolve1 --> End["å®Œæˆ"]
    Resolve2 --> End
    Resolve3 --> End

    style CS fill:#10b981,color:#fff
    style TS fill:#f59e0b,color:#fff
    style ENG fill:#ef4444,color:#fff
    style Handoff1 fill:#3b82f6,color:#fff
    style Handoff2 fill:#3b82f6,color:#fff
    style Decision1 fill:#8b5cf6,color:#fff
    style Decision2 fill:#8b5cf6,color:#fff
                        </div>
                    </div>

                    <h3 class="subsection-title">Handoffs vs å…¶ä»–åä½œæ¨¡å¼</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>æ¨¡å¼</th>
                                <th>æ§åˆ¶æµ</th>
                                <th>é€‚ç”¨åœºæ™¯</th>
                                <th>ç¤ºä¾‹</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Handoffs</strong></td>
                                <td>åŠ¨æ€è½¬ç§»ï¼Œå•å‘æˆ–åŒå‘</td>
                                <td>éœ€è¦å‡çº§ã€ä¸“ä¸šåŒ–å¤„ç†</td>
                                <td>å®¢æœå‡çº§æŠ€æœ¯æ”¯æŒ</td>
                            </tr>
                            <tr>
                                <td><strong>Subagents</strong></td>
                                <td>å›ºå®šé¡ºåºï¼Œæµæ°´çº¿</td>
                                <td>æ˜ç¡®çš„å¤šæ­¥éª¤æµç¨‹</td>
                                <td>ç ”ç©¶ â†’ å†™ä½œ â†’ ç¼–è¾‘</td>
                            </tr>
                            <tr>
                                <td><strong>Router</strong></td>
                                <td>åˆå§‹åˆ†å‘ï¼Œä¸€æ¬¡æ€§</td>
                                <td>è¯·æ±‚åˆ†ç±»å’Œè·¯ç”±</td>
                                <td>é”€å”®/æŠ€æœ¯/è´¦å•åˆ†æµ</td>
                            </tr>
                            <tr>
                                <td><strong>Workflow</strong></td>
                                <td>é¢„å®šä¹‰æµç¨‹ï¼Œå¤æ‚ç¼–æ’</td>
                                <td>å¤šæ­¥éª¤å¤æ‚ä¸šåŠ¡</td>
                                <td>å®¡æ‰¹æµç¨‹ã€å‘å¸ƒæµç¨‹</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- Handoffs å®ç°æ–¹å¼ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ”§ Handoffs å®ç°æ–¹å¼</h2>
                    <p>
                        LangGraph æä¾›å¤šç§æ–¹å¼å®ç° Handoffsï¼Œä»ç®€å•çš„çŠ¶æ€æ ‡è®°åˆ°å¤æ‚çš„æ¡ä»¶è·¯ç”±ã€‚
                    </p>

                    <h3 class="subsection-title">æ–¹å¼ 1ï¼šåŸºäºçŠ¶æ€çš„äº¤æ¥ï¼ˆæ¨èï¼‰</h3>
                    <p>
                        é€šè¿‡åœ¨çŠ¶æ€ä¸­æ·»åŠ  <code>next</code> æˆ– <code>handoff_to</code> å­—æ®µï¼Œ
                        ä»£ç†å¯ä»¥åŠ¨æ€æŒ‡å®šä¸‹ä¸€ä¸ªå¤„ç†è€…ã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
åŸºäºçŠ¶æ€çš„äº¤æ¥ - ç®€å•ä¸¤ä¸ªä»£ç†
"""
from typing import TypedDict, Annotated, Literal
from langgraph.graph import StateGraph, MessagesState, START, END
from langgraph.graph.message import add_messages
from langchain_core.messages import HumanMessage

# å®šä¹‰çŠ¶æ€ï¼ˆåŒ…å«äº¤æ¥ç›®æ ‡ï¼‰
class HandoffState(TypedDict):
    messages: Annotated[list, add_messages]
    next: str  # æŒ‡å®šä¸‹ä¸€ä¸ªä»£ç†

# ä»£ç† 1ï¼šå®¢æœ
def customer_service(state: HandoffState):
    """å®¢æœä»£ç†ï¼šå¤„ç†å¸¸è§„é—®é¢˜"""
    messages = state["messages"]
    last_message = messages[-1].content

    # åˆ¤æ–­æ˜¯å¦éœ€è¦äº¤æ¥ç»™æŠ€æœ¯æ”¯æŒ
    if "æŠ€æœ¯é—®é¢˜" in last_message or "bug" in last_message.lower():
        return {
            "messages": [HumanMessage(content="æˆ‘å°†ä¸ºæ‚¨è½¬æ¥æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ")],
            "next": "technical_support"  # äº¤æ¥æŒ‡ä»¤
        }

    return {
        "messages": [HumanMessage(content="é—®é¢˜å·²è§£å†³")],
        "next": "end"
    }

# ä»£ç† 2ï¼šæŠ€æœ¯æ”¯æŒ
def technical_support(state: HandoffState):
    """æŠ€æœ¯æ”¯æŒä»£ç†"""
    return {
        "messages": [HumanMessage(content="æŠ€æœ¯æ”¯æŒï¼šæˆ‘æ¥å¸®æ‚¨è§£å†³æŠ€æœ¯é—®é¢˜")],
        "next": "end"
    }

# è·¯ç”±å‡½æ•°
def route_next(state: HandoffState) -> Literal["customer_service", "technical_support", "end"]:
    """æ ¹æ® next å­—æ®µè·¯ç”±"""
    next_agent = state.get("next", "customer_service")
    if next_agent == "end":
        return END
    return next_agent

# æ„å»ºå·¥ä½œæµ
graph = StateGraph(HandoffState)
graph.add_node("customer_service", customer_service)
graph.add_node("technical_support", technical_support)

# åˆå§‹è·¯ç”±
graph.add_edge(START, "customer_service")

# æ¡ä»¶è·¯ç”±
graph.add_conditional_edges(
    "customer_service",
    route_next,
    {
        "technical_support": "technical_support",
        "end": END
    }
)
graph.add_conditional_edges(
    "technical_support",
    route_next,
    {"end": END}
)

app = graph.compile()

# æµ‹è¯•
result = app.invoke({
    "messages": [HumanMessage(content="æˆ‘é‡åˆ°äº†æŠ€æœ¯é—®é¢˜")]
})

# è¾“å‡ºï¼š
# 1. å®¢æœï¼šæˆ‘å°†ä¸ºæ‚¨è½¬æ¥æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ
# 2. æŠ€æœ¯æ”¯æŒï¼šæˆ‘æ¥å¸®æ‚¨è§£å†³æŠ€æœ¯é—®é¢˜

# ä¼˜åŠ¿ï¼š
# - ç®€å•ç›´è§‚
# - ä»£ç†è‡ªä¸»å†³å®šäº¤æ¥
# - æ˜“äºç†è§£å’Œè°ƒè¯•</code></pre>
                    </div>

                    <h3 class="subsection-title">æ–¹å¼ 2ï¼šå¤šå±‚çº§å‡çº§äº¤æ¥</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
å¤šå±‚çº§å‡çº§äº¤æ¥ - å®¢æœ â†’ æŠ€æœ¯ â†’ å·¥ç¨‹å¸ˆ
"""
from typing import TypedDict, Annotated, Literal
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from langchain_core.messages import HumanMessage, AIMessage

class EscalationState(TypedDict):
    messages: Annotated[list, add_messages]
    severity: str  # "low", "medium", "high"
    next: str

# L1: å®¢æœä»£ç†
def l1_support(state: EscalationState):
    """L1 å®¢æœï¼šå¤„ç†å¸¸è§„é—®é¢˜"""
    messages = state["messages"]
    last_msg = messages[-1].content

    # è¯„ä¼°ä¸¥é‡æ€§
    if "ç´§æ€¥" in last_msg or "ä¸¥é‡" in last_msg:
        severity = "high"
        next_agent = "l2_technical"
        response = "è¿™æ˜¯ç´§æ€¥é—®é¢˜ï¼Œæˆ‘å°†ä¸ºæ‚¨è½¬æ¥æŠ€æœ¯æ”¯æŒï¼ˆL2ï¼‰"
    elif "æŠ€æœ¯" in last_msg or "bug" in last_msg.lower():
        severity = "medium"
        next_agent = "l2_technical"
        response = "è¿™éœ€è¦æŠ€æœ¯æ”¯æŒï¼Œæˆ‘å°†ä¸ºæ‚¨è½¬æ¥ï¼ˆL2ï¼‰"
    else:
        severity = "low"
        next_agent = "end"
        response = "é—®é¢˜å·²è§£å†³"

    return {
        "messages": [AIMessage(content=f"L1 å®¢æœï¼š{response}")],
        "severity": severity,
        "next": next_agent
    }

# L2: æŠ€æœ¯æ”¯æŒä»£ç†
def l2_technical(state: EscalationState):
    """L2 æŠ€æœ¯æ”¯æŒï¼šè¯Šæ–­æŠ€æœ¯é—®é¢˜"""
    severity = state.get("severity", "medium")

    # é«˜ä¸¥é‡æ€§é—®é¢˜å‡çº§ç»™å·¥ç¨‹å¸ˆ
    if severity == "high":
        return {
            "messages": [AIMessage(content="L2 æŠ€æœ¯æ”¯æŒï¼šè¿™æ˜¯é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼Œå‡çº§ç»™å·¥ç¨‹å¸ˆï¼ˆL3ï¼‰")],
            "next": "l3_engineer"
        }

    return {
        "messages": [AIMessage(content="L2 æŠ€æœ¯æ”¯æŒï¼šé—®é¢˜å·²è¯Šæ–­å’Œè§£å†³")],
        "next": "end"
    }

# L3: å·¥ç¨‹å¸ˆä»£ç†
def l3_engineer(state: EscalationState):
    """L3 å·¥ç¨‹å¸ˆï¼šæ·±åº¦æ’æŸ¥å’Œä¿®å¤"""
    return {
        "messages": [AIMessage(content="L3 å·¥ç¨‹å¸ˆï¼šå·²æ·±åº¦æ’æŸ¥å¹¶ä¿®å¤é—®é¢˜")],
        "next": "end"
    }

# è·¯ç”±å‡½æ•°
def route(state: EscalationState) -> Literal["l1_support", "l2_technical", "l3_engineer", "end"]:
    next_agent = state.get("next", "l1_support")
    return END if next_agent == "end" else next_agent

# æ„å»ºä¸‰å±‚å‡çº§å·¥ä½œæµ
graph = StateGraph(EscalationState)
graph.add_node("l1_support", l1_support)
graph.add_node("l2_technical", l2_technical)
graph.add_node("l3_engineer", l3_engineer)

graph.add_edge(START, "l1_support")
graph.add_conditional_edges("l1_support", route)
graph.add_conditional_edges("l2_technical", route)
graph.add_conditional_edges("l3_engineer", route)

app = graph.compile()

# æµ‹è¯•ä¸åŒä¸¥é‡æ€§
test_cases = [
    "æˆ‘æœ‰ä¸€ä¸ªç®€å•çš„é—®é¢˜",           # L1 å¤„ç†
    "é‡åˆ°äº†æŠ€æœ¯bug",                # L1 â†’ L2
    "ç´§æ€¥ï¼ç³»ç»Ÿå´©æºƒäº†ï¼",           # L1 â†’ L2 â†’ L3
]

for test in test_cases:
    print(f"\næµ‹è¯•: {test}")
    result = app.invoke({"messages": [HumanMessage(content=test)]})
    for msg in result["messages"]:
        if isinstance(msg, AIMessage):
            print(f"  {msg.content}")

# è¾“å‡ºç¤ºä¾‹ï¼š
# æµ‹è¯•: ç´§æ€¥ï¼ç³»ç»Ÿå´©æºƒäº†ï¼
#   L1 å®¢æœï¼šè¿™æ˜¯ç´§æ€¥é—®é¢˜ï¼Œæˆ‘å°†ä¸ºæ‚¨è½¬æ¥æŠ€æœ¯æ”¯æŒï¼ˆL2ï¼‰
#   L2 æŠ€æœ¯æ”¯æŒï¼šè¿™æ˜¯é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼Œå‡çº§ç»™å·¥ç¨‹å¸ˆï¼ˆL3ï¼‰
#   L3 å·¥ç¨‹å¸ˆï¼šå·²æ·±åº¦æ’æŸ¥å¹¶ä¿®å¤é—®é¢˜

# ä¼˜åŠ¿ï¼š
# - è‡ªåŠ¨å‡çº§æœºåˆ¶
# - åŸºäºä¸¥é‡æ€§åˆ†çº§
# - æ¯å±‚ä¸“æ³¨äºè‡ªå·±çš„èŒè´£</code></pre>
                    </div>

                    <h3 class="subsection-title">æ–¹å¼ 3ï¼šå¸¦çŠ¶æ€ä¼ é€’çš„äº¤æ¥</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
å¸¦çŠ¶æ€ä¼ é€’çš„äº¤æ¥ - ä¼ é€’ä¸Šä¸‹æ–‡å’Œæ•°æ®
"""
from typing import TypedDict, Annotated, Literal
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages

class ContextualHandoffState(TypedDict):
    messages: Annotated[list, add_messages]
    user_id: str
    issue_type: str
    collected_data: dict  # æ”¶é›†çš„è¯Šæ–­æ•°æ®
    next: str

# ä»£ç† 1ï¼šè¯Šæ–­ä»£ç†
def diagnostic_agent(state: ContextualHandoffState):
    """è¯Šæ–­ä»£ç†ï¼šæ”¶é›†é—®é¢˜ä¿¡æ¯"""
    # æ”¶é›†è¯Šæ–­æ•°æ®
    collected_data = {
        "symptoms": "åº”ç”¨å´©æºƒ",
        "frequency": "é¢‘ç¹",
        "last_occurrence": "2 å°æ—¶å‰",
        "error_logs": ["Error: NullPointerException", "Error: OutOfMemory"]
    }

    # åˆ¤æ–­é—®é¢˜ç±»å‹
    issue_type = "critical_bug"

    return {
        "messages": [HumanMessage(content="å·²æ”¶é›†è¯Šæ–­ä¿¡æ¯ï¼Œè½¬æ¥ç»™bugä¿®å¤å›¢é˜Ÿ")],
        "issue_type": issue_type,
        "collected_data": collected_data,
        "next": "bug_fix"
    }

# ä»£ç† 2ï¼šBug ä¿®å¤ä»£ç†
def bug_fix_agent(state: ContextualHandoffState):
    """Bugä¿®å¤ä»£ç†ï¼šåŸºäºè¯Šæ–­æ•°æ®ä¿®å¤"""
    # è¯»å–ä¼ é€’çš„æ•°æ®
    data = state["collected_data"]
    issue_type = state["issue_type"]

    # åŸºäºè¯Šæ–­æ•°æ®æ‰§è¡Œä¿®å¤
    fix_plan = f"""
    é—®é¢˜ç±»å‹ï¼š{issue_type}
    ç—‡çŠ¶ï¼š{data['symptoms']}
    é”™è¯¯æ—¥å¿—ï¼š{', '.join(data['error_logs'])}

    ä¿®å¤æ–¹æ¡ˆï¼š
    1. åˆ†æ NullPointerException æ ¹å› 
    2. æ£€æŸ¥å†…å­˜æ³„æ¼
    3. éƒ¨ç½²ä¿®å¤è¡¥ä¸
    """

    return {
        "messages": [HumanMessage(content=f"Bugä¿®å¤å›¢é˜Ÿï¼š{fix_plan}")],
        "next": "end"
    }

# è·¯ç”±
def route(state: ContextualHandoffState) -> Literal["diagnostic", "bug_fix", "end"]:
    next_agent = state.get("next", "diagnostic")
    return END if next_agent == "end" else next_agent

# æ„å»ºå·¥ä½œæµ
graph = StateGraph(ContextualHandoffState)
graph.add_node("diagnostic", diagnostic_agent)
graph.add_node("bug_fix", bug_fix_agent)

graph.add_edge(START, "diagnostic")
graph.add_conditional_edges("diagnostic", route)
graph.add_conditional_edges("bug_fix", route)

app = graph.compile()

# ä½¿ç”¨
result = app.invoke({
    "messages": [HumanMessage(content="åº”ç”¨ä¸€ç›´å´©æºƒ")],
    "user_id": "user123"
})

# ä¼˜åŠ¿ï¼š
# - å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¼ é€’
# - åç»­ä»£ç†å¯ä»¥åˆ©ç”¨ä¹‹å‰æ”¶é›†çš„æ•°æ®
# - é¿å…é‡å¤è¯¢é—®ç”¨æˆ·
# - ä¸“ä¸šåŒ–åˆ†å·¥ï¼ˆè¯Šæ–­ vs ä¿®å¤ï¼‰</code></pre>
                    </div>
                </section>

                <!-- çŠ¶æ€ä¼ é€’æœºåˆ¶ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ—„ï¸ çŠ¶æ€ä¼ é€’æœºåˆ¶</h2>
                    <p>
                        Handoffs çš„æ ¸å¿ƒæ˜¯<strong>çŠ¶æ€ä¼ é€’</strong>ï¼Œç¡®ä¿æ¥æ‰‹çš„ä»£ç†èƒ½å¤Ÿè·å¾—å¿…è¦çš„ä¸Šä¸‹æ–‡ã€‚
                    </p>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph LR
    subgraph Agent1["ä»£ç† 1 (å®¢æœ)"]
        S1["çŠ¶æ€è¾“å…¥"] --> Process1["å¤„ç†é€»è¾‘"]
        Process1 --> Decision1{"éœ€è¦äº¤æ¥ï¼Ÿ"}
        Decision1 -->|"æ˜¯"| Update1["æ›´æ–°çŠ¶æ€:<br/>next=æŠ€æœ¯æ”¯æŒ<br/>context=é—®é¢˜æè¿°"]
        Decision1 -->|"å¦"| Update2["æ›´æ–°çŠ¶æ€:<br/>next=end"]
    end

    Update1 --> Handoff["ğŸ”„ äº¤æ¥ç‚¹<br/>çŠ¶æ€ä¼ é€’"]

    subgraph Agent2["ä»£ç† 2 (æŠ€æœ¯æ”¯æŒ)"]
        Handoff --> S2["ç»§æ‰¿çŠ¶æ€:<br/>messages<br/>context<br/>user_id"]
        S2 --> Process2["åŸºäºä¸Šä¸‹æ–‡å¤„ç†"]
        Process2 --> Result["è¿”å›ç»“æœ"]
    end

    style Handoff fill:#3b82f6,color:#fff
    style S2 fill:#10b981,color:#fff
    style Update1 fill:#f59e0b,color:#fff
                        </div>
                    </div>

                    <h3 class="subsection-title">çŠ¶æ€ä¼ é€’ç­–ç•¥</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ç­–ç•¥</th>
                                <th>ä¼ é€’å†…å®¹</th>
                                <th>ä¼˜ç‚¹</th>
                                <th>ç¼ºç‚¹</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>å®Œæ•´çŠ¶æ€</strong></td>
                                <td>æ‰€æœ‰çŠ¶æ€å­—æ®µ</td>
                                <td>ä¿¡æ¯å®Œæ•´ï¼Œçµæ´»æ€§é«˜</td>
                                <td>å¯èƒ½åŒ…å«æ— å…³æ•°æ®</td>
                            </tr>
                            <tr>
                                <td><strong>æœ€å°å¿…éœ€</strong></td>
                                <td>ä»…å¿…è¦å­—æ®µï¼ˆuser_id, issue_typeï¼‰</td>
                                <td>æ¸…æ™°ï¼Œå‡å°‘è€¦åˆ</td>
                                <td>å¯èƒ½éœ€è¦é‡æ–°æ”¶é›†æ•°æ®</td>
                            </tr>
                            <tr>
                                <td><strong>æ‘˜è¦ä¼ é€’</strong></td>
                                <td>messages + æ‘˜è¦å­—æ®µ</td>
                                <td>å¹³è¡¡ä¿¡æ¯é‡å’Œæ•ˆç‡</td>
                                <td>éœ€è¦è®¾è®¡æ‘˜è¦ç»“æ„</td>
                            </tr>
                            <tr>
                                <td><strong>å¼•ç”¨ä¼ é€’</strong></td>
                                <td>ID å¼•ç”¨å¤–éƒ¨å­˜å‚¨</td>
                                <td>å‡å°‘çŠ¶æ€å¤§å°</td>
                                <td>éœ€è¦é¢å¤–å­˜å‚¨ç³»ç»Ÿ</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box tip">
                        <div class="info-box-title">âœ… çŠ¶æ€ä¼ é€’æœ€ä½³å®è·µ</div>
                        <ul>
                            <li><strong>å¿…ä¼ å­—æ®µ</strong>ï¼šmessagesï¼ˆå¯¹è¯å†å²ï¼‰ã€user_idï¼ˆç”¨æˆ·æ ‡è¯†ï¼‰ã€issue_typeï¼ˆé—®é¢˜åˆ†ç±»ï¼‰</li>
                            <li><strong>å¯é€‰å­—æ®µ</strong>ï¼šcollected_dataï¼ˆè¯Šæ–­æ•°æ®ï¼‰ã€priorityï¼ˆä¼˜å…ˆçº§ï¼‰ã€metadataï¼ˆå…ƒæ•°æ®ï¼‰</li>
                            <li><strong>é¿å…ä¼ é€’</strong>ï¼šä¸´æ—¶è®¡ç®—ç»“æœã€å†…éƒ¨çŠ¶æ€ã€æ•æ„Ÿä¿¡æ¯ï¼ˆé™¤éåŠ å¯†ï¼‰</li>
                            <li><strong>ä½¿ç”¨æ‘˜è¦</strong>ï¼šé•¿å¯¹è¯å†å²ç”¨æ‘˜è¦å­—æ®µè¡¥å……ï¼Œé¿å…ä¸Šä¸‹æ–‡è¿‡è½½</li>
                        </ul>
                    </div>
                </section>

                <!-- å®Œæ•´å®æˆ˜ç¤ºä¾‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ¯ å®Œæ•´å®æˆ˜ç¤ºä¾‹</h2>
                    <p>
                        æ„å»ºä¸€ä¸ª<strong>æ™ºèƒ½å®¢æœç³»ç»Ÿ</strong>ï¼Œæ”¯æŒå¤šå±‚çº§äº¤æ¥ã€çŠ¶æ€ä¼ é€’ã€
                        åŒå‘æµè½¬ï¼ˆå‡çº§å’Œå›é€€ï¼‰ã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§ - ç”Ÿäº§çº§ç¤ºä¾‹</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
å®Œæ•´å®æˆ˜ç¤ºä¾‹ - æ™ºèƒ½å®¢æœç³»ç»Ÿï¼ˆå¤šå±‚çº§äº¤æ¥ï¼‰
"""
import uuid
from typing import TypedDict, Annotated, Literal
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage

# ========== 1. å®šä¹‰çŠ¶æ€ ==========

class SupportState(TypedDict):
    messages: Annotated[list, add_messages]
    user_id: str
    session_id: str

    # é—®é¢˜ä¿¡æ¯
    issue_type: str  # "general", "technical", "critical"
    priority: str    # "low", "medium", "high"

    # è¯Šæ–­æ•°æ®
    symptoms: list[str]
    error_logs: list[str]
    user_actions: list[str]

    # äº¤æ¥æ§åˆ¶
    current_agent: str
    next: str
    handoff_reason: str

    # è§£å†³çŠ¶æ€
    resolved: bool
    resolution: str

# ========== 2. å®šä¹‰ä»£ç† ==========

def tier1_support(state: SupportState):
    """L1 å®¢æœï¼šåˆå§‹æ¥å¾…å’ŒåŸºç¡€é—®é¢˜å¤„ç†"""
    llm = ChatOpenAI(model="gpt-4o")

    messages = state["messages"]
    last_msg = messages[-1].content.lower()

    # æ”¶é›†åˆæ­¥ä¿¡æ¯
    symptoms = []
    if "å´©æºƒ" in last_msg or "crash" in last_msg:
        symptoms.append("åº”ç”¨å´©æºƒ")
    if "æ…¢" in last_msg or "slow" in last_msg:
        symptoms.append("æ€§èƒ½ç¼“æ…¢")
    if "é”™è¯¯" in last_msg or "error" in last_msg:
        symptoms.append("é”™è¯¯æç¤º")

    # åˆ†ç±»å’Œä¼˜å…ˆçº§è¯„ä¼°
    if "ç´§æ€¥" in last_msg or "æ— æ³•ä½¿ç”¨" in last_msg:
        priority = "high"
        issue_type = "critical"
        next_agent = "tier2_technical"
        reason = "é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼Œéœ€è¦æŠ€æœ¯æ”¯æŒ"
        response = "è¿™æ˜¯ç´§æ€¥é—®é¢˜ï¼Œæˆ‘å°†ç«‹å³ä¸ºæ‚¨è½¬æ¥æŠ€æœ¯æ”¯æŒå›¢é˜Ÿï¼ˆL2ï¼‰"
    elif any(word in last_msg for word in ["æŠ€æœ¯", "bug", "å´©æºƒ", "é”™è¯¯"]):
        priority = "medium"
        issue_type = "technical"
        next_agent = "tier2_technical"
        reason = "æŠ€æœ¯é—®é¢˜ï¼Œéœ€è¦ä¸“ä¸šè¯Šæ–­"
        response = "è¿™éœ€è¦æŠ€æœ¯æ”¯æŒååŠ©ï¼Œæˆ‘å°†ä¸ºæ‚¨è½¬æ¥æŠ€æœ¯å›¢é˜Ÿï¼ˆL2ï¼‰"
    elif any(word in last_msg for word in ["å¦‚ä½•", "æ€ä¹ˆ", "ä½¿ç”¨"]):
        priority = "low"
        issue_type = "general"
        next_agent = "end"
        reason = ""

        # L1 å¯ä»¥ç›´æ¥å¤„ç†çš„å¸¸è§é—®é¢˜
        prompt = f"""ä½ æ˜¯å®¢æœä»£ç†ã€‚ç”¨æˆ·é—®é¢˜ï¼š{last_msg}

        æä¾›ç®€æ´çš„è§£å†³æ–¹æ¡ˆï¼ˆ< 100 å­—ï¼‰ã€‚"""

        ai_response = llm.invoke([SystemMessage(content=prompt)])
        response = ai_response.content
    else:
        priority = "low"
        issue_type = "general"
        next_agent = "end"
        reason = ""
        response = "æˆ‘æ¥å¸®æ‚¨è§£å†³è¿™ä¸ªé—®é¢˜"

    return {
        "messages": [AIMessage(content=f"L1 å®¢æœï¼š{response}")],
        "symptoms": symptoms,
        "issue_type": issue_type,
        "priority": priority,
        "current_agent": "tier1",
        "next": next_agent,
        "handoff_reason": reason
    }

def tier2_technical(state: SupportState):
    """L2 æŠ€æœ¯æ”¯æŒï¼šæŠ€æœ¯è¯Šæ–­å’Œå¸¸è§„ä¿®å¤"""
    llm = ChatOpenAI(model="claude-sonnet-4-5")

    priority = state["priority"]
    symptoms = state.get("symptoms", [])
    messages = state["messages"]

    # æŠ€æœ¯è¯Šæ–­
    diagnostic_prompt = f"""ä½ æ˜¯æŠ€æœ¯æ”¯æŒå·¥ç¨‹å¸ˆã€‚

    é—®é¢˜ä¿¡æ¯ï¼š
    - ä¼˜å…ˆçº§ï¼š{priority}
    - ç—‡çŠ¶ï¼š{', '.join(symptoms) if symptoms else 'æœªçŸ¥'}
    - å¯¹è¯å†å²ï¼š{messages[-1].content}

    ä»»åŠ¡ï¼š
    1. è¯Šæ–­é—®é¢˜
    2. åˆ¤æ–­æ˜¯å¦å¯ä»¥è‡ªè¡Œè§£å†³ï¼Œè¿˜æ˜¯éœ€è¦å‡çº§ç»™å·¥ç¨‹å¸ˆï¼ˆL3ï¼‰

    å¦‚æœé—®é¢˜æ¶‰åŠæ•°æ®åº“ã€æœåŠ¡å™¨ã€æˆ–éœ€è¦ä»£ç ä¿®æ”¹ï¼Œåº”å‡çº§ã€‚

    è¿”å›æ ¼å¼ï¼š
    è¯Šæ–­ç»“æœï¼š[ä½ çš„è¯Šæ–­]
    æ˜¯å¦å‡çº§ï¼š[æ˜¯/å¦]
    """

    diagnosis = llm.invoke([SystemMessage(content=diagnostic_prompt)])
    diagnosis_text = diagnosis.content

    # åˆ¤æ–­æ˜¯å¦å‡çº§
    should_escalate = "æ˜¯å¦å‡çº§ï¼šæ˜¯" in diagnosis_text or priority == "high"

    if should_escalate:
        # æ”¶é›†æ›´å¤šè¯Šæ–­æ•°æ®
        error_logs = ["Error: Database connection timeout", "Error: Service unavailable"]

        return {
            "messages": [AIMessage(content=f"L2 æŠ€æœ¯æ”¯æŒï¼š{diagnosis_text}\né—®é¢˜éœ€è¦å·¥ç¨‹å¸ˆæ·±åº¦ä»‹å…¥ï¼Œå‡çº§åˆ° L3")],
            "error_logs": error_logs,
            "current_agent": "tier2",
            "next": "tier3_engineer",
            "handoff_reason": "éœ€è¦ä»£ç çº§åˆ«æ’æŸ¥å’Œä¿®å¤"
        }
    else:
        return {
            "messages": [AIMessage(content=f"L2 æŠ€æœ¯æ”¯æŒï¼š{diagnosis_text}\né—®é¢˜å·²è§£å†³")],
            "current_agent": "tier2",
            "next": "end",
            "resolved": True,
            "resolution": "L2 æŠ€æœ¯æ”¯æŒå·²è§£å†³"
        }

def tier3_engineer(state: SupportState):
    """L3 å·¥ç¨‹å¸ˆï¼šæ·±åº¦æ’æŸ¥å’Œä»£ç ä¿®å¤"""
    llm = ChatOpenAI(model="claude-sonnet-4-5")

    symptoms = state.get("symptoms", [])
    error_logs = state.get("error_logs", [])

    # å·¥ç¨‹å¸ˆçº§åˆ«åˆ†æ
    engineer_prompt = f"""ä½ æ˜¯èµ„æ·±å·¥ç¨‹å¸ˆã€‚

    é—®é¢˜ä¿¡æ¯ï¼š
    - ç—‡çŠ¶ï¼š{', '.join(symptoms)}
    - é”™è¯¯æ—¥å¿—ï¼š{', '.join(error_logs)}

    ä»»åŠ¡ï¼š
    1. æ·±åº¦åˆ†ææ ¹æœ¬åŸå› 
    2. æä¾›ä»£ç çº§åˆ«çš„ä¿®å¤æ–¹æ¡ˆ
    3. ç»™å‡ºé¢„é˜²æªæ–½
    """

    analysis = llm.invoke([SystemMessage(content=engineer_prompt)])

    return {
        "messages": [AIMessage(content=f"L3 å·¥ç¨‹å¸ˆï¼š{analysis.content}")],
        "current_agent": "tier3",
        "next": "end",
        "resolved": True,
        "resolution": "L3 å·¥ç¨‹å¸ˆå·²æ·±åº¦ä¿®å¤"
    }

# ========== 3. è·¯ç”±é€»è¾‘ ==========

def route(state: SupportState) -> Literal["tier1_support", "tier2_technical", "tier3_engineer", "end"]:
    """è·¯ç”±åˆ°ä¸‹ä¸€ä¸ªä»£ç†æˆ–ç»“æŸ"""
    next_agent = state.get("next", "tier1_support")
    if next_agent == "end":
        return END
    return next_agent

# ========== 4. æ„å»ºå·¥ä½œæµ ==========

workflow = StateGraph(SupportState)

# æ·»åŠ ä¸‰å±‚æ”¯æŒä»£ç†
workflow.add_node("tier1_support", tier1_support)
workflow.add_node("tier2_technical", tier2_technical)
workflow.add_node("tier3_engineer", tier3_engineer)

# è·¯ç”±é…ç½®
workflow.add_edge(START, "tier1_support")
workflow.add_conditional_edges("tier1_support", route)
workflow.add_conditional_edges("tier2_technical", route)
workflow.add_conditional_edges("tier3_engineer", route)

# ç¼–è¯‘
app = workflow.compile()

# ========== 5. æµ‹è¯•ä¸åŒåœºæ™¯ ==========

test_scenarios = [
    {
        "name": "ç®€å•å’¨è¯¢ï¼ˆL1 å¤„ç†ï¼‰",
        "message": "å¦‚ä½•é‡ç½®å¯†ç ï¼Ÿ"
    },
    {
        "name": "æŠ€æœ¯é—®é¢˜ï¼ˆL1 â†’ L2ï¼‰",
        "message": "åº”ç”¨åŠ è½½å¾ˆæ…¢ï¼Œæœ‰æ—¶ä¼šå¡ä½"
    },
    {
        "name": "ä¸¥é‡æ•…éšœï¼ˆL1 â†’ L2 â†’ L3ï¼‰",
        "message": "ç´§æ€¥ï¼æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œæ‰€æœ‰ç”¨æˆ·æ— æ³•ç™»å½•"
    }
]

for scenario in test_scenarios:
    print(f"\n{'='*60}")
    print(f"åœºæ™¯ï¼š{scenario['name']}")
    print(f"{'='*60}")

    result = app.invoke({
        "messages": [HumanMessage(content=scenario['message'])],
        "user_id": f"user_{uuid.uuid4().hex[:8]}",
        "session_id": f"session_{uuid.uuid4().hex[:8]}"
    })

    # æ‰“å°äº¤æ¥æµç¨‹
    print(f"\nç”¨æˆ·è¯·æ±‚ï¼š{scenario['message']}")
    print(f"\näº¤æ¥æµç¨‹ï¼š")
    for msg in result["messages"]:
        if isinstance(msg, AIMessage):
            print(f"  {msg.content}")

    print(f"\næœ€ç»ˆçŠ¶æ€ï¼š")
    print(f"  - é—®é¢˜ç±»å‹ï¼š{result.get('issue_type', 'N/A')}")
    print(f"  - ä¼˜å…ˆçº§ï¼š{result.get('priority', 'N/A')}")
    print(f"  - å½“å‰ä»£ç†ï¼š{result.get('current_agent', 'N/A')}")
    print(f"  - æ˜¯å¦è§£å†³ï¼š{result.get('resolved', False)}")
    if result.get('handoff_reason'):
        print(f"  - äº¤æ¥åŸå› ï¼š{result['handoff_reason']}")

# è¾“å‡ºç¤ºä¾‹ï¼š
# ============================================================
# åœºæ™¯ï¼šä¸¥é‡æ•…éšœï¼ˆL1 â†’ L2 â†’ L3ï¼‰
# ============================================================
#
# ç”¨æˆ·è¯·æ±‚ï¼šç´§æ€¥ï¼æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œæ‰€æœ‰ç”¨æˆ·æ— æ³•ç™»å½•
#
# äº¤æ¥æµç¨‹ï¼š
#   L1 å®¢æœï¼šè¿™æ˜¯ç´§æ€¥é—®é¢˜ï¼Œæˆ‘å°†ç«‹å³ä¸ºæ‚¨è½¬æ¥æŠ€æœ¯æ”¯æŒå›¢é˜Ÿï¼ˆL2ï¼‰
#   L2 æŠ€æœ¯æ”¯æŒï¼š[è¯Šæ–­ç»“æœ...]
#   é—®é¢˜éœ€è¦å·¥ç¨‹å¸ˆæ·±åº¦ä»‹å…¥ï¼Œå‡çº§åˆ° L3
#   L3 å·¥ç¨‹å¸ˆï¼š[æ·±åº¦åˆ†æå’Œä¿®å¤æ–¹æ¡ˆ...]
#
# æœ€ç»ˆçŠ¶æ€ï¼š
#   - é—®é¢˜ç±»å‹ï¼šcritical
#   - ä¼˜å…ˆçº§ï¼šhigh
#   - å½“å‰ä»£ç†ï¼štier3
#   - æ˜¯å¦è§£å†³ï¼šTrue
#   - äº¤æ¥åŸå› ï¼šéœ€è¦ä»£ç çº§åˆ«æ’æŸ¥å’Œä¿®å¤

# ä¼˜åŠ¿ï¼š
# - è‡ªåŠ¨åŒ–çš„å¤šå±‚çº§å‡çº§
# - å®Œæ•´çš„çŠ¶æ€ä¼ é€’ï¼ˆç—‡çŠ¶ã€æ—¥å¿—ã€ç”¨æˆ·æ“ä½œï¼‰
# - æ¯å±‚ä»£ç†ä¸“æ³¨äºè‡ªå·±çš„èŒè´£èŒƒå›´
# - çµæ´»çš„äº¤æ¥å†³ç­–ï¼ˆåŸºäºä¼˜å…ˆçº§ã€é—®é¢˜ç±»å‹ï¼‰
# - ç”Ÿäº§çº§çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•</code></pre>
                    </div>
                </section>

                <!-- é«˜çº§ç‰¹æ€§ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸš€ é«˜çº§ç‰¹æ€§</h2>

                    <h3 class="subsection-title">1. åŒå‘äº¤æ¥ï¼ˆå‡çº§ + å›é€€ï¼‰</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
åŒå‘äº¤æ¥ - æ”¯æŒå‡çº§å’Œå›é€€
"""
from typing import TypedDict, Annotated, Literal
from langgraph.graph import StateGraph, START, END

class BidirectionalState(TypedDict):
    messages: Annotated[list, add_messages]
    current_tier: int  # 1, 2, 3
    next: str
    can_downgrade: bool  # æ˜¯å¦å¯ä»¥å›é€€

def tier2_agent(state: BidirectionalState):
    """L2 ä»£ç†ï¼šå¯èƒ½å‡çº§æˆ–å›é€€"""
    messages = state["messages"]
    last_msg = messages[-1].content

    # åˆ¤æ–­ï¼šé—®é¢˜æ˜¯å¦å®é™…ä¸Šå¾ˆç®€å•
    if "å…¶å®æ²¡é‚£ä¹ˆä¸¥é‡" in last_msg or "å·²ç»å¥½äº†" in last_msg:
        return {
            "messages": [AIMessage(content="L2ï¼šé—®é¢˜å·²è§£å†³ï¼Œæ— éœ€è¿›ä¸€æ­¥å‡çº§")],
            "next": "end",
            "can_downgrade": True
        }

    # åˆ¤æ–­ï¼šæ˜¯å¦éœ€è¦å‡çº§
    if "è¿˜æ˜¯ä¸è¡Œ" in last_msg or "æ›´ä¸¥é‡äº†" in last_msg:
        return {
            "messages": [AIMessage(content="L2ï¼šé—®é¢˜åŠ å‰§ï¼Œå‡çº§åˆ° L3 å·¥ç¨‹å¸ˆ")],
            "current_tier": 3,
            "next": "tier3",
            "can_downgrade": False
        }

    return {
        "messages": [AIMessage(content="L2ï¼šæ­£åœ¨å¤„ç†...")],
        "next": "end"
    }

# ä¼˜åŠ¿ï¼š
# - çµæ´»çš„æµç¨‹æ§åˆ¶
# - é¿å…ä¸å¿…è¦çš„å‡çº§
# - æ”¯æŒé—®é¢˜é™çº§ï¼ˆèŠ‚çœèµ„æºï¼‰</code></pre>
                    </div>

                    <h3 class="subsection-title">2. æ¡ä»¶è§¦å‘çš„è‡ªåŠ¨äº¤æ¥</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ¡ä»¶è§¦å‘äº¤æ¥ - åŸºäºå…³é”®è¯ã€å·¥å…·ç»“æœã€æ—¶é—´
"""
from typing import TypedDict, Annotated
import datetime

class AutoHandoffState(TypedDict):
    messages: Annotated[list, add_messages]
    keywords_detected: list[str]
    tools_failed: bool
    elapsed_time: int  # ç§’
    next: str

def smart_agent(state: AutoHandoffState):
    """æ™ºèƒ½ä»£ç†ï¼šè‡ªåŠ¨æ£€æµ‹äº¤æ¥æ¡ä»¶"""
    messages = state["messages"]
    last_msg = messages[-1].content.lower()

    # æ¡ä»¶ 1ï¼šå…³é”®è¯è§¦å‘
    critical_keywords = ["ç´§æ€¥", "æ•°æ®ä¸¢å¤±", "å®‰å…¨æ¼æ´", "å®•æœº"]
    detected = [kw for kw in critical_keywords if kw in last_msg]

    # æ¡ä»¶ 2ï¼šå·¥å…·å¤±è´¥è§¦å‘
    tools_failed = state.get("tools_failed", False)

    # æ¡ä»¶ 3ï¼šè¶…æ—¶è§¦å‘
    elapsed = state.get("elapsed_time", 0)
    timeout = elapsed > 300  # 5 åˆ†é’Ÿ

    # è‡ªåŠ¨äº¤æ¥å†³ç­–
    if detected or tools_failed or timeout:
        reason = []
        if detected:
            reason.append(f"æ£€æµ‹åˆ°å…³é”®è¯ï¼š{', '.join(detected)}")
        if tools_failed:
            reason.append("å·¥å…·è°ƒç”¨å¤±è´¥")
        if timeout:
            reason.append("å¤„ç†è¶…æ—¶")

        return {
            "messages": [AIMessage(content=f"è‡ªåŠ¨å‡çº§ï¼š{'; '.join(reason)}")],
            "keywords_detected": detected,
            "next": "specialist"
        }

    return {
        "messages": [AIMessage(content="æ­£å¸¸å¤„ç†ä¸­...")],
        "next": "end"
    }

# ä¼˜åŠ¿ï¼š
# - è‡ªåŠ¨åŒ–å†³ç­–
# - å¤šç»´åº¦è§¦å‘æ¡ä»¶
# - å‡å°‘äººå·¥å¹²é¢„</code></pre>
                    </div>
                </section>

                <!-- æœ€ä½³å®è·µ -->
                <section class="content-section">
                    <h2 class="section-title">âœ¨ Handoffs æœ€ä½³å®è·µ</h2>

                    <h3 class="subsection-title">1. äº¤æ¥å†³ç­–æ¸…å•</h3>
                    <div class="info-box tip">
                        <div class="info-box-title">ğŸ“ ä½•æ—¶äº¤æ¥ï¼Ÿ</div>
                        <ul>
                            <li><strong>èƒ½åŠ›ä¸è¶³</strong>ï¼šå½“å‰ä»£ç†æ— æ³•å¤„ç†ï¼ˆæŠ€æœ¯é—®é¢˜ â†’ æŠ€æœ¯æ”¯æŒï¼‰</li>
                            <li><strong>ä¼˜å…ˆçº§é«˜</strong>ï¼šç´§æ€¥é—®é¢˜éœ€è¦é«˜çº§åˆ«æ”¯æŒ</li>
                            <li><strong>ä¸“ä¸šåŒ–éœ€æ±‚</strong>ï¼šéœ€è¦ç‰¹å®šé¢†åŸŸä¸“å®¶ï¼ˆè´¦å• â†’ è´¢åŠ¡ï¼‰</li>
                            <li><strong>å·¥å…·å¤±è´¥</strong>ï¼šå¸¸è§„å·¥å…·æ— æ³•è§£å†³é—®é¢˜</li>
                            <li><strong>ç”¨æˆ·è¯·æ±‚</strong>ï¼šç”¨æˆ·æ˜ç¡®è¦æ±‚å‡çº§</li>
                            <li><strong>è¶…æ—¶</strong>ï¼šå¤„ç†æ—¶é—´è¶…è¿‡é˜ˆå€¼</li>
                        </ul>
                    </div>

                    <h3 class="subsection-title">2. çŠ¶æ€è®¾è®¡åŸåˆ™</h3>
                    <ul>
                        <li><strong>åŒ…å«äº¤æ¥å…ƒæ•°æ®</strong>ï¼š
                            <code>handoff_reason</code>ï¼ˆäº¤æ¥åŸå› ï¼‰ã€
                            <code>handoff_timestamp</code>ï¼ˆäº¤æ¥æ—¶é—´ï¼‰ã€
                            <code>previous_agent</code>ï¼ˆå‰ä¸€ä¸ªä»£ç†ï¼‰
                        </li>
                        <li><strong>ä¿ç•™å®Œæ•´ä¸Šä¸‹æ–‡</strong>ï¼š
                            messagesï¼ˆå¯¹è¯å†å²ï¼‰ã€
                            collected_dataï¼ˆæ”¶é›†çš„è¯Šæ–­æ•°æ®ï¼‰ã€
                            user_actionsï¼ˆç”¨æˆ·æ“ä½œè®°å½•ï¼‰
                        </li>
                        <li><strong>æ·»åŠ ä¼˜å…ˆçº§å­—æ®µ</strong>ï¼š
                            priorityï¼ˆä¼˜å…ˆçº§ï¼‰ã€
                            severityï¼ˆä¸¥é‡æ€§ï¼‰ã€
                            urgencyï¼ˆç´§æ€¥åº¦ï¼‰
                        </li>
                        <li><strong>æ”¯æŒå›æº¯</strong>ï¼š
                            handoff_historyï¼ˆäº¤æ¥å†å²é“¾ï¼‰ã€
                            can_downgradeï¼ˆæ˜¯å¦å¯å›é€€ï¼‰
                        </li>
                    </ul>

                    <h3 class="subsection-title">3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>åœºæ™¯</th>
                                <th>å·®çš„å®è·µ</th>
                                <th>å¥½çš„å®è·µ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>äº¤æ¥é€šçŸ¥</strong></td>
                                <td>"è½¬æ¥ä¸­..."</td>
                                <td>"æˆ‘å°†ä¸ºæ‚¨è½¬æ¥æŠ€æœ¯æ”¯æŒï¼Œä»–ä»¬ä¼šå¸®æ‚¨è§£å†³è¿™ä¸ªé—®é¢˜"</td>
                            </tr>
                            <tr>
                                <td><strong>é‡å¤ä¿¡æ¯</strong></td>
                                <td>è¦æ±‚ç”¨æˆ·é‡å¤æè¿°é—®é¢˜</td>
                                <td>è‡ªåŠ¨ä¼ é€’ä¸Šä¸‹æ–‡ï¼Œç›´æ¥ç»§ç»­</td>
                            </tr>
                            <tr>
                                <td><strong>ç­‰å¾…æ—¶é—´</strong></td>
                                <td>é•¿æ—¶é—´æ— å“åº”</td>
                                <td>"æ­£åœ¨ä¸ºæ‚¨åŒ¹é…ä¸“å®¶ï¼Œè¯·ç¨å€™..."</td>
                            </tr>
                            <tr>
                                <td><strong>äº¤æ¥å¤±è´¥</strong></td>
                                <td>ç›´æ¥æŠ¥é”™</td>
                                <td>æä¾›å¤‡é€‰æ–¹æ¡ˆæˆ–é™çº§å¤„ç†</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="subsection-title">4. æ€§èƒ½ä¼˜åŒ–</h3>
                    <ul>
                        <li><strong>ç¼“å­˜ä»£ç†çŠ¶æ€</strong>ï¼šé¿å…é‡å¤åˆå§‹åŒ–ç›¸åŒçš„ä»£ç†</li>
                        <li><strong>é¢„åŠ è½½</strong>ï¼šæå‰åŠ è½½å¯èƒ½éœ€è¦çš„ä»£ç†ï¼ˆåŸºäºé¢„æµ‹ï¼‰</li>
                        <li><strong>å¼‚æ­¥äº¤æ¥</strong>ï¼šäº¤æ¥è¿‡ç¨‹ä¸é˜»å¡ç”¨æˆ·äº¤äº’</li>
                        <li><strong>çŠ¶æ€å‹ç¼©</strong>ï¼šé•¿å¯¹è¯å†å²ä½¿ç”¨æ‘˜è¦ï¼Œå‡å°‘ä¼ è¾“</li>
                        <li><strong>è¶…æ—¶ä¿æŠ¤</strong>ï¼šè®¾ç½®äº¤æ¥è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…</li>
                    </ul>

                    <h3 class="subsection-title">5. ç›‘æ§å’Œè°ƒè¯•</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># äº¤æ¥æ—¥å¿—è®°å½•
import logging

logger = logging.getLogger("handoffs")

def log_handoff(state: SupportState):
    """è®°å½•æ¯æ¬¡äº¤æ¥"""
    logger.info(f"""
    Handoff Event:
    - From: {state.get('current_agent')}
    - To: {state.get('next')}
    - Reason: {state.get('handoff_reason')}
    - User ID: {state.get('user_id')}
    - Session ID: {state.get('session_id')}
    - Timestamp: {datetime.now()}
    - Issue Type: {state.get('issue_type')}
    - Priority: {state.get('priority')}
    """)

# åœ¨ LangSmith ä¸­è¿½è¸ªäº¤æ¥
os.environ["LANGCHAIN_TRACING_V2"] = "true"

# æŸ¥çœ‹äº¤æ¥æµç¨‹ï¼š
# - æ¯ä¸ªä»£ç†çš„æ‰§è¡Œæ—¶é—´
# - äº¤æ¥å†³ç­–ç‚¹
# - çŠ¶æ€å˜åŒ–</code></pre>
                    </div>
                </section>

                <!-- å¸¸è§é—®é¢˜ -->
                <section class="content-section">
                    <h2 class="section-title">â“ å¸¸è§é—®é¢˜</h2>

                    <h3 class="subsection-subtitle">Q1: Handoffs å’Œ Router æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3>
                    <p>
                        <strong>å…³é”®åŒºåˆ«</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>Router</strong>ï¼šåœ¨æµç¨‹<strong>å¼€å§‹æ—¶</strong>ä¸€æ¬¡æ€§å†³å®šè·¯ç”±åˆ°å“ªä¸ªä»£ç†ï¼Œä¸å†æ”¹å˜</li>
                        <li><strong>Handoffs</strong>ï¼šåœ¨æµç¨‹<strong>æ‰§è¡Œè¿‡ç¨‹ä¸­</strong>åŠ¨æ€å†³å®šæ˜¯å¦äº¤æ¥ï¼Œå¯å¤šæ¬¡è½¬ç§»</li>
                    </ul>
                    <p>
                        <strong>ç¤ºä¾‹</strong>ï¼š
                    </p>
                    <ul>
                        <li>Routerï¼šç”¨æˆ·å‘èµ·è¯·æ±‚ â†’ è·¯ç”±å™¨åˆ†æ â†’ åˆ†é…ç»™é”€å”®/æŠ€æœ¯/è´¦å•ä»£ç† â†’  ç»“æŸ</li>
                        <li>Handoffsï¼šç”¨æˆ·è¯·æ±‚ â†’ å®¢æœä»£ç† â†’ ï¼ˆå‘ç°æ˜¯æŠ€æœ¯é—®é¢˜ï¼‰â†’ äº¤æ¥ç»™æŠ€æœ¯æ”¯æŒ â†’ ï¼ˆé—®é¢˜ä¸¥é‡ï¼‰â†’ äº¤æ¥ç»™å·¥ç¨‹å¸ˆ</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q2: å¦‚ä½•é¿å…æ— é™äº¤æ¥å¾ªç¯ï¼Ÿ</h3>
                    <p>
                        <strong>é˜²æ­¢å¾ªç¯çš„ç­–ç•¥</strong>ï¼š
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># ç­–ç•¥ 1ï¼šé™åˆ¶äº¤æ¥æ¬¡æ•°
class SafeHandoffState(TypedDict):
    handoff_count: int
    max_handoffs: int  # æœ€å¤§äº¤æ¥æ¬¡æ•°ï¼ˆå¦‚ 3ï¼‰

def safe_agent(state: SafeHandoffState):
    if state["handoff_count"] >= state["max_handoffs"]:
        return {"next": "end"}  # å¼ºåˆ¶ç»“æŸ

    # æ­£å¸¸äº¤æ¥é€»è¾‘
    return {
        "next": "other_agent",
        "handoff_count": state["handoff_count"] + 1
    }

# ç­–ç•¥ 2ï¼šè®°å½•äº¤æ¥å†å²ï¼Œé¿å…é‡å¤
class HistoryState(TypedDict):
    handoff_history: list[str]  # ["agent1", "agent2"]

def check_cycle(state: HistoryState, target: str):
    """æ£€æŸ¥æ˜¯å¦ä¼šå½¢æˆå¾ªç¯"""
    if state["handoff_history"].count(target) >= 2:
        return True  # åŒä¸€ä¸ªä»£ç†è®¿é—®è¶…è¿‡ 2 æ¬¡
    return False</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q3: å¦‚ä½•å¤„ç†äº¤æ¥å¤±è´¥ï¼Ÿ</h3>
                    <p>
                        <strong>é”™è¯¯å¤„ç†ç­–ç•¥</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>é™çº§å¤„ç†</strong>ï¼šç›®æ ‡ä»£ç†ä¸å¯ç”¨æ—¶ï¼Œå›é€€åˆ°å‰ä¸€ä¸ªä»£ç†æˆ–é€šç”¨ä»£ç†</li>
                        <li><strong>å¤‡é€‰è·¯å¾„</strong>ï¼šå®šä¹‰å¤‡é€‰ä»£ç†åˆ—è¡¨ï¼Œä¾æ¬¡å°è¯•</li>
                        <li><strong>ç”¨æˆ·é€šçŸ¥</strong>ï¼šæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·äº¤æ¥å¤±è´¥ï¼Œæä¾›æ›¿ä»£æ–¹æ¡ˆ</li>
                        <li><strong>é‡è¯•æœºåˆ¶</strong>ï¼šçŸ­æš‚å»¶è¿Ÿåé‡è¯•äº¤æ¥</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q4: çŠ¶æ€å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ</h3>
                    <p>
                        <strong>çŠ¶æ€ä¼˜åŒ–æ–¹æ¡ˆ</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>ä½¿ç”¨æ‘˜è¦</strong>ï¼šé•¿å¯¹è¯å†å²å‹ç¼©ä¸ºæ‘˜è¦å­—æ®µ</li>
                        <li><strong>å¼•ç”¨å­˜å‚¨</strong>ï¼šå¤§æ•°æ®ï¼ˆå¦‚æ—¥å¿—ï¼‰å­˜å‚¨åœ¨å¤–éƒ¨ï¼ŒçŠ¶æ€åªä¿ç•™ ID</li>
                        <li><strong>åˆ†å±‚çŠ¶æ€</strong>ï¼šä»…ä¼ é€’å½“å‰å±‚çº§éœ€è¦çš„å­—æ®µ</li>
                        <li><strong>æ¸…ç†è¿‡æœŸæ•°æ®</strong>ï¼šå®šæœŸæ¸…ç†ä¸å†éœ€è¦çš„ä¸´æ—¶å­—æ®µ</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q5: å¦‚ä½•åœ¨äº¤æ¥æ—¶ä¿æŒç”¨æˆ·ä¼šè¯ï¼Ÿ</h3>
                    <p>
                        <strong>ä¼šè¯ä¿æŒç­–ç•¥</strong>ï¼š
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># ä½¿ç”¨ Checkpointer ä¿æŒä¼šè¯
from langgraph.checkpoint.memory import MemorySaver

checkpointer = MemorySaver()

app = workflow.compile(checkpointer=checkpointer)

# è°ƒç”¨æ—¶ä¼ é€’ thread_id
config = {"configurable": {"thread_id": "user123_session"}}

# ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼ˆå®¢æœä»£ç†ï¼‰
result1 = app.invoke(input1, config=config)

# äº¤æ¥åçš„è°ƒç”¨ï¼ˆæŠ€æœ¯æ”¯æŒä»£ç†ï¼‰
# ä¼šè¯çŠ¶æ€è‡ªåŠ¨ä¿ç•™
result2 = app.invoke(input2, config=config)</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q6: å¦‚ä½•æµ‹è¯• Handoffs æµç¨‹ï¼Ÿ</h3>
                    <p>
                        <strong>æµ‹è¯•ç­–ç•¥</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>å•å…ƒæµ‹è¯•</strong>ï¼šå•ç‹¬æµ‹è¯•æ¯ä¸ªä»£ç†çš„äº¤æ¥å†³ç­–é€»è¾‘</li>
                        <li><strong>è·¯å¾„æµ‹è¯•</strong>ï¼šæµ‹è¯•æ‰€æœ‰å¯èƒ½çš„äº¤æ¥è·¯å¾„ï¼ˆL1â†’L2, L1â†’L2â†’L3ï¼‰</li>
                        <li><strong>è¾¹ç•Œæµ‹è¯•</strong>ï¼šæµ‹è¯•äº¤æ¥æ¬¡æ•°é™åˆ¶ã€è¶…æ—¶ã€å¾ªç¯æ£€æµ‹</li>
                        <li><strong>çŠ¶æ€éªŒè¯</strong>ï¼šéªŒè¯äº¤æ¥åçŠ¶æ€å®Œæ•´æ€§</li>
                        <li><strong>æ€§èƒ½æµ‹è¯•</strong>ï¼šæµ‹è¯•äº¤æ¥å»¶è¿Ÿå’Œååé‡</li>
                    </ul>
                </section>

                <!-- å‚è€ƒèµ„æº -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“– å‚è€ƒèµ„æº</h2>
                    <ul>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/multi-agent/handoffs" target="_blank">
                                Multi-Agent Handoffs å®˜æ–¹æ–‡æ¡£
                            </a>
                        </li>
                        <li>
                            <a href="38-multi-agent-index.html">
                                Multi-Agent æ¦‚è¿°
                            </a>
                        </li>
                        <li>
                            <a href="39-multi-agent-subagents.html">
                                Multi-Agent å­ä»£ç†
                            </a>
                        </li>
                        <li>
                            <a href="39-multi-agent-skills.html">
                                Multi-Agent æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li>
                            <a href="38-multi-agent-router.html">
                                Multi-Agent è·¯ç”±æœºåˆ¶
                            </a>
                        </li>
                        <li>
                            <a href="15-langgraph.html">
                                LangGraph - å›¾å·¥ä½œæµåŸºç¡€
                            </a>
                        </li>
                    </ul>
                </section>

                <!-- é¡µé¢å¯¼èˆª -->
                                <nav class="page-navigation">
                    <a href="33-multi-agent-subagents.html" class="nav-button prev">
                        â† ä¸Šä¸€é¡µ:å­ä»£ç†
                    </a>
                    <a href="35-multi-agent-skills.html" class="nav-button next">
                        ä¸‹ä¸€é¡µ:æŠ€èƒ½ç³»ç»Ÿ â†’
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" aria-label="è¿”å›é¡¶éƒ¨">â†‘</button>

    <!-- JavaScript -->
    <script src="assets/js/mermaid-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
