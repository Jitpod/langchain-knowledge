<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LangChain 1.0 æ ¸å¿ƒæ¶æ„ - æ·±å…¥ç†è§£ LangChain çš„è®¾è®¡å“²å­¦å’Œæ¨¡å—ç»„ç»‡">
    <title>æ ¸å¿ƒæ¶æ„ | LangChain 1.0 Python çŸ¥è¯†æ–‡æ¡£</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <button class="mobile-menu-button" aria-label="æ‰“å¼€èœå•">â˜°</button>

    <div class="container">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">ğŸ¦œ LangChain 1.0</h1>
                <p class="sidebar-subtitle">Python å®Œæ•´å­¦ä¹ æŒ‡å—</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-section">
                    <div class="nav-section-title">å¼€å§‹</div>
                    <ul>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <span class="nav-icon">ğŸ </span>
                                ä¸»é¡µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">åŸºç¡€ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="01-introduction.html" class="nav-link">
                                <span class="nav-icon">ğŸ“–</span>
                                LangChain ç®€ä»‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="02-architecture.html" class="nav-link">
                                <span class="nav-icon">ğŸ—ï¸</span>
                                æ ¸å¿ƒæ¶æ„
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="03-models.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤–</span>
                                æ¨¡å‹æ¥å£
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="04-messages.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¬</span>
                                æ¶ˆæ¯ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="05-tools.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                å·¥å…·ç³»ç»Ÿ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">è¿›é˜¶ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="06-agents.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                Agent åŸºç¡€
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="07-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="08-rag.html" class="nav-link">
                                <span class="nav-icon">ğŸ”</span>
                                RAG è¯¦è§£
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="09-lcel.html" class="nav-link">
                                <span class="nav-icon">ğŸ”—</span>
                                LCEL è¡¨è¾¾å¼
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">é«˜çº§åº”ç”¨</div>
                    <ul>
                        <li class="nav-item">
                            <a href="10-runtime.html" class="nav-link">
                                <span class="nav-icon">ğŸ”Œ</span>
                                Runtime ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="11-checkpointer.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¾</span>
                                æŒä¹…åŒ–ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="12-streaming.html" class="nav-link">
                                <span class="nav-icon">ğŸŒŠ</span>
                                æµå¼è¾“å‡º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="13-human-in-loop.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="14-long-term-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ—„ï¸</span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="15-langgraph.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                LangGraph
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å®æˆ˜ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="16-customer-service.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å®¢æœæœºå™¨äºº
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="17-best-practices.html" class="nav-link">
                                <span class="nav-icon">âœ¨</span>
                                æœ€ä½³å®è·µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å‚è€ƒç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="18-api-reference.html" class="nav-link">
                                <span class="nav-icon">ğŸ“š</span>
                                API é€ŸæŸ¥è¡¨
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="19-troubleshooting.html" class="nav-link">
                                <span class="nav-icon">ğŸ›</span>
                                æ•…éšœæ’é™¤
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="20-migration.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                è¿ç§»æŒ‡å—
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">æ‰©å±•ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="21-structured-output.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                ç»“æ„åŒ–è¾“å‡º
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">DeepAgents ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="22-deepagents-quickstart.html" class="nav-link">
                                <span class="nav-icon">ğŸš€</span>
                                å¿«é€Ÿå¼€å§‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="23-deepagents-customization.html" class="nav-link">
                                <span class="nav-icon">ğŸ¨</span>
                                å®šåˆ¶åŒ–
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="24-deepagents-harness.html" class="nav-link">
                                <span class="nav-icon">ğŸ›ï¸</span>
                                Harness ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="25-deepagents-backends.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                åç«¯é…ç½®
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="26-deepagents-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="27-deepagents-hitl.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="28-deepagents-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ§ </span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="29-deepagents-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">Multi-Agent ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="30-multi-agent-index.html" class="nav-link">
                                <span class="nav-icon">ğŸŒ</span>
                                æ¦‚è¿°
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="31-multi-agent-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="32-multi-agent-handoffs.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                äº¤æ¥æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="33-multi-agent-skills.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="34-multi-agent-router.html" class="nav-link">
                                <span class="nav-icon">ğŸ§­</span>
                                è·¯ç”±æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="35-multi-agent-workflow.html" class="nav-link">
                                <span class="nav-icon">ğŸ”€</span>
                                è‡ªå®šä¹‰å·¥ä½œæµ
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">
                        <a href="index.html" class="breadcrumb-link">ä¸»é¡µ</a>
                    </span>
                    <span class="breadcrumb-item">
                        è¿›é˜¶ç¯‡
                    </span>
                    <span class="breadcrumb-item">
                        ä¸­é—´ä»¶ç³»ç»Ÿ
                    </span>
                </nav>

                <!-- é¡µé¢æ ‡é¢˜ -->
                <header class="page-header">
                    <h1 class="page-title">âš™ï¸ ä¸­é—´ä»¶ç³»ç»Ÿè¯¦è§£</h1>
                    <p class="page-subtitle">
                        æŒæ¡ LangChain 1.0 çš„ä¸­é—´ä»¶é’©å­å‡½æ•°ï¼Œåœ¨ Agent æ‰§è¡Œçš„æ¯ä¸ªæ­¥éª¤
                        å®ç°ç›‘æ§ã€è½¬æ¢å’Œæ§åˆ¶é€»è¾‘ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ã€‚
                    </p>
                </header>

                <!-- ä»€ä¹ˆæ˜¯ä¸­é—´ä»¶ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“š ä»€ä¹ˆæ˜¯ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰ï¼Ÿ</h2>
                    <p>
                        <strong>ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰</strong>æ˜¯ LangChain 1.0 çš„å¼ºå¤§æ‰©å±•æœºåˆ¶ï¼Œ
                        å…è®¸ä½ åœ¨ Agent æ‰§è¡Œçš„å…³é”®èŠ‚ç‚¹æ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚é€šè¿‡ä¸­é—´ä»¶ï¼Œä½ å¯ä»¥ï¼š
                    </p>
                    <ul>
                        <li><strong>è¿½è¸ª</strong>ï¼šè®°å½•æ—¥å¿—ã€æ”¶é›†åˆ†ææ•°æ®ã€è°ƒè¯• Agent è¡Œä¸º</li>
                        <li><strong>è½¬æ¢</strong>ï¼šä¿®æ”¹æç¤ºè¯ã€è°ƒæ•´å·¥å…·é€‰æ‹©ã€æ ¼å¼åŒ–è¾“å‡º</li>
                        <li><strong>æ§åˆ¶</strong>ï¼šæ·»åŠ é‡è¯•ã€é™çº§ã€æå‰ç»ˆæ­¢é€»è¾‘</li>
                        <li><strong>æ²»ç†</strong>ï¼šåº”ç”¨é€Ÿç‡é™åˆ¶ã€éšç§ä¿æŠ¤ã€åˆè§„æ£€æŸ¥</li>
                    </ul>

                    <div class="info-box note">
                        <div class="info-box-title">ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿</div>
                        <p>
                            ä¸­é—´ä»¶è®©ä½ æ— éœ€ä¿®æ”¹æ ¸å¿ƒ Agent ä»£ç å³å¯å®ç°å¤æ‚çš„æ§åˆ¶é€»è¾‘ã€‚
                            é€šè¿‡é’©å­å‡½æ•°åœ¨ Agent æ‰§è¡Œçš„ä¸åŒé˜¶æ®µæ³¨å…¥è¡Œä¸ºï¼Œ
                            å®ç°æ¨¡å—åŒ–ã€å¯å¤ç”¨çš„æ‰©å±•ã€‚
                        </p>
                    </div>
                </section>

                <!-- ä¸­é—´ä»¶æ¶æ„ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ—ï¸ ä¸­é—´ä»¶æ¶æ„å’Œæ‰§è¡Œé¡ºåº</h2>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph TB
    A[Agent å¼€å§‹] --> B[before_agent é’©å­]
    B --> C{å¼€å§‹å¾ªç¯}

    C --> D[before_model é’©å­]
    D --> E[wrap_model_call åŒ…è£…]
    E --> F[æ¨¡å‹è°ƒç”¨]
    F --> G[after_model é’©å­]

    G --> H{éœ€è¦å·¥å…·ï¼Ÿ}

    H -->|æ˜¯| I[wrap_tool_call åŒ…è£…]
    I --> J[æ‰§è¡Œå·¥å…·]
    J --> K[è¿”å› ToolMessage]
    K --> D

    H -->|å¦| L{ç»§ç»­å¾ªç¯ï¼Ÿ}

    L -->|æ˜¯| D
    L -->|å¦| M[after_agent é’©å­]
    M --> N[Agent ç»“æŸ]

    style B fill:#6366f1,color:#fff
    style D fill:#3b82f6,color:#fff
    style E fill:#10b981,color:#fff
    style G fill:#f59e0b,color:#fff
    style I fill:#8b5cf6,color:#fff
    style M fill:#ec4899,color:#fff
                        </div>
                    </div>

                    <h3 class="subsection-title">æ‰§è¡Œé¡ºåºè§„åˆ™</h3>
                    <p>
                        å½“ä½¿ç”¨å¤šä¸ªä¸­é—´ä»¶æ—¶ï¼Œç†è§£æ‰§è¡Œé¡ºåºè‡³å…³é‡è¦ï¼š
                    </p>

                    <table>
                        <thead>
                            <tr>
                                <th>é’©å­ç±»å‹</th>
                                <th>æ‰§è¡Œé¡ºåº</th>
                                <th>è¯´æ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>before_agent</code></td>
                                <td>ä»å‰åˆ°å</td>
                                <td>æŒ‰ä¸­é—´ä»¶åˆ—è¡¨é¡ºåºæ‰§è¡Œ</td>
                            </tr>
                            <tr>
                                <td><code>before_model</code></td>
                                <td>ä»å‰åˆ°å</td>
                                <td>æ¯æ¬¡æ¨¡å‹è°ƒç”¨å‰æŒ‰é¡ºåº</td>
                            </tr>
                            <tr>
                                <td><code>wrap_model_call</code></td>
                                <td>åµŒå¥—åŒ…è£…</td>
                                <td>ç¬¬ä¸€ä¸ªä¸­é—´ä»¶æœ€å¤–å±‚</td>
                            </tr>
                            <tr>
                                <td><code>after_model</code></td>
                                <td><strong>ä»ååˆ°å‰ï¼ˆåå‘ï¼‰</strong></td>
                                <td>ä¸ before_model ç›¸å</td>
                            </tr>
                            <tr>
                                <td><code>after_agent</code></td>
                                <td><strong>ä»ååˆ°å‰ï¼ˆåå‘ï¼‰</strong></td>
                                <td>ä¸ before_agent ç›¸å</td>
                            </tr>
                            <tr>
                                <td><code>wrap_tool_call</code></td>
                                <td>åµŒå¥—åŒ…è£…</td>
                                <td>ç¬¬ä¸€ä¸ªä¸­é—´ä»¶æœ€å¤–å±‚</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box tip">
                        <div class="info-box-title">âœ… å…³é”®è®°å¿†ç‚¹</div>
                        <ul>
                            <li><strong>before_* é’©å­</strong>ï¼šä»å‰åˆ°åæ‰§è¡Œ</li>
                            <li><strong>after_* é’©å­</strong>ï¼šä»ååˆ°å‰æ‰§è¡Œï¼ˆåå‘ï¼‰</li>
                            <li><strong>wrap_* é’©å­</strong>ï¼šåµŒå¥—åŒ…è£…ï¼Œå…ˆæ³¨å†Œçš„åœ¨æœ€å¤–å±‚</li>
                        </ul>
                    </div>
                </section>

                <!-- é’©å­å‡½æ•°ç±»å‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸª é’©å­å‡½æ•°ç±»å‹</h2>
                    <p>
                        LangChain æä¾›ä¸¤ç§é£æ ¼çš„é’©å­å‡½æ•°ï¼š
                    </p>

                    <h3 class="subsection-title">èŠ‚ç‚¹é£æ ¼é’©å­ï¼ˆNode-Style Hooksï¼‰</h3>
                    <p>åœ¨ç‰¹å®šæ‰§è¡Œç‚¹é¡ºåºè¿è¡Œï¼š</p>
                    <ul>
                        <li><code>before_agent</code>ï¼šAgent å¯åŠ¨å‰æ‰§è¡Œä¸€æ¬¡</li>
                        <li><code>before_model</code>ï¼šæ¯æ¬¡æ¨¡å‹è°ƒç”¨å‰æ‰§è¡Œ</li>
                        <li><code>after_model</code>ï¼šæ¯æ¬¡æ¨¡å‹å“åº”åæ‰§è¡Œ</li>
                        <li><code>after_agent</code>ï¼šAgent å®Œæˆåæ‰§è¡Œä¸€æ¬¡</li>
                    </ul>

                    <h3 class="subsection-title">åŒ…è£…é£æ ¼é’©å­ï¼ˆWrap-Style Hooksï¼‰</h3>
                    <p>æ‹¦æˆªå¹¶æ§åˆ¶æ‰§è¡Œæµç¨‹ï¼š</p>
                    <ul>
                        <li><code>wrap_model_call</code>ï¼šåŒ…è£…æ¯æ¬¡æ¨¡å‹è°ƒç”¨</li>
                        <li><code>wrap_tool_call</code>ï¼šåŒ…è£…æ¯æ¬¡å·¥å…·è°ƒç”¨</li>
                    </ul>

                    <div class="info-box note">
                        <div class="info-box-title">ğŸ’¡ å…³é”®åŒºåˆ«</div>
                        <p>
                            <strong>Wrap é£æ ¼</strong>é’©å­è®©ä½ å†³å®šæ˜¯å¦æ‰§è¡Œã€æ‰§è¡Œå¤šå°‘æ¬¡ï¼š
                        </p>
                        <ul>
                            <li><strong>é›¶æ¬¡</strong>ï¼šçŸ­è·¯è·³è¿‡ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰</li>
                            <li><strong>ä¸€æ¬¡</strong>ï¼šæ­£å¸¸æ‰§è¡Œ</li>
                            <li><strong>å¤šæ¬¡</strong>ï¼šé‡è¯•é€»è¾‘</li>
                        </ul>
                    </div>
                </section>

                <!-- è‡ªå®šä¹‰ä¸­é—´ä»¶å¼€å‘ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ”¨ è‡ªå®šä¹‰ä¸­é—´ä»¶å¼€å‘</h2>

                    <h3 class="subsection-title">è£…é¥°å™¨é£æ ¼ï¼ˆç®€å•å¿«é€Ÿï¼‰</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
è£…é¥°å™¨é£æ ¼ä¸­é—´ä»¶ç¤ºä¾‹
åŠŸèƒ½ï¼šè®°å½•æ¨¡å‹è°ƒç”¨æ—¥å¿—
"""
from langchain.agents.middleware import before_model, after_model
from langchain.agents import create_agent

@before_model
def log_before(state, runtime):
    """æ¨¡å‹è°ƒç”¨å‰è®°å½•æ—¥å¿—"""
    print(f"ğŸ“¤ å‡†å¤‡è°ƒç”¨æ¨¡å‹ï¼Œå½“å‰æ¶ˆæ¯æ•°: {len(state['messages'])}")
    return None  # ä¸ä¿®æ”¹çŠ¶æ€

@after_model
def log_after(state, runtime):
    """æ¨¡å‹å“åº”åè®°å½•æ—¥å¿—"""
    last_msg = state["messages"][-1]
    print(f"ğŸ“¥ æ¨¡å‹å“åº”: {last_msg.content[:50]}...")
    return None

# åˆ›å»º Agent
agent = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[log_before, log_after]
)

# æµ‹è¯•
response = agent.invoke({
    "messages": [{"role": "user", "content": "ä½ å¥½"}]
})</code></pre>
                    </div>

                    <h3 class="subsection-title">ç±»é£æ ¼ï¼ˆå¼ºå¤§çµæ´»ï¼‰</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ç±»é£æ ¼ä¸­é—´ä»¶ç¤ºä¾‹
åŠŸèƒ½ï¼šæ¶ˆæ¯é™åˆ¶å’Œæ—¥å¿—è®°å½•
"""
from langchain.agents import AgentMiddleware, create_agent
from langchain.agents.middleware import hook_config
from langchain.messages import AIMessage

class MessageLimitMiddleware(AgentMiddleware):
    """é™åˆ¶å¯¹è¯æ¶ˆæ¯æ•°é‡çš„ä¸­é—´ä»¶"""

    def __init__(self, max_messages: int = 50):
        super().__init__()
        self.max_messages = max_messages

    @hook_config(can_jump_to=["end"])
    def before_model(self, state, runtime):
        """æ£€æŸ¥æ¶ˆæ¯æ•°é‡é™åˆ¶"""
        if len(state["messages"]) >= self.max_messages:
            return {
                "messages": [AIMessage(
                    f"å¯¹è¯å·²è¾¾åˆ°æœ€å¤§æ¶ˆæ¯æ•°é™åˆ¶ï¼ˆ{self.max_messages}æ¡ï¼‰ã€‚"
                )],
                "jump_to": "end"  # æå‰ç»“æŸ
            }
        return None

    def after_model(self, state, runtime):
        """è®°å½•æ¨¡å‹å“åº”"""
        msg_count = len(state["messages"])
        print(f"ğŸ“Š å½“å‰æ¶ˆæ¯æ•°: {msg_count}/{self.max_messages}")
        return None

# åˆ›å»º Agent
agent = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[MessageLimitMiddleware(max_messages=10)]
)</code></pre>
                    </div>

                    <h3 class="subsection-title">Wrap é£æ ¼é’©å­ï¼šé‡è¯•é€»è¾‘</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Wrap é£æ ¼ä¸­é—´ä»¶ï¼šæ¨¡å‹è°ƒç”¨é‡è¯•
åŠŸèƒ½ï¼šå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œå¸¦æŒ‡æ•°é€€é¿
"""
from langchain.agents.middleware import wrap_model_call
from langchain.agents import create_agent
import time

@wrap_model_call
def retry_model(request, handler):
    """æ¨¡å‹è°ƒç”¨é‡è¯•ä¸­é—´ä»¶"""
    max_retries = 3
    base_delay = 1.0

    for attempt in range(max_retries):
        try:
            # è°ƒç”¨å®é™…çš„æ¨¡å‹
            return handler(request)
        except Exception as e:
            if attempt == max_retries - 1:
                # æœ€åä¸€æ¬¡å°è¯•ä»å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
                raise

            # è®¡ç®—é€€é¿æ—¶é—´
            delay = base_delay * (2 ** attempt)
            print(f"âš ï¸ æ¨¡å‹è°ƒç”¨å¤±è´¥ï¼ˆå°è¯• {attempt + 1}/{max_retries}ï¼‰: {e}")
            print(f"ğŸ”„ ç­‰å¾… {delay} ç§’åé‡è¯•...")
            time.sleep(delay)

# å·¥å…·é‡è¯•ç¤ºä¾‹
@wrap_tool_call
def retry_tool(request, handler):
    """å·¥å…·è°ƒç”¨é‡è¯•ä¸­é—´ä»¶"""
    max_retries = 2

    for attempt in range(max_retries):
        try:
            result = handler(request)
            print(f"âœ… å·¥å…· '{request.tool_call['name']}' æ‰§è¡ŒæˆåŠŸ")
            return result
        except Exception as e:
            if attempt == max_retries - 1:
                print(f"âŒ å·¥å…·æ‰§è¡Œæœ€ç»ˆå¤±è´¥: {e}")
                raise
            print(f"ğŸ”„ å·¥å…·é‡è¯• {attempt + 1}/{max_retries}")

agent = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[retry_model, retry_tool]
)</code></pre>
                    </div>
                </section>

                <!-- å†…ç½®ä¸­é—´ä»¶ç²¾é€‰ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“¦ å†…ç½®ä¸­é—´ä»¶ç²¾é€‰</h2>
                    <p>
                        LangChain æä¾›äº† 10+ ä¸ªç”Ÿäº§å°±ç»ªçš„å†…ç½®ä¸­é—´ä»¶ã€‚
                        ä»¥ä¸‹æ˜¯æœ€å¸¸ç”¨çš„å‡ ä¸ªï¼š
                    </p>

                    <h3 class="subsection-title">1. SummarizationMiddleware - å¯¹è¯æ‘˜è¦</h3>
                    <p>è‡ªåŠ¨æ€»ç»“é•¿å¯¹è¯å†å²ï¼Œé˜²æ­¢è¶…å‡º Token é™åˆ¶ã€‚</p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
SummarizationMiddleware ç¤ºä¾‹
åŠŸèƒ½ï¼šå¯¹è¯è¶…è¿‡ Token é™åˆ¶æ—¶è‡ªåŠ¨æ‘˜è¦
"""
from langchain.agents import create_agent
from langchain.agents.middleware import SummarizationMiddleware

agent = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        SummarizationMiddleware(
            model="gpt-4o-mini",          # ç”¨äºç”Ÿæˆæ‘˜è¦çš„æ¨¡å‹
            trigger=("tokens", 4000),      # è¶…è¿‡ 4000 tokens è§¦å‘
            keep=("messages", 20),         # ä¿ç•™æœ€è¿‘ 20 æ¡æ¶ˆæ¯
        ),
    ],
)

# å¤šæ¡ä»¶è§¦å‘
agent2 = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        SummarizationMiddleware(
            model="gpt-4o-mini",
            trigger=[
                ("tokens", 3000),          # 3000 tokens æˆ–
                ("messages", 50),          # 50 æ¡æ¶ˆæ¯
            ],
            keep=("messages", 10),
        ),
    ],
)</code></pre>
                    </div>

                    <h3 class="subsection-title">2. PIIMiddleware - éšç§ä¿æŠ¤</h3>
                    <p>æ£€æµ‹å’Œå¤„ç†ä¸ªäººèº«ä»½ä¿¡æ¯ï¼ˆPIIï¼‰ã€‚</p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
PIIMiddleware ç¤ºä¾‹
åŠŸèƒ½ï¼šæ£€æµ‹å’Œå±è”½æ•æ„Ÿä¿¡æ¯
"""
from langchain.agents import create_agent
from langchain.agents.middleware import PIIMiddleware
import re

# å†…ç½® PII ç±»å‹ï¼šemail, credit_card, ip, mac_address, url
agent = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        # å±è”½é‚®ç®±
        PIIMiddleware(
            "email",
            strategy="redact",           # æ›¿æ¢ä¸º [REDACTED_EMAIL]
            apply_to_input=True          # æ£€æŸ¥ç”¨æˆ·è¾“å…¥
        ),
        # æ©ç ä¿¡ç”¨å¡
        PIIMiddleware(
            "credit_card",
            strategy="mask",             # éƒ¨åˆ†æ©ç : ****-****-****-1234
            apply_to_input=True
        ),
    ],
)

# è‡ªå®šä¹‰ PII æ£€æµ‹ï¼šAPI Key
agent_api = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        PIIMiddleware(
            "api_key",
            detector=r"sk-[a-zA-Z0-9]{32}",  # æ­£åˆ™è¡¨è¾¾å¼
            strategy="block",                 # æ£€æµ‹åˆ°ç›´æ¥é˜»æ­¢
            apply_to_input=True
        ),
    ],
)

# è‡ªå®šä¹‰æ£€æµ‹å‡½æ•°ï¼šèº«ä»½è¯å·
def detect_id_card(content: str):
    """æ£€æµ‹èº«ä»½è¯å·"""
    matches = []
    pattern = r"\d{17}[\dX]"
    for match in re.finditer(pattern, content):
        matches.append({
            "text": match.group(0),
            "start": match.start(),
            "end": match.end(),
        })
    return matches

agent_id = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        PIIMiddleware(
            "id_card",
            detector=detect_id_card,
            strategy="hash",              # æ›¿æ¢ä¸ºå“ˆå¸Œå€¼
        ),
    ],
)</code></pre>
                    </div>

                    <h3 class="subsection-title">3. HumanInTheLoopMiddleware - äººå·¥å®¡æ ¸</h3>
                    <p>æš‚åœæ‰§è¡Œç­‰å¾…äººå·¥æ‰¹å‡†ã€ç¼–è¾‘æˆ–æ‹’ç»ã€‚</p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
HumanInTheLoopMiddleware ç¤ºä¾‹
åŠŸèƒ½ï¼šæ•æ„Ÿæ“ä½œå‰éœ€è¦äººå·¥æ‰¹å‡†
"""
from langchain.agents import create_agent
from langchain.agents.middleware import HumanInTheLoopMiddleware
from langgraph.checkpoint.memory import InMemorySaver
from langchain.tools import tool

@tool
def send_email(to: str, subject: str, body: str) -> str:
    """å‘é€é‚®ä»¶ï¼ˆæ•æ„Ÿæ“ä½œï¼‰"""
    return f"é‚®ä»¶å·²å‘é€åˆ° {to}"

@tool
def read_email(folder: str = "inbox") -> str:
    """è¯»å–é‚®ä»¶ï¼ˆå®‰å…¨æ“ä½œï¼‰"""
    return f"è¯»å– {folder} ä¸­çš„é‚®ä»¶"

# åˆ›å»º Agentï¼ˆéœ€è¦ checkpointerï¼‰
agent = create_agent(
    model="gpt-4o",
    tools=[send_email, read_email],
    checkpointer=InMemorySaver(),  # å¿…éœ€
    middleware=[
        HumanInTheLoopMiddleware(
            interrupt_on={
                "send_email": {
                    "allowed_decisions": ["approve", "edit", "reject"],
                },
                "read_email": False,  # ä¸éœ€è¦å®¡æ ¸
            }
        ),
    ],
)

# è°ƒç”¨ä¼šåœ¨ send_email å‰æš‚åœï¼Œç­‰å¾…äººå·¥å†³ç­–</code></pre>
                    </div>

                    <h3 class="subsection-title">4. ModelCallLimitMiddleware - è°ƒç”¨é™åˆ¶</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ModelCallLimitMiddleware ç¤ºä¾‹
åŠŸèƒ½ï¼šé˜²æ­¢æ— é™å¾ªç¯å’Œè¿‡é«˜æˆæœ¬
"""
from langchain.agents import create_agent
from langchain.agents.middleware import ModelCallLimitMiddleware

agent = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        ModelCallLimitMiddleware(
            thread_limit=20,    # æ•´ä¸ªçº¿ç¨‹æœ€å¤š 20 æ¬¡è°ƒç”¨
            run_limit=5,        # å•æ¬¡æ‰§è¡Œæœ€å¤š 5 æ¬¡è°ƒç”¨
            exit_behavior="end" # è¾¾åˆ°é™åˆ¶æ—¶ä¼˜é›…ç»“æŸ
        ),
    ],
)</code></pre>
                    </div>

                    <h3 class="subsection-title">5. ToolCallLimitMiddleware - å·¥å…·è°ƒç”¨é™åˆ¶</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ToolCallLimitMiddleware ç¤ºä¾‹
åŠŸèƒ½ï¼šé™åˆ¶å·¥å…·è°ƒç”¨æ¬¡æ•°
"""
from langchain.agents import create_agent
from langchain.agents.middleware import ToolCallLimitMiddleware

# å…¨å±€é™åˆ¶
global_limit = ToolCallLimitMiddleware(
    thread_limit=20,
    run_limit=10
)

# ç‰¹å®šå·¥å…·é™åˆ¶
search_limit = ToolCallLimitMiddleware(
    tool_name="search",
    thread_limit=5,
    run_limit=3
)

agent = create_agent(
    model="gpt-4o",
    tools=[search_tool, calculator_tool],
    middleware=[global_limit, search_limit]
)</code></pre>
                    </div>
                </section>

                <!-- é«˜çº§ç‰¹æ€§ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸš€ é«˜çº§ç‰¹æ€§</h2>

                    <h3 class="subsection-title">è‡ªå®šä¹‰çŠ¶æ€ Schema</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
è‡ªå®šä¹‰çŠ¶æ€ Schema ç¤ºä¾‹
åŠŸèƒ½ï¼šåœ¨çŠ¶æ€ä¸­æ·»åŠ è‡ªå®šä¹‰å­—æ®µè¿›è¡Œè·Ÿè¸ª
"""
from typing_extensions import NotRequired
from langchain.agents import AgentState, create_agent
from langchain.agents.middleware import before_model, after_model, hook_config

# å®šä¹‰è‡ªå®šä¹‰çŠ¶æ€
class CustomState(AgentState):
    model_call_count: NotRequired[int]
    total_tokens: NotRequired[int]
    user_id: NotRequired[str]

@before_model(state_schema=CustomState, can_jump_to=["end"])
def check_call_limit(state: CustomState, runtime):
    """æ£€æŸ¥è°ƒç”¨æ¬¡æ•°é™åˆ¶"""
    count = state.get("model_call_count", 0)
    if count >= 10:
        return {"jump_to": "end"}
    return None

@after_model(state_schema=CustomState)
def increment_counter(state: CustomState, runtime):
    """å¢åŠ è®¡æ•°å™¨"""
    current_count = state.get("model_call_count", 0)
    return {"model_call_count": current_count + 1}

agent = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[check_call_limit, increment_counter],
    state_schema=CustomState
)</code></pre>
                    </div>

                    <h3 class="subsection-title">åŠ¨æ€æ¨¡å‹é€‰æ‹©</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
åŠ¨æ€æ¨¡å‹é€‰æ‹©ç¤ºä¾‹
åŠŸèƒ½ï¼šæ ¹æ®å¯¹è¯é•¿åº¦è‡ªåŠ¨åˆ‡æ¢æ¨¡å‹
"""
from langchain.agents.middleware import wrap_model_call
from langchain.chat_models import init_chat_model

# åˆå§‹åŒ–ä¸¤ä¸ªæ¨¡å‹
simple_model = init_chat_model("gpt-4o-mini")
complex_model = init_chat_model("gpt-4o")

@wrap_model_call
def dynamic_model_selector(request, handler):
    """æ ¹æ®æ¶ˆæ¯æ•°é‡é€‰æ‹©æ¨¡å‹"""
    message_count = len(request.messages)

    if message_count > 20:
        # é•¿å¯¹è¯ä½¿ç”¨é«˜çº§æ¨¡å‹
        selected_model = complex_model
        print(f"ğŸ”µ ä½¿ç”¨é«˜çº§æ¨¡å‹ï¼ˆæ¶ˆæ¯æ•°: {message_count}ï¼‰")
    else:
        # çŸ­å¯¹è¯ä½¿ç”¨è½»é‡æ¨¡å‹
        selected_model = simple_model
        print(f"ğŸŸ¢ ä½¿ç”¨è½»é‡æ¨¡å‹ï¼ˆæ¶ˆæ¯æ•°: {message_count}ï¼‰")

    # è¦†ç›–è¯·æ±‚ä¸­çš„æ¨¡å‹
    return handler(request.override(model=selected_model))

agent = create_agent(
    model="gpt-4o-mini",  # é»˜è®¤æ¨¡å‹
    tools=[],
    middleware=[dynamic_model_selector]
)</code></pre>
                    </div>

                    <h3 class="subsection-title">Agent è·³è½¬æ§åˆ¶</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Agent è·³è½¬æ§åˆ¶ç¤ºä¾‹
åŠŸèƒ½ï¼šæ£€æµ‹åˆ°è¿è§„å†…å®¹æ—¶æå‰ç»“æŸ
"""
from langchain.agents.middleware import after_model, hook_config
from langchain.messages import AIMessage

@after_model
@hook_config(can_jump_to=["end"])
def check_for_blocked_content(state, runtime):
    """æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å«è¢«é˜»æ­¢çš„å†…å®¹"""
    last_message = state["messages"][-1]

    # æ£€æŸ¥æ˜¯å¦åŒ…å«è¿è§„æ ‡è®°
    if "BLOCKED" in last_message.content or "æ‹’ç»å›ç­”" in last_message.content:
        return {
            "messages": [AIMessage("æ£€æµ‹åˆ°è¿è§„å†…å®¹ï¼Œå¯¹è¯å·²ç»ˆæ­¢ã€‚")],
            "jump_to": "end"  # è·³è½¬åˆ°ç»“æŸèŠ‚ç‚¹
        }

    return None

# å¯ç”¨çš„è·³è½¬ç›®æ ‡ï¼š
# - 'end': è·³åˆ°ç»“æŸ
# - 'tools': è·³åˆ°å·¥å…·èŠ‚ç‚¹
# - 'model': è·³åˆ°æ¨¡å‹èŠ‚ç‚¹</code></pre>
                    </div>
                </section>

                <!-- å®Œæ•´ç¤ºä¾‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ¯ å®Œæ•´ç¤ºä¾‹ï¼šç”Ÿäº§çº§ Agent</h2>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ç”Ÿäº§çº§ Agent å®Œæ•´ç¤ºä¾‹
åŠŸèƒ½ï¼šç»„åˆå¤šä¸ªä¸­é—´ä»¶å®ç°å®Œæ•´çš„ç›‘æ§ã€é™åˆ¶å’Œä¿æŠ¤
"""
from langchain.agents import create_agent
from langchain.agents.middleware import (
    SummarizationMiddleware,
    PIIMiddleware,
    ModelCallLimitMiddleware,
    ToolCallLimitMiddleware,
    before_agent,
    after_agent,
    before_model,
    after_model,
)
from langchain.tools import tool
from datetime import datetime

# ==================== è‡ªå®šä¹‰ä¸­é—´ä»¶ ====================

@before_agent
def log_session_start(state, runtime):
    """è®°å½•ä¼šè¯å¼€å§‹"""
    print(f"\n{'='*60}")
    print(f"ğŸš€ ä¼šè¯å¼€å§‹æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"{'='*60}\n")
    return None

@after_agent
def log_session_end(state, runtime):
    """è®°å½•ä¼šè¯ç»“æŸ"""
    message_count = len(state["messages"])
    print(f"\n{'='*60}")
    print(f"âœ… ä¼šè¯ç»“æŸæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ“Š æ€»æ¶ˆæ¯æ•°: {message_count}")
    print(f"{'='*60}\n")
    return None

@before_model
def log_model_call(state, runtime):
    """è®°å½•æ¯æ¬¡æ¨¡å‹è°ƒç”¨"""
    user_msgs = [m for m in state["messages"] if m.__class__.__name__ == "HumanMessage"]
    print(f"ğŸ¤– æ¨¡å‹è°ƒç”¨ #{len(user_msgs)}")
    return None

@after_model
def log_model_response(state, runtime):
    """è®°å½•æ¨¡å‹å“åº”"""
    last_msg = state["messages"][-1]
    usage = getattr(last_msg, "usage_metadata", None)
    if usage:
        print(f"ğŸ“ˆ Token ä½¿ç”¨: {usage.get('total_tokens', 'N/A')}")
    return None

# ==================== å®šä¹‰å·¥å…· ====================

@tool
def search_database(query: str) -> str:
    """æœç´¢æ•°æ®åº“"""
    return f"æœç´¢ç»“æœï¼š{query}"

@tool
def send_notification(message: str) -> str:
    """å‘é€é€šçŸ¥"""
    return f"é€šçŸ¥å·²å‘é€ï¼š{message}"

# ==================== åˆ›å»ºç”Ÿäº§çº§ Agent ====================

production_agent = create_agent(
    model="gpt-4o",
    tools=[search_database, send_notification],
    middleware=[
        # 1. ä¼šè¯ç”Ÿå‘½å‘¨æœŸæ—¥å¿—
        log_session_start,
        log_session_end,

        # 2. æ¨¡å‹è°ƒç”¨æ—¥å¿—
        log_model_call,
        log_model_response,

        # 3. è°ƒç”¨é™åˆ¶ï¼ˆé˜²æ­¢æ— é™å¾ªç¯å’Œè¿‡é«˜æˆæœ¬ï¼‰
        ModelCallLimitMiddleware(
            thread_limit=30,
            run_limit=10,
            exit_behavior="end"
        ),

        # 4. å·¥å…·è°ƒç”¨é™åˆ¶
        ToolCallLimitMiddleware(
            thread_limit=20,
            run_limit=5
        ),

        # 5. éšç§ä¿æŠ¤
        PIIMiddleware("email", strategy="redact", apply_to_input=True),
        PIIMiddleware("credit_card", strategy="mask", apply_to_input=True),

        # 6. å¯¹è¯æ‘˜è¦ï¼ˆé•¿å¯¹è¯ç®¡ç†ï¼‰
        SummarizationMiddleware(
            model="gpt-4o-mini",
            trigger=("tokens", 5000),
            keep=("messages", 15)
        ),
    ],
    system_prompt="""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹ã€‚

èŒè´£ï¼š
1. å›ç­”ç”¨æˆ·é—®é¢˜
2. æœç´¢æ•°æ®åº“æŸ¥æ‰¾ä¿¡æ¯
3. å‘é€é€šçŸ¥

æ³¨æ„äº‹é¡¹ï¼š
- ä¿æŠ¤ç”¨æˆ·éšç§
- ç®€æ´å‡†ç¡®åœ°å›ç­”
- å¿…è¦æ—¶ä½¿ç”¨å·¥å…·"""
)

# ==================== æµ‹è¯• ====================

if __name__ == "__main__":
    result = production_agent.invoke({
        "messages": [
            {"role": "user", "content": "æˆ‘çš„é‚®ç®±æ˜¯ [email protected]ï¼Œå¸®æˆ‘æŸ¥è¯¢è®¢å•çŠ¶æ€"}
        ]
    })

    print("\næœ€ç»ˆå“åº”:")
    print(result["messages"][-1].content)</code></pre>
                    </div>
                </section>

                <!-- æœ€ä½³å®è·µ -->
                <section class="content-section">
                    <h2 class="section-title">âœ¨ æœ€ä½³å®è·µ</h2>

                    <h3 class="subsection-title">1. ä¸­é—´ä»¶èŒè´£å•ä¸€</h3>
                    <p>æ¯ä¸ªä¸­é—´ä»¶åº”è¯¥åªå¤„ç†ä¸€ä¸ªå…³æ³¨ç‚¹ã€‚</p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># âŒ ä¸å¥½ï¼šä¸€ä¸ªä¸­é—´ä»¶åšå¤ªå¤šäº‹
@before_model
def do_everything(state, runtime):
    log_message(state)
    check_limits(state)
    validate_input(state)
    track_metrics(state)
    # ...

# âœ… å¥½ï¼šæ¯ä¸ªä¸­é—´ä»¶èŒè´£å•ä¸€
@before_model
def log_message(state, runtime):
    """ä»…è´Ÿè´£æ—¥å¿—è®°å½•"""
    # ...

@before_model
def check_limits(state, runtime):
    """ä»…è´Ÿè´£é™åˆ¶æ£€æŸ¥"""
    # ...</code></pre>
                    </div>

                    <h3 class="subsection-title">2. åˆç†å®‰æ’ä¸­é—´ä»¶é¡ºåº</h3>
                    <p>å°†å…³é”®ä¸­é—´ä»¶æ”¾åœ¨å‰é¢ã€‚</p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">agent = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        # 1. æœ€ä¼˜å…ˆï¼šå®‰å…¨å’Œé™åˆ¶
        PIIMiddleware(...),
        ModelCallLimitMiddleware(...),

        # 2. å…¶æ¬¡ï¼šé‡è¯•å’Œé™çº§
        ToolRetryMiddleware(...),
        ModelFallbackMiddleware(...),

        # 3. æœ€åï¼šæ—¥å¿—å’Œç›‘æ§
        logging_middleware,
    ]
)</code></pre>
                    </div>

                    <h3 class="subsection-title">3. ä¼˜é›…å¤„ç†é”™è¯¯</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">@before_model
def safe_middleware(state, runtime):
    """å®‰å…¨çš„ä¸­é—´ä»¶ï¼šä¸ä¼šè®© Agent å´©æºƒ"""
    try:
        # æ‰§è¡Œå¯èƒ½å¤±è´¥çš„æ“ä½œ
        risky_operation(state)
    except Exception as e:
        # è®°å½•é”™è¯¯ä½†ä¸ä¸­æ–­æ‰§è¡Œ
        print(f"ä¸­é—´ä»¶é”™è¯¯: {e}")
        # å¯é€‰ï¼šè¿”å›é™çº§è¡Œä¸º
    return None</code></pre>
                    </div>

                    <h3 class="subsection-title">4. é€‰æ‹©åˆé€‚çš„é’©å­ç±»å‹</h3>
                    <ul>
                        <li><strong>èŠ‚ç‚¹é£æ ¼</strong>ï¼šæ—¥å¿—è®°å½•ã€éªŒè¯ã€çŠ¶æ€æ›´æ–°</li>
                        <li><strong>Wrap é£æ ¼</strong>ï¼šé‡è¯•ã€ç¼“å­˜ã€é™çº§ã€æ¡ä»¶æ‰§è¡Œ</li>
                    </ul>

                    <h3 class="subsection-title">5. å……åˆ†æµ‹è¯•ä¸­é—´ä»¶</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">def test_message_limit_middleware():
    """æµ‹è¯•æ¶ˆæ¯é™åˆ¶ä¸­é—´ä»¶"""
    middleware = MessageLimitMiddleware(max_messages=5)

    # åˆ›å»ºæµ‹è¯•çŠ¶æ€
    test_state = {"messages": [Mock() for _ in range(6)]}
    test_runtime = Mock()

    # æµ‹è¯•é™åˆ¶è§¦å‘
    result = middleware.before_model(test_state, test_runtime)

    assert result is not None
    assert "jump_to" in result
    assert result["jump_to"] == "end"</code></pre>
                    </div>
                </section>

                <!-- å¸¸è§é—®é¢˜ -->
                <section class="content-section">
                    <h2 class="section-title">â“ å¸¸è§é—®é¢˜</h2>

                    <h3 class="subsection-subtitle">Q1: ä¸­é—´ä»¶çš„æ€§èƒ½å¼€é”€å¤§å—ï¼Ÿ</h3>
                    <p>
                        ä¸­é—´ä»¶æœ¬èº«çš„å¼€é”€å¾ˆå°ã€‚æ€§èƒ½å½±å“ä¸»è¦æ¥è‡ªä¸­é—´ä»¶å†…éƒ¨çš„é€»è¾‘ã€‚
                        å»ºè®®ï¼š
                    </p>
                    <ul>
                        <li>é¿å…åœ¨ä¸­é—´ä»¶ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ</li>
                        <li>ä½¿ç”¨å¼‚æ­¥æ“ä½œå¤„ç† I/O å¯†é›†ä»»åŠ¡</li>
                        <li>åœ¨ç”Ÿäº§ç¯å¢ƒç¦ç”¨è°ƒè¯•æ—¥å¿—</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q2: ä¸­é—´ä»¶å¯ä»¥ä¿®æ”¹å·¥å…·åˆ—è¡¨å—ï¼Ÿ</h3>
                    <p>
                        å¯ä»¥ï¼ä½¿ç”¨ <code>wrap_model_call</code> é’©å­ï¼š
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">@wrap_model_call
def filter_tools(request, handler):
    # æ ¹æ®æ¡ä»¶ç­›é€‰å·¥å…·
    filtered_tools = [t for t in request.tools if should_include(t)]
    return handler(request.override(tools=filtered_tools))</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q3: å¦‚ä½•åœ¨ä¸­é—´ä»¶ä¹‹é—´å…±äº«æ•°æ®ï¼Ÿ</h3>
                    <p>
                        ä½¿ç”¨è‡ªå®šä¹‰çŠ¶æ€ Schema æˆ– runtime.contextï¼š
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># æ–¹å¼ 1ï¼šè‡ªå®šä¹‰çŠ¶æ€
class SharedState(AgentState):
    shared_data: NotRequired[dict]

@before_model(state_schema=SharedState)
def middleware_1(state, runtime):
    return {"shared_data": {"key": "value"}}

@after_model(state_schema=SharedState)
def middleware_2(state, runtime):
    data = state.get("shared_data", {})
    print(data["key"])  # è®¿é—®å…±äº«æ•°æ®</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q4: ä¸­é—´ä»¶å¯ä»¥é˜»æ­¢æ¨¡å‹è°ƒç”¨å—ï¼Ÿ</h3>
                    <p>
                        å¯ä»¥ï¼Œä½¿ç”¨ <code>jump_to</code> è·³è½¬æˆ–åœ¨ wrap é’©å­ä¸­ä¸è°ƒç”¨ handlerï¼š
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># æ–¹å¼ 1ï¼šä½¿ç”¨ jump_to
@before_model
@hook_config(can_jump_to=["end"])
def block_model(state, runtime):
    if should_block(state):
        return {"jump_to": "end"}

# æ–¹å¼ 2ï¼šwrap é’©å­çŸ­è·¯
@wrap_model_call
def cache_check(request, handler):
    cached = get_from_cache(request)
    if cached:
        return cached  # ä¸è°ƒç”¨ handlerï¼Œç›´æ¥è¿”å›ç¼“å­˜
    return handler(request)</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q5: è£…é¥°å™¨å’Œç±»é£æ ¼å¦‚ä½•é€‰æ‹©ï¼Ÿ</h3>
                    <ul>
                        <li><strong>è£…é¥°å™¨</strong>ï¼šå¿«é€ŸåŸå‹ã€å•ä¸ªé’©å­ã€ç®€å•é€»è¾‘</li>
                        <li><strong>ç±»é£æ ¼</strong>ï¼šå¤šä¸ªé’©å­ã€å¤æ‚é…ç½®ã€éœ€è¦å¤ç”¨</li>
                    </ul>
                </section>

                <!-- å‚è€ƒèµ„æº -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ”— å‚è€ƒèµ„æº</h2>
                    <ul>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/middleware/overview" target="_blank">
                                LangChain å®˜æ–¹ Middleware æ¦‚è¿°
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/middleware/built-in" target="_blank">
                                å†…ç½®ä¸­é—´ä»¶å®Œæ•´åˆ—è¡¨
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/middleware/custom" target="_blank">
                                è‡ªå®šä¹‰ä¸­é—´ä»¶å¼€å‘æŒ‡å—
                            </a>
                        </li>
                        <li>
                            <a href="https://blog.langchain.com/agent-middleware/" target="_blank">
                                Agent Middleware å®˜æ–¹åšå®¢
                            </a>
                        </li>
                    </ul>
                </section>

                <!-- é¡µé¢å¯¼èˆª -->
                                <nav class="page-navigation">
                    <a href="06-agents.html" class="nav-button prev">
                        â† ä¸Šä¸€é¡µï¼šAgent åŸºç¡€
                    </a>
                    <a href="08-rag.html" class="nav-button next">
                        ä¸‹ä¸€é¡µï¼šRAG è¯¦è§£ â†’
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" aria-label="è¿”å›é¡¶éƒ¨">â†‘</button>

    <!-- JavaScript -->
    <script src="assets/js/mermaid-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
