<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LangChain 1.0 æ ¸å¿ƒæ¶æ„ - æ·±å…¥ç†è§£ LangChain çš„è®¾è®¡å“²å­¦å’Œæ¨¡å—ç»„ç»‡">
    <title>æ ¸å¿ƒæ¶æ„ | LangChain 1.0 Python çŸ¥è¯†æ–‡æ¡£</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <button class="mobile-menu-button" aria-label="æ‰“å¼€èœå•">â˜°</button>

    <div class="container">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">ğŸ¦œ LangChain 1.0</h1>
                <p class="sidebar-subtitle">Python å®Œæ•´å­¦ä¹ æŒ‡å—</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-section">
                    <div class="nav-section-title">å¼€å§‹</div>
                    <ul>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <span class="nav-icon">ğŸ </span>
                                ä¸»é¡µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">åŸºç¡€ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="01-introduction.html" class="nav-link">
                                <span class="nav-icon">ğŸ“–</span>
                                LangChain ç®€ä»‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="02-architecture.html" class="nav-link">
                                <span class="nav-icon">ğŸ—ï¸</span>
                                æ ¸å¿ƒæ¶æ„
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="03-models.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤–</span>
                                æ¨¡å‹æ¥å£
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="04-messages.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¬</span>
                                æ¶ˆæ¯ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="05-tools.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                å·¥å…·ç³»ç»Ÿ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">è¿›é˜¶ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="06-agents.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                Agent åŸºç¡€
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="07-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="08-rag.html" class="nav-link">
                                <span class="nav-icon">ğŸ”</span>
                                RAG è¯¦è§£
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="09-lcel.html" class="nav-link">
                                <span class="nav-icon">ğŸ”—</span>
                                LCEL è¡¨è¾¾å¼
                            </a>
                        </li>
                    </ul>
                </li>

                                <li class="nav-section">
                    <div class="nav-section-title">é«˜çº§åº”ç”¨</div>
                    <ul>
                        <li class="nav-item active">
                            <a href="10-runtime.html" class="nav-link">
                                <span class="nav-icon">ğŸ”Œ</span>
                                Runtime ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="11-checkpointer.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¾</span>
                                æŒä¹…åŒ–ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="12-streaming.html" class="nav-link">
                                <span class="nav-icon">ğŸŒŠ</span>
                                æµå¼è¾“å‡º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="13-human-in-loop.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="14-long-term-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ—„ï¸</span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="15-langgraph.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                LangGraph
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="16-context-engineering.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                ä¸Šä¸‹æ–‡å·¥ç¨‹
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="17-mcp.html" class="nav-link">
                                <span class="nav-icon">ğŸ”Œ</span>
                                MCP åè®®
                            </a>
                        </li>
                    </ul>
                </li>


                                <li class="nav-section">
                    <div class="nav-section-title">å®æˆ˜ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="18-customer-service.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å®¢æœæœºå™¨äºº
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="19-best-practices.html" class="nav-link">
                                <span class="nav-icon">âœ¨</span>
                                æœ€ä½³å®è·µ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="38-chat.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¬</span>
                                åœ¨çº¿å¯¹è¯åŠ©æ‰‹
                                <span class="nav-badge">NEW</span>
                            </a>
                        </li>
                    </ul>
                </li>


                                <li class="nav-section">
                    <div class="nav-section-title">å‚è€ƒç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="20-api-reference.html" class="nav-link">
                                <span class="nav-icon">ğŸ“š</span>
                                API é€ŸæŸ¥è¡¨
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="21-troubleshooting.html" class="nav-link">
                                <span class="nav-icon">ğŸ›</span>
                                æ•…éšœæ’é™¤
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="22-migration.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                è¿ç§»æŒ‡å—
                            </a>
                        </li>
                    </ul>
                </li>


                                <li class="nav-section">
                    <div class="nav-section-title">æ‰©å±•ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="23-structured-output.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                ç»“æ„åŒ–è¾“å‡º
                            </a>
                        </li>
                    </ul>
                </li>


                                <li class="nav-section">
                    <div class="nav-section-title">DeepAgents ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="24-deepagents-quickstart.html" class="nav-link">
                                <span class="nav-icon">ğŸš€</span>
                                å¿«é€Ÿå¼€å§‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="25-deepagents-customization.html" class="nav-link">
                                <span class="nav-icon">ğŸ¨</span>
                                å®šåˆ¶åŒ–
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="26-deepagents-harness.html" class="nav-link">
                                <span class="nav-icon">ğŸ›ï¸</span>
                                Harness ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="27-deepagents-backends.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                åç«¯é…ç½®
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="28-deepagents-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="29-deepagents-hitl.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="30-deepagents-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ§ </span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="31-deepagents-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶
                            </a>
                        </li>
                    </ul>
                </li>


                                <li class="nav-section">
                    <div class="nav-section-title">Multi-Agent ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="32-multi-agent-index.html" class="nav-link">
                                <span class="nav-icon">ğŸŒ</span>
                                æ¦‚è¿°
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="33-multi-agent-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="34-multi-agent-handoffs.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                äº¤æ¥æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="35-multi-agent-skills.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="36-multi-agent-router.html" class="nav-link">
                                <span class="nav-icon">ğŸ§­</span>
                                è·¯ç”±æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="37-multi-agent-workflow.html" class="nav-link">
                                <span class="nav-icon">ğŸ”€</span>
                                è‡ªå®šä¹‰å·¥ä½œæµ
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">
                        <a href="index.html" class="breadcrumb-link">ä¸»é¡µ</a>
                    </span>
                    <span class="breadcrumb-item">
                        é«˜çº§åº”ç”¨
                    </span>
                    <span class="breadcrumb-item">
                        Runtime ç³»ç»Ÿ
                    </span>
                </nav>

                <!-- é¡µé¢æ ‡é¢˜ -->
                <header class="page-header">
                    <h1 class="page-title">ğŸ”Œ Runtime ä¾èµ–æ³¨å…¥ç³»ç»Ÿ</h1>
                    <p class="page-subtitle">
                        æŒæ¡ LangChain 1.0 çš„ Runtime ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œ
                        é€šè¿‡ Contextã€Store å’Œ Stream Writer å®ç°çµæ´»çš„ä¸Šä¸‹æ–‡ç®¡ç†ã€
                        æ•°æ®æŒä¹…åŒ–å’Œå®æ—¶åé¦ˆã€‚
                    </p>
                </header>

                <!-- ä»€ä¹ˆæ˜¯ Runtime -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“š ä»€ä¹ˆæ˜¯ Runtimeï¼Ÿ</h2>
                    <p>
                        <strong>Runtime</strong> æ˜¯ LangChain çš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿï¼Œ
                        è¿è¡Œåœ¨ LangGraph åº•å±‚ä¹‹ä¸Šã€‚å®ƒä¸ºå·¥å…·å’Œä¸­é—´ä»¶æä¾›äº†è®¿é—®
                        æ‰§è¡Œä¸Šä¸‹æ–‡çš„èƒ½åŠ›ï¼Œè®©ä½ èƒ½å¤Ÿï¼š
                    </p>
                    <ul>
                        <li><strong>æ³¨å…¥ç”¨æˆ·ä¿¡æ¯</strong>ï¼šæ¯æ¬¡è°ƒç”¨æ—¶ä¼ å…¥ç”¨æˆ· IDã€æƒé™ã€é…ç½®ç­‰</li>
                        <li><strong>è®¿é—®æŒä¹…åŒ–å­˜å‚¨</strong>ï¼šè·¨ä¼šè¯è¯»å†™ç”¨æˆ·æ•°æ®ã€åå¥½è®¾ç½®</li>
                        <li><strong>å®æ—¶åé¦ˆè¿›åº¦</strong>ï¼šåœ¨å·¥å…·æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”¨æˆ·å‘é€æ›´æ–°</li>
                        <li><strong>éš”ç¦»è¯·æ±‚æ•°æ®</strong>ï¼šç¡®ä¿å¤šç”¨æˆ·ç¯å¢ƒä¸‹çš„æ•°æ®å®‰å…¨</li>
                    </ul>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph TB
    A[Agent è°ƒç”¨] --> B[Runtime æ³¨å…¥]

    B --> C[Context<br/>é™æ€ä¸Šä¸‹æ–‡]
    B --> D[Store<br/>æŒä¹…åŒ–å­˜å‚¨]
    B --> E[Stream Writer<br/>å®æ—¶åé¦ˆ]

    C --> F[å·¥å…·å‡½æ•°]
    D --> F
    E --> F

    C --> G[ä¸­é—´ä»¶]
    D --> G
    E --> G

    F --> H[æ‰§è¡Œç»“æœ]
    G --> H

    style A fill:#6366f1,color:#fff
    style B fill:#10b981,color:#fff
    style C fill:#f59e0b,color:#fff
    style D fill:#8b5cf6,color:#fff
    style E fill:#ec4899,color:#fff
    style F fill:#3b82f6,color:#fff
                        </div>
                    </div>

                    <div class="info-box note">
                        <div class="info-box-title">ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿</div>
                        <ul>
                            <li><strong>å¯æµ‹è¯•æ€§</strong>ï¼šè½»æ¾æ³¨å…¥ mock ä¾èµ–è¿›è¡Œå•å…ƒæµ‹è¯•</li>
                            <li><strong>å¯å¤ç”¨æ€§</strong>ï¼šå·¥å…·ä¿æŒé€šç”¨ï¼Œé…ç½®å¤–éƒ¨åŒ–</li>
                            <li><strong>çµæ´»æ€§</strong>ï¼šæ¯æ¬¡è°ƒç”¨å¯å®šåˆ¶è¡Œä¸ºï¼Œæ— éœ€å…¨å±€çŠ¶æ€</li>
                            <li><strong>å®‰å…¨æ€§</strong>ï¼šéš”ç¦»ç”¨æˆ·æ•°æ®å’Œå‡­è¯ï¼Œé¿å…æ³„éœ²</li>
                        </ul>
                    </div>
                </section>

                <!-- Runtime ä¸‰å¤§ç»„ä»¶ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ§© Runtime ä¸‰å¤§ç»„ä»¶</h2>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph LR
    A[Runtime] --> B[Context<br/>ä¸Šä¸‹æ–‡]
    A --> C[Store<br/>å­˜å‚¨]
    A --> D[Stream Writer<br/>æµå†™å…¥å™¨]

    B --> E[ç”¨æˆ· ID<br/>æƒé™<br/>é…ç½®]
    C --> F[ç”¨æˆ·åå¥½<br/>å†å²æ•°æ®<br/>çŸ¥è¯†åº“]
    D --> G[è¿›åº¦æ›´æ–°<br/>ä¸­é—´ç»“æœ<br/>è‡ªå®šä¹‰äº‹ä»¶]

    style A fill:#6366f1,color:#fff
    style B fill:#10b981,color:#fff
    style C fill:#f59e0b,color:#fff
    style D fill:#8b5cf6,color:#fff
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>ç»„ä»¶</th>
                                <th>ç±»å‹</th>
                                <th>ä½œç”¨</th>
                                <th>å…¸å‹ç”¨é€”</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>runtime.context</code></td>
                                <td>è‡ªå®šä¹‰ dataclass</td>
                                <td>é™æ€ä¸Šä¸‹æ–‡ä¿¡æ¯</td>
                                <td>ç”¨æˆ· IDã€æ•°æ®åº“è¿æ¥ã€é…ç½®å‚æ•°</td>
                            </tr>
                            <tr>
                                <td><code>runtime.store</code></td>
                                <td>BaseStore å®ä¾‹</td>
                                <td>æŒä¹…åŒ–å­˜å‚¨</td>
                                <td>ç”¨æˆ·åå¥½ã€å†å²è®°å½•ã€é•¿æœŸæ•°æ®</td>
                            </tr>
                            <tr>
                                <td><code>runtime.stream_writer</code></td>
                                <td>å¯è°ƒç”¨å¯¹è±¡</td>
                                <td>å®æ—¶æµå¼è¾“å‡º</td>
                                <td>è¿›åº¦é€šçŸ¥ã€ä¸­é—´ç»“æœã€è‡ªå®šä¹‰äº‹ä»¶</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- Context ä¸Šä¸‹æ–‡æ³¨å…¥ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ¯ Context ä¸Šä¸‹æ–‡æ³¨å…¥</h2>
                    <p>
                        <strong>Context</strong> ç”¨äºä¼ é€’æ¯æ¬¡è°ƒç”¨çš„é™æ€ä¿¡æ¯ï¼Œ
                        å¦‚ç”¨æˆ· IDã€æƒé™çº§åˆ«ã€è¯­è¨€åå¥½ç­‰ã€‚
                    </p>

                    <h3 class="subsection-title">å®šä¹‰å’Œä½¿ç”¨ Context</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Context åŸºç¡€ç¤ºä¾‹
åŠŸèƒ½ï¼šé€šè¿‡ Context æ³¨å…¥ç”¨æˆ·ä¿¡æ¯
"""
from dataclasses import dataclass
from langchain.agents import create_agent
from langchain.chat_models import init_chat_model
from langchain.tools import tool, ToolRuntime

# æ­¥éª¤ 1ï¼šå®šä¹‰ Context Schema
@dataclass
class UserContext:
    """ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯"""
    user_id: str
    user_name: str
    role: str  # 'user', 'admin', 'vip'

# æ­¥éª¤ 2ï¼šåˆ›å»ºä½¿ç”¨ Context çš„å·¥å…·
@tool
def greet_user(runtime: ToolRuntime[UserContext]) -> str:
    """å‘ç”¨æˆ·é—®å€™ã€‚

    Returns:
        ä¸ªæ€§åŒ–é—®å€™è¯­
    """
    # ä» runtime.context è·å–ç”¨æˆ·ä¿¡æ¯
    user_name = runtime.context.user_name
    role = runtime.context.role

    if role == "vip":
        return f"å°Šæ•¬çš„ VIP ç”¨æˆ· {user_name}ï¼Œæ¬¢è¿å›æ¥ï¼"
    elif role == "admin":
        return f"ç®¡ç†å‘˜ {user_name}ï¼Œæ‚¨å¥½ï¼"
    else:
        return f"ä½ å¥½ï¼Œ{user_name}ï¼"

# æ­¥éª¤ 3ï¼šåˆ›å»º Agentï¼ˆæŒ‡å®š context_schemaï¼‰
model = init_chat_model("gpt-4o")
agent = create_agent(
    model,
    tools=[greet_user],
    context_schema=UserContext,  # å£°æ˜ Context ç±»å‹
    system_prompt="ä½ æ˜¯å‹å¥½çš„åŠ©æ‰‹ã€‚"
)

# æ­¥éª¤ 4ï¼šè°ƒç”¨æ—¶æ³¨å…¥ Context
result = agent.invoke(
    {"messages": [{"role": "user", "content": "å‘æˆ‘é—®å€™"}]},
    context=UserContext(
        user_id="user_123",
        user_name="å¼ ä¸‰",
        role="vip"
    )
)

print(result["messages"][-1].content)
# è¾“å‡ºï¼šå°Šæ•¬çš„ VIP ç”¨æˆ· å¼ ä¸‰ï¼Œæ¬¢è¿å›æ¥ï¼</code></pre>
                    </div>

                    <h3 class="subsection-title">Context è®¿é—®æƒé™æ§åˆ¶</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
åŸºäº Context çš„æƒé™æ§åˆ¶ç¤ºä¾‹
åŠŸèƒ½ï¼šæ ¹æ®ç”¨æˆ·è§’è‰²é™åˆ¶å·¥å…·è®¿é—®
"""
from dataclasses import dataclass
from langchain.tools import tool, ToolRuntime
from langchain.agents import create_agent
from langchain.chat_models import init_chat_model

@dataclass
class UserContext:
    user_id: str
    role: str  # 'user', 'moderator', 'admin'

@tool
def delete_user(user_id_to_delete: str, runtime: ToolRuntime[UserContext]) -> str:
    """åˆ é™¤ç”¨æˆ·ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰ã€‚

    Args:
        user_id_to_delete: è¦åˆ é™¤çš„ç”¨æˆ· ID

    Returns:
        æ“ä½œç»“æœ
    """
    # æƒé™æ£€æŸ¥
    current_role = runtime.context.role

    if current_role != "admin":
        return "âŒ æƒé™ä¸è¶³ï¼šæ­¤æ“ä½œä»…é™ç®¡ç†å‘˜æ‰§è¡Œã€‚"

    # æ‰§è¡Œåˆ é™¤ï¼ˆæ¨¡æ‹Ÿï¼‰
    return f"âœ… ç”¨æˆ· {user_id_to_delete} å·²è¢«åˆ é™¤ã€‚"

@tool
def view_user_info(user_id: str, runtime: ToolRuntime[UserContext]) -> str:
    """æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ moderator æˆ– admin æƒé™ï¼‰ã€‚

    Args:
        user_id: ç”¨æˆ· ID

    Returns:
        ç”¨æˆ·ä¿¡æ¯
    """
    current_role = runtime.context.role

    if current_role not in ["moderator", "admin"]:
        return "âŒ æƒé™ä¸è¶³ï¼šæ­¤æ“ä½œéœ€è¦ moderator æˆ–æ›´é«˜æƒé™ã€‚"

    # è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¨¡æ‹Ÿï¼‰
    return f"ç”¨æˆ· {user_id}ï¼šå§“å å¼ ä¸‰ï¼Œé‚®ç®± [email protected]"

@tool
def get_my_info(runtime: ToolRuntime[UserContext]) -> str:
    """æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯ç”¨ï¼‰ã€‚

    Returns:
        å½“å‰ç”¨æˆ·ä¿¡æ¯
    """
    user_id = runtime.context.user_id
    return f"æ‚¨çš„ç”¨æˆ· ID: {user_id}"

# åˆ›å»º Agent
model = init_chat_model("gpt-4o")
agent = create_agent(
    model,
    tools=[delete_user, view_user_info, get_my_info],
    context_schema=UserContext,
    system_prompt="ä½ æ˜¯ç³»ç»Ÿç®¡ç†åŠ©æ‰‹ã€‚"
)

# åœºæ™¯ 1ï¼šæ™®é€šç”¨æˆ·å°è¯•åˆ é™¤
print("=== æ™®é€šç”¨æˆ·å°è¯•åˆ é™¤ ===")
result1 = agent.invoke(
    {"messages": [{"role": "user", "content": "åˆ é™¤ç”¨æˆ· user_456"}]},
    context=UserContext(user_id="user_123", role="user")
)
print(result1["messages"][-1].content)

# åœºæ™¯ 2ï¼šç®¡ç†å‘˜åˆ é™¤ç”¨æˆ·
print("\n=== ç®¡ç†å‘˜åˆ é™¤ç”¨æˆ· ===")
result2 = agent.invoke(
    {"messages": [{"role": "user", "content": "åˆ é™¤ç”¨æˆ· user_456"}]},
    context=UserContext(user_id="admin_001", role="admin")
)
print(result2["messages"][-1].content)</code></pre>
                    </div>

                    <h3 class="subsection-title">åŠ¨æ€é…ç½®ç¤ºä¾‹</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Context åŠ¨æ€é…ç½®ç¤ºä¾‹
åŠŸèƒ½ï¼šæ ¹æ® Context åŠ¨æ€è°ƒæ•´å·¥å…·è¡Œä¸º
"""
from dataclasses import dataclass
from langchain.tools import tool, ToolRuntime

@dataclass
class UserContext:
    language: str  # 'zh-CN', 'en-US', 'ja-JP'
    timezone: str  # 'Asia/Shanghai', 'America/New_York'

@tool
def get_current_time(runtime: ToolRuntime[UserContext]) -> str:
    """è·å–å½“å‰æ—¶é—´ï¼ˆæ ¹æ®ç”¨æˆ·æ—¶åŒºï¼‰ã€‚

    Returns:
        å½“å‰æ—¶é—´
    """
    from datetime import datetime
    import pytz

    # ä» Context è·å–æ—¶åŒº
    timezone = runtime.context.timezone
    language = runtime.context.language

    # è®¡ç®—å½“å‰æ—¶é—´
    tz = pytz.timezone(timezone)
    now = datetime.now(tz)

    # æ ¹æ®è¯­è¨€è¿”å›æ ¼å¼
    if language == "zh-CN":
        return f"å½“å‰æ—¶é—´ï¼š{now.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}"
    elif language == "en-US":
        return f"Current time: {now.strftime('%Y-%m-%d %H:%M:%S')}"
    elif language == "ja-JP":
        return f"ç¾åœ¨ã®æ™‚åˆ»ï¼š{now.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}"
    else:
        return now.strftime('%Y-%m-%d %H:%M:%S')</code></pre>
                    </div>
                </section>

                <!-- Store æŒä¹…åŒ–å­˜å‚¨ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ’¾ Store æŒä¹…åŒ–å­˜å‚¨</h2>
                    <p>
                        <strong>Store</strong> æä¾›è·¨è°ƒç”¨çš„æŒä¹…åŒ–å­˜å‚¨èƒ½åŠ›ï¼Œ
                        ç”¨äºä¿å­˜å’Œæ£€ç´¢é•¿æœŸæ•°æ®ã€‚
                    </p>

                    <h3 class="subsection-title">Store åŸºç¡€ç”¨æ³•</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Store åŸºç¡€ç¤ºä¾‹
åŠŸèƒ½ï¼šåœ¨ Store ä¸­ä¿å­˜å’Œæ£€ç´¢ç”¨æˆ·åå¥½
"""
from dataclasses import dataclass
from langchain.tools import tool, ToolRuntime
from langchain.agents import create_agent
from langchain.chat_models import init_chat_model
from langgraph.store.memory import InMemoryStore

@dataclass
class UserContext:
    user_id: str

@tool
def save_preference(
    preference_key: str,
    preference_value: str,
    runtime: ToolRuntime[UserContext]
) -> str:
    """ä¿å­˜ç”¨æˆ·åå¥½è®¾ç½®ã€‚

    Args:
        preference_key: åå¥½åç§°ï¼ˆå¦‚ 'theme', 'language'ï¼‰
        preference_value: åå¥½å€¼

    Returns:
        ä¿å­˜ç»“æœ
    """
    # æ£€æŸ¥ store æ˜¯å¦å¯ç”¨
    if not runtime.store:
        return "é”™è¯¯ï¼šStore æœªé…ç½®"

    user_id = runtime.context.user_id

    # ä¿å­˜åˆ° Store
    # namespace: ("user_preferences", user_id)
    # key: preference_key
    # value: å®é™…æ•°æ®
    runtime.store.put(
        namespace=("user_preferences", user_id),
        key=preference_key,
        value={"value": preference_value}
    )

    return f"âœ… å·²ä¿å­˜åå¥½ï¼š{preference_key} = {preference_value}"

@tool
def get_preference(
    preference_key: str,
    runtime: ToolRuntime[UserContext]
) -> str:
    """è·å–ç”¨æˆ·åå¥½è®¾ç½®ã€‚

    Args:
        preference_key: åå¥½åç§°

    Returns:
        åå¥½å€¼
    """
    if not runtime.store:
        return "é”™è¯¯ï¼šStore æœªé…ç½®"

    user_id = runtime.context.user_id

    # ä» Store æ£€ç´¢
    item = runtime.store.get(
        namespace=("user_preferences", user_id),
        key=preference_key
    )

    if item:
        return f"{preference_key}: {item.value['value']}"
    else:
        return f"æœªè®¾ç½® {preference_key}"

# åˆ›å»º Store å’Œ Agent
store = InMemoryStore()
model = init_chat_model("gpt-4o")

agent = create_agent(
    model,
    tools=[save_preference, get_preference],
    store=store,  # æ³¨å…¥ Store
    context_schema=UserContext,
    system_prompt="ä½ æ˜¯åå¥½è®¾ç½®åŠ©æ‰‹ã€‚"
)

# æµ‹è¯•ï¼šä¿å­˜åå¥½
result1 = agent.invoke(
    {"messages": [{"role": "user", "content": "è®¾ç½®æˆ‘çš„ä¸»é¢˜ä¸ºæ·±è‰²æ¨¡å¼"}]},
    context=UserContext(user_id="user_123")
)
print(result1["messages"][-1].content)

# æµ‹è¯•ï¼šæ£€ç´¢åå¥½
result2 = agent.invoke(
    {"messages": [{"role": "user", "content": "æˆ‘çš„ä¸»é¢˜è®¾ç½®æ˜¯ä»€ä¹ˆï¼Ÿ"}]},
    context=UserContext(user_id="user_123")
)
print(result2["messages"][-1].content)</code></pre>
                    </div>

                    <h3 class="subsection-title">Store æœç´¢å’Œæ‰¹é‡æ“ä½œ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Store é«˜çº§æ“ä½œç¤ºä¾‹
åŠŸèƒ½ï¼šæœç´¢ã€æ‰¹é‡è¯»å–ç”¨æˆ·æ•°æ®
"""
from langchain.tools import tool, ToolRuntime
from dataclasses import dataclass

@dataclass
class UserContext:
    user_id: str

@tool
def list_all_preferences(runtime: ToolRuntime[UserContext]) -> str:
    """åˆ—å‡ºç”¨æˆ·çš„æ‰€æœ‰åå¥½è®¾ç½®ã€‚

    Returns:
        æ‰€æœ‰åå¥½çš„åˆ—è¡¨
    """
    if not runtime.store:
        return "é”™è¯¯ï¼šStore æœªé…ç½®"

    user_id = runtime.context.user_id

    # æœç´¢å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰é¡¹
    items = runtime.store.search(
        namespace_prefix=("user_preferences", user_id)
    )

    if not items:
        return "æ‚¨è¿˜æ²¡æœ‰ä»»ä½•åå¥½è®¾ç½®ã€‚"

    result = "æ‚¨çš„åå¥½è®¾ç½®ï¼š\n"
    for item in items:
        key = item.key
        value = item.value["value"]
        result += f"- {key}: {value}\n"

    return result

@tool
def delete_preference(
    preference_key: str,
    runtime: ToolRuntime[UserContext]
) -> str:
    """åˆ é™¤åå¥½è®¾ç½®ã€‚

    Args:
        preference_key: è¦åˆ é™¤çš„åå¥½åç§°

    Returns:
        åˆ é™¤ç»“æœ
    """
    if not runtime.store:
        return "é”™è¯¯ï¼šStore æœªé…ç½®"

    user_id = runtime.context.user_id

    # åˆ é™¤æŒ‡å®šé¡¹
    runtime.store.delete(
        namespace=("user_preferences", user_id),
        key=preference_key
    )

    return f"âœ… å·²åˆ é™¤åå¥½ï¼š{preference_key}"

@tool
def save_user_profile(
    name: str,
    email: str,
    runtime: ToolRuntime[UserContext]
) -> str:
    """ä¿å­˜ç”¨æˆ·èµ„æ–™ã€‚

    Args:
        name: ç”¨æˆ·å§“å
        email: ç”¨æˆ·é‚®ç®±

    Returns:
        ä¿å­˜ç»“æœ
    """
    if not runtime.store:
        return "é”™è¯¯ï¼šStore æœªé…ç½®"

    user_id = runtime.context.user_id

    # ä¿å­˜å®Œæ•´çš„ç”¨æˆ·èµ„æ–™
    runtime.store.put(
        namespace=("user_profiles",),
        key=user_id,
        value={
            "name": name,
            "email": email,
            "user_id": user_id
        }
    )

    return f"âœ… å·²ä¿å­˜ç”¨æˆ·èµ„æ–™ï¼š{name} ({email})"</code></pre>
                    </div>
                </section>

                <!-- Stream Writer å®æ—¶åé¦ˆ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“¡ Stream Writer å®æ—¶åé¦ˆ</h2>
                    <p>
                        <strong>Stream Writer</strong> å…è®¸å·¥å…·åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­
                        å‘ç”¨æˆ·å‘é€å®æ—¶è¿›åº¦æ›´æ–°å’Œä¸­é—´ç»“æœã€‚
                    </p>

                    <h3 class="subsection-title">åŸºç¡€è¿›åº¦åé¦ˆ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Stream Writer åŸºç¡€ç¤ºä¾‹
åŠŸèƒ½ï¼šåœ¨å·¥å…·æ‰§è¡Œè¿‡ç¨‹ä¸­å‘é€è¿›åº¦æ›´æ–°
"""
from langchain.tools import tool, ToolRuntime
from langchain.agents import create_agent
from langchain.chat_models import init_chat_model
import time

@tool
def analyze_document(document_id: str, runtime: ToolRuntime) -> str:
    """åˆ†ææ–‡æ¡£ï¼ˆè€—æ—¶æ“ä½œï¼Œå¸¦è¿›åº¦åé¦ˆï¼‰ã€‚

    Args:
        document_id: æ–‡æ¡£ ID

    Returns:
        åˆ†æç»“æœ
    """
    # è·å– stream writer
    writer = runtime.stream_writer

    # æ­¥éª¤ 1ï¼šåŠ è½½æ–‡æ¡£
    writer(f"æ­£åœ¨åŠ è½½æ–‡æ¡£ {document_id}...")
    time.sleep(1)  # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ

    # æ­¥éª¤ 2ï¼šåˆ†æå†…å®¹
    writer(f"æ­£åœ¨åˆ†ææ–‡æ¡£å†…å®¹...")
    time.sleep(1.5)

    # æ­¥éª¤ 3ï¼šç”Ÿæˆæ‘˜è¦
    writer(f"æ­£åœ¨ç”Ÿæˆæ‘˜è¦...")
    time.sleep(1)

    # æ­¥éª¤ 4ï¼šå®Œæˆ
    writer(f"åˆ†æå®Œæˆï¼")

    return f"æ–‡æ¡£ {document_id} åˆ†æç»“æœï¼šè¿™æ˜¯ä¸€ä»½å…³äº AI çš„æŠ€æœ¯æ–‡æ¡£ã€‚"

# åˆ›å»º Agent
model = init_chat_model("gpt-4o")
agent = create_agent(
    model,
    tools=[analyze_document],
    system_prompt="ä½ æ˜¯æ–‡æ¡£åˆ†æåŠ©æ‰‹ã€‚"
)

# ä½¿ç”¨ stream_mode="custom" æ¥æ”¶è¿›åº¦æ›´æ–°
print("å¼€å§‹åˆ†æ...\n")

for event in agent.stream(
    {"messages": [{"role": "user", "content": "åˆ†ææ–‡æ¡£ DOC-123"}]},
    stream_mode="custom"
):
    # event æ˜¯ stream writer å‘é€çš„å­—ç¬¦ä¸²
    print(f"ğŸ“¢ {event}")

print("\nåˆ†æå®Œæˆï¼")</code></pre>
                    </div>

                    <h3 class="subsection-title">ç»„åˆå¤šç§æµå¼æ¨¡å¼</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ç»„åˆæµå¼æ¨¡å¼ç¤ºä¾‹
åŠŸèƒ½ï¼šåŒæ—¶æ¥æ”¶æ¶ˆæ¯å’Œè‡ªå®šä¹‰è¿›åº¦
"""
from langchain.tools import tool, ToolRuntime
from langchain.agents import create_agent
from langchain.chat_models import init_chat_model
import time

@tool
def process_data(data_size: int, runtime: ToolRuntime) -> str:
    """å¤„ç†æ•°æ®ï¼ˆå¸¦è¯¦ç»†è¿›åº¦ï¼‰ã€‚

    Args:
        data_size: æ•°æ®å¤§å°ï¼ˆMBï¼‰

    Returns:
        å¤„ç†ç»“æœ
    """
    writer = runtime.stream_writer

    total_steps = 5
    for step in range(1, total_steps + 1):
        progress = (step / total_steps) * 100
        writer(f"å¤„ç†è¿›åº¦ï¼š{progress:.0f}% ({step}/{total_steps})")
        time.sleep(0.5)

    return f"æˆåŠŸå¤„ç† {data_size}MB æ•°æ®"

model = init_chat_model("gpt-4o")
agent = create_agent(
    model,
    tools=[process_data],
)

# åŒæ—¶æ¥æ”¶æ¶ˆæ¯å’Œè‡ªå®šä¹‰äº‹ä»¶
for event in agent.stream(
    {"messages": [{"role": "user", "content": "å¤„ç† 100MB æ•°æ®"}]},
    stream_mode=["messages", "custom"]
):
    event_type, event_data = event

    if event_type == "custom":
        print(f"ğŸ”§ è¿›åº¦: {event_data}")
    elif event_type == "messages":
        if "messages" in event_data:
            for msg in event_data["messages"]:
                if hasattr(msg, "content") and msg.content:
                    print(f"ğŸ’¬ æ¶ˆæ¯: {msg.content}")</code></pre>
                    </div>
                </section>

                <!-- ä¸­é—´ä»¶ä¸­ä½¿ç”¨ Runtime -->
                <section class="content-section">
                    <h2 class="section-title">âš™ï¸ ä¸­é—´ä»¶ä¸­ä½¿ç”¨ Runtime</h2>
                    <p>
                        ä¸­é—´ä»¶ä¹Ÿå¯ä»¥è®¿é—® Runtimeï¼Œå®ç°åŸºäºä¸Šä¸‹æ–‡çš„åŠ¨æ€è¡Œä¸ºã€‚
                    </p>

                    <h3 class="subsection-title">åŠ¨æ€ç³»ç»Ÿæç¤ºè¯</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
åŠ¨æ€ç³»ç»Ÿæç¤ºè¯ç¤ºä¾‹
åŠŸèƒ½ï¼šæ ¹æ®ç”¨æˆ·ä¿¡æ¯åŠ¨æ€ç”Ÿæˆç³»ç»Ÿæç¤º
"""
from dataclasses import dataclass
from langchain.agents import create_agent
from langchain.chat_models import init_chat_model
from langchain.agents.middleware import dynamic_prompt, ModelRequest

@dataclass
class UserContext:
    user_name: str
    role: str

@dynamic_prompt
def personalized_system_prompt(request: ModelRequest) -> str:
    """æ ¹æ®ç”¨æˆ·ä¿¡æ¯ç”Ÿæˆä¸ªæ€§åŒ–æç¤ºè¯ã€‚"""
    # ä» request.runtime.context è·å–ç”¨æˆ·ä¿¡æ¯
    user_name = request.runtime.context.user_name
    role = request.runtime.context.role

    base_prompt = f"ä½ æ˜¯åŠ©æ‰‹ Claudeã€‚å½“å‰ç”¨æˆ·æ˜¯ {user_name}ã€‚"

    if role == "admin":
        return base_prompt + "\nç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œå¯ä»¥æä¾›ç³»ç»Ÿç®¡ç†å»ºè®®ã€‚"
    elif role == "vip":
        return base_prompt + "\nç”¨æˆ·æ˜¯ VIPï¼Œæä¾›ä¼˜è´¨æœåŠ¡ã€‚"
    else:
        return base_prompt + "\næä¾›æ ‡å‡†æœåŠ¡ã€‚"

# åˆ›å»º Agent
model = init_chat_model("gpt-4o")
agent = create_agent(
    model,
    tools=[],
    middleware=[personalized_system_prompt],
    context_schema=UserContext
)

# æµ‹è¯•ä¸åŒç”¨æˆ·
result1 = agent.invoke(
    {"messages": [{"role": "user", "content": "ä½ å¥½"}]},
    context=UserContext(user_name="å¼ ä¸‰", role="vip")
)
print(result1["messages"][-1].content)</code></pre>
                    </div>

                    <h3 class="subsection-title">before_model å’Œ after_model ä¸­è®¿é—® Runtime</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ä¸­é—´ä»¶ Runtime è®¿é—®ç¤ºä¾‹
åŠŸèƒ½ï¼šåœ¨ä¸­é—´ä»¶ä¸­è®°å½•ç”¨æˆ·æ“ä½œæ—¥å¿—
"""
from dataclasses import dataclass
from langchain.agents import create_agent, AgentState
from langchain.chat_models import init_chat_model
from langchain.agents.middleware import before_model, after_model
from langchain.agents.runtime import Runtime

@dataclass
class UserContext:
    user_id: str
    user_name: str

@before_model
def log_before_model(state: AgentState, runtime: Runtime[UserContext]) -> dict | None:
    """æ¨¡å‹è°ƒç”¨å‰è®°å½•æ—¥å¿—ã€‚"""
    user_id = runtime.context.user_id
    user_name = runtime.context.user_name

    message_count = len(state["messages"])

    print(f"ğŸ“ [æ—¥å¿—] ç”¨æˆ· {user_name} ({user_id}) å‘èµ·è¯·æ±‚ï¼Œæ¶ˆæ¯æ•°: {message_count}")

    return None  # ä¸ä¿®æ”¹çŠ¶æ€

@after_model
def log_after_model(state: AgentState, runtime: Runtime[UserContext]) -> dict | None:
    """æ¨¡å‹å“åº”åè®°å½•æ—¥å¿—ã€‚"""
    user_id = runtime.context.user_id

    last_msg = state["messages"][-1]
    usage = getattr(last_msg, "usage_metadata", None)

    if usage:
        print(f"ğŸ“Š [æ—¥å¿—] ç”¨æˆ· {user_id} çš„è¯·æ±‚æ¶ˆè€— {usage.get('total_tokens', 0)} tokens")

    return None

# åˆ›å»º Agent
model = init_chat_model("gpt-4o")
agent = create_agent(
    model,
    tools=[],
    middleware=[log_before_model, log_after_model],
    context_schema=UserContext,
    system_prompt="ä½ æ˜¯åŠ©æ‰‹ã€‚"
)

# æµ‹è¯•
result = agent.invoke(
    {"messages": [{"role": "user", "content": "ä½ å¥½"}]},
    context=UserContext(user_id="user_123", user_name="å¼ ä¸‰")
)</code></pre>
                    </div>
                </section>

                <!-- å®Œæ•´ç¤ºä¾‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ¯ å®Œæ•´ç¤ºä¾‹ï¼šç”¨æˆ·ç®¡ç†ç³»ç»Ÿ</h2>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
å®Œæ•´çš„ Runtime ä½¿ç”¨ç¤ºä¾‹
åŠŸèƒ½ï¼šæ•´åˆ Contextã€Storeã€Stream Writer çš„ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
"""
from dataclasses import dataclass
from langchain.agents import create_agent
from langchain.chat_models import init_chat_model
from langchain.tools import tool, ToolRuntime
from langgraph.store.memory import InMemoryStore
import time

# ==================== å®šä¹‰ Context ====================

@dataclass
class UserContext:
    """ç”¨æˆ·ä¸Šä¸‹æ–‡"""
    user_id: str
    user_name: str
    role: str  # 'user', 'admin'

# ==================== å®šä¹‰å·¥å…· ====================

@tool
def get_my_info(runtime: ToolRuntime[UserContext]) -> str:
    """è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ã€‚"""
    ctx = runtime.context
    return f"ç”¨æˆ· ID: {ctx.user_id}\nå§“å: {ctx.user_name}\nè§’è‰²: {ctx.role}"

@tool
def save_note(note: str, runtime: ToolRuntime[UserContext]) -> str:
    """ä¿å­˜ç¬”è®°åˆ°ç”¨æˆ·çš„é•¿æœŸå­˜å‚¨ã€‚

    Args:
        note: ç¬”è®°å†…å®¹
    """
    if not runtime.store:
        return "é”™è¯¯ï¼šStore æœªé…ç½®"

    writer = runtime.stream_writer
    user_id = runtime.context.user_id

    # è¿›åº¦åé¦ˆ
    writer("æ­£åœ¨ä¿å­˜ç¬”è®°...")
    time.sleep(0.5)

    # ç”Ÿæˆç¬”è®° ID
    import uuid
    note_id = str(uuid.uuid4())

    # ä¿å­˜åˆ° Store
    runtime.store.put(
        namespace=("user_notes", user_id),
        key=note_id,
        value={"content": note, "note_id": note_id}
    )

    writer("ä¿å­˜å®Œæˆï¼")

    return f"âœ… ç¬”è®°å·²ä¿å­˜ï¼ˆID: {note_id[:8]}...ï¼‰"

@tool
def list_my_notes(runtime: ToolRuntime[UserContext]) -> str:
    """åˆ—å‡ºå½“å‰ç”¨æˆ·çš„æ‰€æœ‰ç¬”è®°ã€‚"""
    if not runtime.store:
        return "é”™è¯¯ï¼šStore æœªé…ç½®"

    writer = runtime.stream_writer
    user_id = runtime.context.user_id

    writer("æ­£åœ¨æ£€ç´¢ç¬”è®°...")
    time.sleep(0.3)

    # æœç´¢ç”¨æˆ·çš„ç¬”è®°
    notes = runtime.store.search(
        namespace_prefix=("user_notes", user_id)
    )

    if not notes:
        return "æ‚¨è¿˜æ²¡æœ‰ä¿å­˜ä»»ä½•ç¬”è®°ã€‚"

    result = f"æ‚¨çš„ç¬”è®°åˆ—è¡¨ï¼ˆå…± {len(notes)} æ¡ï¼‰ï¼š\n\n"
    for i, item in enumerate(notes, 1):
        content = item.value["content"]
        result += f"{i}. {content[:50]}...\n"

    return result

@tool
def admin_view_all_users(runtime: ToolRuntime[UserContext]) -> str:
    """æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰ã€‚"""
    if runtime.context.role != "admin":
        return "âŒ æƒé™ä¸è¶³ï¼šæ­¤åŠŸèƒ½ä»…é™ç®¡ç†å‘˜ä½¿ç”¨ã€‚"

    writer = runtime.stream_writer
    writer("æ­£åœ¨æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·...")
    time.sleep(0.5)

    # æ¨¡æ‹ŸæŸ¥è¯¢
    users = [
        {"id": "user_001", "name": "å¼ ä¸‰"},
        {"id": "user_002", "name": "æå››"},
    ]

    result = "ç³»ç»Ÿç”¨æˆ·åˆ—è¡¨ï¼š\n"
    for user in users:
        result += f"- {user['name']} (ID: {user['id']})\n"

    return result

# ==================== åˆ›å»º Agent ====================

store = InMemoryStore()
model = init_chat_model("gpt-4o")

agent = create_agent(
    model,
    tools=[get_my_info, save_note, list_my_notes, admin_view_all_users],
    store=store,
    context_schema=UserContext,
    system_prompt="""ä½ æ˜¯ç”¨æˆ·ç®¡ç†åŠ©æ‰‹ã€‚

ä½ çš„èŒè´£ï¼š
1. å¸®åŠ©ç”¨æˆ·ç®¡ç†ç¬”è®°
2. æä¾›ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢
3. ä¸ºç®¡ç†å‘˜æä¾›ç³»ç»Ÿç®¡ç†åŠŸèƒ½

ä½¿ç”¨å·¥å…·ï¼š
- get_my_info: æŸ¥çœ‹å½“å‰ç”¨æˆ·ä¿¡æ¯
- save_note: ä¿å­˜ç¬”è®°
- list_my_notes: åˆ—å‡ºç”¨æˆ·çš„ç¬”è®°
- admin_view_all_users: æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
"""
)

# ==================== æµ‹è¯•åœºæ™¯ ====================

if __name__ == "__main__":
    # åœºæ™¯ 1ï¼šæ™®é€šç”¨æˆ·ä¿å­˜ç¬”è®°
    print("=" * 60)
    print("åœºæ™¯ 1ï¼šæ™®é€šç”¨æˆ·æ“ä½œ")
    print("=" * 60)

    result1 = agent.invoke(
        {"messages": [{"role": "user", "content": "ä¿å­˜ä¸€æ¡ç¬”è®°ï¼šæ˜å¤©å¼€ä¼š"}]},
        context=UserContext(user_id="user_001", user_name="å¼ ä¸‰", role="user")
    )
    print(result1["messages"][-1].content)

    # åœºæ™¯ 2ï¼šæ™®é€šç”¨æˆ·å°è¯•æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
    print("\n" + "=" * 60)
    print("åœºæ™¯ 2ï¼šæ™®é€šç”¨æˆ·å°è¯•ç®¡ç†å‘˜æ“ä½œ")
    print("=" * 60)

    result2 = agent.invoke(
        {"messages": [{"role": "user", "content": "æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·"}]},
        context=UserContext(user_id="user_001", user_name="å¼ ä¸‰", role="user")
    )
    print(result2["messages"][-1].content)

    # åœºæ™¯ 3ï¼šç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
    print("\n" + "=" * 60)
    print("åœºæ™¯ 3ï¼šç®¡ç†å‘˜æ“ä½œ")
    print("=" * 60)

    result3 = agent.invoke(
        {"messages": [{"role": "user", "content": "æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·"}]},
        context=UserContext(user_id="admin_001", user_name="ç®¡ç†å‘˜", role="admin")
    )
    print(result3["messages"][-1].content)</code></pre>
                    </div>
                </section>

                <!-- æœ€ä½³å®è·µ -->
                <section class="content-section">
                    <h2 class="section-title">âœ¨ æœ€ä½³å®è·µ</h2>

                    <h3 class="subsection-title">1. Context Schema ä½¿ç”¨ dataclass</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># âœ… æ¨èï¼šä½¿ç”¨ dataclass
from dataclasses import dataclass

@dataclass
class UserContext:
    user_id: str
    user_name: str

# âŒ é¿å…ï¼šä½¿ç”¨æ™®é€šå­—å…¸
context = {"user_id": "123", "user_name": "å¼ ä¸‰"}</code></pre>
                    </div>

                    <h3 class="subsection-title">2. æ£€æŸ¥ Store æ˜¯å¦å¯ç”¨</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># âœ… å¥½çš„åšæ³•
@tool
def my_tool(runtime: ToolRuntime) -> str:
    if not runtime.store:
        return "Store æœªé…ç½®"

    # ä½¿ç”¨ store
    runtime.store.put(...)

# âŒ ä¸æ£€æŸ¥ä¼šå¯¼è‡´ AttributeError
@tool
def bad_tool(runtime: ToolRuntime) -> str:
    runtime.store.put(...)  # å¯èƒ½æŠ¥é”™</code></pre>
                    </div>

                    <h3 class="subsection-title">3. ç±»å‹æ³¨è§£æå‡å¼€å‘ä½“éªŒ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># âœ… ä½¿ç”¨ç±»å‹æ³¨è§£ï¼ŒIDE å¯ä»¥è‡ªåŠ¨è¡¥å…¨
from langchain.tools import tool, ToolRuntime

@dataclass
class UserContext:
    user_id: str

@tool
def my_tool(runtime: ToolRuntime[UserContext]) -> str:
    # IDE ä¼šæç¤º user_id å±æ€§
    user_id = runtime.context.user_id
    return user_id</code></pre>
                    </div>

                    <h3 class="subsection-title">4. Context ç”¨äºåªè¯»æ•°æ®ï¼ŒStore ç”¨äºå¯å˜çŠ¶æ€</h3>
                    <ul>
                        <li><strong>Context</strong>ï¼šç”¨æˆ· IDã€æƒé™ã€é…ç½®ï¼ˆé™æ€ã€åªè¯»ï¼‰</li>
                        <li><strong>Store</strong>ï¼šç”¨æˆ·åå¥½ã€å†å²æ•°æ®ï¼ˆå¯å˜ã€æŒä¹…åŒ–ï¼‰</li>
                    </ul>

                    <h3 class="subsection-title">5. Stream Writer ç”¨äºé•¿æ—¶é—´æ“ä½œ</h3>
                    <p>
                        ä»…åœ¨å·¥å…·æ‰§è¡Œæ—¶é—´è¶…è¿‡ 2 ç§’æ—¶ä½¿ç”¨ Stream Writerï¼Œ
                        é¿å…è¿‡åº¦ä½¿ç”¨é€ æˆä¿¡æ¯å™ªéŸ³ã€‚
                    </p>
                </section>

                <!-- å¸¸è§é—®é¢˜ -->
                <section class="content-section">
                    <h2 class="section-title">â“ å¸¸è§é—®é¢˜</h2>

                    <h3 class="subsection-subtitle">Q1: Runtime åœ¨å“ªé‡Œå¯ç”¨ï¼Ÿ</h3>
                    <p>
                        Runtime ä»…åœ¨ä»¥ä¸‹åœºæ™¯å¯ç”¨ï¼š
                    </p>
                    <ul>
                        <li>å·¥å…·å‡½æ•°ï¼ˆé€šè¿‡ <code>ToolRuntime</code> å‚æ•°ï¼‰</li>
                        <li>ä¸­é—´ä»¶ï¼ˆé€šè¿‡ <code>runtime</code> å‚æ•°æˆ– <code>request.runtime</code>ï¼‰</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q2: Context å’Œ Store æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3>
                    <p>
                        <strong>Context</strong>ï¼šæ¯æ¬¡è°ƒç”¨æ—¶æ³¨å…¥çš„é™æ€ä¿¡æ¯ï¼Œä¸ä¼šè‡ªåŠ¨æŒä¹…åŒ–<br>
                        <strong>Store</strong>ï¼šæŒä¹…åŒ–å­˜å‚¨ï¼Œæ•°æ®ä¼šè·¨è°ƒç”¨ä¿ç•™
                    </p>

                    <h3 class="subsection-subtitle">Q3: Stream Writer ä½•æ—¶å‘é€äº‹ä»¶ï¼Ÿ</h3>
                    <p>
                        éœ€è¦ä½¿ç”¨ <code>stream_mode="custom"</code> æˆ–ç»„åˆæ¨¡å¼æ‰èƒ½æ¥æ”¶
                        Stream Writer å‘é€çš„äº‹ä»¶ã€‚
                    </p>

                    <h3 class="subsection-subtitle">Q4: å¦‚ä½•åœ¨å•å…ƒæµ‹è¯•ä¸­ mock Runtimeï¼Ÿ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">from unittest.mock import Mock
from langchain.tools import ToolRuntime

# åˆ›å»º mock runtime
mock_runtime = Mock(spec=ToolRuntime)
mock_runtime.context = UserContext(user_id="test_user", user_name="æµ‹è¯•")
mock_runtime.store = None
mock_runtime.stream_writer = Mock()

# æµ‹è¯•å·¥å…·
result = my_tool.invoke({"runtime": mock_runtime})</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q5: Store æ”¯æŒå“ªäº›åç«¯ï¼Ÿ</h3>
                    <p>
                        ç›®å‰æ”¯æŒï¼š
                    </p>
                    <ul>
                        <li><code>InMemoryStore</code>ï¼šå†…å­˜å­˜å‚¨ï¼ˆå¼€å‘æµ‹è¯•ï¼‰</li>
                        <li>åç»­ç‰ˆæœ¬å°†æ”¯æŒ PostgreSQLã€Redis ç­‰æŒä¹…åŒ–åç«¯</li>
                    </ul>
                </section>

                <!-- å‚è€ƒèµ„æº -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ”— å‚è€ƒèµ„æº</h2>
                    <ul>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/runtime" target="_blank">
                                LangChain Runtime å®˜æ–¹æ–‡æ¡£
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/tools" target="_blank">
                                Tools å·¥å…·ç³»ç»Ÿæ–‡æ¡£
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/middleware/overview" target="_blank">
                                Middleware ä¸­é—´ä»¶æ–‡æ¡£
                            </a>
                        </li>
                    </ul>
                </section>

                <!-- é¡µé¢å¯¼èˆª -->
                                <nav class="page-navigation">
                    <a href="09-lcel.html" class="nav-button prev">
                        â† ä¸Šä¸€é¡µ:LCEL è¡¨è¾¾å¼
                    </a>
                    <a href="11-checkpointer.html" class="nav-button next">
                        ä¸‹ä¸€é¡µ:æŒä¹…åŒ–ç³»ç»Ÿ â†’
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" aria-label="è¿”å›é¡¶éƒ¨">â†‘</button>

    <!-- JavaScript -->
    <script src="assets/js/mermaid-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
