<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LangChain 1.0 æ ¸å¿ƒæ¶æ„ - æ·±å…¥ç†è§£ LangChain çš„è®¾è®¡å“²å­¦å’Œæ¨¡å—ç»„ç»‡">
    <title>æ ¸å¿ƒæ¶æ„ | LangChain 1.0 Python çŸ¥è¯†æ–‡æ¡£</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <button class="mobile-menu-button" aria-label="æ‰“å¼€èœå•">â˜°</button>

    <div class="container">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">ğŸ¦œ LangChain 1.0</h1>
                <p class="sidebar-subtitle">Python å®Œæ•´å­¦ä¹ æŒ‡å—</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-section">
                    <div class="nav-section-title">å¼€å§‹</div>
                    <ul>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <span class="nav-icon">ğŸ </span>
                                ä¸»é¡µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">åŸºç¡€ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="01-introduction.html" class="nav-link">
                                <span class="nav-icon">ğŸ“–</span>
                                LangChain ç®€ä»‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="02-architecture.html" class="nav-link">
                                <span class="nav-icon">ğŸ—ï¸</span>
                                æ ¸å¿ƒæ¶æ„
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="03-models.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤–</span>
                                æ¨¡å‹æ¥å£
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="04-messages.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¬</span>
                                æ¶ˆæ¯ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="05-tools.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                å·¥å…·ç³»ç»Ÿ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">è¿›é˜¶ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="06-agents.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                Agent åŸºç¡€
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="07-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="08-rag.html" class="nav-link">
                                <span class="nav-icon">ğŸ”</span>
                                RAG è¯¦è§£
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="09-lcel.html" class="nav-link">
                                <span class="nav-icon">ğŸ”—</span>
                                LCEL è¡¨è¾¾å¼
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">é«˜çº§åº”ç”¨</div>
                    <ul>
                        <li class="nav-item">
                            <a href="10-runtime.html" class="nav-link">
                                <span class="nav-icon">ğŸ”Œ</span>
                                Runtime ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="11-checkpointer.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¾</span>
                                æŒä¹…åŒ–ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="12-streaming.html" class="nav-link">
                                <span class="nav-icon">ğŸŒŠ</span>
                                æµå¼è¾“å‡º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="13-human-in-loop.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="14-long-term-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ—„ï¸</span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="15-langgraph.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                LangGraph
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å®æˆ˜ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="16-customer-service.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å®¢æœæœºå™¨äºº
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="17-best-practices.html" class="nav-link">
                                <span class="nav-icon">âœ¨</span>
                                æœ€ä½³å®è·µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å‚è€ƒç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="18-api-reference.html" class="nav-link">
                                <span class="nav-icon">ğŸ“š</span>
                                API é€ŸæŸ¥è¡¨
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="19-troubleshooting.html" class="nav-link">
                                <span class="nav-icon">ğŸ›</span>
                                æ•…éšœæ’é™¤
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="20-migration.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                è¿ç§»æŒ‡å—
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">æ‰©å±•ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="21-structured-output.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                ç»“æ„åŒ–è¾“å‡º
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">DeepAgents ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="22-deepagents-quickstart.html" class="nav-link">
                                <span class="nav-icon">ğŸš€</span>
                                å¿«é€Ÿå¼€å§‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="23-deepagents-customization.html" class="nav-link">
                                <span class="nav-icon">ğŸ¨</span>
                                å®šåˆ¶åŒ–
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="24-deepagents-harness.html" class="nav-link">
                                <span class="nav-icon">ğŸ›ï¸</span>
                                Harness ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="25-deepagents-backends.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                åç«¯é…ç½®
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="26-deepagents-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="27-deepagents-hitl.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="28-deepagents-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ§ </span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="29-deepagents-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">Multi-Agent ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="30-multi-agent-index.html" class="nav-link">
                                <span class="nav-icon">ğŸŒ</span>
                                æ¦‚è¿°
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="31-multi-agent-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="32-multi-agent-handoffs.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                äº¤æ¥æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="33-multi-agent-skills.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="34-multi-agent-router.html" class="nav-link">
                                <span class="nav-icon">ğŸ§­</span>
                                è·¯ç”±æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="35-multi-agent-workflow.html" class="nav-link">
                                <span class="nav-icon">ğŸ”€</span>
                                è‡ªå®šä¹‰å·¥ä½œæµ
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">
                        <a href="index.html" class="breadcrumb-link">ä¸»é¡µ</a>
                    </span>
                    <span class="breadcrumb-item">
                        é«˜çº§åº”ç”¨
                    </span>
                    <span class="breadcrumb-item">
                        äººå·¥ä»‹å…¥
                    </span>
                </nav>

                <!-- é¡µé¢æ ‡é¢˜ -->
                <header class="page-header">
                    <h1 class="page-title">ğŸ‘¤ Human-in-the-Loopï¼ˆäººå·¥ä»‹å…¥ï¼‰</h1>
                    <p class="page-subtitle">
                        æŒæ¡ LangChain 1.0 çš„ Human-in-the-Loop æœºåˆ¶ï¼Œå®ç°æ•æ„Ÿæ“ä½œçš„äººå·¥å®¡æ ¸ï¼Œ
                        æ„å»ºå®‰å…¨å¯æ§çš„ AI Agent ç³»ç»Ÿã€‚
                    </p>
                </header>

                <!-- HITL ç®€ä»‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“š ä»€ä¹ˆæ˜¯ Human-in-the-Loopï¼Ÿ</h2>
                    <p>
                        <strong>Human-in-the-Loop (HITL)</strong> æ˜¯ä¸€ç§è®© AI Agent åœ¨æ‰§è¡Œå…³é”®æ“ä½œå‰
                        <strong>æš‚åœå¹¶ç­‰å¾…äººå·¥å†³ç­–</strong>çš„æœºåˆ¶ã€‚è¿™ç¡®ä¿äº†æ•æ„Ÿæ“ä½œï¼ˆå¦‚åˆ é™¤æ•°æ®ã€å‘é€é‚®ä»¶ã€æ‰§è¡Œæ”¯ä»˜ï¼‰
                        å¿…é¡»ç»è¿‡äººå·¥å®¡æ ¸æ‰èƒ½æ‰§è¡Œã€‚
                    </p>

                    <div class="info-box note">
                        <div class="info-box-title">ğŸ’¡ æ ¸å¿ƒä»·å€¼</div>
                        <ul>
                            <li><strong>å®‰å…¨æ€§</strong>ï¼šé˜²æ­¢ AI æ‰§è¡Œä¸å¯é€†çš„å±é™©æ“ä½œ</li>
                            <li><strong>å¯æ§æ€§</strong>ï¼šäººç±»ä¿ç•™æœ€ç»ˆå†³ç­–æƒ</li>
                            <li><strong>åˆè§„æ€§</strong>ï¼šæ»¡è¶³æŸäº›ä¸šåŠ¡éœ€è¦äººå·¥å®¡æ‰¹çš„è¦æ±‚</li>
                            <li><strong>çµæ´»æ€§</strong>ï¼šå¯ä»¥ä¿®æ”¹ AI æè®®çš„å‚æ•°å†æ‰§è¡Œ</li>
                        </ul>
                    </div>

                    <h3 class="subsection-title">å…¸å‹åº”ç”¨åœºæ™¯</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>åœºæ™¯</th>
                                <th>éœ€è¦å®¡æ ¸çš„æ“ä½œ</th>
                                <th>é£é™©</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>æ•°æ®ç®¡ç†</td>
                                <td>åˆ é™¤æ–‡ä»¶ã€æ¸…ç©ºæ•°æ®åº“</td>
                                <td>æ•°æ®ä¸¢å¤±ä¸å¯æ¢å¤</td>
                            </tr>
                            <tr>
                                <td>è´¢åŠ¡ç³»ç»Ÿ</td>
                                <td>å‘èµ·æ”¯ä»˜ã€è½¬è´¦</td>
                                <td>èµ„é‡‘æŸå¤±</td>
                            </tr>
                            <tr>
                                <td>é€šä¿¡ç³»ç»Ÿ</td>
                                <td>å‘é€é‚®ä»¶ã€çŸ­ä¿¡ã€å…¬å‘Š</td>
                                <td>é”™è¯¯ä¿¡æ¯ä¼ æ’­</td>
                            </tr>
                            <tr>
                                <td>åŸºç¡€è®¾æ–½</td>
                                <td>é‡å¯æœåŠ¡å™¨ã€ä¿®æ”¹é…ç½®</td>
                                <td>æœåŠ¡ä¸­æ–­</td>
                            </tr>
                            <tr>
                                <td>ä»£ç ä»“åº“</td>
                                <td>åˆå¹¶ä»£ç ã€å‘å¸ƒç‰ˆæœ¬</td>
                                <td>ç”Ÿäº§ç¯å¢ƒæ•…éšœ</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- HITL æ¶æ„ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ—ï¸ Human-in-the-Loop æ¶æ„</h2>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph TB
    A[ç”¨æˆ·è¯·æ±‚] --> B[Agent æ¨ç†]
    B --> C[ç”Ÿæˆå·¥å…·è°ƒç”¨]
    C --> D{éœ€è¦äººå·¥å®¡æ ¸ï¼Ÿ}

    D -->|å¦| E[ç›´æ¥æ‰§è¡Œå·¥å…·]
    E --> F[è¿”å›ç»“æœ]

    D -->|æ˜¯| G[æš‚åœæ‰§è¡Œ]
    G --> H[åˆ›å»º interrupt]
    H --> I[ç­‰å¾…äººå·¥å†³ç­–]

    I --> J{å†³ç­–ç±»å‹ï¼Ÿ}

    J -->|âœ… Approve| K[æ‰§è¡ŒåŸå§‹å·¥å…·è°ƒç”¨]
    J -->|âœï¸ Edit| L[ä¿®æ”¹å‚æ•°åæ‰§è¡Œ]
    J -->|âŒ Reject| M[ç”Ÿæˆæ‹’ç»æ¶ˆæ¯]

    K --> N[ç»§ç»­ Agent æ‰§è¡Œ]
    L --> N
    M --> N

    N --> F

    style D fill:#f59e0b,color:#fff
    style G fill:#ef4444,color:#fff
    style I fill:#3b82f6,color:#fff
    style K fill:#10b981,color:#fff
    style L fill:#8b5cf6,color:#fff
    style M fill:#ef4444,color:#fff
                        </div>
                    </div>

                    <h3 class="subsection-title">ä¸‰ç§å†³ç­–ç±»å‹</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>å†³ç­–ç±»å‹</th>
                                <th>ç¬¦å·</th>
                                <th>è¯´æ˜</th>
                                <th>ä½¿ç”¨åœºæ™¯</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Approve</strong></td>
                                <td>âœ…</td>
                                <td>æ‰¹å‡†æ‰§è¡Œï¼Œä¸ä¿®æ”¹å‚æ•°</td>
                                <td>æ“ä½œæ­£ç¡®ï¼Œç›´æ¥æ‰§è¡Œ</td>
                            </tr>
                            <tr>
                                <td><strong>Edit</strong></td>
                                <td>âœï¸</td>
                                <td>ä¿®æ”¹å‚æ•°åæ‰§è¡Œ</td>
                                <td>æ“ä½œæ–¹å‘æ­£ç¡®ï¼Œä½†å‚æ•°éœ€è°ƒæ•´</td>
                            </tr>
                            <tr>
                                <td><strong>Reject</strong></td>
                                <td>âŒ</td>
                                <td>æ‹’ç»æ‰§è¡Œï¼Œå¹¶æä¾›åé¦ˆ</td>
                                <td>æ“ä½œä¸å®‰å…¨æˆ–ä¸åˆç†</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- åŸºç¡€é…ç½® -->
                <section class="content-section">
                    <h2 class="section-title">âš™ï¸ HumanInTheLoopMiddleware é…ç½®</h2>
                    <p>
                        ä½¿ç”¨ <code>HumanInTheLoopMiddleware</code> ä¸º Agent æ·»åŠ äººå·¥å®¡æ ¸èƒ½åŠ›ã€‚
                    </p>

                    <div class="info-box warning">
                        <div class="info-box-title">âš ï¸ å¿…éœ€æ¡ä»¶</div>
                        <p>
                            <strong>å¿…é¡»é…ç½® Checkpointer</strong>ï¼Human-in-the-Loop ä¾èµ–æŒä¹…åŒ–çŠ¶æ€ï¼Œ
                            æ‰èƒ½åœ¨æš‚åœåæ¢å¤æ‰§è¡Œã€‚ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨ <code>PostgresSaver</code>ã€‚
                        </p>
                    </div>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
HumanInTheLoopMiddleware åŸºç¡€é…ç½®
åŠŸèƒ½ï¼šä¸ºæ•æ„Ÿå·¥å…·æ·»åŠ äººå·¥å®¡æ ¸
"""
from langchain.agents import create_agent
from langchain.agents.middleware import HumanInTheLoopMiddleware
from langgraph.checkpoint.memory import InMemorySaver
from langchain.tools import tool

@tool
def write_file(filename: str, content: str) -> str:
    """å†™å…¥æ–‡ä»¶ï¼ˆæ•æ„Ÿæ“ä½œï¼‰"""
    with open(filename, "w") as f:
        f.write(content)
    return f"æ–‡ä»¶ {filename} å†™å…¥æˆåŠŸ"

@tool
def read_file(filename: str) -> str:
    """è¯»å–æ–‡ä»¶ï¼ˆå®‰å…¨æ“ä½œï¼‰"""
    with open(filename, "r") as f:
        return f.read()

@tool
def delete_file(filename: str) -> str:
    """åˆ é™¤æ–‡ä»¶ï¼ˆå±é™©æ“ä½œï¼‰"""
    import os
    os.remove(filename)
    return f"æ–‡ä»¶ {filename} å·²åˆ é™¤"

# åˆ›å»ºå¸¦ HITL çš„ Agent
agent = create_agent(
    model="gpt-4o",
    tools=[write_file, read_file, delete_file],
    middleware=[
        HumanInTheLoopMiddleware(
            interrupt_on={
                "write_file": True,      # å†™æ–‡ä»¶éœ€è¦å®¡æ ¸
                "delete_file": True,     # åˆ é™¤æ–‡ä»¶éœ€è¦å®¡æ ¸
                "read_file": False,      # è¯»æ–‡ä»¶æ— éœ€å®¡æ ¸
            },
            description_prefix="å·¥å…·æ‰§è¡Œç­‰å¾…å®¡æ‰¹"
        )
    ],
    checkpointer=InMemorySaver(),  # å¿…éœ€ï¼
)

# é…ç½® thread_idï¼ˆç”¨äºæŒä¹…åŒ–ï¼‰
config = {"configurable": {"thread_id": "user_001"}}</code></pre>
                    </div>

                    <h3 class="subsection-title">é…ç½®å‚æ•°è¯¦è§£</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>å‚æ•°</th>
                                <th>ç±»å‹</th>
                                <th>è¯´æ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>interrupt_on</code></td>
                                <td>dict</td>
                                <td>æŒ‡å®šå“ªäº›å·¥å…·éœ€è¦å®¡æ ¸ï¼ˆTrue/False/é…ç½®å¯¹è±¡ï¼‰</td>
                            </tr>
                            <tr>
                                <td><code>allowed_decisions</code></td>
                                <td>list</td>
                                <td>å…è®¸çš„å†³ç­–ç±»å‹ï¼ˆé»˜è®¤å…¨éƒ¨å…è®¸ï¼‰</td>
                            </tr>
                            <tr>
                                <td><code>description</code></td>
                                <td>str/callable</td>
                                <td>å®¡æ‰¹è¯·æ±‚çš„æè¿°æ–‡æœ¬</td>
                            </tr>
                            <tr>
                                <td><code>description_prefix</code></td>
                                <td>str</td>
                                <td>æè¿°æ–‡æœ¬çš„é»˜è®¤å‰ç¼€</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- æ‰§è¡Œå·¥ä½œæµ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ”„ å®Œæ•´æ‰§è¡Œå·¥ä½œæµ</h2>

                    <h3 class="subsection-title">æ­¥éª¤ 1ï¼šè¿è¡Œç›´åˆ°ä¸­æ–­</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ­¥éª¤ 1ï¼šè¿è¡Œ Agent ç›´åˆ°é‡åˆ°éœ€è¦å®¡æ ¸çš„æ“ä½œ
"""
from langgraph.types import Command

config = {"configurable": {"thread_id": "user_001"}}

# è°ƒç”¨ Agent
result = agent.invoke(
    {
        "messages": [
            {"role": "user", "content": "åˆ é™¤ old_data.txt æ–‡ä»¶"}
        ]
    },
    config=config
)

# æ£€æŸ¥æ˜¯å¦æœ‰ä¸­æ–­
if "__interrupt__" in result:
    print("â¸ï¸ Agent å·²æš‚åœï¼Œç­‰å¾…äººå·¥å†³ç­–")
    interrupt_info = result["__interrupt__"]

    # æŸ¥çœ‹ä¸­æ–­è¯¦æƒ…
    action_requests = interrupt_info[0]["value"]["action_requests"]
    for req in action_requests:
        print(f"\nå·¥å…·: {req['name']}")
        print(f"å‚æ•°: {req['args']}")
        print(f"æè¿°: {req.get('description', 'æ— ')}")
else:
    # æ— éœ€å®¡æ ¸ï¼Œç›´æ¥æ‰§è¡Œå®Œæˆ
    print("âœ… æ‰§è¡Œå®Œæˆï¼ˆæ— éœ€å®¡æ ¸ï¼‰")
    print(result["messages"][-1].content)</code></pre>
                    </div>

                    <h3 class="subsection-title">æ­¥éª¤ 2ï¼šåšå‡ºå†³ç­–å¹¶æ¢å¤</h3>

                    <h4 class="subsection-subtitle">å†³ç­– 1ï¼šæ‰¹å‡†æ‰§è¡Œ</h4>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ‰¹å‡†æ‰§è¡Œï¼šåŒæ„ Agent çš„æè®®
"""
from langgraph.types import Command

# æ¢å¤æ‰§è¡Œå¹¶æ‰¹å‡†
result = agent.invoke(
    Command(
        resume={
            "decisions": [
                {"type": "approve"}  # âœ… æ‰¹å‡†æ‰§è¡Œ
            ]
        }
    ),
    config=config  # ä½¿ç”¨ç›¸åŒçš„ thread_id
)

print("âœ… æ“ä½œå·²æ‰§è¡Œ")
print(result["messages"][-1].content)</code></pre>
                    </div>

                    <h4 class="subsection-subtitle">å†³ç­– 2ï¼šä¿®æ”¹å‚æ•°åæ‰§è¡Œ</h4>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ç¼–è¾‘æ‰§è¡Œï¼šä¿®æ”¹å‚æ•°åå†æ‰§è¡Œ
"""
from langgraph.types import Command

# å‡è®¾ Agent æƒ³åˆ é™¤ important_file.txt
# æˆ‘ä»¬ä¿®æ”¹ä¸ºåˆ é™¤ backup_file.txt

result = agent.invoke(
    Command(
        resume={
            "decisions": [
                {
                    "type": "edit",  # âœï¸ ç¼–è¾‘æ¨¡å¼
                    "edited_action": {
                        "name": "delete_file",  # å·¥å…·åç§°ï¼ˆå¯é€‰ä¿®æ”¹ï¼‰
                        "args": {
                            "filename": "backup_file.txt"  # ä¿®æ”¹å‚æ•°
                        }
                    }
                }
            ]
        }
    ),
    config=config
)

print("âœï¸ æ“ä½œå·²ä¿®æ”¹å¹¶æ‰§è¡Œ")
print(result["messages"][-1].content)</code></pre>
                    </div>

                    <div class="info-box warning">
                        <div class="info-box-title">âš ï¸ Edit å†³ç­–æ³¨æ„äº‹é¡¹</div>
                        <p>
                            ä¿®æ”¹å‚æ•°æ—¶åº”<strong>ä¿å®ˆ</strong>ã€‚å¤§å¹…ä¿®æ”¹å¯èƒ½å¯¼è‡´æ¨¡å‹é‡æ–°è¯„ä¼°ç­–ç•¥ï¼Œ
                            å¯èƒ½å¤šæ¬¡æ‰§è¡Œå·¥å…·æˆ–äº§ç”Ÿæ„å¤–è¡Œä¸ºã€‚å»ºè®®ï¼š
                        </p>
                        <ul>
                            <li>åªä¿®æ”¹å¿…è¦çš„å‚æ•°å€¼</li>
                            <li>ä¸è¦æ›´æ”¹å·¥å…·çš„æ ¸å¿ƒé€»è¾‘</li>
                            <li>ä¿®æ”¹åçš„å‚æ•°åº”ç¬¦åˆåŸå§‹æ„å›¾</li>
                        </ul>
                    </div>

                    <h4 class="subsection-subtitle">å†³ç­– 3ï¼šæ‹’ç»å¹¶æä¾›åé¦ˆ</h4>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ‹’ç»æ‰§è¡Œï¼šä¸åŒæ„æ“ä½œå¹¶æä¾›åé¦ˆ
"""
from langgraph.types import Command

result = agent.invoke(
    Command(
        resume={
            "decisions": [
                {
                    "type": "reject",  # âŒ æ‹’ç»
                    "message": "ä¸èƒ½åˆ é™¤è¯¥æ–‡ä»¶ï¼Œå› ä¸ºå®ƒåŒ…å«é‡è¦æ•°æ®ã€‚è¯·å…ˆå¤‡ä»½åå†æ“ä½œã€‚"
                }
            ]
        }
    ),
    config=config
)

# æ‹’ç»æ¶ˆæ¯ä¼šè¢«åŠ å…¥å¯¹è¯å†å²
# Agent ä¼šæ ¹æ®åé¦ˆé‡æ–°æ€è€ƒ
print("âŒ æ“ä½œå·²æ‹’ç»")
print(result["messages"][-1].content)</code></pre>
                    </div>
                </section>

                <!-- å¤šä¸ªå·¥å…·å®¡æ‰¹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ”¢ å¤„ç†å¤šä¸ªå·¥å…·å®¡æ‰¹</h2>
                    <p>
                        å½“ Agent åŒæ—¶è°ƒç”¨å¤šä¸ªéœ€è¦å®¡æ ¸çš„å·¥å…·æ—¶ï¼Œéœ€è¦ä¸ºæ¯ä¸ªå·¥å…·æä¾›å†³ç­–ã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
å¤šå·¥å…·å®¡æ‰¹ç¤ºä¾‹
åŠŸèƒ½ï¼šåŒæ—¶å¤„ç†å¤šä¸ªå·¥å…·è°ƒç”¨çš„å®¡æ‰¹
"""
from langchain.agents import create_agent
from langchain.agents.middleware import HumanInTheLoopMiddleware
from langgraph.checkpoint.memory import InMemorySaver
from langchain.tools import tool
from langgraph.types import Command

@tool
def send_email(to: str, subject: str, body: str) -> str:
    """å‘é€é‚®ä»¶"""
    return f"é‚®ä»¶å·²å‘é€åˆ° {to}"

@tool
def delete_records(table: str, condition: str) -> str:
    """åˆ é™¤æ•°æ®åº“è®°å½•"""
    return f"å·²ä» {table} åˆ é™¤ç¬¦åˆ {condition} çš„è®°å½•"

@tool
def create_backup(source: str) -> str:
    """åˆ›å»ºå¤‡ä»½"""
    return f"å·²å¤‡ä»½ {source}"

agent = create_agent(
    model="gpt-4o",
    tools=[send_email, delete_records, create_backup],
    middleware=[
        HumanInTheLoopMiddleware(
            interrupt_on={
                "send_email": True,
                "delete_records": True,
                "create_backup": True,
            }
        )
    ],
    checkpointer=InMemorySaver(),
)

config = {"configurable": {"thread_id": "multi_approval"}}

# Agent å¯èƒ½åŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·
result = agent.invoke(
    {
        "messages": [
            {"role": "user", "content": "å¤‡ä»½æ•°æ®åº“ï¼Œåˆ é™¤æ—§è®°å½•ï¼Œå¹¶å‘é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜"}
        ]
    },
    config=config
)

if "__interrupt__" in result:
    action_requests = result["__interrupt__"][0]["value"]["action_requests"]

    print(f"éœ€è¦å®¡æ‰¹ {len(action_requests)} ä¸ªæ“ä½œï¼š\n")
    for i, req in enumerate(action_requests):
        print(f"{i+1}. {req['name']}: {req['args']}")

    # ä¸ºæ¯ä¸ªå·¥å…·æä¾›å†³ç­–ï¼ˆé¡ºåºå¿…é¡»åŒ¹é…ï¼‰
    result = agent.invoke(
        Command(
            resume={
                "decisions": [
                    {"type": "approve"},  # æ‰¹å‡†ç¬¬1ä¸ªå·¥å…·
                    {
                        "type": "edit",    # ä¿®æ”¹ç¬¬2ä¸ªå·¥å…·
                        "edited_action": {
                            "name": "delete_records",
                            "args": {
                                "table": "logs",
                                "condition": "created_at < '2024-01-01'"  # ä¿®æ”¹æ¡ä»¶
                            }
                        }
                    },
                    {
                        "type": "reject",  # æ‹’ç»ç¬¬3ä¸ªå·¥å…·
                        "message": "è¯·å…ˆç¡®è®¤å¤‡ä»½æˆåŠŸåå†å‘é€é‚®ä»¶"
                    }
                ]
            }
        ),
        config=config
    )

print("\nå†³ç­–å·²æäº¤ï¼ŒAgent ç»§ç»­æ‰§è¡Œ")</code></pre>
                    </div>

                    <div class="info-box tip">
                        <div class="info-box-title">âœ… å¤šå·¥å…·å†³ç­–é¡ºåº</div>
                        <p>
                            å†³ç­–åˆ—è¡¨çš„é¡ºåºå¿…é¡»ä¸ <code>action_requests</code> çš„é¡ºåºä¸€è‡´ã€‚
                            ç¬¬ 1 ä¸ªå†³ç­–å¯¹åº”ç¬¬ 1 ä¸ªå·¥å…·è°ƒç”¨ï¼Œç¬¬ 2 ä¸ªå†³ç­–å¯¹åº”ç¬¬ 2 ä¸ªå·¥å…·è°ƒç”¨ï¼Œä»¥æ­¤ç±»æ¨ã€‚
                        </p>
                    </div>
                </section>

                <!-- æµå¼è¾“å‡ºä¸ HITL -->
                <section class="content-section">
                    <h2 class="section-title">ğŸŒŠ æµå¼è¾“å‡ºä¸ Human-in-the-Loop</h2>
                    <p>
                        ç»“åˆæµå¼è¾“å‡ºï¼Œå¯ä»¥å®æ—¶ç›‘æ§ Agent æ‰§è¡Œè¿‡ç¨‹ï¼Œå¹¶åœ¨ä¸­æ–­æ—¶è·å¾—é€šçŸ¥ã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æµå¼è¾“å‡º + HITL ç¤ºä¾‹
åŠŸèƒ½ï¼šå®æ—¶æ˜¾ç¤ºæ‰§è¡Œè¿‡ç¨‹ï¼Œé‡åˆ°ä¸­æ–­æ—¶æš‚åœ
"""
from langchain.agents import create_agent
from langchain.agents.middleware import HumanInTheLoopMiddleware
from langgraph.checkpoint.memory import InMemorySaver
from langchain.tools import tool
from langgraph.types import Command

@tool
def execute_sql(query: str) -> str:
    """æ‰§è¡Œ SQL æŸ¥è¯¢"""
    return f"SQL æ‰§è¡ŒæˆåŠŸï¼š{query}"

agent = create_agent(
    model="gpt-4o",
    tools=[execute_sql],
    middleware=[
        HumanInTheLoopMiddleware(
            interrupt_on={"execute_sql": True}
        )
    ],
    checkpointer=InMemorySaver(),
)

config = {"configurable": {"thread_id": "streaming_hitl"}}

print("å¼€å§‹æ‰§è¡Œ...\n")

# ä½¿ç”¨æµå¼æ¨¡å¼
interrupted = False

for mode, chunk in agent.stream(
    {
        "messages": [
            {"role": "user", "content": "åˆ é™¤ users è¡¨ä¸­æ‰€æœ‰æœªæ¿€æ´»çš„ç”¨æˆ·"}
        ]
    },
    config=config,
    stream_mode=["updates", "messages"]
):
    if mode == "messages":
        # æ˜¾ç¤º Token æµ
        token, metadata = chunk
        if token:
            print(token, end="", flush=True)

    elif mode == "updates":
        # æ£€æŸ¥æ˜¯å¦æœ‰ä¸­æ–­
        for step, data in chunk.items():
            if "__interrupt__" in data:
                interrupted = True
                print("\n\nâ¸ï¸ æ£€æµ‹åˆ°éœ€è¦å®¡æ‰¹çš„æ“ä½œï¼")

                action_requests = data["__interrupt__"][0]["value"]["action_requests"]
                for req in action_requests:
                    print(f"\nå·¥å…·: {req['name']}")
                    print(f"SQL: {req['args']['query']}")

                # æ¨¡æ‹Ÿäººå·¥å†³ç­–
                print("\nç­‰å¾…äººå·¥å®¡æ‰¹...")
                break

if interrupted:
    # ç»§ç»­æ‰§è¡Œï¼ˆè¿™é‡Œç®€åŒ–ä¸ºè‡ªåŠ¨æ‰¹å‡†ï¼‰
    print("âœ… æ‰¹å‡†æ‰§è¡Œ\n")

    for mode, chunk in agent.stream(
        Command(resume={"decisions": [{"type": "approve"}]}),
        config=config,
        stream_mode=["messages"]
    ):
        token, metadata = chunk
        if token:
            print(token, end="", flush=True)

print("\n\næ‰§è¡Œå®Œæˆ")</code></pre>
                    </div>
                </section>

                <!-- é«˜çº§é…ç½® -->
                <section class="content-section">
                    <h2 class="section-title">âš™ï¸ é«˜çº§é…ç½®é€‰é¡¹</h2>

                    <h3 class="subsection-title">é™åˆ¶å…è®¸çš„å†³ç­–ç±»å‹</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
é™åˆ¶å†³ç­–ç±»å‹ç¤ºä¾‹
åŠŸèƒ½ï¼šæŸäº›å·¥å…·åªå…è®¸æ‰¹å‡†æˆ–æ‹’ç»ï¼Œä¸å…è®¸ç¼–è¾‘
"""
from langchain.agents.middleware import HumanInTheLoopMiddleware

middleware = HumanInTheLoopMiddleware(
    interrupt_on={
        # å†™æ–‡ä»¶ï¼šå…è®¸æ‰€æœ‰å†³ç­–ç±»å‹
        "write_file": True,

        # åˆ é™¤æ–‡ä»¶ï¼šåªå…è®¸æ‰¹å‡†æˆ–æ‹’ç»ï¼Œä¸å…è®¸ç¼–è¾‘
        "delete_file": {
            "allowed_decisions": ["approve", "reject"]
        },

        # å‘é€é‚®ä»¶ï¼šåªå…è®¸æ‰¹å‡†ï¼ˆå¿…é¡»æ‰§è¡Œæˆ–æ‰‹åŠ¨å–æ¶ˆï¼‰
        "send_email": {
            "allowed_decisions": ["approve"]
        },
    }
)</code></pre>
                    </div>

                    <h3 class="subsection-title">è‡ªå®šä¹‰æè¿°æ–‡æœ¬</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
è‡ªå®šä¹‰æè¿°æ–‡æœ¬ç¤ºä¾‹
åŠŸèƒ½ï¼šä¸ºå®¡æ‰¹è¯·æ±‚æä¾›æ›´è¯¦ç»†çš„è¯´æ˜
"""
from langchain.agents.middleware import HumanInTheLoopMiddleware

def custom_description(action_request):
    """åŠ¨æ€ç”Ÿæˆæè¿°æ–‡æœ¬"""
    tool_name = action_request["name"]
    args = action_request["args"]

    if tool_name == "delete_file":
        filename = args.get("filename", "æœªçŸ¥æ–‡ä»¶")
        return f"âš ï¸ å±é™©æ“ä½œï¼šå³å°†åˆ é™¤æ–‡ä»¶ '{filename}'ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼"

    elif tool_name == "send_email":
        to = args.get("to", "æœªçŸ¥æ”¶ä»¶äºº")
        subject = args.get("subject", "æ— ä¸»é¢˜")
        return f"ğŸ“§ é‚®ä»¶å®¡æ‰¹ï¼šå‘é€ç»™ {to}ï¼Œä¸»é¢˜ï¼š{subject}"

    else:
        return f"æ“ä½œå®¡æ‰¹ï¼š{tool_name}"

middleware = HumanInTheLoopMiddleware(
    interrupt_on={
        "delete_file": True,
        "send_email": True,
    },
    description=custom_description  # ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°
)</code></pre>
                    </div>
                </section>

                <!-- å®Œæ•´ç¤ºä¾‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ¯ å®Œæ•´ç¤ºä¾‹ï¼šæ•æ„Ÿæ“ä½œå®¡æ‰¹ç³»ç»Ÿ</h2>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§ - å®Œæ•´é¡¹ç›®</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ•æ„Ÿæ“ä½œå®¡æ‰¹ç³»ç»Ÿå®Œæ•´ç¤ºä¾‹
åŠŸèƒ½ï¼šæ¨¡æ‹ŸçœŸå®çš„å®¡æ‰¹å·¥ä½œæµ
"""
from langchain.agents import create_agent
from langchain.agents.middleware import HumanInTheLoopMiddleware
from langgraph.checkpoint.memory import InMemorySaver
from langchain.tools import tool
from langgraph.types import Command
import json

# ==================== å·¥å…·å®šä¹‰ ====================

@tool
def query_database(sql: str) -> str:
    """æŸ¥è¯¢æ•°æ®åº“ï¼ˆå®‰å…¨æ“ä½œï¼‰"""
    return f"æŸ¥è¯¢ç»“æœï¼š[{'user1', 'user2', 'user3'}]"

@tool
def update_database(sql: str) -> str:
    """æ›´æ–°æ•°æ®åº“ï¼ˆéœ€å®¡æ‰¹ï¼‰"""
    return f"æ•°æ®åº“æ›´æ–°æˆåŠŸï¼š{sql}"

@tool
def delete_from_database(sql: str) -> str:
    """åˆ é™¤æ•°æ®åº“è®°å½•ï¼ˆå±é™©æ“ä½œï¼‰"""
    return f"åˆ é™¤æˆåŠŸï¼š{sql}"

@tool
def send_notification(recipients: list[str], message: str) -> str:
    """å‘é€é€šçŸ¥ï¼ˆéœ€å®¡æ‰¹ï¼‰"""
    return f"é€šçŸ¥å·²å‘é€ç»™ {len(recipients)} äºº"

# ==================== è‡ªå®šä¹‰æè¿° ====================

def approval_description(action_request):
    """ç”Ÿæˆå®¡æ‰¹æè¿°"""
    tool_name = action_request["name"]
    args = action_request["args"]

    descriptions = {
        "update_database": f"ğŸ”¸ æ•°æ®åº“æ›´æ–°\nSQL: {args.get('sql', 'N/A')}",
        "delete_from_database": f"âš ï¸ æ•°æ®åº“åˆ é™¤ï¼ˆå±é™©ï¼‰\nSQL: {args.get('sql', 'N/A')}",
        "send_notification": f"ğŸ“§ æ‰¹é‡é€šçŸ¥\næ”¶ä»¶äºº: {len(args.get('recipients', []))} äºº\nå†…å®¹: {args.get('message', 'N/A')[:50]}...",
    }

    return descriptions.get(tool_name, f"æ“ä½œ: {tool_name}")

# ==================== åˆ›å»º Agent ====================

approval_agent = create_agent(
    model="gpt-4o",
    tools=[
        query_database,
        update_database,
        delete_from_database,
        send_notification
    ],
    middleware=[
        HumanInTheLoopMiddleware(
            interrupt_on={
                "query_database": False,           # æŸ¥è¯¢ä¸éœ€è¦å®¡æ‰¹
                "update_database": True,           # æ›´æ–°éœ€è¦å®¡æ‰¹
                "delete_from_database": {          # åˆ é™¤åªå…è®¸æ‰¹å‡†/æ‹’ç»
                    "allowed_decisions": ["approve", "reject"]
                },
                "send_notification": True,         # å‘é€é€šçŸ¥éœ€è¦å®¡æ‰¹
            },
            description=approval_description
        )
    ],
    checkpointer=InMemorySaver(),
    system_prompt="""ä½ æ˜¯æ•°æ®åº“ç®¡ç†åŠ©æ‰‹ã€‚

èŒè´£ï¼š
1. æŸ¥è¯¢æ•°æ®åº“
2. æ›´æ–°æˆ–åˆ é™¤è®°å½•ï¼ˆéœ€è¦äººå·¥å®¡æ‰¹ï¼‰
3. å‘é€é€šçŸ¥

æ³¨æ„ï¼š
- åˆ é™¤æ“ä½œç‰¹åˆ«å±é™©ï¼Œéœ€è°¨æ…
- å‘é€é€šçŸ¥å‰ç¡®è®¤æ”¶ä»¶äººå’Œå†…å®¹"""
)

# ==================== å®¡æ‰¹å·¥ä½œæµ ====================

def execute_with_approval(user_request: str, thread_id: str):
    """æ‰§è¡Œå¸¦å®¡æ‰¹çš„è¯·æ±‚"""
    config = {"configurable": {"thread_id": thread_id}}

    print("\n" + "="*60)
    print(f"ç”¨æˆ·è¯·æ±‚: {user_request}")
    print("="*60 + "\n")

    # ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šè¿è¡Œç›´åˆ°ä¸­æ–­
    result = approval_agent.invoke(
        {"messages": [{"role": "user", "content": user_request}]},
        config=config
    )

    # æ£€æŸ¥æ˜¯å¦éœ€è¦å®¡æ‰¹
    if "__interrupt__" not in result:
        print("âœ… æ‰§è¡Œå®Œæˆï¼ˆæ— éœ€å®¡æ‰¹ï¼‰")
        print(result["messages"][-1].content)
        return

    # æ˜¾ç¤ºå®¡æ‰¹è¯·æ±‚
    print("â¸ï¸ éœ€è¦äººå·¥å®¡æ‰¹\n")
    action_requests = result["__interrupt__"][0]["value"]["action_requests"]

    decisions = []
    for i, req in enumerate(action_requests):
        print(f"å®¡æ‰¹è¯·æ±‚ #{i+1}:")
        print(f"  å·¥å…·: {req['name']}")
        print(f"  å‚æ•°: {json.dumps(req['args'], ensure_ascii=False, indent=4)}")
        print(f"  è¯´æ˜: {req.get('description', 'æ— ')}")

        # æ¨¡æ‹Ÿäººå·¥å†³ç­–ï¼ˆå®é™…åº”ç”¨ä¸­è¿™é‡Œæ˜¯äº¤äº’å¼è¾“å…¥ï¼‰
        if req['name'] == "delete_from_database":
            # åˆ é™¤æ“ä½œï¼šæ‹’ç»
            decision = {
                "type": "reject",
                "message": "åˆ é™¤æ“ä½œè¿‡äºå±é™©ï¼Œè¯·å…ˆå¤‡ä»½æ•°æ®"
            }
            print("  å†³ç­–: âŒ æ‹’ç»\n")
        elif req['name'] == "send_notification":
            # å‘é€é€šçŸ¥ï¼šæ‰¹å‡†
            decision = {"type": "approve"}
            print("  å†³ç­–: âœ… æ‰¹å‡†\n")
        else:
            # å…¶ä»–æ“ä½œï¼šæ‰¹å‡†
            decision = {"type": "approve"}
            print("  å†³ç­–: âœ… æ‰¹å‡†\n")

        decisions.append(decision)

    # æäº¤å†³ç­–å¹¶ç»§ç»­æ‰§è¡Œ
    print("æäº¤å®¡æ‰¹å†³ç­–...\n")
    result = approval_agent.invoke(
        Command(resume={"decisions": decisions}),
        config=config
    )

    print("âœ… æ‰§è¡Œå®Œæˆ")
    print(result["messages"][-1].content)

# ==================== æµ‹è¯•åœºæ™¯ ====================

if __name__ == "__main__":
    # åœºæ™¯ 1ï¼šæŸ¥è¯¢æ“ä½œï¼ˆæ— éœ€å®¡æ‰¹ï¼‰
    execute_with_approval(
        "æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒç”¨æˆ·",
        thread_id="scenario_1"
    )

    # åœºæ™¯ 2ï¼šæ›´æ–°æ“ä½œï¼ˆéœ€è¦å®¡æ‰¹ï¼‰
    execute_with_approval(
        "æ›´æ–°æ‰€æœ‰æœªæ¿€æ´»ç”¨æˆ·çš„çŠ¶æ€ä¸ºå·²æ¿€æ´»",
        thread_id="scenario_2"
    )

    # åœºæ™¯ 3ï¼šåˆ é™¤æ“ä½œï¼ˆä¼šè¢«æ‹’ç»ï¼‰
    execute_with_approval(
        "åˆ é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®ï¼Œå¹¶å‘é€é€šçŸ¥ç»™ç®¡ç†å‘˜",
        thread_id="scenario_3"
    )</code></pre>
                    </div>
                </section>

                <!-- å¸¸è§é—®é¢˜ -->
                <section class="content-section">
                    <h2 class="section-title">â“ å¸¸è§é—®é¢˜</h2>

                    <h3 class="subsection-subtitle">Q1: å¿˜è®°é…ç½® Checkpointer ä¼šæ€æ ·ï¼Ÿ</h3>
                    <p>
                        ä¼šæŠ›å‡ºé”™è¯¯ã€‚Human-in-the-Loop ä¾èµ–æŒä¹…åŒ–çŠ¶æ€ï¼Œå¿…é¡»é…ç½® Checkpointerã€‚
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># âŒ é”™è¯¯ï¼šç¼ºå°‘ checkpointer
agent = create_agent(
    model="gpt-4o",
    tools=[...],
    middleware=[HumanInTheLoopMiddleware(...)]
    # ç¼ºå°‘ checkpointerï¼
)

# âœ… æ­£ç¡®
agent = create_agent(
    model="gpt-4o",
    tools=[...],
    middleware=[HumanInTheLoopMiddleware(...)],
    checkpointer=InMemorySaver()  # å¿…éœ€
)</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q2: thread_id å¿…é¡»ä¸€è‡´å—ï¼Ÿ</h3>
                    <p>
                        <strong>æ˜¯çš„</strong>ã€‚æš‚åœå’Œæ¢å¤å¿…é¡»ä½¿ç”¨ç›¸åŒçš„ <code>thread_id</code>ï¼Œ
                        å¦åˆ™æ— æ³•æ¢å¤åˆ°æ­£ç¡®çš„çŠ¶æ€ã€‚
                    </p>

                    <h3 class="subsection-subtitle">Q3: å¯ä»¥è¶…æ—¶è‡ªåŠ¨æ‰¹å‡†/æ‹’ç»å—ï¼Ÿ</h3>
                    <p>
                        LangChain æœ¬èº«ä¸æä¾›è¶…æ—¶æœºåˆ¶ï¼Œä½†å¯ä»¥è‡ªå·±å®ç°ï¼š
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">import time
from threading import Thread

def wait_for_approval_with_timeout(agent, config, timeout=300):
    """ç­‰å¾…å®¡æ‰¹ï¼Œè¶…æ—¶è‡ªåŠ¨æ‹’ç»"""
    decision = {"type": None}

    def wait_input():
        # å®é™…åº”ç”¨ä¸­è¿™é‡Œæ˜¯è·å–ç”¨æˆ·è¾“å…¥
        user_input = input("æ‰¹å‡†(y)/æ‹’ç»(n): ")
        decision["type"] = "approve" if user_input == "y" else "reject"

    thread = Thread(target=wait_input)
    thread.start()
    thread.join(timeout=timeout)

    if decision["type"] is None:
        print("â° å®¡æ‰¹è¶…æ—¶ï¼Œè‡ªåŠ¨æ‹’ç»")
        decision["type"] = "reject"
        decision["message"] = "å®¡æ‰¹è¶…æ—¶"

    return decision</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q4: å¦‚ä½•è®°å½•å®¡æ‰¹å†å²ï¼Ÿ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># è®°å½•å®¡æ‰¹æ—¥å¿—
import logging
from datetime import datetime

logger = logging.getLogger("approval_system")

def log_approval_decision(action_request, decision, user_id):
    """è®°å½•å®¡æ‰¹å†³ç­–"""
    log_entry = {
        "timestamp": datetime.now().isoformat(),
        "user_id": user_id,
        "tool": action_request["name"],
        "args": action_request["args"],
        "decision": decision["type"],
        "message": decision.get("message", ""),
    }

    logger.info(f"Approval: {log_entry}")

    # å­˜å‚¨åˆ°æ•°æ®åº“
    # db.save_approval_log(log_entry)</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q5: å¯ä»¥æœ‰å¤šçº§å®¡æ‰¹å—ï¼Ÿ</h3>
                    <p>
                        å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ä¸­é—´ä»¶å®ç°å¤šçº§å®¡æ‰¹ã€‚ä¾‹å¦‚ï¼š
                    </p>
                    <ul>
                        <li>ç¬¬ä¸€çº§ï¼šæ“ä½œè€…å®¡æ‰¹</li>
                        <li>ç¬¬äºŒçº§ï¼šç®¡ç†å‘˜å®¡æ‰¹</li>
                        <li>ç¬¬ä¸‰çº§ï¼šé«˜çº§ç®¡ç†å‘˜å®¡æ‰¹</li>
                    </ul>
                    <p>
                        éœ€è¦åœ¨çŠ¶æ€ä¸­è®°å½•å½“å‰å®¡æ‰¹çº§åˆ«ï¼Œå¹¶æ ¹æ®çº§åˆ«è§¦å‘ä¸åŒçš„å®¡æ‰¹æµç¨‹ã€‚
                    </p>
                </section>

                <!-- æœ€ä½³å®è·µ -->
                <section class="content-section">
                    <h2 class="section-title">âœ¨ æœ€ä½³å®è·µ</h2>

                    <h3 class="subsection-title">1. æ˜ç¡®å®¡æ‰¹èŒƒå›´</h3>
                    <ul>
                        <li><strong>åªå¯¹çœŸæ­£å±é™©çš„æ“ä½œè¦æ±‚å®¡æ‰¹</strong>ï¼šè¿‡åº¦å®¡æ‰¹ä¼šé™ä½æ•ˆç‡</li>
                        <li><strong>åŒºåˆ†æ“ä½œé£é™©ç­‰çº§</strong>ï¼šé«˜é£é™©æ“ä½œåªå…è®¸ approve/reject</li>
                        <li><strong>æ–‡æ¡£åŒ–å®¡æ‰¹ç­–ç•¥</strong>ï¼šè®©å›¢é˜Ÿæ¸…æ¥šå“ªäº›æ“ä½œéœ€è¦å®¡æ‰¹</li>
                    </ul>

                    <h3 class="subsection-title">2. æä¾›æ¸…æ™°çš„ä¸Šä¸‹æ–‡</h3>
                    <ul>
                        <li>ä½¿ç”¨ <code>description</code> å‚æ•°æä¾›è¯¦ç»†è¯´æ˜</li>
                        <li>æ˜¾ç¤ºæ“ä½œçš„å½±å“èŒƒå›´ï¼ˆå¦‚å—å½±å“çš„è®°å½•æ•°ï¼‰</li>
                        <li>åŒ…å«å¿…è¦çš„è­¦å‘Šä¿¡æ¯</li>
                    </ul>

                    <h3 class="subsection-title">3. å®¡æ‰¹å†³ç­–æŒ‡å¯¼</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>æƒ…å†µ</th>
                                <th>å»ºè®®å†³ç­–</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>æ“ä½œå®Œå…¨æ­£ç¡®</td>
                                <td>Approve</td>
                            </tr>
                            <tr>
                                <td>æ–¹å‘å¯¹ä½†å‚æ•°éœ€å¾®è°ƒ</td>
                                <td>Editï¼ˆä¿å®ˆä¿®æ”¹ï¼‰</td>
                            </tr>
                            <tr>
                                <td>æ“ä½œä¸å®‰å…¨æˆ–ä¸åˆç†</td>
                                <td>Reject + è¯¦ç»†åé¦ˆ</td>
                            </tr>
                            <tr>
                                <td>éœ€è¦æ›´å¤šä¿¡æ¯æ‰èƒ½å†³ç­–</td>
                                <td>Reject + è¦æ±‚è¡¥å……ä¿¡æ¯</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="subsection-title">4. ç”Ÿäº§ç¯å¢ƒé…ç½®</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
from langgraph.checkpoint.postgres import PostgresSaver

DB_URI = "postgresql://user:pass@localhost:5432/langchain"

with PostgresSaver.from_conn_string(DB_URI) as checkpointer:
    checkpointer.setup()

    agent = create_agent(
        model="gpt-4o",
        tools=[...],
        middleware=[
            HumanInTheLoopMiddleware(
                interrupt_on={...},
                description=custom_description_function,
            ),
        ],
        checkpointer=checkpointer,  # ç”Ÿäº§çº§æŒä¹…åŒ–
    )</code></pre>
                    </div>
                </section>

                <!-- å‚è€ƒèµ„æº -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“– å‚è€ƒèµ„æº</h2>
                    <ul>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/human-in-the-loop" target="_blank">
                                LangChain å®˜æ–¹ Human-in-the-Loop æ–‡æ¡£
                            </a>
                        </li>
                        <li>
                            <a href="https://langchain-ai.github.io/langgraph/how-tos/human_in_the_loop/" target="_blank">
                                LangGraph HITL æ•™ç¨‹
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/middleware/built-in#humanintheloopmi" target="_blank">
                                HumanInTheLoopMiddleware API å‚è€ƒ
                            </a>
                        </li>
                    </ul>
                </section>

                <!-- é¡µé¢å¯¼èˆª -->
                                <nav class="page-navigation">
                    <a href="12-streaming.html" class="nav-button prev">
                        â† ä¸Šä¸€é¡µï¼šæµå¼è¾“å‡º
                    </a>
                    <a href="14-long-term-memory.html" class="nav-button next">
                        ä¸‹ä¸€é¡µï¼šé•¿æœŸè®°å¿† â†’
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" aria-label="è¿”å›é¡¶éƒ¨">â†‘</button>

    <!-- JavaScript -->
    <script src="assets/js/mermaid-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
