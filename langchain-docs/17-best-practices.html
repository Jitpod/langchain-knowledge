<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LangChain 1.0 æœ€ä½³å®è·µ - ç”Ÿäº§çº§ AI Agent å¼€å‘æŒ‡å—">
    <title>æœ€ä½³å®è·µ | LangChain 1.0 Python çŸ¥è¯†æ–‡æ¡£</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <button class="mobile-menu-button" aria-label="æ‰“å¼€èœå•">â˜°</button>

    <div class="container">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">ğŸ¦œ LangChain 1.0</h1>
                <p class="sidebar-subtitle">Python å®Œæ•´å­¦ä¹ æŒ‡å—</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-section">
                    <div class="nav-section-title">å¼€å§‹</div>
                    <ul>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <span class="nav-icon">ğŸ </span>
                                ä¸»é¡µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">åŸºç¡€ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="01-introduction.html" class="nav-link">
                                <span class="nav-icon">ğŸ“–</span>
                                LangChain ç®€ä»‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="02-architecture.html" class="nav-link">
                                <span class="nav-icon">ğŸ—ï¸</span>
                                æ ¸å¿ƒæ¶æ„
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="03-models.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤–</span>
                                æ¨¡å‹æ¥å£
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="04-messages.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¬</span>
                                æ¶ˆæ¯ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="05-tools.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                å·¥å…·ç³»ç»Ÿ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">è¿›é˜¶ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="06-agents.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                Agent åŸºç¡€
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="07-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="08-rag.html" class="nav-link">
                                <span class="nav-icon">ğŸ”</span>
                                RAG è¯¦è§£
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="09-lcel.html" class="nav-link">
                                <span class="nav-icon">ğŸ”—</span>
                                LCEL è¡¨è¾¾å¼
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">é«˜çº§åº”ç”¨</div>
                    <ul>
                        <li class="nav-item">
                            <a href="10-runtime.html" class="nav-link">
                                <span class="nav-icon">ğŸ”Œ</span>
                                Runtime ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="11-checkpointer.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¾</span>
                                æŒä¹…åŒ–ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="12-streaming.html" class="nav-link">
                                <span class="nav-icon">ğŸŒŠ</span>
                                æµå¼è¾“å‡º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="13-human-in-loop.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="14-long-term-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ—„ï¸</span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="15-langgraph.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                LangGraph
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å®æˆ˜ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="16-customer-service.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å®¢æœæœºå™¨äºº
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item active">\n                            <a href="17-best-practices.html" class="nav-link">
                                <span class="nav-icon">âœ¨</span>
                                æœ€ä½³å®è·µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å‚è€ƒç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="18-api-reference.html" class="nav-link">
                                <span class="nav-icon">ğŸ“š</span>
                                API é€ŸæŸ¥è¡¨
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="19-troubleshooting.html" class="nav-link">
                                <span class="nav-icon">ğŸ›</span>
                                æ•…éšœæ’é™¤
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="20-migration.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                è¿ç§»æŒ‡å—
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">æ‰©å±•ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="21-structured-output.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                ç»“æ„åŒ–è¾“å‡º
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">DeepAgents ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="22-deepagents-quickstart.html" class="nav-link">
                                <span class="nav-icon">ğŸš€</span>
                                å¿«é€Ÿå¼€å§‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="23-deepagents-customization.html" class="nav-link">
                                <span class="nav-icon">ğŸ¨</span>
                                å®šåˆ¶åŒ–
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="24-deepagents-harness.html" class="nav-link">
                                <span class="nav-icon">ğŸ›ï¸</span>
                                Harness ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="25-deepagents-backends.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                åç«¯é…ç½®
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="26-deepagents-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="27-deepagents-hitl.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="28-deepagents-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ§ </span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="29-deepagents-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">Multi-Agent ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="30-multi-agent-index.html" class="nav-link">
                                <span class="nav-icon">ğŸŒ</span>
                                æ¦‚è¿°
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="31-multi-agent-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="32-multi-agent-handoffs.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                äº¤æ¥æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="33-multi-agent-skills.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="34-multi-agent-router.html" class="nav-link">
                                <span class="nav-icon">ğŸ§­</span>
                                è·¯ç”±æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="35-multi-agent-workflow.html" class="nav-link">
                                <span class="nav-icon">ğŸ”€</span>
                                è‡ªå®šä¹‰å·¥ä½œæµ
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">
                        <a href="index.html" class="breadcrumb-link">ä¸»é¡µ</a>
                    </span>
                    <span class="breadcrumb-item">
                        å®æˆ˜ç¯‡
                    </span>
                    <span class="breadcrumb-item">
                        æœ€ä½³å®è·µ
                    </span>
                </nav>

                <!-- é¡µé¢æ ‡é¢˜ -->
                <header class="page-header">
                    <h1 class="page-title">âœ¨ LangChain 1.0 æœ€ä½³å®è·µ</h1>
                    <p class="page-subtitle">
                        ä»æç¤ºè¯ä¼˜åŒ–åˆ°ç”Ÿäº§éƒ¨ç½²ï¼Œå…¨é¢æŒæ¡æ„å»ºå¯é ã€å®‰å…¨ã€é«˜æ•ˆçš„
                        AI Agent ç³»ç»Ÿçš„æœ€ä½³å®è·µå’Œå…³é”®æŠ€å·§ã€‚
                    </p>
                </header>

                <!-- ç®€ä»‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“š ä¸ºä»€ä¹ˆéœ€è¦æœ€ä½³å®è·µï¼Ÿ</h2>
                    <p>
                        æ„å»º AI Agent ä¸ä»…ä»…æ˜¯è°ƒç”¨ APIï¼Œæ›´é‡è¦çš„æ˜¯<strong>å·¥ç¨‹åŒ–</strong>ã€‚
                        æ ¹æ® LangChain å®˜æ–¹æ–‡æ¡£ï¼Œ"å¯é çš„ Agent æ¥è‡ªäºä¼˜ç§€çš„ä¸Šä¸‹æ–‡å·¥ç¨‹ï¼Œ
                        è€Œéä»…ä»…ä¾èµ–æ¨¡å‹èƒ½åŠ›"ã€‚
                    </p>

                    <div class="info-box note">
                        <div class="info-box-title">ğŸ’¡ æ ¸å¿ƒåŸåˆ™</div>
                        <table style="margin-top: 0.5rem;">
                            <thead>
                                <tr>
                                    <th>åŸåˆ™</th>
                                    <th>è¯´æ˜</th>
                                    <th>æ”¶ç›Š</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>ä¸Šä¸‹æ–‡ä¼˜å…ˆ</strong></td>
                                    <td>ä¼˜åŒ–æç¤ºè¯å’Œä¸Šä¸‹æ–‡ï¼Œè€Œéå‡çº§æ¨¡å‹</td>
                                    <td>æ›´é«˜çš„å‡†ç¡®ç‡ï¼Œæ›´ä½çš„æˆæœ¬</td>
                                </tr>
                                <tr>
                                    <td><strong>åˆ†å±‚é˜²æŠ¤</strong></td>
                                    <td>å¤šå±‚ Guardrails ç¡®ä¿å®‰å…¨æ€§</td>
                                    <td>é˜²æ­¢ PII æ³„éœ²å’Œæ¶æ„æ”»å‡»</td>
                                </tr>
                                <tr>
                                    <td><strong>æ¸è¿›å¼ä¼˜åŒ–</strong></td>
                                    <td>ä»ç®€å•å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚æ€§</td>
                                    <td>é™ä½å¼€å‘é£é™©ï¼Œä¾¿äºè°ƒè¯•</td>
                                </tr>
                                <tr>
                                    <td><strong>å¯è§‚æµ‹æ€§</strong></td>
                                    <td>å®Œå–„çš„æ—¥å¿—ã€ç›‘æ§å’Œè¿½è¸ª</td>
                                    <td>å¿«é€Ÿå®šä½é—®é¢˜ï¼ŒæŒç»­æ”¹è¿›</td>
                                </tr>
                                <tr>
                                    <td><strong>æˆæœ¬æ„è¯†</strong></td>
                                    <td>åˆç†é€‰æ‹©æ¨¡å‹ï¼Œä¼˜åŒ– Token ä½¿ç”¨</td>
                                    <td>é™ä½è¿è¥æˆæœ¬ 50%+</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- ä¸Šä¸‹æ–‡å·¥ç¨‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ¯ ä¸Šä¸‹æ–‡å·¥ç¨‹ï¼ˆContext Engineeringï¼‰</h2>
                    <p>
                        <strong>ä¸Šä¸‹æ–‡å·¥ç¨‹æ˜¯ AI å·¥ç¨‹å¸ˆçš„é¦–è¦ä»»åŠ¡</strong>ï¼Œ
                        æŒ‡çš„æ˜¯"ä»¥æ­£ç¡®çš„æ ¼å¼æä¾›æ­£ç¡®çš„ä¿¡æ¯å’Œå·¥å…·ï¼Œä½¿ LLM èƒ½å¤Ÿå®Œæˆä»»åŠ¡"ã€‚
                    </p>

                    <h3 class="subsection-title">æ ¸å¿ƒæŠ€æœ¯</h3>

                    <h4 class="subsection-subtitle">1. åŠ¨æ€ç³»ç»Ÿæç¤ºè¯</h4>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
åŠ¨æ€ç³»ç»Ÿæç¤ºè¯ç¤ºä¾‹
æ ¹æ®ç”¨æˆ·çŠ¶æ€å’Œåå¥½è°ƒæ•´æç¤ºè¯
"""
from langchain.agents import create_agent

def generate_system_prompt(user_context: dict) -> str:
    """æ ¹æ®ç”¨æˆ·ä¸Šä¸‹æ–‡ç”Ÿæˆä¸ªæ€§åŒ–æç¤ºè¯"""

    base_prompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ AI åŠ©æ‰‹ã€‚\n\n"

    # æ ¹æ®å¯¹è¯é•¿åº¦è°ƒæ•´è¯¦ç»†ç¨‹åº¦
    conversation_length = user_context.get("message_count", 0)
    if conversation_length < 3:
        base_prompt += "è¯·æä¾›è¯¦ç»†çš„è§£é‡Šå’ŒèƒŒæ™¯ä¿¡æ¯ã€‚\n"
    else:
        base_prompt += "ç”¨æˆ·å·²ç»äº†è§£åŸºç¡€çŸ¥è¯†ï¼Œè¯·ç®€æ˜æ‰¼è¦åœ°å›ç­”ã€‚\n"

    # æ ¹æ®ç”¨æˆ·è§’è‰²è°ƒæ•´æƒé™
    user_role = user_context.get("role", "guest")
    if user_role == "admin":
        base_prompt += "ä½ å¯ä»¥è®¿é—®ç®¡ç†åŠŸèƒ½å’Œæ•æ„Ÿæ•°æ®ã€‚\n"
    elif user_role == "user":
        base_prompt += "ä½ åªèƒ½è®¿é—®ç”¨æˆ·çº§åˆ«çš„åŠŸèƒ½ã€‚\n"

    # æ ¹æ®ç”¨æˆ·åå¥½è°ƒæ•´é£æ ¼
    preferences = user_context.get("preferences", {})
    language = preferences.get("language", "zh-CN")
    formality = preferences.get("formality", "professional")

    if formality == "casual":
        base_prompt += "ä½¿ç”¨è½»æ¾ã€å‹å¥½çš„è¯­æ°”ã€‚\n"
    else:
        base_prompt += "ä¿æŒä¸“ä¸šã€æ­£å¼çš„è¯­æ°”ã€‚\n"

    # æ·»åŠ åˆè§„è¦æ±‚
    if user_context.get("requires_compliance"):
        base_prompt += "\né‡è¦ï¼šéµå®ˆ GDPR å’Œæ•°æ®éšç§æ³•è§„ï¼Œä¸å¾—æ³„éœ²ç”¨æˆ·ä¸ªäººä¿¡æ¯ã€‚\n"

    return base_prompt

# ä½¿ç”¨ç¤ºä¾‹
user_context = {
    "message_count": 5,
    "role": "user",
    "preferences": {"language": "zh-CN", "formality": "casual"},
    "requires_compliance": True
}

agent = create_agent(
    model="gpt-4o",
    tools=[...],
    system_prompt=generate_system_prompt(user_context)
)</code></pre>
                    </div>

                    <h4 class="subsection-subtitle">2. æ™ºèƒ½å·¥å…·é€‰æ‹©</h4>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
åŠ¨æ€å·¥å…·é€‰æ‹©
æ ¹æ®ç”¨æˆ·çŠ¶æ€å’Œæƒé™è¿‡æ»¤å¯ç”¨å·¥å…·
"""
from langchain.tools import tool
from typing import Literal

# å®šä¹‰æ‰€æœ‰å·¥å…·
@tool
def public_search(query: str) -> str:
    """å…¬å¼€æœç´¢å·¥å…·ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯ç”¨ï¼‰"""
    return f"æœç´¢ç»“æœï¼š{query}"

@tool
def private_database_query(query: str) -> str:
    """ç§æœ‰æ•°æ®åº“æŸ¥è¯¢ï¼ˆä»…è®¤è¯ç”¨æˆ·ï¼‰"""
    return f"æ•°æ®åº“ç»“æœï¼š{query}"

@tool
def admin_delete_user(user_id: str) -> str:
    """åˆ é™¤ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰"""
    return f"å·²åˆ é™¤ç”¨æˆ·ï¼š{user_id}"

@tool
def premium_analysis(data: str) -> str:
    """é«˜çº§åˆ†æï¼ˆä»…ä»˜è´¹ç”¨æˆ·ï¼‰"""
    return f"åˆ†æç»“æœï¼š{data}"

# å·¥å…·é€‰æ‹©é€»è¾‘
def select_tools_for_user(
    user_role: Literal["guest", "user", "premium", "admin"],
    is_authenticated: bool
) -> list:
    """æ ¹æ®ç”¨æˆ·è§’è‰²å’Œè®¤è¯çŠ¶æ€é€‰æ‹©å·¥å…·"""

    # åŸºç¡€å·¥å…·ï¼ˆæ‰€æœ‰äººå¯ç”¨ï¼‰
    available_tools = [public_search]

    # è®¤è¯ç”¨æˆ·å·¥å…·
    if is_authenticated:
        available_tools.append(private_database_query)

    # ä»˜è´¹ç”¨æˆ·å·¥å…·
    if user_role in ["premium", "admin"]:
        available_tools.append(premium_analysis)

    # ç®¡ç†å‘˜å·¥å…·
    if user_role == "admin":
        available_tools.append(admin_delete_user)

    return available_tools

# ä½¿ç”¨ç¤ºä¾‹
tools_for_guest = select_tools_for_user("guest", is_authenticated=False)
print(f"è®¿å®¢å¯ç”¨å·¥å…·ï¼š{[t.name for t in tools_for_guest]}")
# è¾“å‡ºï¼š['public_search']

tools_for_admin = select_tools_for_user("admin", is_authenticated=True)
print(f"ç®¡ç†å‘˜å¯ç”¨å·¥å…·ï¼š{[t.name for t in tools_for_admin]}")
# è¾“å‡ºï¼š['public_search', 'private_database_query', 'premium_analysis', 'admin_delete_user']

# åˆ›å»º Agent
agent = create_agent(
    model="gpt-4o",
    tools=tools_for_admin,  # åŠ¨æ€é€‰æ‹©çš„å·¥å…·
    system_prompt="..."
)</code></pre>
                    </div>

                    <h4 class="subsection-subtitle">3. ä¸Šä¸‹æ–‡æ³¨å…¥</h4>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ä¸Šä¸‹æ–‡æ³¨å…¥ç¤ºä¾‹
åœ¨å¯¹è¯ä¸­åŠ¨æ€æ³¨å…¥ç›¸å…³ä¿¡æ¯
"""
def inject_context_messages(
    user_messages: list,
    uploaded_files: list = None,
    user_preferences: dict = None
) -> list:
    """åœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­æ³¨å…¥ä¸Šä¸‹æ–‡ä¿¡æ¯"""

    enriched_messages = []

    # æ·»åŠ ç”¨æˆ·åå¥½ä¸Šä¸‹æ–‡
    if user_preferences:
        context_msg = {
            "role": "system",
            "content": f"ç”¨æˆ·åå¥½ï¼š{user_preferences}"
        }
        enriched_messages.append(context_msg)

    # æ·»åŠ æ–‡ä»¶ä¸Šä¸‹æ–‡
    if uploaded_files:
        for file in uploaded_files:
            file_context = {
                "role": "system",
                "content": f"ç”¨æˆ·ä¸Šä¼ äº†æ–‡ä»¶ï¼š{file['name']}\nå†…å®¹æ‘˜è¦ï¼š{file['summary']}"
            }
            enriched_messages.append(file_context)

    # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    enriched_messages.extend(user_messages)

    return enriched_messages

# ä½¿ç”¨ç¤ºä¾‹
user_messages = [
    {"role": "user", "content": "åˆ†æè¿™ä¸ªæ–‡ä»¶"}
]

uploaded_files = [
    {"name": "sales_data.csv", "summary": "2024å¹´é”€å”®æ•°æ®ï¼ŒåŒ…å«1000æ¡è®°å½•"}
]

user_preferences = {
    "analysis_depth": "detailed",
    "chart_type": "bar"
}

final_messages = inject_context_messages(
    user_messages,
    uploaded_files=uploaded_files,
    user_preferences=user_preferences
)

# final_messages å°†åŒ…å«ç³»ç»Ÿæ¶ˆæ¯ + æ–‡ä»¶ä¸Šä¸‹æ–‡ + ç”¨æˆ·æ¶ˆæ¯
result = agent.invoke({"messages": final_messages})</code></pre>
                    </div>

                    <div class="info-box tip">
                        <div class="info-box-title">âœ… ä¸Šä¸‹æ–‡å·¥ç¨‹æœ€ä½³å®è·µ</div>
                        <ol>
                            <li><strong>ä»ç®€å•å¼€å§‹</strong>ï¼šå…ˆç”¨é™æ€æç¤ºè¯å’Œå·¥å…·ï¼Œå†é€æ­¥å¼•å…¥åŠ¨æ€æ€§</li>
                            <li><strong>è¿­ä»£æµ‹è¯•</strong>ï¼šæ¯æ¬¡æ·»åŠ ä¸€ä¸ªä¸Šä¸‹æ–‡ç‰¹æ€§ï¼Œæµ‹é‡å½±å“</li>
                            <li><strong>ç›‘æ§æ€§èƒ½</strong>ï¼šè¿½è¸ªæ¨¡å‹è°ƒç”¨æ¬¡æ•°ã€Token ä½¿ç”¨é‡ã€å»¶è¿Ÿ</li>
                            <li><strong>åˆ©ç”¨ä¸­é—´ä»¶</strong>ï¼šä½¿ç”¨ SummarizationMiddlewareã€LLMToolSelectorMiddleware ç­‰</li>
                            <li><strong>ç†è§£æŒä¹…æ€§</strong>ï¼šæ¨¡å‹ä¸Šä¸‹æ–‡æ˜¯ä¸´æ—¶çš„ï¼ŒçŠ¶æ€å˜åŒ–æ˜¯æŒä¹…çš„</li>
                        </ol>
                    </div>
                </section>

                <!-- Guardrails å®‰å…¨é˜²æŠ¤ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ›¡ï¸ Guardrails å®‰å…¨é˜²æŠ¤</h2>
                    <p>
                        <strong>Guardrailsï¼ˆå®‰å…¨é˜²æŠ¤æ ï¼‰</strong>æ˜¯åœ¨ Agent æ‰§è¡Œå…³é”®ç‚¹éªŒè¯å’Œè¿‡æ»¤å†…å®¹çš„å®‰å…¨æœºåˆ¶ï¼Œ
                        å¸®åŠ©æ„å»ºå®‰å…¨ã€åˆè§„çš„ AI åº”ç”¨ã€‚
                    </p>

                    <h3 class="subsection-title">å¸¸è§åº”ç”¨åœºæ™¯</h3>
                    <ul>
                        <li>é˜²æ­¢ PIIï¼ˆä¸ªäººèº«ä»½ä¿¡æ¯ï¼‰æ³„éœ²</li>
                        <li>æ£€æµ‹å’Œé˜»æ­¢æç¤ºè¯æ³¨å…¥æ”»å‡»</li>
                        <li>è¿‡æ»¤ä¸å½“æˆ–æœ‰å®³å†…å®¹</li>
                        <li>æ‰§è¡Œä¸šåŠ¡è§„åˆ™å’Œåˆè§„è¦æ±‚</li>
                        <li>éªŒè¯è¾“å‡ºè´¨é‡å’Œå‡†ç¡®æ€§</li>
                    </ul>

                    <h3 class="subsection-title">ä¸¤ç§å®ç°æ–¹å¼</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ç±»å‹</th>
                                <th>ç‰¹ç‚¹</th>
                                <th>é€‚ç”¨åœºæ™¯</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>ç¡®å®šæ€§ Guardrails</strong></td>
                                <td>åŸºäºè§„åˆ™ï¼ˆæ­£åˆ™ã€å…³é”®è¯ï¼‰<br/>å¿«é€Ÿã€å¯é¢„æµ‹ã€æˆæœ¬ä½</td>
                                <td>PII æ£€æµ‹ã€æ ¼å¼éªŒè¯ã€å…³é”®è¯è¿‡æ»¤</td>
                            </tr>
                            <tr>
                                <td><strong>æ¨¡å‹åŒ– Guardrails</strong></td>
                                <td>ä½¿ç”¨ LLM æˆ–åˆ†ç±»å™¨<br/>è¯­ä¹‰ç†è§£ã€æˆæœ¬è¾ƒé«˜</td>
                                <td>å†…å®¹å®‰å…¨æ€§ã€æƒ…æ„Ÿåˆ†æã€ç»†å¾®è¿è§„æ£€æµ‹</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="subsection-title">å†…ç½® Guardrails</h3>

                    <h4 class="subsection-subtitle">PII æ£€æµ‹å’Œå¤„ç†</h4>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
PII æ£€æµ‹ä¸­é—´ä»¶
è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†ä¸ªäººèº«ä»½ä¿¡æ¯
"""
from langchain.agents.middleware import PIIMiddleware
from langchain.agents import create_agent

# PII å¤„ç†ç­–ç•¥
pii_middleware = PIIMiddleware(
    # æ£€æµ‹ç±»å‹
    pii_types=[
        "email",           # ç”µå­é‚®ä»¶
        "credit_card",     # ä¿¡ç”¨å¡å·
        "ip_address",      # IP åœ°å€
        "phone_number",    # ç”µè¯å·ç 
        "ssn",            # ç¤¾ä¼šä¿éšœå·
    ],

    # å¤„ç†ç­–ç•¥
    strategy="redact",  # é€‰é¡¹ï¼šredact, mask, hash, block

    # è‡ªå®šä¹‰æ¨¡å¼ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
    custom_patterns={
        "chinese_id": r"\d{17}[\dXx]",  # ä¸­å›½èº«ä»½è¯å·
        "bank_card": r"\d{16,19}",      # é“¶è¡Œå¡å·
    }
)

agent = create_agent(
    model="gpt-4o",
    tools=[...],
    middleware=[pii_middleware],
    system_prompt="ä½ æ˜¯å®¢æœåŠ©æ‰‹ã€‚æ³¨æ„ä¿æŠ¤ç”¨æˆ·éšç§ä¿¡æ¯ã€‚"
)

# æµ‹è¯•
result = agent.invoke({
    "messages": [{
        "role": "user",
        "content": "æˆ‘çš„é‚®ç®±æ˜¯ user@example.comï¼Œç”µè¯æ˜¯ 13812345678"
    }]
})

# PII ä¼šè¢«è‡ªåŠ¨å¤„ç†ï¼š
# "æˆ‘çš„é‚®ç®±æ˜¯ [REDACTED_EMAIL]ï¼Œç”µè¯æ˜¯ [REDACTED_PHONE_NUMBER]"</code></pre>
                    </div>

                    <h4 class="subsection-subtitle">å†…å®¹å®‰å…¨æ£€æŸ¥</h4>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
è‡ªå®šä¹‰å†…å®¹å®‰å…¨ Guardrail
ä½¿ç”¨æ¨¡å‹æ£€æŸ¥è¾“å‡ºå†…å®¹å®‰å…¨æ€§
"""
from langchain.agents.middleware import CustomMiddleware
from langchain_openai import ChatOpenAI

class ContentSafetyGuardrail(CustomMiddleware):
    """å†…å®¹å®‰å…¨æ£€æŸ¥ä¸­é—´ä»¶"""

    def __init__(self):
        self.safety_checker = ChatOpenAI(model="gpt-4o-mini")

    def after_agent(self, state, config):
        """Agent æ‰§è¡Œåæ£€æŸ¥è¾“å‡ºå®‰å…¨æ€§"""
        last_message = state["messages"][-1]

        # è·³è¿‡å·¥å…·è°ƒç”¨æ¶ˆæ¯
        if not hasattr(last_message, "content"):
            return state

        content = last_message.content

        # ä½¿ç”¨æ¨¡å‹æ£€æŸ¥å®‰å…¨æ€§
        safety_prompt = f"""
        è¯·è¯„ä¼°ä»¥ä¸‹ AI å›ç­”æ˜¯å¦å®‰å…¨ã€åˆè§„ï¼š

        {content}

        è¯„ä¼°æ ‡å‡†ï¼š
        1. ä¸åŒ…å«æœ‰å®³ã€æš´åŠ›ã€æ­§è§†æ€§å†…å®¹
        2. ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
        3. ç¬¦åˆé“å¾·å’Œæ³•å¾‹è¦æ±‚

        è¯·å›ç­”ï¼š"å®‰å…¨" æˆ– "ä¸å®‰å…¨ï¼š[åŸå› ]"
        """

        response = self.safety_checker.invoke(safety_prompt)
        result = response.content.strip()

        if not result.startswith("å®‰å…¨"):
            # ä¸å®‰å…¨ï¼Œæ›¿æ¢ä¸ºå®‰å…¨æ¶ˆæ¯
            state["messages"][-1].content = "æŠ±æ­‰ï¼Œæˆ‘æ— æ³•æä¾›è¯¥ä¿¡æ¯ã€‚è¯·æ¢ä¸€ä¸ªé—®é¢˜ã€‚"

        return state

# ä½¿ç”¨
agent = create_agent(
    model="gpt-4o",
    tools=[...],
    middleware=[ContentSafetyGuardrail()],
)</code></pre>
                    </div>

                    <h3 class="subsection-title">åˆ†å±‚é˜²æŠ¤ç­–ç•¥</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
å¤šå±‚ Guardrails ç»„åˆ
æ„å»ºæ·±åº¦é˜²å¾¡ä½“ç³»
"""
from langchain.agents import create_agent
from langchain.agents.middleware import (
    PIIMiddleware,
    HumanInTheLoopMiddleware,
    CustomMiddleware
)

# ç¬¬ 1 å±‚ï¼šè¾“å…¥éªŒè¯ï¼ˆç¡®å®šæ€§ï¼‰
class InputValidationGuardrail(CustomMiddleware):
    """éªŒè¯è¾“å…¥æ ¼å¼å’Œé•¿åº¦"""

    def before_agent(self, state, config):
        last_message = state["messages"][-1]
        content = last_message.get("content", "")

        # æ£€æŸ¥é•¿åº¦
        if len(content) > 5000:
            raise ValueError("è¾“å…¥è¿‡é•¿ï¼Œè¯·æ§åˆ¶åœ¨ 5000 å­—ç¬¦ä»¥å†…")

        # æ£€æŸ¥ç¦ç”¨è¯
        forbidden_words = ["hack", "exploit", "jailbreak"]
        if any(word in content.lower() for word in forbidden_words):
            raise ValueError("è¾“å…¥åŒ…å«ä¸å…è®¸çš„å†…å®¹")

        return state

# ç¬¬ 2 å±‚ï¼šPII ä¿æŠ¤
pii_guardrail = PIIMiddleware(
    pii_types=["email", "phone_number", "credit_card"],
    strategy="redact"
)

# ç¬¬ 3 å±‚ï¼šæ•æ„Ÿæ“ä½œå®¡æ ¸
hitl_guardrail = HumanInTheLoopMiddleware(
    interrupt_on={
        "delete_data": True,
        "send_email": True,
        "make_payment": True,
    }
)

# ç¬¬ 4 å±‚ï¼šè¾“å‡ºå®‰å…¨æ£€æŸ¥ï¼ˆæ¨¡å‹åŒ–ï¼‰
output_safety_guardrail = ContentSafetyGuardrail()

# ç»„åˆæ‰€æœ‰ Guardrails
agent = create_agent(
    model="gpt-4o",
    tools=[...],
    middleware=[
        InputValidationGuardrail(),   # ç¬¬ 1 å±‚
        pii_guardrail,                # ç¬¬ 2 å±‚
        hitl_guardrail,               # ç¬¬ 3 å±‚
        output_safety_guardrail,      # ç¬¬ 4 å±‚
    ],
    checkpointer=checkpointer,  # HITL éœ€è¦
    system_prompt="..."
)

# è¿™æ ·æ„å»ºäº†å®Œæ•´çš„å®‰å…¨é˜²æŠ¤ä½“ç³»</code></pre>
                    </div>
                </section>

                <!-- æ€§èƒ½ä¼˜åŒ– -->
                <section class="content-section">
                    <h2 class="section-title">âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h2>

                    <h3 class="subsection-title">ä¼˜åŒ–æ¸…å•</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ä¼˜åŒ–é¡¹</th>
                                <th>æ–¹æ³•</th>
                                <th>é¢„æœŸæå‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>æ¨¡å‹é€‰æ‹©</strong></td>
                                <td>ç®€å•ä»»åŠ¡ç”¨ GPT-3.5ï¼Œå¤æ‚ä»»åŠ¡ç”¨ GPT-4</td>
                                <td>æˆæœ¬é™ä½ 50%ï¼Œé€Ÿåº¦æå‡ 3x</td>
                            </tr>
                            <tr>
                                <td><strong>Token ä¼˜åŒ–</strong></td>
                                <td>ç²¾ç®€æç¤ºè¯ï¼Œæ‘˜è¦å†å²å¯¹è¯</td>
                                <td>æˆæœ¬é™ä½ 30%</td>
                            </tr>
                            <tr>
                                <td><strong>å¹¶è¡Œè°ƒç”¨</strong></td>
                                <td>ä½¿ç”¨ RunnableParallel å¹¶å‘æ‰§è¡Œ</td>
                                <td>å»¶è¿Ÿé™ä½ 60%</td>
                            </tr>
                            <tr>
                                <td><strong>ç¼“å­˜</strong></td>
                                <td>ç¼“å­˜ FAQã€Embeddingsã€å·¥å…·ç»“æœ</td>
                                <td>å“åº”æ—¶é—´å‡å°‘ 70%</td>
                            </tr>
                            <tr>
                                <td><strong>æµå¼è¾“å‡º</strong></td>
                                <td>å¯ç”¨ stream_mode="messages"</td>
                                <td>é¦–å­—å»¶è¿Ÿå‡å°‘ 80%</td>
                            </tr>
                            <tr>
                                <td><strong>å‘é‡ç´¢å¼•</strong></td>
                                <td>ä½¿ç”¨ HNSW ç´¢å¼•ï¼Œä¼˜åŒ–æ£€ç´¢</td>
                                <td>æ£€ç´¢é€Ÿåº¦æå‡ 10x</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="subsection-title">æ™ºèƒ½æ¨¡å‹è·¯ç”±</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
åŠ¨æ€æ¨¡å‹é€‰æ‹©
æ ¹æ®ä»»åŠ¡å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„æ¨¡å‹
"""
from langchain_openai import ChatOpenAI
from langchain.agents.middleware import CustomMiddleware

class SmartModelRouter(CustomMiddleware):
    """æ™ºèƒ½æ¨¡å‹è·¯ç”±ä¸­é—´ä»¶"""

    def __init__(self):
        self.cheap_model = ChatOpenAI(model="gpt-3.5-turbo")
        self.expensive_model = ChatOpenAI(model="gpt-4o")

    def before_model(self, state, config):
        """æ ¹æ®ä»»åŠ¡é€‰æ‹©æ¨¡å‹"""
        last_message = state["messages"][-1]
        content = last_message.get("content", "")

        # ç®€å•ä»»åŠ¡æ ‡è¯†
        simple_keywords = ["ä½ å¥½", "è°¢è°¢", "å†è§", "ä»€ä¹ˆæ—¶å€™", "å¤šå°‘é’±"]
        is_simple = any(kw in content for kw in simple_keywords)

        # å¤æ‚ä»»åŠ¡æ ‡è¯†
        complex_keywords = ["åˆ†æ", "è§£é‡Š", "è®¾è®¡", "è§„åˆ’", "å¯¹æ¯”"]
        is_complex = any(kw in content for kw in complex_keywords)

        # é€‰æ‹©æ¨¡å‹
        if is_simple:
            config["model"] = self.cheap_model
            print("ğŸŸ¢ ä½¿ç”¨ GPT-3.5-turboï¼ˆç®€å•ä»»åŠ¡ï¼‰")
        elif is_complex:
            config["model"] = self.expensive_model
            print("ğŸ”´ ä½¿ç”¨ GPT-4oï¼ˆå¤æ‚ä»»åŠ¡ï¼‰")
        else:
            # é»˜è®¤ä½¿ç”¨ä¾¿å®œæ¨¡å‹
            config["model"] = self.cheap_model
            print("ğŸŸ¡ ä½¿ç”¨ GPT-3.5-turboï¼ˆé»˜è®¤ï¼‰")

        return state

# ä½¿ç”¨
agent = create_agent(
    model="gpt-4o",  # é»˜è®¤æ¨¡å‹
    tools=[...],
    middleware=[SmartModelRouter()],
)</code></pre>
                    </div>

                    <h3 class="subsection-title">Token ä¼˜åŒ–æŠ€å·§</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Token ä¼˜åŒ–ç¤ºä¾‹
å‡å°‘ä¸å¿…è¦çš„ Token æ¶ˆè€—
"""
from langchain.agents.middleware import SummarizationMiddleware

# 1. ä½¿ç”¨æ‘˜è¦ä¸­é—´ä»¶
summarization = SummarizationMiddleware(
    max_messages=10,  # ä¿ç•™æœ€è¿‘ 10 æ¡æ¶ˆæ¯
    summarize_older=True  # æ‘˜è¦æ—§æ¶ˆæ¯
)

# 2. ç²¾ç®€ç³»ç»Ÿæç¤ºè¯
# âŒ å†—é•¿çš„æç¤ºè¯
bad_prompt = """
ä½ æ˜¯ä¸€ä¸ªéå¸¸ä¸“ä¸šä¸”ç»éªŒä¸°å¯Œçš„å®¢æœåŠ©æ‰‹ã€‚
ä½ éœ€è¦å¸®åŠ©ç”¨æˆ·è§£å†³å„ç§å„æ ·çš„é—®é¢˜ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº...
è¯·å§‹ç»ˆä¿æŒç¤¼è²Œã€è€å¿ƒã€å‹å¥½çš„æ€åº¦...
ï¼ˆçœç•¥ 500 å­—ï¼‰
"""

# âœ… ç²¾ç®€çš„æç¤ºè¯
good_prompt = """
ä½ æ˜¯ä¸“ä¸šå®¢æœåŠ©æ‰‹ã€‚
èŒè´£ï¼šè§£ç­”é—®é¢˜ã€æŸ¥è¯¢è®¢å•ã€å¤„ç†å”®åã€‚
åŸåˆ™ï¼šç¤¼è²Œã€å‡†ç¡®ã€åŠæ—¶ã€‚
"""

# 3. é™åˆ¶å¯¹è¯å†å²é•¿åº¦
def trim_conversation_history(messages: list, max_messages: int = 20) -> list:
    """ä¿ç•™æœ€è¿‘çš„ N æ¡æ¶ˆæ¯"""
    if len(messages) <= max_messages:
        return messages

    # ä¿ç•™ç³»ç»Ÿæ¶ˆæ¯ + æœ€è¿‘çš„ç”¨æˆ·/AI æ¶ˆæ¯
    system_messages = [m for m in messages if m["role"] == "system"]
    recent_messages = messages[-max_messages:]

    return system_messages + recent_messages

# 4. ä½¿ç”¨æ›´å°çš„ Embedding æ¨¡å‹
from langchain_openai import OpenAIEmbeddings

# text-embedding-3-small: 512 ç»´ï¼Œæˆæœ¬æ›´ä½
embeddings = OpenAIEmbeddings(model="text-embedding-3-small")</code></pre>
                    </div>
                </section>

                <!-- æˆæœ¬æ§åˆ¶ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ’° æˆæœ¬æ§åˆ¶å»ºè®®</h2>

                    <h3 class="subsection-title">æˆæœ¬åˆ†æ</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>æˆæœ¬é¡¹</th>
                                <th>å æ¯”</th>
                                <th>ä¼˜åŒ–ç­–ç•¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>æ¨¡å‹è°ƒç”¨</strong></td>
                                <td>60-70%</td>
                                <td>é€‰æ‹©åˆé€‚æ¨¡å‹ã€å‡å°‘è°ƒç”¨æ¬¡æ•°ã€ç¼“å­˜ç»“æœ</td>
                            </tr>
                            <tr>
                                <td><strong>Embeddings</strong></td>
                                <td>15-20%</td>
                                <td>ä½¿ç”¨æ›´å°æ¨¡å‹ã€æ‰¹é‡å¤„ç†ã€ç¼“å­˜å‘é‡</td>
                            </tr>
                            <tr>
                                <td><strong>å‘é‡æ•°æ®åº“</strong></td>
                                <td>10-15%</td>
                                <td>é€‰æ‹©å¼€æºæ–¹æ¡ˆï¼ˆChromaï¼‰ã€ä¼˜åŒ–ç´¢å¼•å¤§å°</td>
                            </tr>
                            <tr>
                                <td><strong>å…¶ä»–åŸºç¡€è®¾æ–½</strong></td>
                                <td>5-10%</td>
                                <td>ä½¿ç”¨ Serverlessã€æŒ‰éœ€æ‰©ç¼©å®¹</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="subsection-title">æˆæœ¬ä¼˜åŒ–å®è·µ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æˆæœ¬ä¼˜åŒ–å®Œæ•´ç¤ºä¾‹
"""
import functools
from datetime import datetime, timedelta

# 1. ç»“æœç¼“å­˜
cache = {}

def cache_result(ttl_seconds: int = 3600):
    """ç¼“å­˜è£…é¥°å™¨"""
    def decorator(func):
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            cache_key = f"{func.__name__}:{args}:{kwargs}"

            # æ£€æŸ¥ç¼“å­˜
            if cache_key in cache:
                result, timestamp = cache[cache_key]
                if datetime.now() - timestamp < timedelta(seconds=ttl_seconds):
                    print(f"ğŸ’° ä½¿ç”¨ç¼“å­˜ç»“æœï¼š{func.__name__}")
                    return result

            # æ‰§è¡Œå‡½æ•°
            result = func(*args, **kwargs)

            # ä¿å­˜ç¼“å­˜
            cache[cache_key] = (result, datetime.now())
            return result

        return wrapper
    return decorator

# 2. FAQ ç¼“å­˜
@cache_result(ttl_seconds=3600)  # ç¼“å­˜ 1 å°æ—¶
def search_faq_cached(query: str) -> str:
    """å¸¦ç¼“å­˜çš„ FAQ æœç´¢"""
    return search_faq(query)

# 3. æ‰¹é‡ Embedding
def batch_embed_documents(texts: list[str], batch_size: int = 100):
    """æ‰¹é‡ç”Ÿæˆ Embeddingsï¼Œé™ä½æˆæœ¬"""
    embeddings_model = OpenAIEmbeddings(model="text-embedding-3-small")

    all_embeddings = []
    for i in range(0, len(texts), batch_size):
        batch = texts[i:i + batch_size]
        batch_embeddings = embeddings_model.embed_documents(batch)
        all_embeddings.extend(batch_embeddings)

    return all_embeddings

# 4. é™æµä¿æŠ¤
import time
from collections import deque

class RateLimiter:
    """ç®€å•çš„é™æµå™¨"""

    def __init__(self, max_requests: int, time_window: int):
        self.max_requests = max_requests
        self.time_window = time_window
        self.requests = deque()

    def allow_request(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚"""
        now = time.time()

        # æ¸…ç†è¿‡æœŸè¯·æ±‚
        while self.requests and self.requests[0] < now - self.time_window:
            self.requests.popleft()

        # æ£€æŸ¥é™åˆ¶
        if len(self.requests) >= self.max_requests:
            return False

        # è®°å½•è¯·æ±‚
        self.requests.append(now)
        return True

# ä½¿ç”¨é™æµå™¨
rate_limiter = RateLimiter(max_requests=100, time_window=60)  # æ¯åˆ†é’Ÿ 100 æ¬¡

def process_request(user_message: str):
    if not rate_limiter.allow_request():
        return "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"

    # å¤„ç†è¯·æ±‚
    return agent.invoke({"messages": [{"role": "user", "content": user_message}]})

# 5. æˆæœ¬ç›‘æ§
def track_cost(num_input_tokens: int, num_output_tokens: int, model: str):
    """è¿½è¸ªæˆæœ¬"""
    # GPT-4o å®šä»·ï¼ˆç¤ºä¾‹ï¼‰
    pricing = {
        "gpt-4o": {"input": 0.00001, "output": 0.00003},  # æ¯ token ä»·æ ¼
        "gpt-3.5-turbo": {"input": 0.000001, "output": 0.000002},
    }

    price = pricing.get(model, pricing["gpt-4o"])
    cost = num_input_tokens * price["input"] + num_output_tokens * price["output"]

    print(f"ğŸ’¸ æœ¬æ¬¡è°ƒç”¨æˆæœ¬ï¼š${cost:.6f}")
    return cost</code></pre>
                    </div>
                </section>

                <!-- ç›‘æ§å’Œå¯è§‚æµ‹æ€§ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“Š ç›‘æ§å’Œå¯è§‚æµ‹æ€§</h2>
                    <p>
                        ä½¿ç”¨ <strong>LangSmith</strong> è¿›è¡Œå…¨é¢çš„è¿½è¸ªã€ç›‘æ§å’Œè°ƒè¯•ã€‚
                    </p>

                    <h3 class="subsection-title">LangSmith é›†æˆ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
LangSmith è¿½è¸ªé…ç½®
"""
import os

# é…ç½® LangSmith
os.environ["LANGCHAIN_TRACING_V2"] = "true"
os.environ["LANGCHAIN_API_KEY"] = "your-api-key"
os.environ["LANGCHAIN_PROJECT"] = "customer-service-bot"  # é¡¹ç›®åç§°

# æ‰€æœ‰ Agent è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨è¿½è¸ª
result = agent.invoke({"messages": [...]})

# æŸ¥çœ‹è¿½è¸ªï¼šhttps://smith.langchain.com/</code></pre>
                    </div>

                    <h3 class="subsection-title">å…³é”®æŒ‡æ ‡ç›‘æ§</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>æŒ‡æ ‡ç±»å‹</th>
                                <th>å…·ä½“æŒ‡æ ‡</th>
                                <th>ç›®æ ‡å€¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>æ€§èƒ½æŒ‡æ ‡</strong></td>
                                <td>P50/P95/P99 å»¶è¿Ÿ<br/>é¦–å­—å»¶è¿Ÿï¼ˆTTFTï¼‰</td>
                                <td>P95 < 3s<br/>TTFT < 1s</td>
                            </tr>
                            <tr>
                                <td><strong>è´¨é‡æŒ‡æ ‡</strong></td>
                                <td>ä»»åŠ¡å®Œæˆç‡<br/>ç”¨æˆ·æ»¡æ„åº¦</td>
                                <td>> 85%<br/>> 4.0/5.0</td>
                            </tr>
                            <tr>
                                <td><strong>æˆæœ¬æŒ‡æ ‡</strong></td>
                                <td>æ¯æ¬¡å¯¹è¯æˆæœ¬<br/>Token ä½¿ç”¨æ•ˆç‡</td>
                                <td>< $0.10<br/>Token/å›ç­” < 1000</td>
                            </tr>
                            <tr>
                                <td><strong>å¯é æ€§æŒ‡æ ‡</strong></td>
                                <td>é”™è¯¯ç‡<br/>è¶…æ—¶ç‡</td>
                                <td>< 1%<br/>< 2%</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="subsection-title">è‡ªå®šä¹‰æ—¥å¿—</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ç»“æ„åŒ–æ—¥å¿—è®°å½•
"""
import logging
import json
from datetime import datetime

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger("customer-service")

class LoggingMiddleware(CustomMiddleware):
    """æ—¥å¿—è®°å½•ä¸­é—´ä»¶"""

    def before_agent(self, state, config):
        """è®°å½•è¯·æ±‚å¼€å§‹"""
        user_message = state["messages"][-1].get("content", "")

        log_data = {
            "event": "agent_request",
            "timestamp": datetime.now().isoformat(),
            "user_id": config.get("context", {}).get("user_id"),
            "message_preview": user_message[:100],
        }

        logger.info(json.dumps(log_data, ensure_ascii=False))
        return state

    def after_agent(self, state, config):
        """è®°å½•å“åº”å®Œæˆ"""
        ai_message = state["messages"][-1]

        log_data = {
            "event": "agent_response",
            "timestamp": datetime.now().isoformat(),
            "user_id": config.get("context", {}).get("user_id"),
            "has_tool_calls": hasattr(ai_message, "tool_calls") and bool(ai_message.tool_calls),
            "response_length": len(ai_message.content) if hasattr(ai_message, "content") else 0,
        }

        logger.info(json.dumps(log_data, ensure_ascii=False))
        return state

# ä½¿ç”¨
agent = create_agent(
    model="gpt-4o",
    tools=[...],
    middleware=[LoggingMiddleware()],
)</code></pre>
                    </div>
                </section>

                <!-- æµ‹è¯•ç­–ç•¥ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ§ª æµ‹è¯•ç­–ç•¥</h2>

                    <h3 class="subsection-title">æµ‹è¯•é‡‘å­—å¡”</h3>
                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph TB
    A[E2E æµ‹è¯•<br/>10%] --> B[é›†æˆæµ‹è¯•<br/>30%]
    B --> C[å•å…ƒæµ‹è¯•<br/>60%]

    A1[å®Œæ•´å¯¹è¯æµç¨‹<br/>çœŸå®åœºæ™¯æµ‹è¯•] -.-> A
    B1[Agent + å·¥å…·<br/>æ¨¡æ‹Ÿ LLM] -.-> B
    C1[å·¥å…·å‡½æ•°<br/>è¾¹ç•Œæ¡ä»¶] -.-> C

    style A fill:#ef4444,color:#fff
    style B fill:#f59e0b,color:#fff
    style C fill:#10b981,color:#fff
                        </div>
                    </div>

                    <h3 class="subsection-title">å•å…ƒæµ‹è¯•ç¤ºä¾‹</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
å·¥å…·å•å…ƒæµ‹è¯•
"""
import pytest
from unittest.mock import Mock

def test_get_my_orders():
    """æµ‹è¯•è®¢å•æŸ¥è¯¢å·¥å…·"""
    # æ¨¡æ‹Ÿ Runtime
    mock_runtime = Mock()
    mock_runtime.context = {"user_id": "user_123"}

    # è°ƒç”¨å·¥å…·
    result = get_my_orders.invoke({"runtime": mock_runtime})

    # æ–­è¨€
    assert "è®¢å•" in result
    assert "user_123" in result or len(result) > 0

def test_search_faq_with_valid_query():
    """æµ‹è¯• FAQ æœç´¢ï¼ˆæœ‰æ•ˆæŸ¥è¯¢ï¼‰"""
    result = search_faq.invoke({"query": "é…é€æ—¶é—´"})

    assert "é…é€" in result or "å·¥ä½œæ—¥" in result
    assert len(result) > 0

def test_search_faq_with_invalid_query():
    """æµ‹è¯• FAQ æœç´¢ï¼ˆæ— æ•ˆæŸ¥è¯¢ï¼‰"""
    result = search_faq.invoke({"query": "askdjflkajsdf"})

    assert "æ²¡æœ‰æ‰¾åˆ°" in result or "æŠ±æ­‰" in result

def test_cancel_order_without_permission():
    """æµ‹è¯•å–æ¶ˆè®¢å•ï¼ˆæ— æƒé™ï¼‰"""
    mock_runtime = Mock()
    mock_runtime.context = {"user_id": "wrong_user"}

    result = cancel_order.invoke({
        "order_id": "ORDER-2024001",
        "reason": "æµ‹è¯•",
        "runtime": mock_runtime
    })

    assert "æœªæ‰¾åˆ°" in result or "æ— æ³•å–æ¶ˆ" in result</code></pre>
                    </div>

                    <h3 class="subsection-title">é›†æˆæµ‹è¯•ç¤ºä¾‹</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Agent é›†æˆæµ‹è¯•ï¼ˆæ¨¡æ‹Ÿ LLMï¼‰
"""
import pytest
from unittest.mock import patch

@patch('langchain_openai.ChatOpenAI.invoke')
def test_agent_faq_flow(mock_llm):
    """æµ‹è¯• FAQ æŸ¥è¯¢æµç¨‹"""
    # æ¨¡æ‹Ÿ LLM è¿”å›å·¥å…·è°ƒç”¨
    mock_llm.return_value = Mock(
        content="",
        tool_calls=[{
            "name": "search_faq",
            "args": {"query": "é…é€æ—¶é—´"},
            "id": "call_123"
        }]
    )

    # åˆ›å»º Agent
    agent = create_agent(
        model="gpt-4o",
        tools=[search_faq],
    )

    # è°ƒç”¨
    result = agent.invoke({
        "messages": [{"role": "user", "content": "å¤šä¹…èƒ½æ”¶åˆ°è´§ï¼Ÿ"}]
    })

    # éªŒè¯å·¥å…·è¢«è°ƒç”¨
    assert any("é…é€" in str(msg) for msg in result["messages"])

def test_agent_with_checkpointer():
    """æµ‹è¯•å¤šè½®å¯¹è¯ï¼ˆçœŸå® Agentï¼‰"""
    from langgraph.checkpoint.memory import InMemorySaver

    checkpointer = InMemorySaver()
    agent = create_agent(
        model="gpt-3.5-turbo",  # ä½¿ç”¨ä¾¿å®œæ¨¡å‹æµ‹è¯•
        tools=[get_my_orders],
        checkpointer=checkpointer,
    )

    config = {"configurable": {"thread_id": "test_001"}}

    # ç¬¬ä¸€è½®å¯¹è¯
    result1 = agent.invoke(
        {"messages": [{"role": "user", "content": "ä½ å¥½"}]},
        config=config
    )

    # ç¬¬äºŒè½®å¯¹è¯ï¼ˆåº”è¯¥è®°ä½ä¸Šä¸‹æ–‡ï¼‰
    result2 = agent.invoke(
        {"messages": [{"role": "user", "content": "æˆ‘åˆšæ‰è¯´äº†ä»€ä¹ˆï¼Ÿ"}]},
        config=config
    )

    # éªŒè¯å¯¹è¯å†å²
    assert len(result2["messages"]) > 2  # åŒ…å«å†å²æ¶ˆæ¯</code></pre>
                    </div>
                </section>

                <!-- ç”Ÿäº§ç¯å¢ƒé…ç½® -->
                <section class="content-section">
                    <h2 class="section-title">ğŸš€ ç”Ÿäº§ç¯å¢ƒé…ç½®</h2>

                    <h3 class="subsection-title">å®Œæ•´é…ç½®ç¤ºä¾‹</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§ - ç”Ÿäº§çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ç”Ÿäº§ç¯å¢ƒ Agent é…ç½®
åŒ…å«æ‰€æœ‰æœ€ä½³å®è·µ
"""
import os
from langchain.agents import create_agent
from langchain.agents.middleware import (
    PIIMiddleware,
    HumanInTheLoopMiddleware,
    SummarizationMiddleware,
)
from langgraph.checkpoint.postgres import PostgresSaver
from langgraph.store.postgres import PostgresStore

# ==================== ç¯å¢ƒé…ç½® ====================

# æ•°æ®åº“è¿æ¥
DB_URI = os.getenv("DATABASE_URL")
assert DB_URI, "DATABASE_URL ç¯å¢ƒå˜é‡æœªè®¾ç½®"

# LangSmith è¿½è¸ª
os.environ["LANGCHAIN_TRACING_V2"] = "true"
os.environ["LANGCHAIN_API_KEY"] = os.getenv("LANGSMITH_API_KEY")
os.environ["LANGCHAIN_PROJECT"] = "production-customer-service"

# ==================== æŒä¹…åŒ–é…ç½® ====================

with PostgresSaver.from_conn_string(DB_URI) as checkpointer:
    checkpointer.setup()

    with PostgresStore.from_conn_string(DB_URI) as store:
        store.setup()

        # ==================== ä¸­é—´ä»¶é…ç½® ====================

        # PII ä¿æŠ¤
        pii_middleware = PIIMiddleware(
            pii_types=["email", "phone_number", "credit_card", "ip_address"],
            strategy="redact",
            custom_patterns={
                "chinese_id": r"\d{17}[\dXx]",
                "bank_card": r"\d{16,19}",
            }
        )

        # å¯¹è¯æ‘˜è¦
        summarization = SummarizationMiddleware(
            max_messages=20,
            summarize_older=True
        )

        # æ•æ„Ÿæ“ä½œå®¡æ ¸
        hitl = HumanInTheLoopMiddleware(
            interrupt_on={
                "cancel_order": True,
                "refund_order": True,
                "delete_user_data": True,
            }
        )

        # è‡ªå®šä¹‰ä¸­é—´ä»¶
        logging_middleware = LoggingMiddleware()
        content_safety = ContentSafetyGuardrail()

        # ==================== åˆ›å»º Agent ====================

        production_agent = create_agent(
            model="gpt-4o",
            tools=all_production_tools,  # æ‰€æœ‰å·¥å…·
            middleware=[
                logging_middleware,      # æ—¥å¿—
                pii_middleware,          # PII ä¿æŠ¤
                summarization,           # æ‘˜è¦
                hitl,                    # äººå·¥ä»‹å…¥
                content_safety,          # å†…å®¹å®‰å…¨
            ],
            checkpointer=checkpointer,   # PostgreSQL æŒä¹…åŒ–
            store=store,                 # PostgreSQL Store
            context_schema=CustomerContext,
            system_prompt=generate_production_prompt(),  # åŠ¨æ€æç¤ºè¯
        )

        # ==================== ç›‘æ§å’Œå‘Šè­¦ ====================

        def invoke_with_monitoring(user_message: str, user_id: str, thread_id: str):
            """å¸¦ç›‘æ§çš„è°ƒç”¨"""
            import time

            start_time = time.time()

            try:
                config = {
                    "configurable": {"thread_id": thread_id},
                    "context": {"user_id": user_id}
                }

                result = production_agent.invoke(
                    {"messages": [{"role": "user", "content": user_message}]},
                    config=config
                )

                # è®°å½•æˆåŠŸ
                latency = time.time() - start_time
                logger.info(json.dumps({
                    "event": "agent_success",
                    "user_id": user_id,
                    "latency": latency,
                }))

                return result

            except Exception as e:
                # è®°å½•é”™è¯¯
                logger.error(json.dumps({
                    "event": "agent_error",
                    "user_id": user_id,
                    "error": str(e),
                }))

                # å‘é€å‘Šè­¦
                # send_alert(f"Agent error: {e}")

                # è¿”å›å‹å¥½é”™è¯¯æ¶ˆæ¯
                return {
                    "messages": [{
                        "role": "assistant",
                        "content": "æŠ±æ­‰ï¼Œç³»ç»Ÿé‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚è¯·ç¨åå†è¯•æˆ–è”ç³»å®¢æœã€‚"
                    }]
                }

        # ==================== å¥åº·æ£€æŸ¥ ====================

        def health_check():
            """å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
            checks = {
                "database": check_database_connection(DB_URI),
                "model": check_model_availability(),
                "vector_store": check_vector_store(),
            }

            all_healthy = all(checks.values())

            return {
                "status": "healthy" if all_healthy else "unhealthy",
                "checks": checks
            }</code></pre>
                    </div>
                </section>

                <!-- å¸¸è§é—®é¢˜ -->
                <section class="content-section">
                    <h2 class="section-title">â“ å¸¸è§é—®é¢˜</h2>

                    <h3 class="subsection-subtitle">Q1: å¦‚ä½•å¹³è¡¡æˆæœ¬å’Œè´¨é‡ï¼Ÿ</h3>
                    <p>
                        <strong>åˆ†å±‚ç­–ç•¥</strong>ï¼š
                    </p>
                    <ul>
                        <li>ç®€å•ä»»åŠ¡ï¼ˆFAQã€é—®å€™ï¼‰â†’ GPT-3.5-turbo</li>
                        <li>ä¸­ç­‰ä»»åŠ¡ï¼ˆè®¢å•æŸ¥è¯¢ã€æ•°æ®åˆ†æï¼‰â†’ GPT-4o-mini</li>
                        <li>å¤æ‚ä»»åŠ¡ï¼ˆå¤æ‚æ¨ç†ã€åˆ›ä½œï¼‰â†’ GPT-4o</li>
                        <li>ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è°ƒç”¨</li>
                        <li>ç›‘æ§æ¯ä¸ªä»»åŠ¡çš„å®é™…æˆæœ¬</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q2: Guardrails ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ</h3>
                    <p>
                        <strong>ç¡®å®šæ€§ Guardrails</strong>ï¼ˆæ­£åˆ™ã€å…³é”®è¯ï¼‰å‡ ä¹æ— å½±å“ï¼ˆ<5msï¼‰<br/>
                        <strong>æ¨¡å‹åŒ– Guardrails</strong>ï¼ˆä½¿ç”¨ LLMï¼‰ä¼šå¢åŠ å»¶è¿Ÿå’Œæˆæœ¬
                    </p>
                    <p>
                        <strong>å»ºè®®</strong>ï¼š
                    </p>
                    <ul>
                        <li>è¾“å…¥éªŒè¯ä½¿ç”¨ç¡®å®šæ€§æ–¹æ³•</li>
                        <li>è¾“å‡ºéªŒè¯ä½¿ç”¨å¿«é€Ÿçš„å°æ¨¡å‹ï¼ˆgpt-4o-miniï¼‰</li>
                        <li>å¼‚æ­¥æ‰§è¡Œéå…³é”®æ£€æŸ¥</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q3: å¦‚ä½•è°ƒè¯•ç”Ÿäº§ç¯å¢ƒçš„é—®é¢˜ï¼Ÿ</h3>
                    <ol>
                        <li><strong>å¯ç”¨ LangSmith</strong>ï¼šæŸ¥çœ‹å®Œæ•´çš„æ‰§è¡Œè½¨è¿¹</li>
                        <li><strong>ç»“æ„åŒ–æ—¥å¿—</strong>ï¼šè®°å½•å…³é”®äº‹ä»¶å’Œå‚æ•°</li>
                        <li><strong>ä¿å­˜å¤±è´¥æ¡ˆä¾‹</strong>ï¼šè‡ªåŠ¨ä¿å­˜é”™è¯¯çš„è¾“å…¥å’Œè¾“å‡º</li>
                        <li><strong>æœ¬åœ°å¤ç°</strong>ï¼šä½¿ç”¨ç›¸åŒçš„ thread_id å’Œè¾“å…¥å¤ç°é—®é¢˜</li>
                        <li><strong>A/B æµ‹è¯•</strong>ï¼šå¯¹æ¯”ä¸åŒé…ç½®çš„æ•ˆæœ</li>
                    </ol>

                    <h3 class="subsection-subtitle">Q4: æç¤ºè¯å·¥ç¨‹çš„ä¼˜å…ˆçº§ï¼Ÿ</h3>
                    <p>
                        <strong>ä¼˜åŒ–é¡ºåº</strong>ï¼š
                    </p>
                    <ol>
                        <li><strong>æ˜ç¡®ä»»åŠ¡</strong>ï¼šæ¸…æ™°å®šä¹‰ Agent çš„èŒè´£èŒƒå›´</li>
                        <li><strong>æä¾›ç¤ºä¾‹</strong>ï¼šFew-shot examples æœ€æœ‰æ•ˆ</li>
                        <li><strong>ç»“æ„åŒ–è¾“å‡º</strong>ï¼šä½¿ç”¨ JSON Schema çº¦æŸæ ¼å¼</li>
                        <li><strong>åŠ¨æ€ä¸Šä¸‹æ–‡</strong>ï¼šæ³¨å…¥ç›¸å…³ä¿¡æ¯</li>
                        <li><strong>ç²¾ç®€è¯­è¨€</strong>ï¼šå»é™¤å†—ä½™ï¼ŒèŠ‚çœ Token</li>
                    </ol>

                    <h3 class="subsection-subtitle">Q5: ä»€ä¹ˆæ—¶å€™åº”è¯¥é‡æ„ï¼Ÿ</h3>
                    <p>
                        å‡ºç°ä»¥ä¸‹ä¿¡å·æ—¶è€ƒè™‘é‡æ„ï¼š
                    </p>
                    <ul>
                        <li>å•æ¬¡è°ƒç”¨æˆæœ¬ > $0.50</li>
                        <li>P95 å»¶è¿Ÿ > 10 ç§’</li>
                        <li>é”™è¯¯ç‡ > 5%</li>
                        <li>ç”¨æˆ·æ»¡æ„åº¦ < 3.5/5.0</li>
                        <li>æç¤ºè¯è¶…è¿‡ 2000 tokens</li>
                        <li>å·¥å…·æ•°é‡ > 20 ä¸ª</li>
                    </ul>
                </section>

                <!-- å‚è€ƒèµ„æº -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“– å‚è€ƒèµ„æº</h2>
                    <ul>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/guardrails" target="_blank">
                                LangChain Guardrails æ–‡æ¡£
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/context-engineering" target="_blank">
                                Context Engineering æ–‡æ¡£
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.smith.langchain.com/" target="_blank">
                                LangSmith æ–‡æ¡£
                            </a>
                        </li>
                        <li>
                            <a href="https://platform.openai.com/docs/guides/production-best-practices" target="_blank">
                                OpenAI ç”Ÿäº§æœ€ä½³å®è·µ
                            </a>
                        </li>
                    </ul>
                </section>

                <!-- é¡µé¢å¯¼èˆª -->
                <nav class="page-navigation">
                    <a href="16-customer-service.html" class="nav-button prev">
                        â† ä¸Šä¸€é¡µï¼šå®¢æœæœºå™¨äººå®æˆ˜
                    </a>
                    <a href="18-api-reference.html" class="nav-button next">
                        ä¸‹ä¸€é¡µï¼šAPI é€ŸæŸ¥è¡¨ â†’
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" aria-label="è¿”å›é¡¶éƒ¨">â†‘</button>

    <!-- JavaScript -->
    <script src="assets/js/mermaid-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
