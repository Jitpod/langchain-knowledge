<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Multi-Agent è‡ªå®šä¹‰å·¥ä½œæµ - å¤æ‚ä¸šåŠ¡æµç¨‹ç¼–æ’">
    <title>Multi-Agent è‡ªå®šä¹‰å·¥ä½œæµ | LangChain 1.0 Python çŸ¥è¯†æ–‡æ¡£</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <button class="mobile-menu-button" aria-label="æ‰“å¼€èœå•">â˜°</button>

    <div class="container">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">ğŸ¦œ LangChain 1.0</h1>
                <p class="sidebar-subtitle">Python å®Œæ•´å­¦ä¹ æŒ‡å—</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-section">
                    <div class="nav-section-title">å¼€å§‹</div>
                    <ul>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <span class="nav-icon">ğŸ </span>
                                ä¸»é¡µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">åŸºç¡€ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="01-introduction.html" class="nav-link">
                                <span class="nav-icon">ğŸ“–</span>
                                LangChain ç®€ä»‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="02-architecture.html" class="nav-link">
                                <span class="nav-icon">ğŸ—ï¸</span>
                                æ ¸å¿ƒæ¶æ„
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="03-models.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤–</span>
                                æ¨¡å‹æ¥å£
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="04-messages.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¬</span>
                                æ¶ˆæ¯ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="05-tools.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                å·¥å…·ç³»ç»Ÿ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">è¿›é˜¶ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="06-agents.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                Agent åŸºç¡€
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="07-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="08-rag.html" class="nav-link">
                                <span class="nav-icon">ğŸ”</span>
                                RAG è¯¦è§£
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="09-lcel.html" class="nav-link">
                                <span class="nav-icon">ğŸ”—</span>
                                LCEL è¡¨è¾¾å¼
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">é«˜çº§åº”ç”¨</div>
                    <ul>
                        <li class="nav-item">
                            <a href="10-runtime.html" class="nav-link">
                                <span class="nav-icon">ğŸ”Œ</span>
                                Runtime ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="11-checkpointer.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¾</span>
                                æŒä¹…åŒ–ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="12-streaming.html" class="nav-link">
                                <span class="nav-icon">ğŸŒŠ</span>
                                æµå¼è¾“å‡º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="13-human-in-loop.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="14-long-term-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ—„ï¸</span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="15-langgraph.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                LangGraph
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å®æˆ˜ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="16-customer-service.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å®¢æœæœºå™¨äºº
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="17-best-practices.html" class="nav-link">
                                <span class="nav-icon">âœ¨</span>
                                æœ€ä½³å®è·µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å‚è€ƒç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="18-api-reference.html" class="nav-link">
                                <span class="nav-icon">ğŸ“š</span>
                                API é€ŸæŸ¥è¡¨
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="19-troubleshooting.html" class="nav-link">
                                <span class="nav-icon">ğŸ›</span>
                                æ•…éšœæ’é™¤
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="20-migration.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                è¿ç§»æŒ‡å—
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">æ‰©å±•ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="21-structured-output.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                ç»“æ„åŒ–è¾“å‡º
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">DeepAgents ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="22-deepagents-quickstart.html" class="nav-link">
                                <span class="nav-icon">ğŸš€</span>
                                å¿«é€Ÿå¼€å§‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="23-deepagents-customization.html" class="nav-link">
                                <span class="nav-icon">ğŸ¨</span>
                                å®šåˆ¶åŒ–
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="24-deepagents-harness.html" class="nav-link">
                                <span class="nav-icon">ğŸ›ï¸</span>
                                Harness ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="25-deepagents-backends.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                åç«¯é…ç½®
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="26-deepagents-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="27-deepagents-hitl.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="28-deepagents-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ§ </span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="29-deepagents-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">Multi-Agent ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="30-multi-agent-index.html" class="nav-link">
                                <span class="nav-icon">ğŸŒ</span>
                                æ¦‚è¿°
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="31-multi-agent-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="32-multi-agent-handoffs.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                äº¤æ¥æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="33-multi-agent-skills.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="34-multi-agent-router.html" class="nav-link">
                                <span class="nav-icon">ğŸ§­</span>
                                è·¯ç”±æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item active">
                            <a href="35-multi-agent-workflow.html" class="nav-link">
                                <span class="nav-icon">ğŸ”€</span>
                                è‡ªå®šä¹‰å·¥ä½œæµ
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">
                        <a href="index.html" class="breadcrumb-link">ä¸»é¡µ</a>
                    </span>
                    <span class="breadcrumb-item">
                        Multi-Agent ç¯‡
                    </span>
                    <span class="breadcrumb-item">
                        è‡ªå®šä¹‰å·¥ä½œæµ
                    </span>
                </nav>

                <!-- é¡µé¢æ ‡é¢˜ -->
                <header class="page-header">
                    <h1 class="page-title">ğŸ”€ Multi-Agent è‡ªå®šä¹‰å·¥ä½œæµ</h1>
                    <p class="page-subtitle">
                        è®¾è®¡å’Œå®ç°å¤æ‚çš„å¤šä»£ç†ä¸šåŠ¡æµç¨‹ï¼Œçµæ´»ç»„åˆ Subagentsã€Handoffsã€Skills å’Œ Routerï¼Œ
                        æ„å»ºé€‚åº”å„ç§ä¸šåŠ¡åœºæ™¯çš„ä¼ä¸šçº§å·¥ä½œæµç³»ç»Ÿã€‚
                    </p>
                </header>

                <!-- ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰å·¥ä½œæµ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“š ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰å·¥ä½œæµï¼Ÿ</h2>
                    <p>
                        <strong>è‡ªå®šä¹‰å·¥ä½œæµï¼ˆCustom Workflowï¼‰</strong>æ˜¯ Multi-Agent ç³»ç»Ÿä¸­çš„<strong>é«˜çº§ç¼–æ’æ¨¡å¼</strong>ã€‚
                        å¼€å‘è€…ä½¿ç”¨ LangGraph å®Œå…¨æ§åˆ¶å›¾ç»“æ„ï¼Œå°†<strong>ç¡®å®šæ€§é€»è¾‘</strong>ä¸<strong>æ™ºèƒ½å†³ç­–</strong>ç»“åˆï¼Œ
                        æ„å»ºé€‚åº”å¤æ‚ä¸šåŠ¡åœºæ™¯çš„å®šåˆ¶åŒ–æµç¨‹ã€‚
                    </p>

                    <div class="info-box note">
                        <div class="info-box-title">ğŸ’¡ æ ¸å¿ƒç‰¹æ€§</div>
                        <table style="margin-top: 0.5rem;">
                            <thead>
                                <tr>
                                    <th>ç‰¹æ€§</th>
                                    <th>è¯´æ˜</th>
                                    <th>ä¼˜åŠ¿</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>å®Œå…¨æ§åˆ¶</strong></td>
                                    <td>å®Œå…¨æŒæ§å›¾ç»“æ„å’Œæ‰§è¡Œæµç¨‹</td>
                                    <td>çµæ´»é€‚åº”ä»»ä½•ä¸šåŠ¡éœ€æ±‚</td>
                                </tr>
                                <tr>
                                    <td><strong>æ··åˆé€»è¾‘</strong></td>
                                    <td>ç¡®å®šæ€§æ­¥éª¤ + AI å†³ç­–</td>
                                    <td>å¹³è¡¡å¯é æ€§å’Œæ™ºèƒ½æ€§</td>
                                </tr>
                                <tr>
                                    <td><strong>æ¨¡å¼ç»„åˆ</strong></td>
                                    <td>é›†æˆ Subagents/Handoffs/Skills/Router</td>
                                    <td>å¤ç”¨ç°æœ‰æ¨¡å¼èƒ½åŠ›</td>
                                </tr>
                                <tr>
                                    <td><strong>å¤šç§æ‰§è¡Œæ¨¡å¼</strong></td>
                                    <td>é¡ºåºã€å¹¶è¡Œã€æ¡ä»¶ã€å¾ªç¯</td>
                                    <td>æ”¯æŒå¤æ‚ä¸šåŠ¡åœºæ™¯</td>
                                </tr>
                                <tr>
                                    <td><strong>çŠ¶æ€ç®¡ç†</strong></td>
                                    <td>ç±»å‹åŒ–çŠ¶æ€å­—å…¸</td>
                                    <td>æ¸…æ™°çš„æ•°æ®æµè½¬</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph TB
    User["ç”¨æˆ·è¯·æ±‚"] --> CustomWF["è‡ªå®šä¹‰å·¥ä½œæµ"]

    subgraph CustomWF["è‡ªå®šä¹‰å·¥ä½œæµæ¶æ„"]
        Router["Router èŠ‚ç‚¹<br/>æ™ºèƒ½è·¯ç”±"]
        Validate["éªŒè¯èŠ‚ç‚¹<br/>ç¡®å®šæ€§é€»è¾‘"]
        Agent1["Agent èŠ‚ç‚¹<br/>æ™ºèƒ½å¤„ç†"]
        Parallel["å¹¶è¡ŒèŠ‚ç‚¹"]
        Condition["æ¡ä»¶èŠ‚ç‚¹<br/>åˆ†æ”¯å†³ç­–"]
        Subagent["Subagent èŠ‚ç‚¹<br/>å¤æ‚å­æµç¨‹"]
        Aggregate["æ±‡æ€»èŠ‚ç‚¹<br/>ç»“æœæ•´åˆ"]
    end

    Router --> Validate
    Validate --> Condition

    Condition -->|"ç®€å•ä»»åŠ¡"| Agent1
    Condition -->|"å¤æ‚ä»»åŠ¡"| Parallel

    Parallel --> P1["å­ä»»åŠ¡ 1"]
    Parallel --> P2["å­ä»»åŠ¡ 2"]
    Parallel --> P3["å­ä»»åŠ¡ 3"]

    P1 --> Aggregate
    P2 --> Aggregate
    P3 --> Aggregate

    Agent1 --> Subagent
    Aggregate --> Subagent
    Subagent --> Result["æœ€ç»ˆç»“æœ"]

    style CustomWF fill:#3b82f6,color:#fff
    style Router fill:#10b981,color:#fff
    style Validate fill:#f59e0b,color:#fff
    style Agent1 fill:#8b5cf6,color:#fff
    style Parallel fill:#ef4444,color:#fff
    style Condition fill:#06b6d4,color:#fff
    style Subagent fill:#a855f7,color:#fff
    style Aggregate fill:#ec4899,color:#fff
                        </div>
                    </div>

                    <h3 class="subsection-title">ä½•æ—¶ä½¿ç”¨è‡ªå®šä¹‰å·¥ä½œæµï¼Ÿ</h3>
                    <div class="info-box tip">
                        <div class="info-box-title">âœ… é€‚åˆä½¿ç”¨åœºæ™¯</div>
                        <ul>
                            <li><strong>æ ‡å‡†æ¨¡å¼æ— æ³•æ»¡è¶³</strong>ï¼šä¸šåŠ¡é€»è¾‘è¶…å‡º Subagents/Handoffs/Skills/Router çš„ç»„åˆ</li>
                            <li><strong>æ··åˆç¡®å®šæ€§å’Œæ™ºèƒ½</strong>ï¼šéœ€è¦åœ¨å›ºå®šæµç¨‹ä¸­åµŒå…¥ AI å†³ç­–</li>
                            <li><strong>å¤æ‚è·¯ç”±é€»è¾‘</strong>ï¼šå¤šæ¡ä»¶åˆ†æ”¯ã€åŠ¨æ€è·¯å¾„é€‰æ‹©</li>
                            <li><strong>å¤šé˜¶æ®µå¤„ç†</strong>ï¼šæ•°æ®é¢„å¤„ç† â†’ AI åˆ†æ â†’ åå¤„ç† â†’ éªŒè¯</li>
                            <li><strong>å¹¶è¡Œä»»åŠ¡åè°ƒ</strong>ï¼šåŒæ—¶æ‰§è¡Œå¤šä¸ªç‹¬ç«‹ä»»åŠ¡åæ±‡æ€»</li>
                            <li><strong>è¿­ä»£ä¼˜åŒ–æµç¨‹</strong>ï¼šå¾ªç¯æ”¹è¿›ç›´åˆ°æ»¡è¶³è´¨é‡æ ‡å‡†</li>
                        </ul>
                    </div>

                    <h3 class="subsection-title">è‡ªå®šä¹‰å·¥ä½œæµ vs æ ‡å‡†æ¨¡å¼</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>å¯¹æ¯”ç»´åº¦</th>
                                <th>æ ‡å‡†æ¨¡å¼</th>
                                <th>è‡ªå®šä¹‰å·¥ä½œæµ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>å¤æ‚åº¦</strong></td>
                                <td>ç®€å•ã€æ¨¡å¼åŒ–</td>
                                <td>å¤æ‚ã€é«˜åº¦å®šåˆ¶</td>
                            </tr>
                            <tr>
                                <td><strong>çµæ´»æ€§</strong></td>
                                <td>å—æ¨¡å¼é™åˆ¶</td>
                                <td>å®Œå…¨è‡ªç”±</td>
                            </tr>
                            <tr>
                                <td><strong>å¼€å‘æˆæœ¬</strong></td>
                                <td>ä½ï¼ˆä½¿ç”¨é¢„å®šä¹‰æ¨¡å¼ï¼‰</td>
                                <td>é«˜ï¼ˆéœ€è¦è®¾è®¡å’Œå®ç°ï¼‰</td>
                            </tr>
                            <tr>
                                <td><strong>ç»´æŠ¤æˆæœ¬</strong></td>
                                <td>ä½ï¼ˆæ ‡å‡†åŒ–ï¼‰</td>
                                <td>ä¸­ï¼ˆéœ€è¦æ–‡æ¡£å’Œæ³¨é‡Šï¼‰</td>
                            </tr>
                            <tr>
                                <td><strong>é€‚ç”¨åœºæ™¯</strong></td>
                                <td>å¸¸è§ä¸šåŠ¡åœºæ™¯</td>
                                <td>ç‰¹æ®Šä¸šåŠ¡éœ€æ±‚</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- å·¥ä½œæµæ¨¡å¼ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ”§ å·¥ä½œæµæ‰§è¡Œæ¨¡å¼</h2>
                    <p>
                        è‡ªå®šä¹‰å·¥ä½œæµæ”¯æŒ<strong>å››ç§åŸºæœ¬æ‰§è¡Œæ¨¡å¼</strong>ï¼Œå¯ä»¥çµæ´»ç»„åˆæ„å»ºå¤æ‚æµç¨‹ã€‚
                    </p>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph TB
    subgraph Sequential["æ¨¡å¼ 1ï¼šé¡ºåºæ‰§è¡Œ"]
        S1["æ­¥éª¤ 1"] --> S2["æ­¥éª¤ 2"]
        S2 --> S3["æ­¥éª¤ 3"]
        S3 --> S4["æ­¥éª¤ 4"]
    end

    subgraph Parallel["æ¨¡å¼ 2ï¼šå¹¶è¡Œæ‰§è¡Œ"]
        P_Start["å¼€å§‹"] --> P1["ä»»åŠ¡ 1"]
        P_Start --> P2["ä»»åŠ¡ 2"]
        P_Start --> P3["ä»»åŠ¡ 3"]
        P1 --> P_End["æ±‡æ€»"]
        P2 --> P_End
        P3 --> P_End
    end

    subgraph Conditional["æ¨¡å¼ 3ï¼šæ¡ä»¶åˆ†æ”¯"]
        C_Start["å¼€å§‹"] --> C_Decision{"æ¡ä»¶åˆ¤æ–­"}
        C_Decision -->|"è·¯å¾„ A"| C_A["å¤„ç† A"]
        C_Decision -->|"è·¯å¾„ B"| C_B["å¤„ç† B"]
        C_Decision -->|"è·¯å¾„ C"| C_C["å¤„ç† C"]
    end

    subgraph Cyclic["æ¨¡å¼ 4ï¼šå¾ªç¯è¿­ä»£"]
        L_Start["å¼€å§‹"] --> L_Process["å¤„ç†"]
        L_Process --> L_Check{"æ»¡è¶³æ¡ä»¶ï¼Ÿ"}
        L_Check -->|"å¦"| L_Process
        L_Check -->|"æ˜¯"| L_End["ç»“æŸ"]
    end

    style Sequential fill:#10b981,color:#fff
    style Parallel fill:#f59e0b,color:#fff
    style Conditional fill:#8b5cf6,color:#fff
    style Cyclic fill:#ef4444,color:#fff
                        </div>
                    </div>

                    <h3 class="subsection-title">æ¨¡å¼ 1ï¼šé¡ºåºæ‰§è¡Œ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ¨¡å¼ 1ï¼šé¡ºåºæ‰§è¡Œ - RAG æµæ°´çº¿ç¤ºä¾‹
"""
from typing import TypedDict
from langgraph.graph import StateGraph, START, END
from langchain_openai import ChatOpenAI
from pydantic import BaseModel, Field

# ========== 1. å®šä¹‰çŠ¶æ€ ==========

class RAGState(TypedDict):
    question: str
    rewritten_query: str
    documents: list[str]
    answer: str

# ========== 2. èŠ‚ç‚¹å®šä¹‰ ==========

# èŠ‚ç‚¹ 1ï¼šæŸ¥è¯¢æ”¹å†™ï¼ˆLLMï¼‰
class RewrittenQuery(BaseModel):
    query: str = Field(description="æ”¹å†™åçš„æŸ¥è¯¢ï¼Œä¼˜åŒ–ç”¨äºæ£€ç´¢")

def rewrite_node(state: RAGState):
    """ä½¿ç”¨ LLM æ”¹å†™æŸ¥è¯¢"""
    llm = ChatOpenAI(model="gpt-4o")
    llm_with_structure = llm.with_structured_output(RewrittenQuery)

    prompt = f"""å°†ç”¨æˆ·é—®é¢˜æ”¹å†™ä¸ºæ›´é€‚åˆæ£€ç´¢çš„æŸ¥è¯¢ï¼š

ç”¨æˆ·é—®é¢˜ï¼š{state['question']}

è¦æ±‚ï¼š
- æå–æ ¸å¿ƒå…³é”®è¯
- è½¬æ¢ä¸ºé™ˆè¿°å¥
- å»é™¤å£è¯­åŒ–è¡¨è¾¾
"""

    rewritten = llm_with_structure.invoke(prompt)

    return {
        "rewritten_query": rewritten.query
    }

# èŠ‚ç‚¹ 2ï¼šæ–‡æ¡£æ£€ç´¢ï¼ˆç¡®å®šæ€§ï¼‰
def retrieve_node(state: RAGState):
    """ä»å‘é‡æ•°æ®åº“æ£€ç´¢æ–‡æ¡£"""
    # å®é™…ä¼šè°ƒç”¨å‘é‡æ•°æ®åº“
    # è¿™é‡Œæ¨¡æ‹Ÿæ£€ç´¢ç»“æœ
    query = state["rewritten_query"]

    # æ¨¡æ‹Ÿå‘é‡æ£€ç´¢
    retrieved_docs = [
        f"æ–‡æ¡£1ï¼šå…³äº {query} çš„å†…å®¹...",
        f"æ–‡æ¡£2ï¼š{query} çš„è¯¦ç»†è¯´æ˜...",
        f"æ–‡æ¡£3ï¼š{query} çš„æ¡ˆä¾‹ç ”ç©¶..."
    ]

    return {
        "documents": retrieved_docs
    }

# èŠ‚ç‚¹ 3ï¼šç­”æ¡ˆç”Ÿæˆï¼ˆLLM Agentï¼‰
def answer_node(state: RAGState):
    """åŸºäºæ£€ç´¢æ–‡æ¡£ç”Ÿæˆç­”æ¡ˆ"""
    llm = ChatOpenAI(model="claude-sonnet-4-5")

    context = "\n\n".join(state["documents"])
    prompt = f"""åŸºäºä»¥ä¸‹æ–‡æ¡£å›ç­”ç”¨æˆ·é—®é¢˜ï¼š

æ–‡æ¡£ï¼š
{context}

ç”¨æˆ·é—®é¢˜ï¼š{state['question']}

è¦æ±‚ï¼š
- ä»…åŸºäºæ–‡æ¡£å†…å®¹å›ç­”
- å¼•ç”¨å…·ä½“æ–‡æ¡£
- ç®€æ´æ¸…æ™°
"""

    response = llm.invoke(prompt)

    return {
        "answer": response.content
    }

# ========== 3. æ„å»ºé¡ºåºå·¥ä½œæµ ==========

workflow = StateGraph(RAGState)

# æ·»åŠ èŠ‚ç‚¹
workflow.add_node("rewrite", rewrite_node)
workflow.add_node("retrieve", retrieve_node)
workflow.add_node("answer", answer_node)

# å®šä¹‰é¡ºåºæ‰§è¡Œ
workflow.add_edge(START, "rewrite")
workflow.add_edge("rewrite", "retrieve")
workflow.add_edge("retrieve", "answer")
workflow.add_edge("answer", END)

# ç¼–è¯‘
app = workflow.compile()

# ä½¿ç”¨
result = app.invoke({
    "question": "LangChain æ˜¯ä»€ä¹ˆï¼Ÿ"
})

print(f"åŸå§‹é—®é¢˜ï¼š{result['question']}")
print(f"æ”¹å†™æŸ¥è¯¢ï¼š{result['rewritten_query']}")
print(f"æ£€ç´¢æ–‡æ¡£æ•°ï¼š{len(result['documents'])}")
print(f"ç­”æ¡ˆï¼š{result['answer']}")

# æ‰§è¡Œæµç¨‹ï¼š
# ç”¨æˆ·é—®é¢˜ â†’ æŸ¥è¯¢æ”¹å†™(LLM) â†’ æ–‡æ¡£æ£€ç´¢(ç¡®å®šæ€§) â†’ ç­”æ¡ˆç”Ÿæˆ(LLM) â†’ è¿”å›

# ä¼˜åŠ¿ï¼š
# - æµç¨‹æ¸…æ™°ï¼Œæ˜“äºç†è§£
# - æ··åˆ LLM å’Œç¡®å®šæ€§æ­¥éª¤
# - æ¯ä¸ªèŠ‚ç‚¹èŒè´£å•ä¸€</code></pre>
                    </div>

                    <h3 class="subsection-title">æ¨¡å¼ 2ï¼šå¹¶è¡Œæ‰§è¡Œ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ¨¡å¼ 2ï¼šå¹¶è¡Œæ‰§è¡Œ - å¤šæºæ•°æ®èšåˆ
"""
from typing import TypedDict
from langgraph.graph import StateGraph, START, END
from langchain_openai import ChatOpenAI

# å®šä¹‰çŠ¶æ€
class MultiSourceState(TypedDict):
    query: str
    web_results: str
    database_results: str
    api_results: str
    aggregated_answer: str

# å¹¶è¡ŒèŠ‚ç‚¹ 1ï¼šç½‘ç»œæœç´¢
def web_search_node(state: MultiSourceState):
    """æœç´¢ç½‘ç»œä¿¡æ¯"""
    # å®é™…ä¼šè°ƒç”¨æœç´¢ API
    return {
        "web_results": f"ç½‘ç»œæœç´¢ç»“æœï¼šå…³äº {state['query']} çš„æœ€æ–°ä¿¡æ¯..."
    }

# å¹¶è¡ŒèŠ‚ç‚¹ 2ï¼šæ•°æ®åº“æŸ¥è¯¢
def database_query_node(state: MultiSourceState):
    """æŸ¥è¯¢æ•°æ®åº“"""
    # å®é™…ä¼šæŸ¥è¯¢æ•°æ®åº“
    return {
        "database_results": f"æ•°æ®åº“æŸ¥è¯¢ï¼š{state['query']} çš„å†å²æ•°æ®..."
    }

# å¹¶è¡ŒèŠ‚ç‚¹ 3ï¼šAPI è°ƒç”¨
def api_call_node(state: MultiSourceState):
    """è°ƒç”¨å¤–éƒ¨ API"""
    # å®é™…ä¼šè°ƒç”¨ API
    return {
        "api_results": f"API æ•°æ®ï¼š{state['query']} çš„å®æ—¶æ•°æ®..."
    }

# æ±‡æ€»èŠ‚ç‚¹
def aggregate_node(state: MultiSourceState):
    """æ±‡æ€»æ‰€æœ‰æ¥æºçš„æ•°æ®"""
    llm = ChatOpenAI(model="gpt-4o")

    prompt = f"""æ•´åˆä»¥ä¸‹å¤šæºæ•°æ®ï¼Œç”Ÿæˆç»¼åˆç­”æ¡ˆï¼š

ç”¨æˆ·æŸ¥è¯¢ï¼š{state['query']}

ç½‘ç»œæ•°æ®ï¼š{state['web_results']}
æ•°æ®åº“æ•°æ®ï¼š{state['database_results']}
API æ•°æ®ï¼š{state['api_results']}

è¦æ±‚ï¼šç»¼åˆåˆ†æï¼Œç»™å‡ºå…¨é¢çš„ç­”æ¡ˆã€‚
"""

    response = llm.invoke(prompt)

    return {
        "aggregated_answer": response.content
    }

# æ„å»ºå¹¶è¡Œå·¥ä½œæµ
workflow = StateGraph(MultiSourceState)

# æ·»åŠ èŠ‚ç‚¹
workflow.add_node("web_search", web_search_node)
workflow.add_node("database_query", database_query_node)
workflow.add_node("api_call", api_call_node)
workflow.add_node("aggregate", aggregate_node)

# å¹¶è¡Œæ‰§è¡Œï¼šSTART åˆ°ä¸‰ä¸ªæ•°æ®æº
workflow.add_edge(START, "web_search")
workflow.add_edge(START, "database_query")
workflow.add_edge(START, "api_call")

# æ‰€æœ‰æ•°æ®æºå®Œæˆåæ±‡æ€»
workflow.add_edge("web_search", "aggregate")
workflow.add_edge("database_query", "aggregate")
workflow.add_edge("api_call", "aggregate")

workflow.add_edge("aggregate", END)

app = workflow.compile()

# ä½¿ç”¨
result = app.invoke({
    "query": "ä»Šå¹´ AI é¢†åŸŸçš„æœ€æ–°è¿›å±•"
})

print(f"ç»¼åˆç­”æ¡ˆï¼š{result['aggregated_answer']}")

# æ‰§è¡Œæµç¨‹ï¼š
#            â”Œâ†’ ç½‘ç»œæœç´¢ â”€â”
# ç”¨æˆ·æŸ¥è¯¢ â”€â”¼â†’ æ•°æ®åº“æŸ¥è¯¢ â”€â”¼â†’ æ±‡æ€» â†’ è¿”å›
#            â””â†’ API è°ƒç”¨ â”€â”˜

# ä¼˜åŠ¿ï¼š
# - æé«˜æ•ˆç‡ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
# - å¤šæºæ•°æ®æ•´åˆ
# - é™ä½æ€»å»¶è¿Ÿ</code></pre>
                    </div>

                    <h3 class="subsection-title">æ¨¡å¼ 3ï¼šæ¡ä»¶åˆ†æ”¯</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ¨¡å¼ 3ï¼šæ¡ä»¶åˆ†æ”¯ - åŸºäºå¤æ‚åº¦çš„åŠ¨æ€è·¯ç”±
"""
from typing import TypedDict, Literal
from langgraph.graph import StateGraph, START, END
from pydantic import BaseModel, Field
from langchain_openai import ChatOpenAI

# å®šä¹‰çŠ¶æ€
class ConditionalState(TypedDict):
    query: str
    complexity: str  # "simple", "medium", "complex"
    answer: str

# å¤æ‚åº¦è¯„ä¼°
class ComplexityAssessment(BaseModel):
    complexity: Literal["simple", "medium", "complex"] = Field(
        description="æŸ¥è¯¢å¤æ‚åº¦ï¼šsimple(ç®€å•), medium(ä¸­ç­‰), complex(å¤æ‚)"
    )
    reason: str = Field(description="åˆ¤æ–­ç†ç”±")

def assess_complexity(state: ConditionalState):
    """è¯„ä¼°æŸ¥è¯¢å¤æ‚åº¦"""
    llm = ChatOpenAI(model="gpt-4o")
    llm_with_structure = llm.with_structured_output(ComplexityAssessment)

    prompt = f"""è¯„ä¼°ç”¨æˆ·æŸ¥è¯¢çš„å¤æ‚åº¦ï¼š

æŸ¥è¯¢ï¼š{state['query']}

åˆ†ç±»æ ‡å‡†ï¼š
- simple: äº‹å®æŸ¥è¯¢ã€ç®€å•å®šä¹‰
- medium: éœ€è¦åˆ†æã€å¯¹æ¯”
- complex: éœ€è¦æ·±åº¦ç ”ç©¶ã€å¤šæ­¥æ¨ç†

è¿”å›å¤æ‚åº¦å’Œç†ç”±ã€‚
"""

    assessment = llm_with_structure.invoke(prompt)

    return {
        "complexity": assessment.complexity
    }

# ç®€å•æŸ¥è¯¢å¤„ç†
def simple_handler(state: ConditionalState):
    """å¤„ç†ç®€å•æŸ¥è¯¢"""
    llm = ChatOpenAI(model="gpt-4o-mini")  # ä½¿ç”¨ä¾¿å®œæ¨¡å‹
    response = llm.invoke(f"ç®€æ´å›ç­”ï¼š{state['query']}")
    return {"answer": response.content}

# ä¸­ç­‰æŸ¥è¯¢å¤„ç†
def medium_handler(state: ConditionalState):
    """å¤„ç†ä¸­ç­‰æŸ¥è¯¢"""
    llm = ChatOpenAI(model="gpt-4o")
    response = llm.invoke(f"è¯¦ç»†åˆ†æï¼š{state['query']}")
    return {"answer": response.content}

# å¤æ‚æŸ¥è¯¢å¤„ç†
def complex_handler(state: ConditionalState):
    """å¤„ç†å¤æ‚æŸ¥è¯¢"""
    llm = ChatOpenAI(model="claude-sonnet-4-5")  # ä½¿ç”¨é«˜çº§æ¨¡å‹
    response = llm.invoke(f"æ·±åº¦ç ”ç©¶å’Œåˆ†æï¼š{state['query']}")
    return {"answer": response.content}

# è·¯ç”±å‡½æ•°
def route_by_complexity(state: ConditionalState) -> str:
    """æ ¹æ®å¤æ‚åº¦è·¯ç”±"""
    complexity_map = {
        "simple": "simple_handler",
        "medium": "medium_handler",
        "complex": "complex_handler"
    }
    return complexity_map[state["complexity"]]

# æ„å»ºæ¡ä»¶å·¥ä½œæµ
workflow = StateGraph(ConditionalState)

# æ·»åŠ èŠ‚ç‚¹
workflow.add_node("assess", assess_complexity)
workflow.add_node("simple_handler", simple_handler)
workflow.add_node("medium_handler", medium_handler)
workflow.add_node("complex_handler", complex_handler)

# æµç¨‹
workflow.add_edge(START, "assess")

# æ¡ä»¶è·¯ç”±
workflow.add_conditional_edges(
    "assess",
    route_by_complexity,
    {
        "simple_handler": "simple_handler",
        "medium_handler": "medium_handler",
        "complex_handler": "complex_handler"
    }
)

# æ‰€æœ‰è·¯å¾„ç»“æŸ
workflow.add_edge("simple_handler", END)
workflow.add_edge("medium_handler", END)
workflow.add_edge("complex_handler", END)

app = workflow.compile()

# æµ‹è¯•
test_queries = [
    "ä»€ä¹ˆæ˜¯ Pythonï¼Ÿ",
    "å¯¹æ¯” Python å’Œ Java çš„ä¼˜ç¼ºç‚¹",
    "è®¾è®¡ä¸€ä¸ªé«˜å¹¶å‘çš„å¾®æœåŠ¡æ¶æ„"
]

for query in test_queries:
    result = app.invoke({"query": query})
    print(f"æŸ¥è¯¢ï¼š{query}")
    print(f"å¤æ‚åº¦ï¼š{result['complexity']}")
    print(f"ç­”æ¡ˆï¼š{result['answer'][:100]}...\n")

# æ‰§è¡Œæµç¨‹ï¼š
#               â”Œâ†’ simple_handler (gpt-4o-mini)
# æŸ¥è¯¢ â†’ è¯„ä¼° â”€â”¼â†’ medium_handler (gpt-4o)
#               â””â†’ complex_handler (claude-sonnet-4-5)

# ä¼˜åŠ¿ï¼š
# - æˆæœ¬ä¼˜åŒ–ï¼ˆç®€å•æŸ¥è¯¢ç”¨ä¾¿å®œæ¨¡å‹ï¼‰
# - è´¨é‡ä¿è¯ï¼ˆå¤æ‚æŸ¥è¯¢ç”¨é«˜çº§æ¨¡å‹ï¼‰
# - è‡ªåŠ¨å†³ç­–</code></pre>
                    </div>

                    <h3 class="subsection-title">æ¨¡å¼ 4ï¼šå¾ªç¯è¿­ä»£</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ¨¡å¼ 4ï¼šå¾ªç¯è¿­ä»£ - è´¨é‡é©±åŠ¨çš„å†…å®¹ä¼˜åŒ–
"""
from typing import TypedDict, Literal
from langgraph.graph import StateGraph, START, END
from pydantic import BaseModel, Field
from langchain_openai import ChatOpenAI

# å®šä¹‰çŠ¶æ€
class IterativeState(TypedDict):
    topic: str
    draft: str
    quality_score: float
    iteration_count: int
    max_iterations: int
    feedback: str
    final_content: str

# è´¨é‡è¯„ä¼°ç»“æ„
class QualityAssessment(BaseModel):
    score: float = Field(description="è´¨é‡è¯„åˆ† (0-1)", ge=0, le=1)
    feedback: str = Field(description="æ”¹è¿›å»ºè®®")
    pass_quality: bool = Field(description="æ˜¯å¦è¾¾åˆ°è´¨é‡æ ‡å‡†")

# å†…å®¹ç”ŸæˆèŠ‚ç‚¹
def generate_content(state: IterativeState):
    """ç”Ÿæˆæˆ–æ”¹è¿›å†…å®¹"""
    llm = ChatOpenAI(model="claude-sonnet-4-5")

    if state.get("draft"):
        # æ”¹è¿›ç°æœ‰å†…å®¹
        prompt = f"""æ”¹è¿›ä»¥ä¸‹å†…å®¹ï¼š

ä¸»é¢˜ï¼š{state['topic']}
å½“å‰ç‰ˆæœ¬ï¼š{state['draft']}
æ”¹è¿›å»ºè®®ï¼š{state['feedback']}

è¦æ±‚ï¼šæ ¹æ®åé¦ˆæ”¹è¿›å†…å®¹ã€‚
"""
    else:
        # é¦–æ¬¡ç”Ÿæˆ
        prompt = f"""åˆ›ä½œå…³äºä»¥ä¸‹ä¸»é¢˜çš„å†…å®¹ï¼š

ä¸»é¢˜ï¼š{state['topic']}

è¦æ±‚ï¼šé«˜è´¨é‡ã€ç»“æ„æ¸…æ™°ã€å†…å®¹ä¸°å¯Œã€‚
"""

    response = llm.invoke(prompt)

    return {
        "draft": response.content,
        "iteration_count": state.get("iteration_count", 0) + 1
    }

# è´¨é‡æ£€æŸ¥èŠ‚ç‚¹
def quality_check(state: IterativeState):
    """æ£€æŸ¥å†…å®¹è´¨é‡"""
    llm = ChatOpenAI(model="gpt-4o")
    llm_with_structure = llm.with_structured_output(QualityAssessment)

    prompt = f"""è¯„ä¼°å†…å®¹è´¨é‡ï¼š

ä¸»é¢˜ï¼š{state['topic']}
å†…å®¹ï¼š{state['draft']}

è¯„ä¼°æ ‡å‡†ï¼š
- å†…å®¹ç›¸å…³æ€§å’Œå‡†ç¡®æ€§
- ç»“æ„æ¸…æ™°åº¦
- è¯­è¨€æµç•…æ€§
- ä¿¡æ¯å®Œæ•´æ€§

è´¨é‡é˜ˆå€¼ï¼š0.8ï¼ˆä½äºéœ€æ”¹è¿›ï¼‰
è¿”å›è¯„åˆ†ã€æ˜¯å¦è¾¾æ ‡ã€æ”¹è¿›å»ºè®®ã€‚
"""

    assessment = llm_with_structure.invoke(prompt)

    return {
        "quality_score": assessment.score,
        "feedback": assessment.feedback
    }

# å†³ç­–å‡½æ•°
def should_continue(state: IterativeState) -> Literal["improve", "finish"]:
    """å†³å®šæ˜¯å¦ç»§ç»­ä¼˜åŒ–"""
    # è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°
    if state["iteration_count"] >= state["max_iterations"]:
        return "finish"

    # è´¨é‡è¾¾æ ‡
    if state["quality_score"] >= 0.8:
        return "finish"

    # ç»§ç»­ä¼˜åŒ–
    return "improve"

# å®ŒæˆèŠ‚ç‚¹
def finalize(state: IterativeState):
    """æœ€ç»ˆåŒ–å†…å®¹"""
    return {
        "final_content": state["draft"]
    }

# æ„å»ºå¾ªç¯å·¥ä½œæµ
workflow = StateGraph(IterativeState)

# æ·»åŠ èŠ‚ç‚¹
workflow.add_node("generate", generate_content)
workflow.add_node("quality_check", quality_check)
workflow.add_node("finalize", finalize)

# æµç¨‹
workflow.add_edge(START, "generate")
workflow.add_edge("generate", "quality_check")

# æ¡ä»¶å¾ªç¯
workflow.add_conditional_edges(
    "quality_check",
    should_continue,
    {
        "improve": "generate",  # å¾ªç¯å›å»æ”¹è¿›
        "finish": "finalize"
    }
)

workflow.add_edge("finalize", END)

app = workflow.compile()

# ä½¿ç”¨
result = app.invoke({
    "topic": "AI åœ¨åŒ»ç–—é¢†åŸŸçš„åº”ç”¨",
    "max_iterations": 3
})

print(f"ä¸»é¢˜ï¼š{result['topic']}")
print(f"è¿­ä»£æ¬¡æ•°ï¼š{result['iteration_count']}")
print(f"æœ€ç»ˆè´¨é‡è¯„åˆ†ï¼š{result['quality_score']}")
print(f"æœ€ç»ˆå†…å®¹ï¼š{result['final_content'][:200]}...")

# æ‰§è¡Œæµç¨‹ï¼š
# ç”Ÿæˆ â†’ è´¨é‡æ£€æŸ¥ â†’ (ä¸è¾¾æ ‡ï¼Ÿ) â†’ ç”Ÿæˆ â†’ è´¨é‡æ£€æŸ¥ â†’ (è¾¾æ ‡) â†’ å®Œæˆ

# ä¼˜åŠ¿ï¼š
# - è‡ªåŠ¨è´¨é‡æ§åˆ¶
# - è¿­ä»£ä¼˜åŒ–
# - é˜²æ­¢æ— é™å¾ªç¯ï¼ˆæœ€å¤§æ¬¡æ•°é™åˆ¶ï¼‰</code></pre>
                    </div>
                </section>

                <!-- å®Œæ•´å®æˆ˜ç¤ºä¾‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ¯ å®Œæ•´å®æˆ˜ç¤ºä¾‹</h2>
                    <p>
                        æ„å»ºä¸€ä¸ª<strong>æ™ºèƒ½å†…å®¹å®¡æ ¸å’Œå‘å¸ƒç³»ç»Ÿ</strong>ï¼Œç»¼åˆä½¿ç”¨æ‰€æœ‰å·¥ä½œæµæ¨¡å¼å’Œ Multi-Agent åä½œæ¨¡å¼ï¼Œ
                        å®ç°ä»å†…å®¹æ¥æ”¶åˆ°å‘å¸ƒçš„å®Œæ•´è‡ªåŠ¨åŒ–æµç¨‹ã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§ - ç”Ÿäº§çº§ç»¼åˆç¤ºä¾‹</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
å®Œæ•´å®æˆ˜ç¤ºä¾‹ - æ™ºèƒ½å†…å®¹å®¡æ ¸å’Œå‘å¸ƒç³»ç»Ÿ
ç»¼åˆä½¿ç”¨ï¼šRouter + Subagents + Handoffs + Skills + å››ç§å·¥ä½œæµæ¨¡å¼
"""
import uuid
from typing import TypedDict, Annotated, Literal
from enum import Enum
from pydantic import BaseModel, Field
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from langchain_openai import ChatOpenAI
from langchain_anthropic import ChatAnthropic
from langchain.tools import tool

# ========== 1. å®šä¹‰æšä¸¾å’Œæ•°æ®ç»“æ„ ==========

class ContentType(str, Enum):
    ARTICLE = "article"
    VIDEO = "video"
    IMAGE = "image"

class ReviewStatus(str, Enum):
    PENDING = "pending"
    APPROVED = "approved"
    REJECTED = "rejected"
    NEEDS_REVISION = "needs_revision"

class ContentQuality(BaseModel):
    score: float = Field(ge=0, le=1)
    issues: list[str]
    suggestions: list[str]
    pass_review: bool

# ========== 2. å®šä¹‰çŠ¶æ€ ==========

class ContentWorkflowState(TypedDict):
    # è¾“å…¥
    content_id: str
    content_type: ContentType
    raw_content: str
    submitter: str

    # Router é˜¶æ®µ
    route_to: str

    # é¢„å¤„ç†é˜¶æ®µ
    preprocessed_content: str

    # å®¡æ ¸é˜¶æ®µ
    quality_assessment: ContentQuality
    review_status: ReviewStatus
    revision_count: int

    # å¹¶è¡Œåˆ†æ
    seo_score: float
    sentiment: str
    compliance_passed: bool

    # æœ€ç»ˆè¾“å‡º
    final_content: str
    published: bool
    publish_url: str

# ========== 3. Skills å®šä¹‰ ==========

@tool
def check_content_compliance(content: str) -> dict:
    """æ£€æŸ¥å†…å®¹åˆè§„æ€§"""
    # å®é™…ä¼šæ£€æŸ¥æ•æ„Ÿè¯ã€ç‰ˆæƒç­‰
    return {
        "passed": True,
        "issues": []
    }

@tool
def analyze_sentiment(content: str) -> str:
    """åˆ†æå†…å®¹æƒ…ç»ª"""
    # å®é™…ä¼šè°ƒç”¨æƒ…æ„Ÿåˆ†æ API
    return "positive"

@tool
def calculate_seo_score(content: str) -> float:
    """è®¡ç®— SEO è¯„åˆ†"""
    # å®é™…ä¼šåˆ†æå…³é”®è¯å¯†åº¦ã€å¯è¯»æ€§ç­‰
    return 0.85

@tool
def publish_to_cms(content: str, metadata: dict) -> dict:
    """å‘å¸ƒåˆ° CMS"""
    # å®é™…ä¼šè°ƒç”¨ CMS API
    return {
        "success": True,
        "url": f"https://example.com/content/{uuid.uuid4().hex}"
    }

# ========== 4. èŠ‚ç‚¹å®šä¹‰ ==========

# Router èŠ‚ç‚¹ï¼šå†…å®¹åˆ†ç±»
def content_router(state: ContentWorkflowState):
    """æ ¹æ®å†…å®¹ç±»å‹è·¯ç”±åˆ°ä¸åŒå¤„ç†æµç¨‹"""
    content_type = state["content_type"]

    route_map = {
        ContentType.ARTICLE: "article_pipeline",
        ContentType.VIDEO: "video_pipeline",
        ContentType.IMAGE: "image_pipeline"
    }

    return {
        "route_to": route_map[content_type]
    }

# é¢„å¤„ç†èŠ‚ç‚¹
def preprocess_content(state: ContentWorkflowState):
    """é¢„å¤„ç†å†…å®¹ï¼ˆç¡®å®šæ€§é€»è¾‘ï¼‰"""
    raw = state["raw_content"]

    # æ¸…ç†ã€æ ¼å¼åŒ–
    preprocessed = raw.strip()
    # å®é™…ä¼šåšæ›´å¤šå¤„ç†ï¼šHTML æ¸…ç†ã€æ ¼å¼æ ‡å‡†åŒ–ç­‰

    return {
        "preprocessed_content": preprocessed
    }

# è´¨é‡è¯„ä¼°èŠ‚ç‚¹ï¼ˆSubagentï¼‰
def quality_assessment_agent(state: ContentWorkflowState):
    """ä½¿ç”¨ Agent è¯„ä¼°å†…å®¹è´¨é‡"""
    llm = ChatAnthropic(model="claude-sonnet-4-5")
    llm_with_structure = llm.with_structured_output(ContentQuality)

    prompt = f"""å…¨é¢è¯„ä¼°å†…å®¹è´¨é‡ï¼š

å†…å®¹ç±»å‹ï¼š{state['content_type'].value}
å†…å®¹ï¼š{state['preprocessed_content'][:500]}...

è¯„ä¼°ç»´åº¦ï¼š
- å†…å®¹ç›¸å…³æ€§å’Œå‡†ç¡®æ€§
- è¯­è¨€è´¨é‡å’Œæµç•…æ€§
- ç»“æ„æ¸…æ™°åº¦
- ä¿¡æ¯ä»·å€¼
- æ˜¯å¦å­˜åœ¨æ˜æ˜¾é—®é¢˜

è´¨é‡é˜ˆå€¼ï¼š0.7ï¼ˆä½äºéœ€ä¿®æ”¹ï¼‰
è¿”å›è¯„åˆ†ã€é—®é¢˜åˆ—è¡¨ã€æ”¹è¿›å»ºè®®ã€æ˜¯å¦é€šè¿‡ã€‚
"""

    assessment = llm_with_structure.invoke(prompt)

    # ç¡®å®šå®¡æ ¸çŠ¶æ€
    if assessment.pass_review:
        status = ReviewStatus.APPROVED
    else:
        status = ReviewStatus.NEEDS_REVISION

    return {
        "quality_assessment": assessment,
        "review_status": status
    }

# å†…å®¹æ”¹è¿›èŠ‚ç‚¹ï¼ˆå¾ªç¯ä¼˜åŒ–ï¼‰
def content_improvement_agent(state: ContentWorkflowState):
    """æ ¹æ®åé¦ˆæ”¹è¿›å†…å®¹"""
    llm = ChatAnthropic(model="claude-sonnet-4-5")

    quality = state["quality_assessment"]
    issues = ", ".join(quality.issues)
    suggestions = ", ".join(quality.suggestions)

    prompt = f"""æ”¹è¿›å†…å®¹ï¼š

åŸå†…å®¹ï¼š{state['preprocessed_content']}

é—®é¢˜ï¼š{issues}
å»ºè®®ï¼š{suggestions}

è¦æ±‚ï¼šæ ¹æ®åé¦ˆæ”¹è¿›å†…å®¹ï¼Œä¿æŒåŸæ„ã€‚
"""

    response = llm.invoke(prompt)

    return {
        "preprocessed_content": response.content,
        "revision_count": state.get("revision_count", 0) + 1
    }

# å¹¶è¡Œåˆ†æèŠ‚ç‚¹ 1ï¼šSEO åˆ†æ
def seo_analysis(state: ContentWorkflowState):
    """SEO åˆ†æ"""
    score = calculate_seo_score.invoke({"content": state["preprocessed_content"]})
    return {"seo_score": score}

# å¹¶è¡Œåˆ†æèŠ‚ç‚¹ 2ï¼šæƒ…æ„Ÿåˆ†æ
def sentiment_analysis(state: ContentWorkflowState):
    """æƒ…æ„Ÿåˆ†æ"""
    sentiment = analyze_sentiment.invoke({"content": state["preprocessed_content"]})
    return {"sentiment": sentiment}

# å¹¶è¡Œåˆ†æèŠ‚ç‚¹ 3ï¼šåˆè§„æ£€æŸ¥
def compliance_check(state: ContentWorkflowState):
    """åˆè§„æ€§æ£€æŸ¥"""
    result = check_content_compliance.invoke({"content": state["preprocessed_content"]})
    return {"compliance_passed": result["passed"]}

# Handoff å†³ç­–ï¼šæ˜¯å¦éœ€è¦äººå·¥å®¡æ ¸
def need_human_review(state: ContentWorkflowState) -> Literal["human_review", "auto_publish"]:
    """å†³å®šæ˜¯å¦éœ€è¦äººå·¥å®¡æ ¸"""
    quality = state["quality_assessment"]

    # ä½è´¨é‡æˆ–ä¸åˆè§„éœ€è¦äººå·¥å®¡æ ¸
    if quality.score < 0.6 or not state["compliance_passed"]:
        return "human_review"

    return "auto_publish"

# äººå·¥å®¡æ ¸èŠ‚ç‚¹ï¼ˆæ¨¡æ‹Ÿï¼‰
def human_review_agent(state: ContentWorkflowState):
    """äººå·¥å®¡æ ¸ï¼ˆå®é™…ä¼šç­‰å¾…äººå·¥å†³ç­–ï¼‰"""
    # æ¨¡æ‹Ÿäººå·¥æ‰¹å‡†
    return {
        "review_status": ReviewStatus.APPROVED,
        "final_content": state["preprocessed_content"]
    }

# å‘å¸ƒèŠ‚ç‚¹
def publish_content(state: ContentWorkflowState):
    """å‘å¸ƒå†…å®¹"""
    result = publish_to_cms.invoke({
        "content": state.get("final_content", state["preprocessed_content"]),
        "metadata": {
            "content_type": state["content_type"].value,
            "submitter": state["submitter"],
            "seo_score": state["seo_score"]
        }
    })

    return {
        "published": result["success"],
        "publish_url": result["url"]
    }

# ========== 5. æ¡ä»¶è·¯ç”±å‡½æ•° ==========

def route_by_type(state: ContentWorkflowState) -> str:
    """æ ¹æ®å†…å®¹ç±»å‹è·¯ç”±"""
    return state["route_to"]

def should_revise(state: ContentWorkflowState) -> Literal["revise", "parallel_analysis"]:
    """å†³å®šæ˜¯å¦éœ€è¦ä¿®æ”¹"""
    if state["review_status"] == ReviewStatus.NEEDS_REVISION:
        # æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§ä¿®æ”¹æ¬¡æ•°
        if state.get("revision_count", 0) >= 2:
            return "parallel_analysis"  # å¼ºåˆ¶è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
        return "revise"
    return "parallel_analysis"

# ========== 6. æ„å»ºç»¼åˆå·¥ä½œæµ ==========

workflow = StateGraph(ContentWorkflowState)

# ===== ç¬¬ä¸€é˜¶æ®µï¼šRouter =====
workflow.add_node("router", content_router)

# ===== ç¬¬äºŒé˜¶æ®µï¼šé¢„å¤„ç†ï¼ˆç¡®å®šæ€§ï¼‰ =====
workflow.add_node("preprocess", preprocess_content)

# ===== ç¬¬ä¸‰é˜¶æ®µï¼šè´¨é‡è¯„ä¼°ï¼ˆAgentï¼‰ =====
workflow.add_node("quality_assessment", quality_assessment_agent)

# ===== ç¬¬å››é˜¶æ®µï¼šå†…å®¹æ”¹è¿›ï¼ˆå¾ªç¯ï¼‰ =====
workflow.add_node("improve", content_improvement_agent)

# ===== ç¬¬äº”é˜¶æ®µï¼šå¹¶è¡Œåˆ†æ =====
workflow.add_node("seo_analysis", seo_analysis)
workflow.add_node("sentiment_analysis", sentiment_analysis)
workflow.add_node("compliance_check", compliance_check)

# ===== ç¬¬å…­é˜¶æ®µï¼šHandoffï¼ˆäººå·¥å®¡æ ¸ï¼‰ =====
workflow.add_node("human_review", human_review_agent)

# ===== ç¬¬ä¸ƒé˜¶æ®µï¼šå‘å¸ƒ =====
workflow.add_node("publish", publish_content)

# ===== è¿æ¥æµç¨‹ =====

# START â†’ router
workflow.add_edge(START, "router")

# router â†’ preprocessï¼ˆæ‰€æœ‰ç±»å‹éƒ½ç»è¿‡é¢„å¤„ç†ï¼‰
workflow.add_conditional_edges(
    "router",
    route_by_type,
    {
        "article_pipeline": "preprocess",
        "video_pipeline": "preprocess",
        "image_pipeline": "preprocess"
    }
)

# preprocess â†’ quality_assessment
workflow.add_edge("preprocess", "quality_assessment")

# quality_assessment â†’ æ¡ä»¶åˆ†æ”¯ï¼ˆä¿®æ”¹æˆ–å¹¶è¡Œåˆ†æï¼‰
workflow.add_conditional_edges(
    "quality_assessment",
    should_revise,
    {
        "revise": "improve",
        "parallel_analysis": "seo_analysis"
    }
)

# improve â†’ quality_assessmentï¼ˆå¾ªç¯ï¼‰
workflow.add_edge("improve", "quality_assessment")

# å¹¶è¡Œåˆ†æï¼ˆä¸‰ä¸ªèŠ‚ç‚¹åŒæ—¶æ‰§è¡Œï¼‰
workflow.add_edge("seo_analysis", "human_review")
workflow.add_edge("sentiment_analysis", "human_review")
workflow.add_edge("compliance_check", "human_review")

# human_review â†’ æ¡ä»¶åˆ†æ”¯ï¼ˆäººå·¥å®¡æ ¸æˆ–è‡ªåŠ¨å‘å¸ƒï¼‰
workflow.add_conditional_edges(
    "human_review",
    need_human_review,
    {
        "human_review": "publish",  # å·²ç»äººå·¥å®¡æ ¸ï¼Œç›´æ¥å‘å¸ƒ
        "auto_publish": "publish"
    }
)

# publish â†’ END
workflow.add_edge("publish", END)

# ç¼–è¯‘
app = workflow.compile()

# ========== 7. æµ‹è¯•ç³»ç»Ÿ ==========

test_content = {
    "content_id": str(uuid.uuid4()),
    "content_type": ContentType.ARTICLE,
    "raw_content": """
    äººå·¥æ™ºèƒ½æ­£åœ¨æ”¹å˜ä¸–ç•Œã€‚éšç€æŠ€æœ¯çš„å‘å±•ï¼ŒAI åº”ç”¨è¶Šæ¥è¶Šå¹¿æ³›ã€‚
    ä»åŒ»ç–—åˆ°é‡‘èï¼Œä»æ•™è‚²åˆ°å¨±ä¹ï¼ŒAI æ— å¤„ä¸åœ¨ã€‚
    """,
    "submitter": "user_001"
}

result = app.invoke(test_content)

print("=" * 60)
print("å†…å®¹å®¡æ ¸å’Œå‘å¸ƒç³»ç»Ÿæ‰§è¡Œç»“æœ")
print("=" * 60)
print(f"å†…å®¹ IDï¼š{result['content_id']}")
print(f"å†…å®¹ç±»å‹ï¼š{result['content_type'].value}")
print(f"æäº¤è€…ï¼š{result['submitter']}")
print(f"\nå®¡æ ¸ç»“æœï¼š")
print(f"  - è´¨é‡è¯„åˆ†ï¼š{result['quality_assessment'].score}")
print(f"  - å®¡æ ¸çŠ¶æ€ï¼š{result['review_status'].value}")
print(f"  - ä¿®æ”¹æ¬¡æ•°ï¼š{result.get('revision_count', 0)}")
print(f"\nå¹¶è¡Œåˆ†æï¼š")
print(f"  - SEO è¯„åˆ†ï¼š{result['seo_score']}")
print(f"  - æƒ…æ„Ÿå€¾å‘ï¼š{result['sentiment']}")
print(f"  - åˆè§„æ£€æŸ¥ï¼š{'é€šè¿‡' if result['compliance_passed'] else 'æœªé€šè¿‡'}")
print(f"\nå‘å¸ƒçŠ¶æ€ï¼š")
print(f"  - æ˜¯å¦å‘å¸ƒï¼š{result['published']}")
print(f"  - å‘å¸ƒ URLï¼š{result['publish_url']}")

# å·¥ä½œæµæ‰§è¡Œè¿‡ç¨‹ï¼š
# 1. Routerï¼šæ ¹æ®å†…å®¹ç±»å‹è·¯ç”±
# 2. é¢„å¤„ç†ï¼šæ¸…ç†å’Œæ ¼å¼åŒ–ï¼ˆç¡®å®šæ€§ï¼‰
# 3. è´¨é‡è¯„ä¼°ï¼šAgent æ™ºèƒ½è¯„ä¼°
# 4. æ¡ä»¶å¾ªç¯ï¼šè´¨é‡ä¸è¾¾æ ‡æ—¶æ”¹è¿›ï¼ˆæœ€å¤š 2 æ¬¡ï¼‰
# 5. å¹¶è¡Œåˆ†æï¼šSEO + æƒ…æ„Ÿ + åˆè§„ï¼ˆåŒæ—¶è¿›è¡Œï¼‰
# 6. Handoff å†³ç­–ï¼šä½è´¨é‡è½¬äººå·¥å®¡æ ¸
# 7. å‘å¸ƒï¼šå‘å¸ƒåˆ° CMS

# ä¼˜åŠ¿ï¼š
# - ç»¼åˆä½¿ç”¨æ‰€æœ‰ Multi-Agent æ¨¡å¼
# - æ··åˆç¡®å®šæ€§é€»è¾‘å’Œ AI å†³ç­–
# - è‡ªåŠ¨åŒ–è´¨é‡æ§åˆ¶å’Œä¼˜åŒ–
# - çµæ´»çš„äººå·¥ä»‹å…¥æœºåˆ¶
# - ç”Ÿäº§çº§é”™è¯¯å¤„ç†å’Œè¿½è¸ª</code></pre>
                    </div>
                </section>

                <!-- æœ€ä½³å®è·µ -->
                <section class="content-section">
                    <h2 class="section-title">âœ¨ è‡ªå®šä¹‰å·¥ä½œæµæœ€ä½³å®è·µ</h2>

                    <h3 class="subsection-title">1. å·¥ä½œæµè®¾è®¡åŸåˆ™</h3>
                    <div class="info-box tip">
                        <div class="info-box-title">âœ… è®¾è®¡åŸåˆ™</div>
                        <ul>
                            <li><strong>å…³æ³¨ç‚¹åˆ†ç¦»</strong>ï¼šæ¯ä¸ªèŠ‚ç‚¹æ‰¿æ‹…æ˜ç¡®çš„å•ä¸€èŒè´£</li>
                            <li><strong>ç¡®å®šæ€§ä¼˜å…ˆ</strong>ï¼šèƒ½ç”¨ç¡®å®šæ€§é€»è¾‘å°±ä¸ç”¨ LLMï¼ˆæé«˜å¯é æ€§å’Œé€Ÿåº¦ï¼‰</li>
                            <li><strong>ç±»å‹åŒ–çŠ¶æ€</strong>ï¼šä½¿ç”¨ TypedDict å®šä¹‰æ¸…æ™°çš„çŠ¶æ€ç»“æ„</li>
                            <li><strong>æ¨¡å—åŒ–è®¾è®¡</strong>ï¼šèŠ‚ç‚¹å¯ç‹¬ç«‹æµ‹è¯•å’Œå¤ç”¨</li>
                            <li><strong>æ¸è¿›å¼å¤æ‚åº¦</strong>ï¼šä»ç®€å•é¡ºåºæµç¨‹å¼€å§‹ï¼Œé€æ­¥æ·»åŠ å¤æ‚æ€§</li>
                            <li><strong>é”™è¯¯è¾¹ç•Œ</strong>ï¼šä¸ºå…³é”®èŠ‚ç‚¹æ·»åŠ é”™è¯¯å¤„ç†å’Œé™çº§</li>
                        </ul>
                    </div>

                    <h3 class="subsection-title">2. èŠ‚ç‚¹ç±»å‹é€‰æ‹©</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ä»»åŠ¡ç±»å‹</th>
                                <th>æ¨èèŠ‚ç‚¹ç±»å‹</th>
                                <th>ç¤ºä¾‹</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>æ•°æ®è·å–</td>
                                <td>ç¡®å®šæ€§å‡½æ•°</td>
                                <td>æ•°æ®åº“æŸ¥è¯¢ã€API è°ƒç”¨</td>
                            </tr>
                            <tr>
                                <td>æ•°æ®è½¬æ¢</td>
                                <td>ç¡®å®šæ€§å‡½æ•°</td>
                                <td>æ ¼å¼è½¬æ¢ã€æ¸…æ´—</td>
                            </tr>
                            <tr>
                                <td>å†…å®¹ç†è§£</td>
                                <td>LLM èŠ‚ç‚¹</td>
                                <td>åˆ†ç±»ã€æ‘˜è¦ã€æƒ…æ„Ÿåˆ†æ</td>
                            </tr>
                            <tr>
                                <td>å†…å®¹ç”Ÿæˆ</td>
                                <td>LLM èŠ‚ç‚¹</td>
                                <td>å†™ä½œã€æ”¹å†™ã€åˆ›ä½œ</td>
                            </tr>
                            <tr>
                                <td>å¤æ‚æ¨ç†</td>
                                <td>Agent èŠ‚ç‚¹</td>
                                <td>å¤šæ­¥å†³ç­–ã€å·¥å…·è°ƒç”¨</td>
                            </tr>
                            <tr>
                                <td>éªŒè¯æ£€æŸ¥</td>
                                <td>ç¡®å®šæ€§å‡½æ•°</td>
                                <td>æ ¼å¼æ ¡éªŒã€è§„åˆ™æ£€æŸ¥</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="subsection-title">3. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3>
                    <ul>
                        <li><strong>å¹¶è¡ŒåŒ–</strong>ï¼šè¯†åˆ«å¯å¹¶è¡Œçš„ç‹¬ç«‹ä»»åŠ¡</li>
                        <li><strong>ç¼“å­˜</strong>ï¼šç¼“å­˜æ˜‚è´µçš„ LLM è°ƒç”¨ç»“æœ</li>
                        <li><strong>æ—©åœ</strong>ï¼šæ¡ä»¶æå‰ç»ˆæ­¢ï¼Œè·³è¿‡ä¸å¿…è¦çš„æ­¥éª¤</li>
                        <li><strong>æ‰¹å¤„ç†</strong>ï¼šå°†å¤šä¸ªè¯·æ±‚æ‰¹é‡å¤„ç†</li>
                        <li><strong>æ¨¡å‹é€‰æ‹©</strong>ï¼šæ ¹æ®ä»»åŠ¡å¤æ‚åº¦é€‰æ‹©æ¨¡å‹ï¼ˆç®€å•ä»»åŠ¡ç”¨ miniï¼‰</li>
                        <li><strong>æµå¼è¾“å‡º</strong>ï¼šå¯¹é•¿æ—¶é—´ä»»åŠ¡ä½¿ç”¨æµå¼å“åº”</li>
                    </ul>

                    <h3 class="subsection-title">4. çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># å¥½çš„çŠ¶æ€è®¾è®¡

class WellDesignedState(TypedDict):
    # è¾“å…¥å­—æ®µï¼ˆæ¸…æ™°æ ‡æ³¨ï¼‰
    user_query: str
    user_id: str

    # ä¸­é—´ç»“æœï¼ˆæŒ‰é˜¶æ®µç»„ç»‡ï¼‰
    stage1_result: str
    stage2_analysis: dict

    # å…ƒæ•°æ®ï¼ˆè¿½è¸ªä¿¡æ¯ï¼‰
    processing_time_ms: float
    node_history: list[str]

    # è¾“å‡ºå­—æ®µ
    final_answer: str
    confidence: float

# å·®çš„çŠ¶æ€è®¾è®¡

class PoorlyDesignedState(TypedDict):
    # å­—æ®µå‘½åä¸æ¸…æ™°
    data: str
    result: str
    temp: str

    # ç¼ºå°‘ç±»å‹æç¤º
    analysis  # ç±»å‹ä¸æ˜ç¡®

    # èŒè´£æ··ä¹±
    everything: dict  # æ‰€æœ‰æ•°æ®æ··åœ¨ä¸€èµ·</code></pre>
                    </div>

                    <h3 class="subsection-title">5. é”™è¯¯å¤„ç†å’Œç›‘æ§</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># èŠ‚ç‚¹é”™è¯¯å¤„ç†

def robust_node(state):
    """å¸¦é”™è¯¯å¤„ç†çš„èŠ‚ç‚¹"""
    try:
        # ä¸»è¦é€»è¾‘
        result = expensive_operation(state)
        return {"result": result}
    except SpecificError as e:
        # é™çº§å¤„ç†
        logger.warning(f"Operation failed, using fallback: {e}")
        return {"result": fallback_operation(state)}
    except Exception as e:
        # è®°å½•é”™è¯¯å¹¶ä¼ é€’
        logger.error(f"Node failed: {e}")
        return {"error": str(e), "failed_node": "robust_node"}

# å·¥ä½œæµçº§åˆ«ç›‘æ§

def add_monitoring(workflow):
    """ä¸ºå·¥ä½œæµæ·»åŠ ç›‘æ§"""
    def log_node_entry(node_name):
        print(f"Entering node: {node_name}")

    def log_node_exit(node_name, duration_ms):
        print(f"Exiting node: {node_name} ({duration_ms}ms)")

    # ä½¿ç”¨ LangSmith è¿½è¸ª
    import os
    os.environ["LANGCHAIN_TRACING_V2"] = "true"
    os.environ["LANGCHAIN_PROJECT"] = "custom-workflow"</code></pre>
                    </div>
                </section>

                <!-- å¸¸è§é—®é¢˜ -->
                <section class="content-section">
                    <h2 class="section-title">â“ å¸¸è§é—®é¢˜</h2>

                    <h3 class="subsection-subtitle">Q1: ä½•æ—¶ä½¿ç”¨è‡ªå®šä¹‰å·¥ä½œæµè€Œéæ ‡å‡†æ¨¡å¼ï¼Ÿ</h3>
                    <p>
                        <strong>å†³ç­–æ ‘</strong>ï¼š
                    </p>
                    <ol>
                        <li>éœ€æ±‚æ˜¯å¦ç¬¦åˆ Subagentsï¼ˆé¡ºåºæµæ°´çº¿ï¼‰ï¼Ÿâ†’ æ˜¯ï¼šä½¿ç”¨ Subagents</li>
                        <li>æ˜¯å¦éœ€è¦è¿è¡Œæ—¶åŠ¨æ€è½¬ç§»ï¼Ÿâ†’ æ˜¯ï¼šä½¿ç”¨ Handoffs</li>
                        <li>æ˜¯å¦åªéœ€åˆå§‹åˆ†ç±»è·¯ç”±ï¼Ÿâ†’ æ˜¯ï¼šä½¿ç”¨ Router</li>
                        <li>æ˜¯å¦åªéœ€å…±äº«å·¥å…·èƒ½åŠ›ï¼Ÿâ†’ æ˜¯ï¼šä½¿ç”¨ Skills</li>
                        <li>ä»¥ä¸Šéƒ½ä¸å®Œå…¨ç¬¦åˆï¼Ÿâ†’ ä½¿ç”¨è‡ªå®šä¹‰å·¥ä½œæµ</li>
                    </ol>

                    <h3 class="subsection-subtitle">Q2: å¦‚ä½•ç»„åˆå¤šä¸ª Multi-Agent æ¨¡å¼ï¼Ÿ</h3>
                    <p>
                        <strong>ç»„åˆç­–ç•¥</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>Router ä½œä¸ºå…¥å£</strong>ï¼šè‡ªå®šä¹‰å·¥ä½œæµçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ˜¯ Router</li>
                        <li><strong>Subagents ä½œä¸ºèŠ‚ç‚¹</strong>ï¼šå°†å®Œæ•´çš„ Subagent æµç¨‹ä½œä¸ºå•ä¸ªèŠ‚ç‚¹</li>
                        <li><strong>Skills ä½œä¸ºå·¥å…·</strong>ï¼šæ‰€æœ‰ä»£ç†èŠ‚ç‚¹ä½¿ç”¨å…±äº«çš„ Skills</li>
                        <li><strong>Handoffs ä½œä¸ºå†³ç­–</strong>ï¼šä½¿ç”¨æ¡ä»¶è¾¹å®ç° Handoff é€»è¾‘</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q3: å¦‚ä½•é¿å…å·¥ä½œæµè¿‡äºå¤æ‚ï¼Ÿ</h3>
                    <p>
                        <strong>å¤æ‚åº¦ç®¡ç†</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>åˆ†å±‚è®¾è®¡</strong>ï¼šå°†å¤æ‚å·¥ä½œæµæ‹†åˆ†ä¸ºå¤šä¸ªå­å·¥ä½œæµ</li>
                        <li><strong>é™åˆ¶æ·±åº¦</strong>ï¼šé¿å…è¶…è¿‡ 3 å±‚åµŒå¥—</li>
                        <li><strong>å¯è§†åŒ–</strong>ï¼šä½¿ç”¨ Mermaid å›¾è¡¨è®°å½•å·¥ä½œæµ</li>
                        <li><strong>ä»£ç å®¡æŸ¥</strong>ï¼šå®šæœŸå®¡æŸ¥å·¥ä½œæµè®¾è®¡</li>
                        <li><strong>é‡æ„</strong>ï¼šå½“å·¥ä½œæµè¶…è¿‡ 10 ä¸ªèŠ‚ç‚¹æ—¶è€ƒè™‘é‡æ„</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q4: å¦‚ä½•æµ‹è¯•è‡ªå®šä¹‰å·¥ä½œæµï¼Ÿ</h3>
                    <p>
                        <strong>æµ‹è¯•ç­–ç•¥</strong>ï¼š
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># å•å…ƒæµ‹è¯•ï¼šæµ‹è¯•å•ä¸ªèŠ‚ç‚¹
def test_quality_assessment_node():
    state = {
        "preprocessed_content": "æµ‹è¯•å†…å®¹"
    }
    result = quality_assessment_agent(state)
    assert "quality_assessment" in result
    assert 0 <= result["quality_assessment"].score <= 1

# é›†æˆæµ‹è¯•ï¼šæµ‹è¯•å®Œæ•´è·¯å¾„
def test_full_workflow():
    input_state = {
        "content_type": ContentType.ARTICLE,
        "raw_content": "æµ‹è¯•æ–‡ç« å†…å®¹"
    }
    result = app.invoke(input_state)
    assert result["published"] == True

# è·¯å¾„æµ‹è¯•ï¼šæµ‹è¯•æ‰€æœ‰æ¡ä»¶åˆ†æ”¯
def test_revision_path():
    # æµ‹è¯•è§¦å‘ä¿®æ”¹çš„è·¯å¾„
    pass

def test_human_review_path():
    # æµ‹è¯•è§¦å‘äººå·¥å®¡æ ¸çš„è·¯å¾„
    pass</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q5: å¦‚ä½•è°ƒè¯•å·¥ä½œæµæ‰§è¡Œï¼Ÿ</h3>
                    <p>
                        <strong>è°ƒè¯•æŠ€å·§</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>LangSmith è¿½è¸ª</strong>ï¼šæŸ¥çœ‹å®Œæ•´æ‰§è¡Œé“¾å’Œæ¯ä¸ªèŠ‚ç‚¹çš„è¾“å…¥è¾“å‡º</li>
                        <li><strong>æ‰“å°çŠ¶æ€</strong>ï¼šåœ¨å…³é”®èŠ‚ç‚¹æ‰“å°çŠ¶æ€å˜åŒ–</li>
                        <li><strong>æ—¥å¿—è®°å½•</strong>ï¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ ç»“æ„åŒ–æ—¥å¿—</li>
                        <li><strong>å•æ­¥æ‰§è¡Œ</strong>ï¼šç‹¬ç«‹æµ‹è¯•æ¯ä¸ªèŠ‚ç‚¹</li>
                        <li><strong>å¯è§†åŒ–æ‰§è¡Œ</strong>ï¼šç”Ÿæˆå·¥ä½œæµæ‰§è¡Œçš„æ—¶åºå›¾</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q6: å¦‚ä½•ä¼˜åŒ–å·¥ä½œæµæ€§èƒ½ï¼Ÿ</h3>
                    <p>
                        <strong>æ€§èƒ½ä¼˜åŒ–æ¸…å•</strong>ï¼š
                    </p>
                    <ul>
                        <li>âœ… è¯†åˆ«å¯å¹¶è¡Œçš„èŠ‚ç‚¹å¹¶å¹¶è¡Œæ‰§è¡Œ</li>
                        <li>âœ… ç¼“å­˜æ˜‚è´µçš„ LLM è°ƒç”¨</li>
                        <li>âœ… å¯¹ç®€å•ä»»åŠ¡ä½¿ç”¨ä¾¿å®œæ¨¡å‹ï¼ˆgpt-4o-miniï¼‰</li>
                        <li>âœ… æ·»åŠ æ—©åœæ¡ä»¶ï¼Œè·³è¿‡ä¸å¿…è¦çš„èŠ‚ç‚¹</li>
                        <li>âœ… æ‰¹é‡å¤„ç†å¤šä¸ªè¯·æ±‚</li>
                        <li>âœ… ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œï¼ˆasync/awaitï¼‰</li>
                        <li>âœ… ç›‘æ§æ¯ä¸ªèŠ‚ç‚¹çš„å»¶è¿Ÿï¼Œä¼˜åŒ–ç“¶é¢ˆ</li>
                    </ul>
                </section>

                <!-- å‚è€ƒèµ„æº -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“– å‚è€ƒèµ„æº</h2>
                    <ul>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/multi-agent/custom-workflow" target="_blank">
                                Multi-Agent Custom Workflow å®˜æ–¹æ–‡æ¡£
                            </a>
                        </li>
                        <li>
                            <a href="30-multi-agent-index.html">
                                Multi-Agent æ¦‚è¿°
                            </a>
                        </li>
                        <li>
                            <a href="31-multi-agent-subagents.html">
                                Multi-Agent å­ä»£ç†
                            </a>
                        </li>
                        <li>
                            <a href="32-multi-agent-handoffs.html">
                                Multi-Agent äº¤æ¥æœºåˆ¶
                            </a>
                        </li>
                        <li>
                            <a href="33-multi-agent-skills.html">
                                Multi-Agent æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li>
                            <a href="34-multi-agent-router.html">
                                Multi-Agent è·¯ç”±æœºåˆ¶
                            </a>
                        </li>
                        <li>
                            <a href="15-langgraph.html">
                                LangGraph - å›¾å·¥ä½œæµåŸºç¡€
                            </a>
                        </li>
                    </ul>
                </section>

                <!-- é¡µé¢å¯¼èˆª -->
                <nav class="page-navigation">
                    <a href="34-multi-agent-router.html" class="nav-button prev">
                        â† ä¸Šä¸€é¡µï¼šè·¯ç”±æœºåˆ¶
                    </a>
                    <a href="index.html" class="nav-button next">
                        è¿”å›ä¸»é¡µ â†’
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" aria-label="è¿”å›é¡¶éƒ¨">â†‘</button>

    <!-- JavaScript -->
    <script src="assets/js/mermaid-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
