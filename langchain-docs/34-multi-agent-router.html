<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Multi-Agent è·¯ç”±æœºåˆ¶ - æ™ºèƒ½åˆ†å‘å’Œä»»åŠ¡åˆ†ç±»">
    <title>Multi-Agent è·¯ç”±æœºåˆ¶ | LangChain 1.0 Python çŸ¥è¯†æ–‡æ¡£</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <button class="mobile-menu-button" aria-label="æ‰“å¼€èœå•">â˜°</button>

    <div class="container">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">ğŸ¦œ LangChain 1.0</h1>
                <p class="sidebar-subtitle">Python å®Œæ•´å­¦ä¹ æŒ‡å—</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-section">
                    <div class="nav-section-title">å¼€å§‹</div>
                    <ul>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <span class="nav-icon">ğŸ </span>
                                ä¸»é¡µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">åŸºç¡€ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="01-introduction.html" class="nav-link">
                                <span class="nav-icon">ğŸ“–</span>
                                LangChain ç®€ä»‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="02-architecture.html" class="nav-link">
                                <span class="nav-icon">ğŸ—ï¸</span>
                                æ ¸å¿ƒæ¶æ„
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="03-models.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤–</span>
                                æ¨¡å‹æ¥å£
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="04-messages.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¬</span>
                                æ¶ˆæ¯ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="05-tools.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                å·¥å…·ç³»ç»Ÿ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">è¿›é˜¶ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="06-agents.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                Agent åŸºç¡€
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="07-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="08-rag.html" class="nav-link">
                                <span class="nav-icon">ğŸ”</span>
                                RAG è¯¦è§£
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="09-lcel.html" class="nav-link">
                                <span class="nav-icon">ğŸ”—</span>
                                LCEL è¡¨è¾¾å¼
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">é«˜çº§åº”ç”¨</div>
                    <ul>
                        <li class="nav-item">
                            <a href="10-runtime.html" class="nav-link">
                                <span class="nav-icon">ğŸ”Œ</span>
                                Runtime ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="11-checkpointer.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¾</span>
                                æŒä¹…åŒ–ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="12-streaming.html" class="nav-link">
                                <span class="nav-icon">ğŸŒŠ</span>
                                æµå¼è¾“å‡º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="13-human-in-loop.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="14-long-term-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ—„ï¸</span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="15-langgraph.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                LangGraph
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å®æˆ˜ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="16-customer-service.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å®¢æœæœºå™¨äºº
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="17-best-practices.html" class="nav-link">
                                <span class="nav-icon">âœ¨</span>
                                æœ€ä½³å®è·µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å‚è€ƒç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="18-api-reference.html" class="nav-link">
                                <span class="nav-icon">ğŸ“š</span>
                                API é€ŸæŸ¥è¡¨
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="19-troubleshooting.html" class="nav-link">
                                <span class="nav-icon">ğŸ›</span>
                                æ•…éšœæ’é™¤
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="20-migration.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                è¿ç§»æŒ‡å—
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">æ‰©å±•ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="21-structured-output.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                ç»“æ„åŒ–è¾“å‡º
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">DeepAgents ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="22-deepagents-quickstart.html" class="nav-link">
                                <span class="nav-icon">ğŸš€</span>
                                å¿«é€Ÿå¼€å§‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="23-deepagents-customization.html" class="nav-link">
                                <span class="nav-icon">ğŸ¨</span>
                                å®šåˆ¶åŒ–
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="24-deepagents-harness.html" class="nav-link">
                                <span class="nav-icon">ğŸ›ï¸</span>
                                Harness ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="25-deepagents-backends.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                åç«¯é…ç½®
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="26-deepagents-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="27-deepagents-hitl.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="28-deepagents-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ§ </span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="29-deepagents-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">Multi-Agent ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="30-multi-agent-index.html" class="nav-link">
                                <span class="nav-icon">ğŸŒ</span>
                                æ¦‚è¿°
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="31-multi-agent-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="32-multi-agent-handoffs.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                äº¤æ¥æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="33-multi-agent-skills.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item active">
                            <a href="34-multi-agent-router.html" class="nav-link">
                                <span class="nav-icon">ğŸ§­</span>
                                è·¯ç”±æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="35-multi-agent-workflow.html" class="nav-link">
                                <span class="nav-icon">ğŸ”€</span>
                                è‡ªå®šä¹‰å·¥ä½œæµ
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">
                        <a href="index.html" class="breadcrumb-link">ä¸»é¡µ</a>
                    </span>
                    <span class="breadcrumb-item">
                        Multi-Agent ç¯‡
                    </span>
                    <span class="breadcrumb-item">
                        è·¯ç”±æœºåˆ¶
                    </span>
                </nav>

                <!-- é¡µé¢æ ‡é¢˜ -->
                <header class="page-header">
                    <h1 class="page-title">ğŸ§­ Multi-Agent è·¯ç”±æœºåˆ¶</h1>
                    <p class="page-subtitle">
                        åœ¨ç³»ç»Ÿå…¥å£å¤„æ™ºèƒ½åˆ†æç”¨æˆ·è¯·æ±‚ï¼Œè‡ªåŠ¨è·¯ç”±åˆ°æœ€åˆé€‚çš„ä¸“ä¸šä»£ç†ï¼Œ
                        å®ç°é«˜æ•ˆçš„ä»»åŠ¡åˆ†ç±»å’Œè¯·æ±‚åˆ†å‘ï¼Œæ„å»ºæ™ºèƒ½åŒ–çš„ Agent è°ƒåº¦ç³»ç»Ÿã€‚
                    </p>
                </header>

                <!-- ä»€ä¹ˆæ˜¯ Router -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“š ä»€ä¹ˆæ˜¯ Routerï¼Ÿ</h2>
                    <p>
                        <strong>Routerï¼ˆè·¯ç”±æœºåˆ¶ï¼‰</strong>æ˜¯ Multi-Agent ç³»ç»Ÿä¸­çš„<strong>å…¥å£è°ƒåº¦å±‚</strong>ã€‚
                        åœ¨ç”¨æˆ·è¯·æ±‚è¿›å…¥ç³»ç»Ÿæ—¶ï¼ŒRouter åˆ†æè¯·æ±‚ç‰¹å¾å¹¶<strong>ä¸€æ¬¡æ€§</strong>å†³å®šå°†å…¶è·¯ç”±åˆ°å“ªä¸ªä¸“ä¸šä»£ç†å¤„ç†ï¼Œ
                        æ— éœ€åç»­çš„åŠ¨æ€äº¤æ¥ã€‚
                    </p>

                    <div class="info-box note">
                        <div class="info-box-title">ğŸ’¡ æ ¸å¿ƒç‰¹æ€§</div>
                        <table style="margin-top: 0.5rem;">
                            <thead>
                                <tr>
                                    <th>ç‰¹æ€§</th>
                                    <th>è¯´æ˜</th>
                                    <th>ä¼˜åŠ¿</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>åˆå§‹åˆ†å‘</strong></td>
                                    <td>åœ¨æµç¨‹å¼€å§‹æ—¶è¿›è¡Œä¸€æ¬¡æ€§è·¯ç”±</td>
                                    <td>å¿«é€Ÿå®šä½ç›®æ ‡ä»£ç†</td>
                                </tr>
                                <tr>
                                    <td><strong>æ™ºèƒ½åˆ†ç±»</strong></td>
                                    <td>åŸºäºè¯·æ±‚å†…å®¹ã€æ„å›¾ã€å¤æ‚åº¦åˆ†ç±»</td>
                                    <td>ç²¾å‡†åŒ¹é…ä¸“ä¸šèƒ½åŠ›</td>
                                </tr>
                                <tr>
                                    <td><strong>ä¸“ä¸šåŒ–ä»£ç†</strong></td>
                                    <td>æ¯ä¸ªä»£ç†ä¸“æ³¨ç‰¹å®šé¢†åŸŸ</td>
                                    <td>æé«˜å¤„ç†è´¨é‡</td>
                                </tr>
                                <tr>
                                    <td><strong>æ•ˆç‡ä¼˜åŒ–</strong></td>
                                    <td>ç›´æ¥è·¯ç”±ï¼Œé¿å…ä¸å¿…è¦çš„äº¤æ¥</td>
                                    <td>é™ä½å»¶è¿Ÿå’Œæˆæœ¬</td>
                                </tr>
                                <tr>
                                    <td><strong>å¯æ‰©å±•æ€§</strong></td>
                                    <td>è½»æ¾æ·»åŠ æ–°çš„ä»£ç†åˆ†æ”¯</td>
                                    <td>ç³»ç»Ÿæ˜“äºæ‰©å±•</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph TB
    User["ç”¨æˆ·è¯·æ±‚ï¼š<br/>æˆ‘çš„è®¢å•åœ¨å“ªé‡Œï¼Ÿ"] --> Router["ğŸ§­ Router<br/>æ™ºèƒ½è·¯ç”±å±‚"]

    Router -->|"åˆ†æè¯·æ±‚å†…å®¹"| Analysis["è¯·æ±‚åˆ†æ<br/>å…³é”®è¯ï¼šè®¢å•<br/>æ„å›¾ï¼šæŸ¥è¯¢<br/>é¢†åŸŸï¼šç”µå•†"]

    Analysis --> Decision{"è·¯ç”±å†³ç­–"}

    Decision -->|"è®¢å•ç›¸å…³"| OrderAgent["è®¢å•ä»£ç†<br/>å¤„ç†è®¢å•æŸ¥è¯¢"]
    Decision -->|"æŠ€æœ¯é—®é¢˜"| TechAgent["æŠ€æœ¯ä»£ç†<br/>è§£å†³æŠ€æœ¯é—®é¢˜"]
    Decision -->|"è´¦å•é—®é¢˜"| BillingAgent["è´¦å•ä»£ç†<br/>å¤„ç†è´¦å•é—®é¢˜"]
    Decision -->|"ä¸€èˆ¬å’¨è¯¢"| GeneralAgent["å®¢æœä»£ç†<br/>å¤„ç†ä¸€èˆ¬é—®é¢˜"]

    OrderAgent --> Result1["è®¢å•ä¿¡æ¯è¿”å›"]
    TechAgent --> Result2["æŠ€æœ¯è§£å†³æ–¹æ¡ˆ"]
    BillingAgent --> Result3["è´¦å•å¤„ç†ç»“æœ"]
    GeneralAgent --> Result4["å’¨è¯¢ç­”å¤"]

    Result1 --> End["å®Œæˆ"]
    Result2 --> End
    Result3 --> End
    Result4 --> End

    style Router fill:#3b82f6,color:#fff
    style Analysis fill:#8b5cf6,color:#fff
    style Decision fill:#f59e0b,color:#fff
    style OrderAgent fill:#10b981,color:#fff
    style TechAgent fill:#ef4444,color:#fff
    style BillingAgent fill:#06b6d4,color:#fff
    style GeneralAgent fill:#a855f7,color:#fff
                        </div>
                    </div>

                    <h3 class="subsection-title">Router vs å…¶ä»–åä½œæ¨¡å¼</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>æ¨¡å¼</th>
                                <th>å†³ç­–æ—¶æœº</th>
                                <th>è½¬ç§»æ¬¡æ•°</th>
                                <th>é€‚ç”¨åœºæ™¯</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Router</strong></td>
                                <td>æµç¨‹å¼€å§‹æ—¶</td>
                                <td>ä¸€æ¬¡æ€§</td>
                                <td>è¯·æ±‚åˆ†ç±»ã€é¢†åŸŸåˆ†æµ</td>
                            </tr>
                            <tr>
                                <td><strong>Subagents</strong></td>
                                <td>é¢„å®šä¹‰æµç¨‹</td>
                                <td>å›ºå®šé¡ºåº</td>
                                <td>æµæ°´çº¿ã€å¤šæ­¥éª¤ä»»åŠ¡</td>
                            </tr>
                            <tr>
                                <td><strong>Handoffs</strong></td>
                                <td>è¿è¡Œæ—¶åŠ¨æ€</td>
                                <td>æŒ‰éœ€å¤šæ¬¡</td>
                                <td>å‡çº§ã€ä¸“ä¸šåŒ–è½¬ç§»</td>
                            </tr>
                            <tr>
                                <td><strong>Skills</strong></td>
                                <td>å·¥å…·çº§åˆ«</td>
                                <td>å·¥å…·å…±äº«</td>
                                <td>èƒ½åŠ›å¤ç”¨ã€å·¥å…·ç®¡ç†</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- è·¯ç”±ç­–ç•¥ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ”§ è·¯ç”±ç­–ç•¥</h2>
                    <p>
                        Router çš„æ ¸å¿ƒæ˜¯<strong>è·¯ç”±å†³ç­–é€»è¾‘</strong>ï¼Œå¯ä»¥åŸºäºè§„åˆ™ã€LLM æˆ–æ··åˆæ–¹å¼å®ç°ã€‚
                    </p>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph TB
    subgraph Strategy1["ç­–ç•¥ 1ï¼šåŸºäºè§„åˆ™"]
        R1["ç”¨æˆ·è¯·æ±‚"] --> R2["å…³é”®è¯åŒ¹é…"]
        R2 --> R3{"åŒ…å«å…³é”®è¯ï¼Ÿ"}
        R3 -->|"è®¢å•ã€å¿«é€’"| R4["è®¢å•ä»£ç†"]
        R3 -->|"é€€æ¬¾ã€æ”¯ä»˜"| R5["è´¦å•ä»£ç†"]
        R3 -->|"bugã€å´©æºƒ"| R6["æŠ€æœ¯ä»£ç†"]
    end

    subgraph Strategy2["ç­–ç•¥ 2ï¼šåŸºäº LLM"]
        L1["ç”¨æˆ·è¯·æ±‚"] --> L2["LLM åˆ†æ"]
        L2 --> L3["ç»“æ„åŒ–è¾“å‡º<br/>{intent, category}"]
        L3 --> L4{"åˆ†ç±»ç»“æœ"}
        L4 -->|"order"| L5["è®¢å•ä»£ç†"]
        L4 -->|"billing"| L6["è´¦å•ä»£ç†"]
        L4 -->|"technical"| L7["æŠ€æœ¯ä»£ç†"]
    end

    subgraph Strategy3["ç­–ç•¥ 3ï¼šæ··åˆè·¯ç”±"]
        H1["ç”¨æˆ·è¯·æ±‚"] --> H2["è§„åˆ™é¢„ç­›é€‰"]
        H2 --> H3{"å¿«é€ŸåŒ¹é…ï¼Ÿ"}
        H3 -->|"æ˜¯"| H4["ç›´æ¥è·¯ç”±"]
        H3 -->|"å¦"| H5["LLM åˆ†æ"]
        H5 --> H6["è·¯ç”±å†³ç­–"]
    end

    style R2 fill:#10b981,color:#fff
    style L2 fill:#f59e0b,color:#fff
    style H5 fill:#8b5cf6,color:#fff
                        </div>
                    </div>

                    <h3 class="subsection-title">ç­–ç•¥ 1ï¼šåŸºäºè§„åˆ™çš„è·¯ç”±</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
åŸºäºè§„åˆ™çš„è·¯ç”± - ä½¿ç”¨å…³é”®è¯åŒ¹é…
"""
from typing import TypedDict, Annotated, Literal
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from langchain_core.messages import HumanMessage, AIMessage

# å®šä¹‰çŠ¶æ€
class RouterState(TypedDict):
    messages: Annotated[list, add_messages]
    route_to: str  # è·¯ç”±ç›®æ ‡

# è·¯ç”±å‡½æ•°ï¼šåŸºäºå…³é”®è¯
def rule_based_router(state: RouterState) -> str:
    """åŸºäºè§„åˆ™çš„è·¯ç”±å™¨"""
    last_message = state["messages"][-1].content.lower()

    # è§„åˆ™å®šä¹‰
    order_keywords = ["è®¢å•", "ç‰©æµ", "å¿«é€’", "é…é€", "å‘è´§"]
    billing_keywords = ["é€€æ¬¾", "æ”¯ä»˜", "è´¦å•", "æ‰£è´¹", "ä»·æ ¼"]
    technical_keywords = ["bug", "å´©æºƒ", "å¡é¡¿", "ç™»å½•ä¸äº†", "æ‰“ä¸å¼€"]

    # å…³é”®è¯åŒ¹é…
    if any(kw in last_message for kw in order_keywords):
        return "order_agent"
    elif any(kw in last_message for kw in billing_keywords):
        return "billing_agent"
    elif any(kw in last_message for kw in technical_keywords):
        return "technical_agent"
    else:
        return "general_agent"

# ä¸“ä¸šä»£ç†
def order_agent(state: RouterState):
    """è®¢å•ä»£ç†"""
    return {
        "messages": [AIMessage(content="è®¢å•ä»£ç†ï¼šæˆ‘æ¥å¸®æ‚¨æŸ¥è¯¢è®¢å•ä¿¡æ¯")],
        "route_to": "order_agent"
    }

def billing_agent(state: RouterState):
    """è´¦å•ä»£ç†"""
    return {
        "messages": [AIMessage(content="è´¦å•ä»£ç†ï¼šæˆ‘æ¥å¤„ç†æ‚¨çš„è´¦å•é—®é¢˜")],
        "route_to": "billing_agent"
    }

def technical_agent(state: RouterState):
    """æŠ€æœ¯ä»£ç†"""
    return {
        "messages": [AIMessage(content="æŠ€æœ¯ä»£ç†ï¼šæˆ‘æ¥è§£å†³æ‚¨çš„æŠ€æœ¯é—®é¢˜")],
        "route_to": "technical_agent"
    }

def general_agent(state: RouterState):
    """é€šç”¨ä»£ç†"""
    return {
        "messages": [AIMessage(content="å®¢æœä»£ç†ï¼šæˆ‘æ¥å¸®æ‚¨è§£å†³é—®é¢˜")],
        "route_to": "general_agent"
    }

# æ„å»ºè·¯ç”±å›¾
workflow = StateGraph(RouterState)

# æ·»åŠ ä»£ç†èŠ‚ç‚¹
workflow.add_node("order_agent", order_agent)
workflow.add_node("billing_agent", billing_agent)
workflow.add_node("technical_agent", technical_agent)
workflow.add_node("general_agent", general_agent)

# ä» START æ¡ä»¶è·¯ç”±åˆ°ä¸åŒä»£ç†
workflow.add_conditional_edges(
    START,
    rule_based_router,
    {
        "order_agent": "order_agent",
        "billing_agent": "billing_agent",
        "technical_agent": "technical_agent",
        "general_agent": "general_agent"
    }
)

# æ‰€æœ‰ä»£ç†ç»“æŸååˆ° END
workflow.add_edge("order_agent", END)
workflow.add_edge("billing_agent", END)
workflow.add_edge("technical_agent", END)
workflow.add_edge("general_agent", END)

app = workflow.compile()

# æµ‹è¯•
test_cases = [
    "æˆ‘çš„è®¢å•ä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ",
    "æˆ‘è¦ç”³è¯·é€€æ¬¾",
    "åº”ç”¨ä¸€ç›´å´©æºƒ",
    "ä½ ä»¬çš„è¥ä¸šæ—¶é—´ï¼Ÿ"
]

for test in test_cases:
    result = app.invoke({"messages": [HumanMessage(content=test)]})
    print(f"è¯·æ±‚: {test}")
    print(f"è·¯ç”±åˆ°: {result['route_to']}\n")

# ä¼˜åŠ¿ï¼š
# - å¿«é€Ÿï¼ˆæ— éœ€è°ƒç”¨ LLMï¼‰
# - æˆæœ¬ä½ï¼ˆçº¯è§„åˆ™åŒ¹é…ï¼‰
# - å¯è§£é‡Šæ€§å¼º
# - é€‚åˆæ˜ç¡®çš„åˆ†ç±»åœºæ™¯

# åŠ£åŠ¿ï¼š
# - éœ€è¦ç»´æŠ¤å…³é”®è¯åˆ—è¡¨
# - éš¾ä»¥å¤„ç†å¤æ‚æˆ–æ¨¡ç³Šè¯·æ±‚
# - æ— æ³•ç†è§£ä¸Šä¸‹æ–‡å’Œè¯­ä¹‰</code></pre>
                    </div>

                    <h3 class="subsection-title">ç­–ç•¥ 2ï¼šåŸºäº LLM çš„è·¯ç”±</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
åŸºäº LLM çš„è·¯ç”± - ä½¿ç”¨ç»“æ„åŒ–è¾“å‡º
"""
from typing import TypedDict, Annotated, Literal
from pydantic import BaseModel, Field
from langgraph.graph import StateGraph, START, END
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage

# å®šä¹‰è·¯ç”±å†³ç­–ç»“æ„
class RouteDecision(BaseModel):
    """è·¯ç”±å†³ç­–ç»“æ„"""
    category: Literal["order", "billing", "technical", "general"] = Field(
        description="è¯·æ±‚ç±»åˆ«ï¼šorder(è®¢å•), billing(è´¦å•), technical(æŠ€æœ¯), general(ä¸€èˆ¬)"
    )
    confidence: float = Field(
        description="åˆ†ç±»ç½®ä¿¡åº¦ (0-1)",
        ge=0,
        le=1
    )
    reason: str = Field(
        description="åˆ†ç±»ç†ç”±"
    )

# å®šä¹‰çŠ¶æ€
class LLMRouterState(TypedDict):
    messages: Annotated[list, add_messages]
    route_decision: RouteDecision
    route_to: str

# LLM è·¯ç”±å™¨
def llm_router(state: LLMRouterState):
    """ä½¿ç”¨ LLM è¿›è¡Œæ™ºèƒ½è·¯ç”±"""
    llm = ChatOpenAI(model="gpt-4o")
    llm_with_structure = llm.with_structured_output(RouteDecision)

    prompt = f"""åˆ†æä»¥ä¸‹ç”¨æˆ·è¯·æ±‚ï¼Œå¹¶åˆ†ç±»åˆ°æœ€åˆé€‚çš„ç±»åˆ«ï¼š

ç”¨æˆ·è¯·æ±‚ï¼š{state['messages'][-1].content}

åˆ†ç±»è§„åˆ™ï¼š
- order: è®¢å•æŸ¥è¯¢ã€ç‰©æµè¿½è¸ªã€å‘è´§é—®é¢˜
- billing: é€€æ¬¾ã€æ”¯ä»˜ã€è´¦å•ã€ä»·æ ¼
- technical: æŠ€æœ¯æ•…éšœã€bugã€ç™»å½•é—®é¢˜
- general: å…¶ä»–ä¸€èˆ¬æ€§å’¨è¯¢

è¿”å›åˆ†ç±»ç»“æœã€ç½®ä¿¡åº¦å’Œç†ç”±ã€‚
"""

    decision = llm_with_structure.invoke(prompt)

    return {
        "route_decision": decision,
        "route_to": f"{decision.category}_agent"
    }

# è·¯ç”±å†³ç­–å‡½æ•°
def route_by_llm(state: LLMRouterState) -> str:
    """æ ¹æ® LLM å†³ç­–è·¯ç”±"""
    # å¦‚æœè¿˜æ²¡æœ‰å†³ç­–ï¼Œå…ˆè°ƒç”¨ router èŠ‚ç‚¹
    if "route_decision" not in state:
        return "router"

    # æ ¹æ®å†³ç­–è·¯ç”±
    return state["route_to"]

# ä¸“ä¸šä»£ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
def order_agent(state: LLMRouterState):
    llm = ChatOpenAI(model="gpt-4o")
    response = llm.invoke("ä½ æ˜¯è®¢å•ä¸“å‘˜ï¼Œå¸®ç”¨æˆ·æŸ¥è¯¢è®¢å•ä¿¡æ¯")
    return {"messages": [response]}

def billing_agent(state: LLMRouterState):
    llm = ChatOpenAI(model="gpt-4o")
    response = llm.invoke("ä½ æ˜¯è´¦å•ä¸“å‘˜ï¼Œå¸®ç”¨æˆ·å¤„ç†è´¦å•é—®é¢˜")
    return {"messages": [response]}

def technical_agent(state: LLMRouterState):
    llm = ChatOpenAI(model="claude-sonnet-4-5")
    response = llm.invoke("ä½ æ˜¯æŠ€æœ¯æ”¯æŒï¼Œå¸®ç”¨æˆ·è§£å†³æŠ€æœ¯é—®é¢˜")
    return {"messages": [response]}

def general_agent(state: LLMRouterState):
    llm = ChatOpenAI(model="gpt-4o")
    response = llm.invoke("ä½ æ˜¯å®¢æœï¼Œå¸®ç”¨æˆ·è§£å†³ä¸€èˆ¬é—®é¢˜")
    return {"messages": [response]}

# æ„å»º LLM è·¯ç”±å›¾
workflow = StateGraph(LLMRouterState)

# æ·»åŠ  router èŠ‚ç‚¹
workflow.add_node("router", llm_router)

# æ·»åŠ ä»£ç†èŠ‚ç‚¹
workflow.add_node("order_agent", order_agent)
workflow.add_node("billing_agent", billing_agent)
workflow.add_node("technical_agent", technical_agent)
workflow.add_node("general_agent", general_agent)

# START â†’ routerï¼ˆå…ˆè¿›è¡Œè·¯ç”±åˆ†æï¼‰
workflow.add_edge(START, "router")

# router â†’ æ¡ä»¶è·¯ç”±åˆ°ä¸åŒä»£ç†
workflow.add_conditional_edges(
    "router",
    lambda state: state["route_to"],
    {
        "order_agent": "order_agent",
        "billing_agent": "billing_agent",
        "technical_agent": "technical_agent",
        "general_agent": "general_agent"
    }
)

# æ‰€æœ‰ä»£ç† â†’ END
workflow.add_edge("order_agent", END)
workflow.add_edge("billing_agent", END)
workflow.add_edge("technical_agent", END)
workflow.add_edge("general_agent", END)

app = workflow.compile()

# æµ‹è¯•
result = app.invoke({
    "messages": [HumanMessage(content="æˆ‘çš„åŒ…è£¹æ€ä¹ˆè¿˜æ²¡åˆ°ï¼Ÿ")]
})

print(f"è·¯ç”±å†³ç­–ï¼š{result['route_decision']}")
print(f"ç±»åˆ«ï¼š{result['route_decision'].category}")
print(f"ç½®ä¿¡åº¦ï¼š{result['route_decision'].confidence}")
print(f"ç†ç”±ï¼š{result['route_decision'].reason}")

# ä¼˜åŠ¿ï¼š
# - è¯­ä¹‰ç†è§£èƒ½åŠ›å¼º
# - å¯å¤„ç†å¤æ‚å’Œæ¨¡ç³Šè¯·æ±‚
# - æ— éœ€ç»´æŠ¤è§„åˆ™åˆ—è¡¨
# - å¯æä¾›åˆ†ç±»ç†ç”±ï¼ˆå¯è§£é‡Šæ€§ï¼‰

# åŠ£åŠ¿ï¼š
# - è°ƒç”¨ LLMï¼Œå¢åŠ å»¶è¿Ÿ
# - æˆæœ¬ç›¸å¯¹è¾ƒé«˜
# - éœ€è¦å¤„ç† LLM ä¸ç¡®å®šæ€§</code></pre>
                    </div>

                    <h3 class="subsection-title">ç­–ç•¥ 3ï¼šæ··åˆè·¯ç”±ï¼ˆæ¨èï¼‰</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ··åˆè·¯ç”± - è§„åˆ™é¢„ç­›é€‰ + LLM ç²¾å‡†åˆ†ç±»
"""
from typing import TypedDict, Annotated, Literal
from langgraph.graph import StateGraph, START, END
from langchain_openai import ChatOpenAI
from pydantic import BaseModel, Field

class HybridRouterState(TypedDict):
    messages: Annotated[list, add_messages]
    quick_match: bool  # æ˜¯å¦å¿«é€ŸåŒ¹é…æˆåŠŸ
    route_to: str
    confidence: float

# ç¬¬ä¸€å±‚ï¼šå¿«é€Ÿè§„åˆ™åŒ¹é…
def quick_rule_filter(state: HybridRouterState):
    """å¿«é€Ÿè§„åˆ™è¿‡æ»¤å™¨"""
    last_message = state["messages"][-1].content.lower()

    # é«˜ç½®ä¿¡åº¦è§„åˆ™ï¼ˆæ˜ç¡®å…³é”®è¯ï¼‰
    high_confidence_rules = {
        "order_agent": ["è®¢å•å·", "ç‰©æµå•å·", "å¿«é€’ç¼–å·"],
        "billing_agent": ["é€€æ¬¾ç”³è¯·", "å‘ç¥¨", "è´¦å•æ˜ç»†"],
        "technical_agent": ["é”™è¯¯ä»£ç ", "å´©æºƒæ—¥å¿—", "bugæŠ¥å‘Š"]
    }

    # æ£€æŸ¥é«˜ç½®ä¿¡åº¦åŒ¹é…
    for agent, keywords in high_confidence_rules.items():
        if any(kw in last_message for kw in keywords):
            return {
                "quick_match": True,
                "route_to": agent,
                "confidence": 0.95
            }

    # æ²¡æœ‰é«˜ç½®ä¿¡åº¦åŒ¹é…ï¼Œéœ€è¦ LLM åˆ†æ
    return {
        "quick_match": False,
        "confidence": 0.0
    }

# ç¬¬äºŒå±‚ï¼šLLM ç²¾å‡†åˆ†ç±»
class DetailedRouteDecision(BaseModel):
    category: Literal["order", "billing", "technical", "general"]
    confidence: float = Field(ge=0, le=1)
    reason: str
    keywords_found: list[str]

def llm_precise_classifier(state: HybridRouterState):
    """LLM ç²¾å‡†åˆ†ç±»å™¨"""
    llm = ChatOpenAI(model="gpt-4o")
    llm_with_structure = llm.with_structured_output(DetailedRouteDecision)

    prompt = f"""æ·±åº¦åˆ†æç”¨æˆ·è¯·æ±‚ï¼Œè¿›è¡Œç²¾å‡†åˆ†ç±»ï¼š

ç”¨æˆ·è¯·æ±‚ï¼š{state['messages'][-1].content}

åˆ†æè¦æ±‚ï¼š
1. ä»”ç»†ç†è§£ç”¨æˆ·æ„å›¾å’Œä¸Šä¸‹æ–‡
2. è€ƒè™‘éšå«çš„éœ€æ±‚å’Œæƒ…ç»ª
3. è¯†åˆ«å…³é”®è¯å’Œé—®é¢˜ç±»å‹
4. ç»™å‡ºé«˜ç½®ä¿¡åº¦çš„åˆ†ç±»

è¿”å›è¯¦ç»†çš„åˆ†ç±»ç»“æœã€‚
"""

    decision = llm_with_structure.invoke(prompt)

    return {
        "route_to": f"{decision.category}_agent",
        "confidence": decision.confidence
    }

# è·¯ç”±å†³ç­–å‡½æ•°
def route_decision(state: HybridRouterState) -> Literal["quick_route", "llm_route"]:
    """å†³å®šä½¿ç”¨å¿«é€Ÿè·¯ç”±è¿˜æ˜¯ LLM è·¯ç”±"""
    if state.get("quick_match", False):
        return "quick_route"
    else:
        return "llm_route"

def final_route(state: HybridRouterState) -> str:
    """æœ€ç»ˆè·¯ç”±"""
    return state["route_to"]

# ä»£ç†èŠ‚ç‚¹ï¼ˆç®€åŒ–ï¼‰
def order_agent(state: HybridRouterState):
    return {"messages": [AIMessage(content="è®¢å•ä»£ç†å¤„ç†ä¸­...")]}

def billing_agent(state: HybridRouterState):
    return {"messages": [AIMessage(content="è´¦å•ä»£ç†å¤„ç†ä¸­...")]}

def technical_agent(state: HybridRouterState):
    return {"messages": [AIMessage(content="æŠ€æœ¯ä»£ç†å¤„ç†ä¸­...")]}

def general_agent(state: HybridRouterState):
    return {"messages": [AIMessage(content="å®¢æœä»£ç†å¤„ç†ä¸­...")]}

# æ„å»ºæ··åˆè·¯ç”±å›¾
workflow = StateGraph(HybridRouterState)

# ç¬¬ä¸€å±‚ï¼šå¿«é€Ÿè¿‡æ»¤
workflow.add_node("quick_filter", quick_rule_filter)

# ç¬¬äºŒå±‚ï¼šLLM åˆ†ç±»
workflow.add_node("llm_classifier", llm_precise_classifier)

# ä»£ç†èŠ‚ç‚¹
workflow.add_node("order_agent", order_agent)
workflow.add_node("billing_agent", billing_agent)
workflow.add_node("technical_agent", technical_agent)
workflow.add_node("general_agent", general_agent)

# START â†’ quick_filterï¼ˆå¿«é€Ÿè¿‡æ»¤ï¼‰
workflow.add_edge(START, "quick_filter")

# quick_filter â†’ æ¡ä»¶è·¯ç”±
workflow.add_conditional_edges(
    "quick_filter",
    route_decision,
    {
        "quick_route": "order_agent",  # å¿«é€ŸåŒ¹é…ç›´æ¥è·¯ç”±
        "llm_route": "llm_classifier"  # éœ€è¦ LLM åˆ†æ
    }
)

# llm_classifier â†’ æœ€ç»ˆè·¯ç”±
workflow.add_conditional_edges(
    "llm_classifier",
    final_route,
    {
        "order_agent": "order_agent",
        "billing_agent": "billing_agent",
        "technical_agent": "technical_agent",
        "general_agent": "general_agent"
    }
)

# æ‰€æœ‰ä»£ç† â†’ END
workflow.add_edge("order_agent", END)
workflow.add_edge("billing_agent", END)
workflow.add_edge("technical_agent", END)
workflow.add_edge("general_agent", END)

app = workflow.compile()

# æµ‹è¯•ä¸åŒåœºæ™¯
test_cases = [
    ("æˆ‘çš„è®¢å•å·æ˜¯ 123456ï¼Œå¸®æˆ‘æŸ¥ä¸€ä¸‹", "å¿«é€ŸåŒ¹é…"),
    ("ä¸œè¥¿è¿˜æ²¡åˆ°ï¼Œæœ‰ç‚¹ç€æ€¥", "LLM åˆ†æ"),
    ("æˆ‘è¦é€€æ¬¾ç”³è¯·ï¼Œå‘ç¥¨æ€ä¹ˆå¼€", "å¿«é€ŸåŒ¹é…"),
    ("æˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ ä»¬çš„æœåŠ¡", "LLM åˆ†æ")
]

for test, expected_type in test_cases:
    result = app.invoke({"messages": [HumanMessage(content=test)]})
    print(f"è¯·æ±‚: {test}")
    print(f"å¿«é€ŸåŒ¹é…: {result.get('quick_match', False)}")
    print(f"è·¯ç”±åˆ°: {result['route_to']}")
    print(f"ç½®ä¿¡åº¦: {result.get('confidence', 0)}")
    print(f"é¢„æœŸç±»å‹: {expected_type}\n")

# ä¼˜åŠ¿ï¼š
# - å¹³è¡¡é€Ÿåº¦å’Œå‡†ç¡®æ€§
# - é™ä½ LLM è°ƒç”¨æˆæœ¬ï¼ˆ80%+ è¯·æ±‚å¿«é€ŸåŒ¹é…ï¼‰
# - å¯¹æ˜ç¡®è¯·æ±‚å¿«é€Ÿå“åº”
# - å¯¹å¤æ‚è¯·æ±‚ç²¾å‡†åˆ†ç±»

# é€‚ç”¨åœºæ™¯ï¼š
# - ç”Ÿäº§ç¯å¢ƒæ¨èæ–¹æ¡ˆ
# - é«˜å¹¶å‘åœºæ™¯
# - æˆæœ¬æ•æ„Ÿçš„ç³»ç»Ÿ</code></pre>
                    </div>
                </section>

                <!-- å®Œæ•´å®æˆ˜ç¤ºä¾‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ¯ å®Œæ•´å®æˆ˜ç¤ºä¾‹</h2>
                    <p>
                        æ„å»ºä¸€ä¸ª<strong>æ™ºèƒ½å®¢æœè·¯ç”±ç³»ç»Ÿ</strong>ï¼Œæ”¯æŒå¤šé¢†åŸŸåˆ†æµã€ä¼˜å…ˆçº§åˆ¤æ–­ã€
                        æ™ºèƒ½é™çº§å’Œå®Œæ•´çš„è·¯ç”±è¿½è¸ªã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§ - ç”Ÿäº§çº§ç¤ºä¾‹</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
å®Œæ•´å®æˆ˜ç¤ºä¾‹ - æ™ºèƒ½å®¢æœè·¯ç”±ç³»ç»Ÿ
"""
import uuid
from typing import TypedDict, Annotated, Literal
from enum import Enum
from pydantic import BaseModel, Field
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from langchain_openai import ChatOpenAI
from langchain_anthropic import ChatAnthropic
from langchain_core.messages import HumanMessage, AIMessage

# ========== 1. å®šä¹‰æšä¸¾å’Œæ•°æ®ç»“æ„ ==========

class AgentCategory(str, Enum):
    """ä»£ç†ç±»åˆ«"""
    ORDER = "order"
    BILLING = "billing"
    TECHNICAL = "technical"
    GENERAL = "general"
    VIP = "vip"

class Priority(str, Enum):
    """ä¼˜å…ˆçº§"""
    LOW = "low"
    NORMAL = "normal"
    HIGH = "high"
    URGENT = "urgent"

class RouteAnalysis(BaseModel):
    """è·¯ç”±åˆ†æç»“æœ"""
    category: AgentCategory = Field(description="è¯·æ±‚ç±»åˆ«")
    priority: Priority = Field(description="ä¼˜å…ˆçº§")
    confidence: float = Field(description="ç½®ä¿¡åº¦", ge=0, le=1)
    keywords: list[str] = Field(description="è¯†åˆ«çš„å…³é”®è¯")
    sentiment: str = Field(description="æƒ…ç»ªï¼ˆpositive, neutral, negativeï¼‰")
    reason: str = Field(description="åˆ†ç±»ç†ç”±")

# ========== 2. å®šä¹‰çŠ¶æ€ ==========

class SmartRouterState(TypedDict):
    messages: Annotated[list, add_messages]
    user_id: str
    session_id: str

    # è·¯ç”±ä¿¡æ¯
    route_analysis: RouteAnalysis
    route_to: str
    route_method: str  # "quick" or "llm"

    # ç”¨æˆ·ä¿¡æ¯
    is_vip: bool
    user_history: list[str]

    # è¿½è¸ªä¿¡æ¯
    route_timestamp: str
    routing_time_ms: float

# ========== 3. è§„åˆ™å¼•æ“ ==========

class RuleEngine:
    """è§„åˆ™å¼•æ“ï¼šå¿«é€ŸåŒ¹é…"""

    # é«˜ç½®ä¿¡åº¦è§„åˆ™
    HIGH_CONFIDENCE_RULES = {
        AgentCategory.ORDER: [
            "è®¢å•å·", "ç‰©æµå•å·", "å¿«é€’ç¼–å·", "å‘è´§æ—¶é—´",
            "é…é€æ—¶é—´", "è®¢å•çŠ¶æ€", "åœ¨å“ªé‡Œ"
        ],
        AgentCategory.BILLING: [
            "é€€æ¬¾ç”³è¯·", "å‘ç¥¨", "è´¦å•æ˜ç»†", "æ‰£è´¹",
            "æ”¯ä»˜å¤±è´¥", "ä½™é¢", "ä»·æ ¼é”™è¯¯"
        ],
        AgentCategory.TECHNICAL: [
            "é”™è¯¯ä»£ç ", "å´©æºƒæ—¥å¿—", "bug", "æ— æ³•ç™»å½•",
            "æ‰“ä¸å¼€", "å¡é¡¿", "é—ªé€€"
        ]
    }

    # ä¼˜å…ˆçº§å…³é”®è¯
    PRIORITY_KEYWORDS = {
        Priority.URGENT: ["ç´§æ€¥", "ç«‹å³", "é©¬ä¸Š", "æŠ•è¯‰", "ä¸¥é‡"],
        Priority.HIGH: ["å°½å¿«", "ç€æ€¥", "é‡è¦", "æŸå¤±"],
        Priority.NORMAL: []  # é»˜è®¤
    }

    # è´Ÿé¢æƒ…ç»ªå…³é”®è¯
    NEGATIVE_KEYWORDS = [
        "ä¸æ»¡", "å¤±æœ›", "ç”Ÿæ°”", "æ„¤æ€’", "å·®è¯„",
        "æŠ•è¯‰", "åƒåœ¾", "éª—å­", "é€€è´§"
    ]

    @classmethod
    def quick_match(cls, message: str) -> dict | None:
        """å¿«é€ŸåŒ¹é…"""
        message_lower = message.lower()

        # æ£€æŸ¥é«˜ç½®ä¿¡åº¦è§„åˆ™
        for category, keywords in cls.HIGH_CONFIDENCE_RULES.items():
            matched = [kw for kw in keywords if kw in message_lower]
            if matched:
                # åˆ¤æ–­ä¼˜å…ˆçº§
                priority = Priority.NORMAL
                for pri, pri_kws in cls.PRIORITY_KEYWORDS.items():
                    if any(kw in message_lower for kw in pri_kws):
                        priority = pri
                        break

                # åˆ¤æ–­æƒ…ç»ª
                sentiment = "negative" if any(
                    kw in message_lower for kw in cls.NEGATIVE_KEYWORDS
                ) else "neutral"

                return {
                    "category": category,
                    "priority": priority,
                    "confidence": 0.9,
                    "keywords": matched,
                    "sentiment": sentiment,
                    "reason": f"å…³é”®è¯åŒ¹é…ï¼š{', '.join(matched)}"
                }

        return None

# ========== 4. è·¯ç”±èŠ‚ç‚¹ ==========

def quick_router(state: SmartRouterState):
    """å¿«é€Ÿè·¯ç”±å™¨"""
    import time
    start_time = time.time()

    message = state["messages"][-1].content

    # å°è¯•å¿«é€ŸåŒ¹é…
    quick_result = RuleEngine.quick_match(message)

    if quick_result:
        # å¿«é€ŸåŒ¹é…æˆåŠŸ
        route_analysis = RouteAnalysis(**quick_result)

        # VIP ç”¨æˆ·ç›´æ¥å‡çº§åˆ° VIP ä»£ç†
        if state.get("is_vip", False):
            route_to = "vip_agent"
        else:
            route_to = f"{route_analysis.category.value}_agent"

        routing_time = (time.time() - start_time) * 1000

        return {
            "route_analysis": route_analysis,
            "route_to": route_to,
            "route_method": "quick",
            "routing_time_ms": routing_time
        }

    # å¿«é€ŸåŒ¹é…å¤±è´¥ï¼Œéœ€è¦ LLM
    return {
        "route_method": "need_llm"
    }

def llm_router(state: SmartRouterState):
    """LLM æ™ºèƒ½è·¯ç”±å™¨"""
    import time
    start_time = time.time()

    llm = ChatOpenAI(model="gpt-4o")
    llm_with_structure = llm.with_structured_output(RouteAnalysis)

    message = state["messages"][-1].content
    user_history = state.get("user_history", [])

    prompt = f"""æ·±åº¦åˆ†æå®¢æœè¯·æ±‚å¹¶åˆ†ç±»ï¼š

ç”¨æˆ·è¯·æ±‚ï¼š{message}

ç”¨æˆ·å†å²ï¼š{user_history[-3:] if user_history else "æ— "}

åˆ†æè¦æ±‚ï¼š
1. ç†è§£ç”¨æˆ·æ„å›¾å’Œæƒ…ç»ª
2. è€ƒè™‘ç”¨æˆ·å†å²ä¸Šä¸‹æ–‡
3. åˆ¤æ–­é—®é¢˜ç±»åˆ«å’Œä¼˜å…ˆçº§
4. è¯†åˆ«å…³é”®è¯
5. è¯„ä¼°ç”¨æˆ·æƒ…ç»ª

ç±»åˆ«è¯´æ˜ï¼š
- order: è®¢å•æŸ¥è¯¢ã€ç‰©æµè¿½è¸ª
- billing: é€€æ¬¾ã€æ”¯ä»˜ã€è´¦å•
- technical: æŠ€æœ¯é—®é¢˜ã€bug
- general: ä¸€èˆ¬å’¨è¯¢

ä¼˜å…ˆçº§è¯´æ˜ï¼š
- urgent: ä¸¥é‡é—®é¢˜ã€ç”¨æˆ·æŠ•è¯‰
- high: å½±å“ä½¿ç”¨ã€éœ€å°½å¿«å¤„ç†
- normal: ä¸€èˆ¬é—®é¢˜
- low: ç®€å•å’¨è¯¢

è¿”å›å®Œæ•´çš„è·¯ç”±åˆ†æã€‚
"""

    route_analysis = llm_with_structure.invoke(prompt)

    # VIP ç”¨æˆ·ç‰¹æ®Šå¤„ç†
    if state.get("is_vip", False):
        route_to = "vip_agent"
    else:
        route_to = f"{route_analysis.category.value}_agent"

    routing_time = (time.time() - start_time) * 1000

    return {
        "route_analysis": route_analysis,
        "route_to": route_to,
        "route_method": "llm",
        "routing_time_ms": routing_time
    }

# ========== 5. ä¸“ä¸šä»£ç† ==========

def order_agent(state: SmartRouterState):
    """è®¢å•ä»£ç†"""
    llm = ChatOpenAI(model="gpt-4o")

    priority = state["route_analysis"].priority
    prompt_prefix = "ã€é«˜ä¼˜å…ˆçº§ã€‘" if priority in [Priority.HIGH, Priority.URGENT] else ""

    prompt = f"""{prompt_prefix}ä½ æ˜¯è®¢å•ä¸“å‘˜ã€‚

ç”¨æˆ·è¯·æ±‚ï¼š{state['messages'][-1].content}
è·¯ç”±åˆ†æï¼š{state['route_analysis'].reason}

ä»»åŠ¡ï¼šå¸®åŠ©ç”¨æˆ·æŸ¥è¯¢è®¢å•ä¿¡æ¯ã€è§£å†³ç‰©æµé—®é¢˜ã€‚
"""

    response = llm.invoke(prompt)

    return {
        "messages": [AIMessage(content=f"è®¢å•ä»£ç†ï¼š{response.content}")]
    }

def billing_agent(state: SmartRouterState):
    """è´¦å•ä»£ç†"""
    llm = ChatOpenAI(model="gpt-4o")

    prompt = f"""ä½ æ˜¯è´¦å•ä¸“å‘˜ã€‚

ç”¨æˆ·è¯·æ±‚ï¼š{state['messages'][-1].content}
æƒ…ç»ªï¼š{state['route_analysis'].sentiment}

ä»»åŠ¡ï¼šå¤„ç†é€€æ¬¾ã€æ”¯ä»˜ã€è´¦å•é—®é¢˜ã€‚æ³¨æ„ç”¨æˆ·æƒ…ç»ªï¼Œå‹å¥½æ²Ÿé€šã€‚
"""

    response = llm.invoke(prompt)

    return {
        "messages": [AIMessage(content=f"è´¦å•ä»£ç†ï¼š{response.content}")]
    }

def technical_agent(state: SmartRouterState):
    """æŠ€æœ¯ä»£ç†"""
    llm = ChatAnthropic(model="claude-sonnet-4-5")

    prompt = f"""ä½ æ˜¯æŠ€æœ¯æ”¯æŒå·¥ç¨‹å¸ˆã€‚

ç”¨æˆ·è¯·æ±‚ï¼š{state['messages'][-1].content}
å…³é”®è¯ï¼š{', '.join(state['route_analysis'].keywords)}

ä»»åŠ¡ï¼šè¯Šæ–­å¹¶è§£å†³æŠ€æœ¯é—®é¢˜ï¼Œæä¾›æ¸…æ™°çš„è§£å†³æ–¹æ¡ˆã€‚
"""

    response = llm.invoke(prompt)

    return {
        "messages": [AIMessage(content=f"æŠ€æœ¯ä»£ç†ï¼š{response.content}")]
    }

def general_agent(state: SmartRouterState):
    """é€šç”¨ä»£ç†"""
    llm = ChatOpenAI(model="gpt-4o")

    response = llm.invoke("ä½ æ˜¯å®¢æœï¼Œå¤„ç†ä¸€èˆ¬æ€§å’¨è¯¢")

    return {
        "messages": [AIMessage(content=f"å®¢æœä»£ç†ï¼š{response.content}")]
    }

def vip_agent(state: SmartRouterState):
    """VIP ä»£ç†"""
    llm = ChatAnthropic(model="claude-sonnet-4-5")

    prompt = f"""ä½ æ˜¯ VIP ä¸“å±å®¢æœã€‚

ç”¨æˆ·è¯·æ±‚ï¼š{state['messages'][-1].content}
ç”¨æˆ·ç±»å‹ï¼šVIP ä¼šå‘˜
ä¼˜å…ˆçº§ï¼š{state['route_analysis'].priority.value}

ä»»åŠ¡ï¼šæä¾›é«˜è´¨é‡ã€ä¸ªæ€§åŒ–çš„æœåŠ¡ï¼Œä¼˜å…ˆå¤„ç† VIP ç”¨æˆ·é—®é¢˜ã€‚
"""

    response = llm.invoke(prompt)

    return {
        "messages": [AIMessage(content=f"VIP ä»£ç†ï¼š{response.content}")]
    }

# ========== 6. è·¯ç”±å†³ç­– ==========

def should_use_llm(state: SmartRouterState) -> Literal["quick_done", "need_llm"]:
    """å†³å®šæ˜¯å¦éœ€è¦ LLM"""
    return state.get("route_method", "need_llm")

def final_route(state: SmartRouterState) -> str:
    """æœ€ç»ˆè·¯ç”±"""
    return state["route_to"]

# ========== 7. æ„å»ºå·¥ä½œæµ ==========

workflow = StateGraph(SmartRouterState)

# æ·»åŠ è·¯ç”±èŠ‚ç‚¹
workflow.add_node("quick_router", quick_router)
workflow.add_node("llm_router", llm_router)

# æ·»åŠ ä»£ç†èŠ‚ç‚¹
workflow.add_node("order_agent", order_agent)
workflow.add_node("billing_agent", billing_agent)
workflow.add_node("technical_agent", technical_agent)
workflow.add_node("general_agent", general_agent)
workflow.add_node("vip_agent", vip_agent)

# START â†’ quick_router
workflow.add_edge(START, "quick_router")

# quick_router â†’ æ¡ä»¶åˆ¤æ–­
workflow.add_conditional_edges(
    "quick_router",
    should_use_llm,
    {
        "quick_done": "order_agent",  # å ä½ï¼Œä¼šè¢« final_route è¦†ç›–
        "need_llm": "llm_router"
    }
)

# ä¸ºå¿«é€Ÿè·¯ç”±æ·»åŠ æœ€ç»ˆè·¯ç”±
workflow.add_conditional_edges(
    "quick_router",
    final_route,
    {
        "order_agent": "order_agent",
        "billing_agent": "billing_agent",
        "technical_agent": "technical_agent",
        "general_agent": "general_agent",
        "vip_agent": "vip_agent"
    }
)

# llm_router â†’ æœ€ç»ˆè·¯ç”±
workflow.add_conditional_edges(
    "llm_router",
    final_route,
    {
        "order_agent": "order_agent",
        "billing_agent": "billing_agent",
        "technical_agent": "technical_agent",
        "general_agent": "general_agent",
        "vip_agent": "vip_agent"
    }
)

# æ‰€æœ‰ä»£ç† â†’ END
workflow.add_edge("order_agent", END)
workflow.add_edge("billing_agent", END)
workflow.add_edge("technical_agent", END)
workflow.add_edge("general_agent", END)
workflow.add_edge("vip_agent", END)

# ç¼–è¯‘
app = workflow.compile()

# ========== 8. æµ‹è¯•ç³»ç»Ÿ ==========

test_scenarios = [
    {
        "name": "è®¢å•æŸ¥è¯¢ï¼ˆå¿«é€ŸåŒ¹é…ï¼‰",
        "message": "æˆ‘çš„è®¢å•å·æ˜¯ 123456ï¼Œä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ",
        "is_vip": False
    },
    {
        "name": "å¤æ‚å’¨è¯¢ï¼ˆLLM åˆ†æï¼‰",
        "message": "ä¸œè¥¿è¿˜æ²¡åˆ°ï¼Œæœ‰ç‚¹ç€æ€¥ï¼Œèƒ½å¸®æˆ‘å‚¬ä¸€ä¸‹å—ï¼Ÿ",
        "is_vip": False
    },
    {
        "name": "VIP ç”¨æˆ·ï¼ˆä¼˜å…ˆå¤„ç†ï¼‰",
        "message": "æˆ‘è¦ç”³è¯·é€€æ¬¾",
        "is_vip": True
    },
    {
        "name": "æŠ€æœ¯é—®é¢˜ï¼ˆè´Ÿé¢æƒ…ç»ªï¼‰",
        "message": "è¿™ä¸ªç ´è½¯ä»¶æ€»æ˜¯å´©æºƒï¼Œå¤ªåƒåœ¾äº†ï¼",
        "is_vip": False
    }
]

for scenario in test_scenarios:
    print(f"\n{'='*60}")
    print(f"åœºæ™¯ï¼š{scenario['name']}")
    print(f"{'='*60}")

    result = app.invoke({
        "messages": [HumanMessage(content=scenario['message'])],
        "user_id": f"user_{uuid.uuid4().hex[:8]}",
        "session_id": f"session_{uuid.uuid4().hex[:8]}",
        "is_vip": scenario["is_vip"],
        "user_history": []
    })

    print(f"ç”¨æˆ·è¯·æ±‚ï¼š{scenario['message']}")
    print(f"\nè·¯ç”±åˆ†æï¼š")
    print(f"  - ç±»åˆ«ï¼š{result['route_analysis'].category.value}")
    print(f"  - ä¼˜å…ˆçº§ï¼š{result['route_analysis'].priority.value}")
    print(f"  - ç½®ä¿¡åº¦ï¼š{result['route_analysis'].confidence}")
    print(f"  - æƒ…ç»ªï¼š{result['route_analysis'].sentiment}")
    print(f"  - ç†ç”±ï¼š{result['route_analysis'].reason}")
    print(f"\nè·¯ç”±å†³ç­–ï¼š")
    print(f"  - è·¯ç”±åˆ°ï¼š{result['route_to']}")
    print(f"  - è·¯ç”±æ–¹æ³•ï¼š{result['route_method']}")
    print(f"  - è·¯ç”±è€—æ—¶ï¼š{result['routing_time_ms']:.2f} ms")

# ä¼˜åŠ¿ï¼š
# - å¿«é€Ÿè·¯ç”±ï¼ˆ80%+ è¯·æ±‚ < 10msï¼‰
# - ç²¾å‡†åˆ†ç±»ï¼ˆLLM æ”¯æŒå¤æ‚åœºæ™¯ï¼‰
# - VIP ä¼˜å…ˆå¤„ç†
# - æƒ…ç»ªæ„ŸçŸ¥å’Œä¼˜å…ˆçº§åˆ¤æ–­
# - å®Œæ•´çš„è·¯ç”±è¿½è¸ª
# - ç”Ÿäº§çº§é”™è¯¯å¤„ç†</code></pre>
                    </div>
                </section>

                <!-- æœ€ä½³å®è·µ -->
                <section class="content-section">
                    <h2 class="section-title">âœ¨ Router æœ€ä½³å®è·µ</h2>

                    <h3 class="subsection-title">1. è·¯ç”±ç­–ç•¥é€‰æ‹©</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>åœºæ™¯</th>
                                <th>æ¨èç­–ç•¥</th>
                                <th>åŸå› </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>æ˜ç¡®çš„åˆ†ç±»åœºæ™¯</td>
                                <td>åŸºäºè§„åˆ™</td>
                                <td>å¿«é€Ÿã€æˆæœ¬ä½ã€å¯è§£é‡Š</td>
                            </tr>
                            <tr>
                                <td>å¤æ‚è¯­ä¹‰ç†è§£</td>
                                <td>åŸºäº LLM</td>
                                <td>å‡†ç¡®ã€çµæ´»ã€æ— éœ€ç»´æŠ¤è§„åˆ™</td>
                            </tr>
                            <tr>
                                <td>ç”Ÿäº§ç¯å¢ƒ</td>
                                <td>æ··åˆè·¯ç”±</td>
                                <td>å¹³è¡¡é€Ÿåº¦ã€æˆæœ¬å’Œå‡†ç¡®æ€§</td>
                            </tr>
                            <tr>
                                <td>é«˜å¹¶å‘ç³»ç»Ÿ</td>
                                <td>è§„åˆ™ + ç¼“å­˜</td>
                                <td>é™ä½ LLM è°ƒç”¨é¢‘ç‡</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="subsection-title">2. è·¯ç”±å™¨è®¾è®¡åŸåˆ™</h3>
                    <div class="info-box tip">
                        <div class="info-box-title">âœ… è®¾è®¡åŸåˆ™</div>
                        <ul>
                            <li><strong>å¿«é€Ÿå†³ç­–</strong>ï¼šè·¯ç”±å†³ç­–åº”å°½å¯èƒ½å¿«ï¼ˆç›®æ ‡ < 100msï¼‰</li>
                            <li><strong>é«˜å‡†ç¡®æ€§</strong>ï¼šé”™è¯¯è·¯ç”±ä¼šå¯¼è‡´ç”¨æˆ·ä½“éªŒå·®å’Œæµªè´¹èµ„æº</li>
                            <li><strong>å¯é™çº§</strong>ï¼šLLM å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°è§„åˆ™è·¯ç”±</li>
                            <li><strong>å¯è¿½è¸ª</strong>ï¼šè®°å½•è·¯ç”±å†³ç­–ã€è€—æ—¶ã€ç½®ä¿¡åº¦</li>
                            <li><strong>å¯æ‰©å±•</strong>ï¼šæ˜“äºæ·»åŠ æ–°çš„ä»£ç†åˆ†æ”¯</li>
                            <li><strong>ç”¨æˆ·æ„ŸçŸ¥</strong>ï¼šè€ƒè™‘ç”¨æˆ·ä¼˜å…ˆçº§ã€æƒ…ç»ªã€å†å²</li>
                        </ul>
                    </div>

                    <h3 class="subsection-title">3. ä»£ç†åˆ†ç±»ç­–ç•¥</h3>
                    <ul>
                        <li><strong>æŒ‰é¢†åŸŸåˆ†ç±»</strong>ï¼šè®¢å•ã€è´¦å•ã€æŠ€æœ¯ã€ä¸€èˆ¬ï¼ˆæœ€å¸¸è§ï¼‰</li>
                        <li><strong>æŒ‰èƒ½åŠ›åˆ†ç±»</strong>ï¼šåˆçº§ã€ä¸­çº§ã€é«˜çº§ï¼ˆæŒ‰å¤æ‚åº¦ï¼‰</li>
                        <li><strong>æŒ‰ç”¨æˆ·åˆ†ç±»</strong>ï¼šVIPã€æ™®é€šã€æ–°ç”¨æˆ·ï¼ˆæŒ‰é‡è¦æ€§ï¼‰</li>
                        <li><strong>æŒ‰ç´§æ€¥åº¦åˆ†ç±»</strong>ï¼šç´§æ€¥ã€é«˜ä¼˜å…ˆçº§ã€æ™®é€šï¼ˆæŒ‰æ—¶æ•ˆï¼‰</li>
                        <li><strong>æ··åˆåˆ†ç±»</strong>ï¼šé¢†åŸŸ + ä¼˜å…ˆçº§çš„ç»„åˆ</li>
                    </ul>

                    <h3 class="subsection-title">4. æ€§èƒ½ä¼˜åŒ–</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># ä¼˜åŒ–ç­–ç•¥

# 1. ç¼“å­˜ LLM è·¯ç”±ç»“æœ
from functools import lru_cache

@lru_cache(maxsize=1000)
def cached_llm_route(message_hash: str):
    """ç¼“å­˜ç›¸ä¼¼è¯·æ±‚çš„è·¯ç”±ç»“æœ"""
    # å¯¹ç›¸ä¼¼è¯·æ±‚è¿”å›ç¼“å­˜çš„è·¯ç”±å†³ç­–
    pass

# 2. æ‰¹é‡è·¯ç”±ï¼ˆé€‚ç”¨äºæ‰¹å¤„ç†åœºæ™¯ï¼‰
def batch_route(messages: list[str]):
    """æ‰¹é‡è·¯ç”±å¤šä¸ªè¯·æ±‚"""
    # ä½¿ç”¨ LLM çš„ batch API é™ä½æˆæœ¬
    pass

# 3. å¼‚æ­¥è·¯ç”±
import asyncio

async def async_router(state):
    """å¼‚æ­¥è·¯ç”±å™¨"""
    # ä½¿ç”¨å¼‚æ­¥ LLM è°ƒç”¨æé«˜å¹¶å‘
    pass

# 4. è§„åˆ™ä¼˜å…ˆçº§æ’åº
# å°†æœ€å¸¸åŒ¹é…çš„è§„åˆ™æ”¾åœ¨å‰é¢
PRIORITY_RULES = [
    (most_common_keywords, "most_common_agent"),
    (less_common_keywords, "less_common_agent"),
]

# 5. ç›‘æ§å’Œä¼˜åŒ–
def log_routing_metrics(state):
    """è®°å½•è·¯ç”±æŒ‡æ ‡"""
    metrics = {
        "route_method": state["route_method"],
        "routing_time_ms": state["routing_time_ms"],
        "confidence": state["route_analysis"].confidence,
        "category": state["route_analysis"].category
    }
    # å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    # å®šæœŸåˆ†æä¼˜åŒ–</code></pre>
                    </div>

                    <h3 class="subsection-title">5. é”™è¯¯å¤„ç†å’Œé™çº§</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># é”™è¯¯å¤„ç†ç­–ç•¥

def robust_llm_router(state):
    """å¸¦é™çº§çš„ LLM è·¯ç”±å™¨"""
    try:
        # å°è¯• LLM è·¯ç”±
        return llm_router(state)
    except Exception as e:
        logger.error(f"LLM è·¯ç”±å¤±è´¥: {e}")

        # é™çº§åˆ°è§„åˆ™è·¯ç”±
        fallback_result = rule_based_router(state)

        return {
            "route_to": fallback_result,
            "route_method": "fallback",
            "error": str(e)
        }

# é»˜è®¤è·¯ç”±
def default_router(state):
    """é»˜è®¤è·¯ç”±åˆ°é€šç”¨ä»£ç†"""
    return {
        "route_to": "general_agent",
        "route_method": "default",
        "confidence": 0.5
    }</code></pre>
                    </div>
                </section>

                <!-- å¸¸è§é—®é¢˜ -->
                <section class="content-section">
                    <h2 class="section-title">â“ å¸¸è§é—®é¢˜</h2>

                    <h3 class="subsection-subtitle">Q1: Router å’Œ Handoffs æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3>
                    <p>
                        <strong>å…³é”®åŒºåˆ«</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>æ—¶æœºä¸åŒ</strong>ï¼š
                            <ul>
                                <li>Routerï¼šåœ¨æµç¨‹<strong>å¼€å§‹æ—¶</strong>ä¸€æ¬¡æ€§å†³å®šè·¯ç”±</li>
                                <li>Handoffsï¼šåœ¨æµç¨‹<strong>æ‰§è¡Œè¿‡ç¨‹ä¸­</strong>åŠ¨æ€è½¬ç§»</li>
                            </ul>
                        </li>
                        <li><strong>å†³ç­–ä¾æ®ä¸åŒ</strong>ï¼š
                            <ul>
                                <li>Routerï¼šåŸºäº<strong>ç”¨æˆ·è¯·æ±‚å†…å®¹</strong>åˆ†ç±»</li>
                                <li>Handoffsï¼šåŸºäº<strong>å½“å‰ä»£ç†çš„å¤„ç†ç»“æœ</strong>åˆ¤æ–­</li>
                            </ul>
                        </li>
                        <li><strong>ä½¿ç”¨åœºæ™¯ä¸åŒ</strong>ï¼š
                            <ul>
                                <li>Routerï¼š<strong>åˆå§‹åˆ†æµ</strong>ï¼ˆå®¢æœç³»ç»Ÿã€ä»»åŠ¡è°ƒåº¦ï¼‰</li>
                                <li>Handoffsï¼š<strong>å‡çº§è½¬ç§»</strong>ï¼ˆL1 â†’ L2 â†’ L3ï¼‰</li>
                            </ul>
                        </li>
                    </ul>

                    <h3 class="subsection-subtitle">Q2: å¦‚ä½•æé«˜è·¯ç”±å‡†ç¡®æ€§ï¼Ÿ</h3>
                    <p>
                        <strong>æå‡ç­–ç•¥</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>ä¸°å¯Œè§„åˆ™åº“</strong>ï¼šæŒç»­ç§¯ç´¯å’Œæ›´æ–°å…³é”®è¯è§„åˆ™</li>
                        <li><strong>ä½¿ç”¨é«˜è´¨é‡ LLM</strong>ï¼šGPT-4o æˆ– Claude Sonnet 4.5</li>
                        <li><strong>ç»“æ„åŒ–è¾“å‡º</strong>ï¼šä½¿ç”¨ Pydantic çº¦æŸ LLM è¾“å‡ºæ ¼å¼</li>
                        <li><strong>ä¸Šä¸‹æ–‡å¢å¼º</strong>ï¼šåˆ©ç”¨ç”¨æˆ·å†å²ã€ä¼šè¯ä¸Šä¸‹æ–‡</li>
                        <li><strong>å¤šè½®ç¡®è®¤</strong>ï¼šç½®ä¿¡åº¦ä½æ—¶è¯¢é—®ç”¨æˆ·ç¡®è®¤</li>
                        <li><strong>æŒç»­å­¦ä¹ </strong>ï¼šæ”¶é›†é”™è¯¯è·¯ç”±æ¡ˆä¾‹ï¼Œä¼˜åŒ–è§„åˆ™</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q3: Router å¦‚ä½•å¤„ç†æ¨¡ç³Šè¯·æ±‚ï¼Ÿ</h3>
                    <p>
                        <strong>å¤„ç†ç­–ç•¥</strong>ï¼š
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># å¤„ç†æ¨¡ç³Šè¯·æ±‚

def handle_ambiguous_request(state):
    """å¤„ç†æ¨¡ç³Šè¯·æ±‚"""
    analysis = state["route_analysis"]

    # ç­–ç•¥ 1ï¼šç½®ä¿¡åº¦é˜ˆå€¼
    if analysis.confidence < 0.7:
        # è¯¢é—®ç”¨æˆ·æ˜ç¡®æ„å›¾
        return {
            "messages": [AIMessage(content="è¯·é—®æ‚¨æ˜¯æƒ³å’¨è¯¢è®¢å•ã€è´¦å•è¿˜æ˜¯æŠ€æœ¯é—®é¢˜ï¼Ÿ")],
            "route_to": "clarification_agent"
        }

    # ç­–ç•¥ 2ï¼šå¤šæ ‡ç­¾è·¯ç”±
    if len(analysis.keywords) == 0:
        # è·¯ç”±åˆ°é€šç”¨ä»£ç†
        return {"route_to": "general_agent"}

    # ç­–ç•¥ 3ï¼šæ™ºèƒ½çŒœæµ‹ + ç¡®è®¤
    return {
        "messages": [AIMessage(content=f"æˆ‘ç†è§£æ‚¨æ˜¯æƒ³å’¨è¯¢{analysis.category}ç›¸å…³é—®é¢˜ï¼Œå¯¹å—ï¼Ÿ")],
        "route_to": f"{analysis.category}_agent"
    }</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q4: å¦‚ä½•ç›‘æ§ Router æ€§èƒ½ï¼Ÿ</h3>
                    <p>
                        <strong>å…³é”®æŒ‡æ ‡</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>è·¯ç”±å‡†ç¡®ç‡</strong>ï¼šæ­£ç¡®è·¯ç”±çš„è¯·æ±‚å æ¯”ï¼ˆç›®æ ‡ > 95%ï¼‰</li>
                        <li><strong>è·¯ç”±å»¶è¿Ÿ</strong>ï¼šè·¯ç”±å†³ç­–çš„å¹³å‡è€—æ—¶ï¼ˆç›®æ ‡ < 100msï¼‰</li>
                        <li><strong>å¿«é€ŸåŒ¹é…ç‡</strong>ï¼šè§„åˆ™ç›´æ¥åŒ¹é…çš„æ¯”ä¾‹ï¼ˆç›®æ ‡ > 80%ï¼‰</li>
                        <li><strong>LLM è°ƒç”¨ç‡</strong>ï¼šéœ€è¦ LLM åˆ†æçš„æ¯”ä¾‹ï¼ˆé™ä½æˆæœ¬ï¼‰</li>
                        <li><strong>ç”¨æˆ·æ»¡æ„åº¦</strong>ï¼šè·¯ç”±åçš„é—®é¢˜è§£å†³ç‡</li>
                        <li><strong>é”™è¯¯è·¯ç”±ç‡</strong>ï¼šéœ€è¦é‡æ–°è·¯ç”±çš„æ¯”ä¾‹</li>
                    </ul>

                    <h3 class="subsection-subtitle">Q5: å¦‚ä½•å®ç°åŠ¨æ€è·¯ç”±è§„åˆ™æ›´æ–°ï¼Ÿ</h3>
                    <p>
                        <strong>åŠ¨æ€æ›´æ–°æ–¹æ¡ˆ</strong>ï¼š
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># åŠ¨æ€è§„åˆ™ç®¡ç†

class DynamicRuleEngine:
    """åŠ¨æ€è§„åˆ™å¼•æ“"""

    def __init__(self):
        self._rules = self._load_rules_from_db()
        self._last_update = time.time()

    def _load_rules_from_db(self):
        """ä»æ•°æ®åº“åŠ è½½è§„åˆ™"""
        # ä»é…ç½®ä¸­å¿ƒæˆ–æ•°æ®åº“åŠ è½½æœ€æ–°è§„åˆ™
        return {}

    def refresh_rules(self):
        """åˆ·æ–°è§„åˆ™ï¼ˆå®šæœŸè°ƒç”¨ï¼‰"""
        if time.time() - self._last_update > 300:  # 5 åˆ†é’Ÿ
            self._rules = self._load_rules_from_db()
            self._last_update = time.time()

    def add_rule(self, category: str, keywords: list[str]):
        """åŠ¨æ€æ·»åŠ è§„åˆ™"""
        self._rules.setdefault(category, []).extend(keywords)
        # åŒæ­¥åˆ°æ•°æ®åº“

    def match(self, message: str):
        """ä½¿ç”¨æœ€æ–°è§„åˆ™åŒ¹é…"""
        self.refresh_rules()
        # æ‰§è¡ŒåŒ¹é…é€»è¾‘

# ä½¿ç”¨
engine = DynamicRuleEngine()

# è¿è¥äººå‘˜å¯ä»¥é€šè¿‡ç®¡ç†ç•Œé¢æ·»åŠ æ–°è§„åˆ™
# æ— éœ€é‡å¯æœåŠ¡ï¼Œå®æ—¶ç”Ÿæ•ˆ</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q6: Router å¦‚ä½•æ”¯æŒå¤šè¯­è¨€ï¼Ÿ</h3>
                    <p>
                        <strong>å¤šè¯­è¨€æ”¯æŒç­–ç•¥</strong>ï¼š
                    </p>
                    <ul>
                        <li><strong>LLM å¤©ç„¶æ”¯æŒ</strong>ï¼šä½¿ç”¨ LLM è·¯ç”±è‡ªåŠ¨æ”¯æŒå¤šè¯­è¨€</li>
                        <li><strong>è¯­è¨€æ£€æµ‹</strong>ï¼šå…ˆæ£€æµ‹è¯­è¨€ï¼Œç„¶åä½¿ç”¨å¯¹åº”è¯­è¨€çš„è§„åˆ™</li>
                        <li><strong>ç¿»è¯‘è·¯ç”±</strong>ï¼šå°†è¯·æ±‚ç¿»è¯‘ä¸ºç»Ÿä¸€è¯­è¨€åå†è·¯ç”±</li>
                        <li><strong>å¤šè¯­è¨€è§„åˆ™</strong>ï¼šä¸ºæ¯ç§è¯­è¨€ç»´æŠ¤ç‹¬ç«‹çš„å…³é”®è¯åº“</li>
                        <li><strong>å¤šè¯­è¨€ä»£ç†</strong>ï¼šæ¯ç§è¯­è¨€é…ç½®ä¸“é—¨çš„ä»£ç†</li>
                    </ul>
                </section>

                <!-- å‚è€ƒèµ„æº -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“– å‚è€ƒèµ„æº</h2>
                    <ul>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/multi-agent/router" target="_blank">
                                Multi-Agent Router å®˜æ–¹æ–‡æ¡£
                            </a>
                        </li>
                        <li>
                            <a href="30-multi-agent-index.html">
                                Multi-Agent æ¦‚è¿°
                            </a>
                        </li>
                        <li>
                            <a href="31-multi-agent-subagents.html">
                                Multi-Agent å­ä»£ç†
                            </a>
                        </li>
                        <li>
                            <a href="32-multi-agent-handoffs.html">
                                Multi-Agent äº¤æ¥æœºåˆ¶
                            </a>
                        </li>
                        <li>
                            <a href="33-multi-agent-skills.html">
                                Multi-Agent æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li>
                            <a href="35-multi-agent-workflow.html">
                                Multi-Agent è‡ªå®šä¹‰å·¥ä½œæµ
                            </a>
                        </li>
                        <li>
                            <a href="21-structured-output.html">
                                ç»“æ„åŒ–è¾“å‡º - Router å†³ç­–è¾“å‡º
                            </a>
                        </li>
                    </ul>
                </section>

                <!-- é¡µé¢å¯¼èˆª -->
                <nav class="page-navigation">
                    <a href="33-multi-agent-skills.html" class="nav-button prev">
                        â† ä¸Šä¸€é¡µï¼šæŠ€èƒ½ç³»ç»Ÿ
                    </a>
                    <a href="35-multi-agent-workflow.html" class="nav-button next">
                        ä¸‹ä¸€é¡µï¼šè‡ªå®šä¹‰å·¥ä½œæµ â†’
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" aria-label="è¿”å›é¡¶éƒ¨">â†‘</button>

    <!-- JavaScript -->
    <script src="assets/js/mermaid-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
