<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LangChain 1.0 æ ¸å¿ƒæ¶æ„ - æ·±å…¥ç†è§£ LangChain çš„è®¾è®¡å“²å­¦å’Œæ¨¡å—ç»„ç»‡">
    <title>æ ¸å¿ƒæ¶æ„ | LangChain 1.0 Python çŸ¥è¯†æ–‡æ¡£</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <button class="mobile-menu-button" aria-label="æ‰“å¼€èœå•">â˜°</button>

    <div class="container">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">ğŸ¦œ LangChain 1.0</h1>
                <p class="sidebar-subtitle">Python å®Œæ•´å­¦ä¹ æŒ‡å—</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-section">
                    <div class="nav-section-title">å¼€å§‹</div>
                    <ul>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <span class="nav-icon">ğŸ </span>
                                ä¸»é¡µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">åŸºç¡€ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="01-introduction.html" class="nav-link">
                                <span class="nav-icon">ğŸ“–</span>
                                LangChain ç®€ä»‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="02-architecture.html" class="nav-link">
                                <span class="nav-icon">ğŸ—ï¸</span>
                                æ ¸å¿ƒæ¶æ„
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="03-models.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤–</span>
                                æ¨¡å‹æ¥å£
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="04-messages.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¬</span>
                                æ¶ˆæ¯ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="05-tools.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                å·¥å…·ç³»ç»Ÿ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">è¿›é˜¶ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="06-agents.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                Agent åŸºç¡€
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="07-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="08-rag.html" class="nav-link">
                                <span class="nav-icon">ğŸ”</span>
                                RAG è¯¦è§£
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="09-lcel.html" class="nav-link">
                                <span class="nav-icon">ğŸ”—</span>
                                LCEL è¡¨è¾¾å¼
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">é«˜çº§åº”ç”¨</div>
                    <ul>
                        <li class="nav-item">
                            <a href="10-runtime.html" class="nav-link">
                                <span class="nav-icon">ğŸ”Œ</span>
                                Runtime ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="11-checkpointer.html" class="nav-link">
                                <span class="nav-icon">ğŸ’¾</span>
                                æŒä¹…åŒ–ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="12-streaming.html" class="nav-link">
                                <span class="nav-icon">ğŸŒŠ</span>
                                æµå¼è¾“å‡º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="13-human-in-loop.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="14-long-term-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ—„ï¸</span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="15-langgraph.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                LangGraph
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å®æˆ˜ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="16-customer-service.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å®¢æœæœºå™¨äºº
                                <span class="nav-badge">é‡ç‚¹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="17-best-practices.html" class="nav-link">
                                <span class="nav-icon">âœ¨</span>
                                æœ€ä½³å®è·µ
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">å‚è€ƒç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="18-api-reference.html" class="nav-link">
                                <span class="nav-icon">ğŸ“š</span>
                                API é€ŸæŸ¥è¡¨
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="19-troubleshooting.html" class="nav-link">
                                <span class="nav-icon">ğŸ›</span>
                                æ•…éšœæ’é™¤
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="20-migration.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                è¿ç§»æŒ‡å—
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">æ‰©å±•ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="21-structured-output.html" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                ç»“æ„åŒ–è¾“å‡º
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">DeepAgents ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="22-deepagents-quickstart.html" class="nav-link">
                                <span class="nav-icon">ğŸš€</span>
                                å¿«é€Ÿå¼€å§‹
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="23-deepagents-customization.html" class="nav-link">
                                <span class="nav-icon">ğŸ¨</span>
                                å®šåˆ¶åŒ–
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="24-deepagents-harness.html" class="nav-link">
                                <span class="nav-icon">ğŸ›ï¸</span>
                                Harness ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="25-deepagents-backends.html" class="nav-link">
                                <span class="nav-icon">ğŸ”§</span>
                                åç«¯é…ç½®
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="26-deepagents-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="27-deepagents-hitl.html" class="nav-link">
                                <span class="nav-icon">ğŸ¤</span>
                                äººå·¥ä»‹å…¥
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="28-deepagents-memory.html" class="nav-link">
                                <span class="nav-icon">ğŸ§ </span>
                                é•¿æœŸè®°å¿†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="29-deepagents-middleware.html" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                ä¸­é—´ä»¶
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">Multi-Agent ç¯‡</div>
                    <ul>
                        <li class="nav-item">
                            <a href="30-multi-agent-index.html" class="nav-link">
                                <span class="nav-icon">ğŸŒ</span>
                                æ¦‚è¿°
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="31-multi-agent-subagents.html" class="nav-link">
                                <span class="nav-icon">ğŸ‘¥</span>
                                å­ä»£ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="32-multi-agent-handoffs.html" class="nav-link">
                                <span class="nav-icon">ğŸ”„</span>
                                äº¤æ¥æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="33-multi-agent-skills.html" class="nav-link">
                                <span class="nav-icon">ğŸ¯</span>
                                æŠ€èƒ½ç³»ç»Ÿ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="34-multi-agent-router.html" class="nav-link">
                                <span class="nav-icon">ğŸ§­</span>
                                è·¯ç”±æœºåˆ¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="35-multi-agent-workflow.html" class="nav-link">
                                <span class="nav-icon">ğŸ”€</span>
                                è‡ªå®šä¹‰å·¥ä½œæµ
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">
                        <a href="index.html" class="breadcrumb-link">ä¸»é¡µ</a>
                    </span>
                    <span class="breadcrumb-item">
                        é«˜çº§åº”ç”¨
                    </span>
                    <span class="breadcrumb-item">
                        æµå¼è¾“å‡º
                    </span>
                </nav>

                <!-- é¡µé¢æ ‡é¢˜ -->
                <header class="page-header">
                    <h1 class="page-title">ğŸŒŠ Streaming æµå¼è¾“å‡º</h1>
                    <p class="page-subtitle">
                        æŒæ¡ LangChain 1.0 çš„æµå¼è¾“å‡ºæœºåˆ¶ï¼Œå®ç°å®æ—¶åé¦ˆå’Œè¿›åº¦æ›´æ–°ï¼Œ
                        å¤§å¹…æå‡ AI Agent çš„ç”¨æˆ·ä½“éªŒã€‚
                    </p>
                </header>

                <!-- Streaming ç®€ä»‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“š ä»€ä¹ˆæ˜¯ Streamingï¼Ÿ</h2>
                    <p>
                        <strong>Streamingï¼ˆæµå¼è¾“å‡ºï¼‰</strong>å…è®¸ Agent åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­<strong>å®æ—¶å‘é€æ›´æ–°</strong>ï¼Œ
                        è€Œä¸æ˜¯ç­‰å¾…æ•´ä¸ªä»»åŠ¡å®Œæˆåæ‰è¿”å›ç»“æœã€‚è¿™æ˜¾è‘—æ”¹å–„äº†ç”¨æˆ·ä½“éªŒï¼Œç‰¹åˆ«æ˜¯å¤„ç†è€—æ—¶ä»»åŠ¡æ—¶ã€‚
                    </p>

                    <div class="info-box note">
                        <div class="info-box-title">ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿</div>
                        <ul>
                            <li><strong>å®æ—¶åé¦ˆ</strong>ï¼šç”¨æˆ·ç«‹å³çœ‹åˆ° Agent çš„æ€è€ƒè¿‡ç¨‹å’Œè¿›åº¦</li>
                            <li><strong>é™ä½æ„ŸçŸ¥å»¶è¿Ÿ</strong>ï¼šå³ä½¿æ€»æ—¶é—´ç›¸åŒï¼Œæµå¼è¾“å‡ºè®©ç”¨æˆ·æ„Ÿè§‰æ›´å¿«</li>
                            <li><strong>æ—©æœŸé”™è¯¯å‘ç°</strong>ï¼šå¯ä»¥åœ¨æ‰§è¡Œä¸­é€”å‘ç°é—®é¢˜å¹¶ä¸­æ–­</li>
                            <li><strong>æ›´å¥½çš„äº¤äº’æ€§</strong>ï¼šæ”¯æŒè¿›åº¦æ¡ã€æ—¥å¿—æ˜¾ç¤ºç­‰ UI å…ƒç´ </li>
                        </ul>
                    </div>

                    <h3 class="subsection-title">å¯¹æ¯”ï¼šé˜»å¡å¼ vs æµå¼</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ç‰¹æ€§</th>
                                <th>é˜»å¡å¼è°ƒç”¨ (invoke)</th>
                                <th>æµå¼è°ƒç”¨ (stream)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>è¿”å›æ—¶æœº</strong></td>
                                <td>ä»»åŠ¡å®Œæˆå</td>
                                <td>é€æ­¥è¿”å›</td>
                            </tr>
                            <tr>
                                <td><strong>ç”¨æˆ·ä½“éªŒ</strong></td>
                                <td>ç­‰å¾…æœŸé—´æ— åé¦ˆ</td>
                                <td>å®æ—¶çœ‹åˆ°è¿›åº¦</td>
                            </tr>
                            <tr>
                                <td><strong>é€‚ç”¨åœºæ™¯</strong></td>
                                <td>ç®€å•ã€å¿«é€Ÿä»»åŠ¡</td>
                                <td>å¤æ‚ã€è€—æ—¶ä»»åŠ¡</td>
                            </tr>
                            <tr>
                                <td><strong>å®ç°éš¾åº¦</strong></td>
                                <td>ç®€å•</td>
                                <td>ç¨å¤æ‚</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- Streaming æ¶æ„ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ—ï¸ Streaming æ¶æ„</h2>

                    <div class="mermaid-wrapper">
                        <div class="mermaid">
graph TB
    A[ç”¨æˆ·è¯·æ±‚] --> B[agent.stream è°ƒç”¨]
    B --> C{é€‰æ‹© stream_mode}

    C -->|updates| D[æ­¥éª¤æ›´æ–°æµ]
    C -->|messages| E[Token æµ]
    C -->|custom| F[è‡ªå®šä¹‰ä¿¡å·æµ]
    C -->|å¤šæ¨¡å¼| G[ç»„åˆæµ]

    D --> H[æ¯æ­¥å®Œæˆåå‘é€çŠ¶æ€]
    E --> I[LLM é€ Token å‘é€]
    F --> J[å·¥å…·è‡ªå®šä¹‰æ¶ˆæ¯]
    G --> K[åŒæ—¶å‘é€å¤šç§äº‹ä»¶]

    H --> L[å®¢æˆ·ç«¯æ¥æ”¶]
    I --> L
    J --> L
    K --> L

    L --> M[å®æ—¶æ˜¾ç¤º]

    style D fill:#3b82f6,color:#fff
    style E fill:#10b981,color:#fff
    style F fill:#f59e0b,color:#fff
    style G fill:#8b5cf6,color:#fff
                        </div>
                    </div>

                    <h3 class="subsection-title">ä¸‰ç§ä¸»è¦ Stream Mode</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>æ¨¡å¼</th>
                                <th>ç”¨é€”</th>
                                <th>è¿”å›å†…å®¹</th>
                                <th>å…¸å‹åœºæ™¯</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>updates</code></td>
                                <td>æ­¥éª¤è¿›åº¦</td>
                                <td>æ¯ä¸ª Agent æ­¥éª¤åçš„çŠ¶æ€å˜åŒ–</td>
                                <td>æ˜¾ç¤º "æ­£åœ¨æ€è€ƒ..." "æ­£åœ¨è°ƒç”¨å·¥å…·..."</td>
                            </tr>
                            <tr>
                                <td><code>messages</code></td>
                                <td>Token æµ</td>
                                <td>LLM ç”Ÿæˆçš„æ¯ä¸ª Token + å…ƒæ•°æ®</td>
                                <td>é€å­—æ˜¾ç¤ºå›ç­”ï¼Œæ‰“å­—æœºæ•ˆæœ</td>
                            </tr>
                            <tr>
                                <td><code>custom</code></td>
                                <td>è‡ªå®šä¹‰ä¿¡å·</td>
                                <td>é€šè¿‡ stream_writer å‘é€çš„ä»»æ„æ•°æ®</td>
                                <td>è¿›åº¦æ¡ã€æ—¥å¿—ã€è°ƒè¯•ä¿¡æ¯</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- updates æ¨¡å¼ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“Š Updates æ¨¡å¼ - æ­¥éª¤è¿›åº¦</h2>
                    <p>
                        <code>stream_mode="updates"</code> åœ¨æ¯ä¸ª Agent æ­¥éª¤å®Œæˆåå‘é€çŠ¶æ€æ›´æ–°ï¼Œ
                        è®©ä½ äº†è§£ Agent å½“å‰åœ¨åšä»€ä¹ˆã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Updates æ¨¡å¼ç¤ºä¾‹
åŠŸèƒ½ï¼šæ˜¾ç¤º Agent çš„æ‰§è¡Œæ­¥éª¤
"""
from langchain.agents import create_agent
from langchain.tools import tool

@tool
def get_weather(city: str) -> str:
    """è·å–å¤©æ°”ä¿¡æ¯"""
    return f"{city} ä»Šå¤©æ™´æœ—ï¼Œ22Â°C"

agent = create_agent(
    model="gpt-4o",
    tools=[get_weather],
    system_prompt="ä½ æ˜¯å¤©æ°”åŠ©æ‰‹ã€‚"
)

# ä½¿ç”¨ updates æ¨¡å¼æµå¼è°ƒç”¨
for chunk in agent.stream(
    {"messages": [{"role": "user", "content": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"}]},
    stream_mode="updates"  # å…³é”®å‚æ•°
):
    # chunk æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œkey æ˜¯æ­¥éª¤åç§°
    for step_name, step_data in chunk.items():
        print(f"\nğŸ“ æ­¥éª¤: {step_name}")
        print(f"   æ•°æ®: {step_data}")

# é¢„æœŸè¾“å‡ºï¼š
# ğŸ“ æ­¥éª¤: agent
#    æ•°æ®: {'messages': [...]}  # Agent å†³å®šè°ƒç”¨å·¥å…·
#
# ğŸ“ æ­¥éª¤: tools
#    æ•°æ®: {'messages': [...]}  # å·¥å…·æ‰§è¡Œç»“æœ
#
# ğŸ“ æ­¥éª¤: agent
#    æ•°æ®: {'messages': [...]}  # Agent ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ</code></pre>
                    </div>

                    <h3 class="subsection-title">Updates æ¨¡å¼è¿›é˜¶ï¼šUI é›†æˆ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Updates æ¨¡å¼ UI é›†æˆç¤ºä¾‹
åŠŸèƒ½ï¼šå®ç°è¿›åº¦æ¡å’ŒçŠ¶æ€æ˜¾ç¤º
"""
from langchain.agents import create_agent
from langchain.tools import tool
import sys

@tool
def search_database(query: str) -> str:
    """æœç´¢æ•°æ®åº“"""
    import time
    time.sleep(1)  # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    return f"æ‰¾åˆ°ä¸ '{query}' ç›¸å…³çš„ 5 æ¡è®°å½•"

@tool
def analyze_data(data: str) -> str:
    """åˆ†ææ•°æ®"""
    import time
    time.sleep(1.5)
    return "åˆ†æå®Œæˆï¼šè¶‹åŠ¿å‘ä¸Š"

agent = create_agent(
    model="gpt-4o",
    tools=[search_database, analyze_data],
    system_prompt="ä½ æ˜¯æ•°æ®åˆ†æåŠ©æ‰‹ã€‚"
)

# çŠ¶æ€æ˜ å°„
STATUS_EMOJIS = {
    "agent": "ğŸ¤– Agent æ€è€ƒä¸­...",
    "tools": "ğŸ”§ æ‰§è¡Œå·¥å…·ä¸­...",
}

print("å¼€å§‹ä»»åŠ¡...\n")

for chunk in agent.stream(
    {"messages": [{"role": "user", "content": "æœç´¢é”€å”®æ•°æ®å¹¶åˆ†æè¶‹åŠ¿"}]},
    stream_mode="updates"
):
    for step, data in chunk.items():
        # æ˜¾ç¤ºæ­¥éª¤çŠ¶æ€
        status = STATUS_EMOJIS.get(step, f"ğŸ“ {step}")
        print(f"\r{status}", end="", flush=True)

        # å¦‚æœæ˜¯ tools æ­¥éª¤ï¼Œæ˜¾ç¤ºå·¥å…·åç§°
        if step == "tools":
            messages = data.get("messages", [])
            for msg in messages:
                if hasattr(msg, "name"):
                    print(f"\n   âœ… æ‰§è¡Œäº†å·¥å…·: {msg.name}")

print("\n\nâœ… ä»»åŠ¡å®Œæˆï¼")</code></pre>
                    </div>
                </section>

                <!-- messages æ¨¡å¼ -->
                <section class="content-section">
                    <h2 class="section-title">âœï¸ Messages æ¨¡å¼ - Token æµ</h2>
                    <p>
                        <code>stream_mode="messages"</code> è¿”å› LLM ç”Ÿæˆçš„æ¯ä¸ª Tokenï¼Œ
                        å®ç°æ‰“å­—æœºæ•ˆæœï¼Œè®©ç”¨æˆ·å®æ—¶çœ‹åˆ° AI çš„å›ç­”é€å­—æ˜¾ç°ã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty basic">ğŸŸ¢ åŸºç¡€</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Messages æ¨¡å¼ç¤ºä¾‹
åŠŸèƒ½ï¼šå®ç°æ‰“å­—æœºæ•ˆæœ
"""
from langchain.agents import create_agent

agent = create_agent(
    model="gpt-4o",
    tools=[],
    system_prompt="ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹ï¼Œç”¨ç®€æ´çš„è¯­è¨€å›ç­”é—®é¢˜ã€‚"
)

print("ğŸ¤– åŠ©æ‰‹: ", end="", flush=True)

# ä½¿ç”¨ messages æ¨¡å¼æµå¼è¾“å‡º
for token, metadata in agent.stream(
    {"messages": [{"role": "user", "content": "ä»‹ç»ä¸€ä¸‹ LangChain"}]},
    stream_mode="messages"  # Token æµæ¨¡å¼
):
    # token æ˜¯å­—ç¬¦ä¸²ï¼Œmetadata åŒ…å«èŠ‚ç‚¹ä¿¡æ¯
    print(token, end="", flush=True)

print("\n")

# é¢„æœŸè¾“å‡ºï¼š
# ğŸ¤– åŠ©æ‰‹: LangChain æ˜¯ä¸€ä¸ªç”¨äºæ„å»º AI åº”ç”¨çš„æ¡†æ¶...
#          ï¼ˆé€å­—æ˜¾ç¤ºï¼Œåƒæ‰“å­—æœºä¸€æ ·ï¼‰</code></pre>
                    </div>

                    <h3 class="subsection-title">Messages æ¨¡å¼è¿›é˜¶ï¼šå…ƒæ•°æ®å¤„ç†</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Messages æ¨¡å¼å…ƒæ•°æ®ç¤ºä¾‹
åŠŸèƒ½ï¼šåŒºåˆ†ä¸åŒèŠ‚ç‚¹çš„ Token è¾“å‡º
"""
from langchain.agents import create_agent
from langchain.tools import tool

@tool
def get_fact() -> str:
    """è·å–æœ‰è¶£çš„äº‹å®"""
    return "èœ‚é¸Ÿæ˜¯å”¯ä¸€èƒ½å‘åé£çš„é¸Ÿç±»ã€‚"

agent = create_agent(
    model="gpt-4o",
    tools=[get_fact],
)

current_node = None

for token, metadata in agent.stream(
    {"messages": [{"role": "user", "content": "ç»™æˆ‘ä¸€ä¸ªæœ‰è¶£çš„äº‹å®å¹¶è§£é‡Š"}]},
    stream_mode="messages"
):
    # è·å–å½“å‰èŠ‚ç‚¹åç§°
    node = metadata.get("langgraph_node", "unknown")

    # èŠ‚ç‚¹åˆ‡æ¢æ—¶æ˜¾ç¤ºæ ‡ç­¾
    if node != current_node:
        if current_node is not None:
            print()  # æ¢è¡Œ
        print(f"\n[{node.upper()}] ", end="", flush=True)
        current_node = node

    # æ˜¾ç¤º Token
    print(token, end="", flush=True)

print("\n")

# é¢„æœŸè¾“å‡ºï¼š
# [AGENT] è®©æˆ‘ä¸ºä½ æŸ¥æ‰¾ä¸€ä¸ªæœ‰è¶£çš„äº‹å®...
#
# [AGENT] èœ‚é¸Ÿæ˜¯å”¯ä¸€èƒ½å‘åé£çš„é¸Ÿç±»ã€‚è¿™æ˜¯å› ä¸ºå®ƒä»¬ç‹¬ç‰¹çš„ç¿…è†€ç»“æ„...</code></pre>
                    </div>
                </section>

                <!-- custom æ¨¡å¼ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ¨ Custom æ¨¡å¼ - è‡ªå®šä¹‰ä¿¡å·</h2>
                    <p>
                        <code>stream_mode="custom"</code> å…è®¸ä½ åœ¨å·¥å…·æˆ–ä¸­é—´ä»¶ä¸­å‘é€ä»»æ„è‡ªå®šä¹‰ä¿¡å·ï¼Œ
                        å¦‚è¿›åº¦ç™¾åˆ†æ¯”ã€æ—¥å¿—æ¶ˆæ¯ã€è°ƒè¯•ä¿¡æ¯ç­‰ã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Custom æ¨¡å¼ç¤ºä¾‹
åŠŸèƒ½ï¼šåœ¨å·¥å…·ä¸­å‘é€è‡ªå®šä¹‰è¿›åº¦ä¿¡å·
"""
from langchain.agents import create_agent
from langchain.tools import tool
from langgraph.config import get_stream_writer
import time

@tool
def process_large_file(filename: str) -> str:
    """å¤„ç†å¤§æ–‡ä»¶ï¼ˆå¸¦è¿›åº¦åé¦ˆï¼‰"""
    # è·å– stream writer
    writer = get_stream_writer()

    # æ¨¡æ‹Ÿå¤„ç†è¿‡ç¨‹
    steps = [
        "æ­£åœ¨æ‰“å¼€æ–‡ä»¶...",
        "æ­£åœ¨è§£ææ•°æ®...",
        "æ­£åœ¨éªŒè¯æ ¼å¼...",
        "æ­£åœ¨è®¡ç®—ç»Ÿè®¡ä¿¡æ¯...",
        "å¤„ç†å®Œæˆï¼"
    ]

    for i, step in enumerate(steps):
        # å‘é€è‡ªå®šä¹‰ä¿¡å·
        writer(f"[{i+1}/{len(steps)}] {step}")
        time.sleep(0.5)  # æ¨¡æ‹Ÿè€—æ—¶

    return f"æ–‡ä»¶ '{filename}' å¤„ç†å®Œæˆï¼Œå…± 1000 æ¡è®°å½•"

agent = create_agent(
    model="gpt-4o",
    tools=[process_large_file],
    system_prompt="ä½ æ˜¯æ–‡ä»¶å¤„ç†åŠ©æ‰‹ã€‚"
)

# ä½¿ç”¨ custom æ¨¡å¼æ¥æ”¶è‡ªå®šä¹‰ä¿¡å·
for event in agent.stream(
    {"messages": [{"role": "user", "content": "å¤„ç† sales_data.csv æ–‡ä»¶"}]},
    stream_mode="custom"
):
    print(f"ğŸ“¢ {event}")

# é¢„æœŸè¾“å‡ºï¼š
# ğŸ“¢ [1/5] æ­£åœ¨æ‰“å¼€æ–‡ä»¶...
# ğŸ“¢ [2/5] æ­£åœ¨è§£ææ•°æ®...
# ğŸ“¢ [3/5] æ­£åœ¨éªŒè¯æ ¼å¼...
# ğŸ“¢ [4/5] æ­£åœ¨è®¡ç®—ç»Ÿè®¡ä¿¡æ¯...
# ğŸ“¢ [5/5] å¤„ç†å®Œæˆï¼</code></pre>
                    </div>

                    <h3 class="subsection-title">Custom æ¨¡å¼è¿›é˜¶ï¼šè¿›åº¦æ¡é›†æˆ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
Custom æ¨¡å¼è¿›åº¦æ¡ç¤ºä¾‹
åŠŸèƒ½ï¼šå®ç°çœŸå®çš„è¿›åº¦æ¡æ˜¾ç¤º
"""
from langchain.agents import create_agent
from langchain.tools import tool
from langgraph.config import get_stream_writer
import time
import sys

@tool
def download_dataset(dataset_name: str) -> str:
    """ä¸‹è½½æ•°æ®é›†ï¼ˆå¸¦è¿›åº¦æ¡ï¼‰"""
    writer = get_stream_writer()

    total_size = 100  # æ¨¡æ‹Ÿæ€»å¤§å°ï¼ˆMBï¼‰
    downloaded = 0

    while downloaded < total_size:
        downloaded += 10
        percentage = (downloaded / total_size) * 100

        # å‘é€ JSON æ ¼å¼çš„è¿›åº¦æ•°æ®
        writer({
            "type": "progress",
            "downloaded": downloaded,
            "total": total_size,
            "percentage": percentage
        })

        time.sleep(0.2)

    writer({"type": "complete", "message": "ä¸‹è½½å®Œæˆï¼"})
    return f"æ•°æ®é›† '{dataset_name}' ä¸‹è½½æˆåŠŸ"

agent = create_agent(
    model="gpt-4o",
    tools=[download_dataset],
)

def draw_progress_bar(percentage):
    """ç»˜åˆ¶è¿›åº¦æ¡"""
    bar_length = 30
    filled = int(bar_length * percentage / 100)
    bar = "â–ˆ" * filled + "â–‘" * (bar_length - filled)
    return f"[{bar}] {percentage:.0f}%"

# æµå¼æ¥æ”¶å¹¶æ˜¾ç¤ºè¿›åº¦
for event in agent.stream(
    {"messages": [{"role": "user", "content": "ä¸‹è½½ ImageNet æ•°æ®é›†"}]},
    stream_mode="custom"
):
    if isinstance(event, dict):
        if event.get("type") == "progress":
            progress_bar = draw_progress_bar(event["percentage"])
            size_info = f"{event['downloaded']}/{event['total']} MB"
            print(f"\r{progress_bar} {size_info}", end="", flush=True)
        elif event.get("type") == "complete":
            print(f"\nâœ… {event['message']}")

print("\n")</code></pre>
                    </div>
                </section>

                <!-- å¤šæ¨¡å¼ç»„åˆ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ”€ å¤šæ¨¡å¼ç»„åˆæµå¼</h2>
                    <p>
                        å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ª stream_modeï¼Œé€šè¿‡ä¼ é€’åˆ—è¡¨æ¥ç»„åˆä¸åŒçš„æµå¼è¾“å‡ºã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
å¤šæ¨¡å¼ç»„åˆç¤ºä¾‹
åŠŸèƒ½ï¼šåŒæ—¶æ¥æ”¶æ­¥éª¤æ›´æ–°å’Œè‡ªå®šä¹‰ä¿¡å·
"""
from langchain.agents import create_agent
from langchain.tools import tool
from langgraph.config import get_stream_writer

@tool
def analyze_sentiment(text: str) -> str:
    """æƒ…æ„Ÿåˆ†æï¼ˆå¸¦è¿›åº¦ï¼‰"""
    writer = get_stream_writer()

    writer("å¼€å§‹åˆ†æ...")
    writer("æå–ç‰¹å¾å‘é‡...")
    writer("æ¨¡å‹æ¨ç†ä¸­...")
    writer("ç”ŸæˆæŠ¥å‘Š...")

    return f"æƒ…æ„Ÿåˆ†æç»“æœï¼šç§¯æ (ç½®ä¿¡åº¦ 85%)"

agent = create_agent(
    model="gpt-4o",
    tools=[analyze_sentiment],
)

# ç»„åˆ updates å’Œ custom æ¨¡å¼
for stream_mode, chunk in agent.stream(
    {"messages": [{"role": "user", "content": "åˆ†æè¿™æ®µè¯„è®ºçš„æƒ…æ„Ÿï¼šäº§å“å¾ˆæ£’ï¼"}]},
    stream_mode=["updates", "custom"]  # åˆ—è¡¨å½¢å¼
):
    if stream_mode == "updates":
        # å¤„ç†æ­¥éª¤æ›´æ–°
        for step, data in chunk.items():
            print(f"[æ­¥éª¤] {step}")

    elif stream_mode == "custom":
        # å¤„ç†è‡ªå®šä¹‰ä¿¡å·
        print(f"[è¿›åº¦] {chunk}")

# é¢„æœŸè¾“å‡ºï¼š
# [æ­¥éª¤] agent
# [æ­¥éª¤] tools
# [è¿›åº¦] å¼€å§‹åˆ†æ...
# [è¿›åº¦] æå–ç‰¹å¾å‘é‡...
# [è¿›åº¦] æ¨¡å‹æ¨ç†ä¸­...
# [è¿›åº¦] ç”ŸæˆæŠ¥å‘Š...
# [æ­¥éª¤] agent</code></pre>
                    </div>

                    <div class="info-box tip">
                        <div class="info-box-title">âœ… å¤šæ¨¡å¼ç»„åˆå»ºè®®</div>
                        <table style="margin-top: 0.5rem;">
                            <thead>
                                <tr>
                                    <th>ç»„åˆ</th>
                                    <th>é€‚ç”¨åœºæ™¯</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>["updates", "custom"]</code></td>
                                    <td>éœ€è¦æ­¥éª¤çŠ¶æ€ + å·¥å…·è¿›åº¦åé¦ˆ</td>
                                </tr>
                                <tr>
                                    <td><code>["messages", "custom"]</code></td>
                                    <td>éœ€è¦æ‰“å­—æœºæ•ˆæœ + è‡ªå®šä¹‰æ—¥å¿—</td>
                                </tr>
                                <tr>
                                    <td><code>["updates", "messages"]</code></td>
                                    <td>éœ€è¦å®Œæ•´æ‰§è¡Œè¿‡ç¨‹å¯è§†åŒ–</td>
                                </tr>
                                <tr>
                                    <td><code>["updates", "messages", "custom"]</code></td>
                                    <td>æœ€å…¨é¢çš„ç›‘æ§ï¼ˆè°ƒè¯•ç”¨ï¼‰</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- æµå¼å·¥å…·è°ƒç”¨ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ”§ æµå¼å·¥å…·è°ƒç”¨</h2>
                    <p>
                        ç»„åˆ <code>messages</code> å’Œ <code>updates</code> æ¨¡å¼ï¼Œ
                        å¯ä»¥åŒæ—¶è®¿é—®éƒ¨åˆ†å·¥å…·è°ƒç”¨ JSON å’Œå®Œæ•´çš„è§£æç»“æœã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æµå¼å·¥å…·è°ƒç”¨ç¤ºä¾‹
åŠŸèƒ½ï¼šå®æ—¶æ˜¾ç¤ºå·¥å…·è°ƒç”¨çš„å‚æ•°è§£æè¿‡ç¨‹
"""
from langchain.agents import create_agent
from langchain.tools import tool

@tool
def create_user(
    username: str,
    email: str,
    age: int,
    preferences: dict
) -> str:
    """åˆ›å»ºç”¨æˆ·ï¼ˆå¤æ‚å‚æ•°ï¼‰"""
    return f"ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼š{username} ({email})"

agent = create_agent(
    model="gpt-4o",
    tools=[create_user],
)

print("å®æ—¶æ˜¾ç¤ºå·¥å…·è°ƒç”¨å‚æ•°è§£æ...\n")

for stream_mode, chunk in agent.stream(
    {"messages": [{"role": "user", "content": "åˆ›å»ºç”¨æˆ·ï¼šå¼ ä¸‰ï¼Œé‚®ç®± zhang@example.comï¼Œ25å²ï¼Œåå¥½æ·±è‰²ä¸»é¢˜"}]},
    stream_mode=["messages", "updates"]
):
    if stream_mode == "messages":
        # Token æµï¼ˆåŒ…å«éƒ¨åˆ† JSONï¼‰
        token, metadata = chunk
        if token:
            print(token, end="", flush=True)

    elif stream_mode == "updates":
        # è·å–å®Œæ•´çš„å·¥å…·è°ƒç”¨
        for step, data in chunk.items():
            if step == "agent":
                messages = data.get("messages", [])
                for msg in messages:
                    if hasattr(msg, "tool_calls") and msg.tool_calls:
                        print("\n\nâœ… å·¥å…·è°ƒç”¨å®Œæ•´è§£æï¼š")
                        for tc in msg.tool_calls:
                            print(f"   å·¥å…·: {tc['name']}")
                            print(f"   å‚æ•°: {tc['args']}")

print("\n")</code></pre>
                    </div>
                </section>

                <!-- ç¦ç”¨æµå¼è¾“å‡º -->
                <section class="content-section">
                    <h2 class="section-title">ğŸš« ç¦ç”¨æµå¼è¾“å‡º</h2>
                    <p>
                        åœ¨æŸäº›åœºæ™¯ä¸‹ï¼ˆå¦‚å­ Agentã€ç‰¹å®šå·¥å…·ï¼‰ï¼Œä½ å¯èƒ½æƒ³è¦ç¦ç”¨æµå¼è¾“å‡ºã€‚
                    </p>

                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty intermediate">ğŸŸ¡ ä¸­çº§</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
ç¦ç”¨æµå¼è¾“å‡ºç¤ºä¾‹
åŠŸèƒ½ï¼šä¸ºç‰¹å®šæ¨¡å‹ç¦ç”¨ Token æµ
"""
from langchain_openai import ChatOpenAI
from langchain.agents import create_agent

# æ–¹å¼ 1ï¼šåœ¨æ¨¡å‹åˆå§‹åŒ–æ—¶ç¦ç”¨
model_no_streaming = ChatOpenAI(
    model="gpt-4o",
    streaming=False  # ç¦ç”¨æµå¼è¾“å‡º
)

agent = create_agent(
    model=model_no_streaming,
    tools=[],
)

# å³ä½¿ä½¿ç”¨ stream_mode="messages"ï¼Œä¹Ÿä¸ä¼šæœ‰ Token æµ
for chunk in agent.stream(
    {"messages": [{"role": "user", "content": "ä½ å¥½"}]},
    stream_mode="messages"
):
    print(chunk)  # åªä¼šè¿”å›å®Œæ•´å“åº”ï¼Œä¸ä¼šé€ Token è¿”å›

# æ–¹å¼ 2ï¼šåœ¨ç‰¹å®šè°ƒç”¨æ—¶ç¦ç”¨
model = ChatOpenAI(model="gpt-4o")

# å¯¹äºæŸäº›è°ƒç”¨ï¼Œä¼ é€’ config ç¦ç”¨æµå¼
response = model.invoke(
    "ä½ å¥½",
    config={"metadata": {"streaming": False}}
)</code></pre>
                    </div>

                    <div class="info-box note">
                        <div class="info-box-title">ğŸ’¡ ä½•æ—¶ç¦ç”¨æµå¼è¾“å‡º</div>
                        <ul>
                            <li><strong>å­ Agent</strong>ï¼šå†…éƒ¨ Agent ä¸éœ€è¦å‘ç”¨æˆ·æš´éœ²ç»†èŠ‚</li>
                            <li><strong>æ‰¹é‡å¤„ç†</strong>ï¼šå¤„ç†å¤§é‡è¯·æ±‚æ—¶ï¼Œæµå¼è¾“å‡ºå¢åŠ å¼€é”€</li>
                            <li><strong>API è°ƒç”¨</strong>ï¼šæŸäº›æ¨¡å‹æä¾›å•†ä¸æ”¯æŒæµå¼</li>
                            <li><strong>æµ‹è¯•ç¯å¢ƒ</strong>ï¼šå•å…ƒæµ‹è¯•ä¸­ç®€åŒ–è¾“å‡ºéªŒè¯</li>
                        </ul>
                    </div>
                </section>

                <!-- å®Œæ•´ç¤ºä¾‹ -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ¯ å®Œæ•´ç¤ºä¾‹ï¼šæ™ºèƒ½å®¢æœæµå¼å“åº”</h2>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <span class="code-difficulty advanced">ğŸ”´ é«˜çº§ - å®Œæ•´é¡¹ç›®</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">"""
æ™ºèƒ½å®¢æœæµå¼å“åº”å®Œæ•´ç¤ºä¾‹
åŠŸèƒ½ï¼šæ¼”ç¤ºå®é™…å®¢æœåœºæ™¯ä¸­çš„æµå¼è¾“å‡ºåº”ç”¨
"""
from langchain.agents import create_agent
from langchain.tools import tool
from langgraph.config import get_stream_writer
import time
import sys

# ==================== å·¥å…·å®šä¹‰ ====================

@tool
def search_orders(user_id: str) -> str:
    """æœç´¢ç”¨æˆ·è®¢å•ï¼ˆå¸¦è¿›åº¦ï¼‰"""
    writer = get_stream_writer()

    writer("ğŸ” æ­£åœ¨è¿æ¥è®¢å•æ•°æ®åº“...")
    time.sleep(0.3)

    writer("ğŸ“Š æ­£åœ¨æŸ¥è¯¢è®¢å•è®°å½•...")
    time.sleep(0.5)

    writer("âœ… æŸ¥è¯¢å®Œæˆ")

    return f"ç”¨æˆ· {user_id} æœ‰ 3 ä¸ªè®¢å•ï¼š\n- è®¢å•#001: iPhone 15 (å·²å‘è´§)\n- è®¢å•#002: AirPods (é…é€ä¸­)\n- è®¢å•#003: MacBook Pro (å¤„ç†ä¸­)"

@tool
def check_inventory(product_id: str) -> str:
    """æ£€æŸ¥åº“å­˜ï¼ˆå¸¦è¿›åº¦ï¼‰"""
    writer = get_stream_writer()

    writer("ğŸ“¦ æ­£åœ¨æŸ¥è¯¢åº“å­˜ç³»ç»Ÿ...")
    time.sleep(0.4)

    writer("ğŸ”¢ æ­£åœ¨è®¡ç®—å¯ç”¨åº“å­˜...")
    time.sleep(0.3)

    return f"äº§å“ {product_id} åº“å­˜å……è¶³ï¼šå‰©ä½™ 156 ä»¶"

# ==================== åˆ›å»º Agent ====================

customer_service_agent = create_agent(
    model="gpt-4o",
    tools=[search_orders, check_inventory],
    system_prompt="""ä½ æ˜¯ä¸“ä¸šçš„å®¢æœåŠ©æ‰‹ã€‚

èŒè´£ï¼š
1. æŸ¥è¯¢ç”¨æˆ·è®¢å•çŠ¶æ€
2. æ£€æŸ¥äº§å“åº“å­˜
3. æä¾›å‹å¥½ã€ä¸“ä¸šçš„æœåŠ¡

å·¥ä½œæµç¨‹ï¼š
- ä½¿ç”¨ search_orders æŸ¥è¯¢è®¢å•
- ä½¿ç”¨ check_inventory æ£€æŸ¥åº“å­˜
- å§‹ç»ˆä¿æŒç¤¼è²Œå’Œè€å¿ƒ"""
)

# ==================== æµå¼å“åº”å¤„ç† ====================

def streaming_customer_service(user_query: str):
    """æµå¼å¤„ç†å®¢æœå¯¹è¯"""
    print("\n" + "="*60)
    print(f"ç”¨æˆ·: {user_query}")
    print("="*60 + "\n")

    current_section = None

    for stream_mode, chunk in customer_service_agent.stream(
        {"messages": [{"role": "user", "content": user_query}]},
        stream_mode=["updates", "messages", "custom"]
    ):
        if stream_mode == "custom":
            # è‡ªå®šä¹‰è¿›åº¦ä¿¡å·
            print(f"  ğŸ’¬ {chunk}")

        elif stream_mode == "updates":
            # æ­¥éª¤æ›´æ–°
            for step, data in chunk.items():
                if step != current_section:
                    if current_section == "agent" and step == "tools":
                        print()  # æ¢è¡Œ
                    current_section = step

        elif stream_mode == "messages":
            # Token æµï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
            token, metadata = chunk
            node = metadata.get("langgraph_node")

            if node == "agent" and token:
                if current_section != "agent_response":
                    print("\nğŸ¤– å®¢æœ: ", end="", flush=True)
                    current_section = "agent_response"
                print(token, end="", flush=True)

    print("\n" + "="*60 + "\n")

# ==================== æµ‹è¯•åœºæ™¯ ====================

if __name__ == "__main__":
    # åœºæ™¯ 1ï¼šæŸ¥è¯¢è®¢å•
    streaming_customer_service("æˆ‘æƒ³æŸ¥çœ‹æˆ‘çš„è®¢å•çŠ¶æ€ï¼Œæˆ‘çš„ç”¨æˆ·IDæ˜¯ USER_12345")

    time.sleep(1)

    # åœºæ™¯ 2ï¼šæ£€æŸ¥åº“å­˜
    streaming_customer_service("iPhone 15 Pro Max è¿˜æœ‰è´§å—ï¼Ÿäº§å“IDæ˜¯ PROD_67890")

    time.sleep(1)

    # åœºæ™¯ 3ï¼šç»„åˆæŸ¥è¯¢
    streaming_customer_service("æŸ¥è¯¢æˆ‘çš„è®¢å•ï¼Œç„¶åå‘Šè¯‰æˆ‘ MacBook Pro çš„åº“å­˜æƒ…å†µ")

# é¢„æœŸè¾“å‡ºï¼š
# ============================================================
# ç”¨æˆ·: æˆ‘æƒ³æŸ¥çœ‹æˆ‘çš„è®¢å•çŠ¶æ€ï¼Œæˆ‘çš„ç”¨æˆ·IDæ˜¯ USER_12345
# ============================================================
#
#   ğŸ’¬ ğŸ” æ­£åœ¨è¿æ¥è®¢å•æ•°æ®åº“...
#   ğŸ’¬ ğŸ“Š æ­£åœ¨æŸ¥è¯¢è®¢å•è®°å½•...
#   ğŸ’¬ âœ…æŸ¥è¯¢å®Œæˆ
#
# ğŸ¤– å®¢æœ: æ‚¨å¥½ï¼æˆ‘å·²ä¸ºæ‚¨æŸ¥è¯¢åˆ°è®¢å•ä¿¡æ¯ï¼š
# - è®¢å•#001: iPhone 15 (å·²å‘è´§)
# - è®¢å•#002: AirPods (é…é€ä¸­)
# - è®¢å•#003: MacBook Pro (å¤„ç†ä¸­)
#
# æœ‰ä»€ä¹ˆå…¶ä»–å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ
# ============================================================</code></pre>
                    </div>
                </section>

                <!-- å¸¸è§é—®é¢˜ -->
                <section class="content-section">
                    <h2 class="section-title">â“ å¸¸è§é—®é¢˜</h2>

                    <h3 class="subsection-subtitle">Q1: æµå¼è¾“å‡ºä¼šå¢åŠ å»¶è¿Ÿå—ï¼Ÿ</h3>
                    <p>
                        <strong>ä¸ä¼š</strong>ã€‚æµå¼è¾“å‡ºä¸ä¼šå¢åŠ æ€»æ‰§è¡Œæ—¶é—´ï¼Œåè€Œé™ä½äº†<strong>æ„ŸçŸ¥å»¶è¿Ÿ</strong>ã€‚
                        ç”¨æˆ·åœ¨ç­‰å¾…æœŸé—´èƒ½çœ‹åˆ°è¿›åº¦ï¼Œä½“éªŒæ›´å¥½ã€‚
                    </p>

                    <h3 class="subsection-subtitle">Q2: æ‰€æœ‰æ¨¡å‹éƒ½æ”¯æŒæµå¼è¾“å‡ºå—ï¼Ÿ</h3>
                    <p>
                        å¤§å¤šæ•°ä¸»æµ LLM æä¾›å•†æ”¯æŒæµå¼è¾“å‡ºï¼ŒåŒ…æ‹¬ï¼š
                    </p>
                    <ul>
                        <li>âœ… OpenAI (GPT-4, GPT-3.5)</li>
                        <li>âœ… Anthropic (Claude)</li>
                        <li>âœ… Google (Gemini)</li>
                        <li>âŒ æŸäº›æœ¬åœ°æ¨¡å‹å¯èƒ½ä¸æ”¯æŒ</li>
                    </ul>
                    <p>
                        å¦‚æœæ¨¡å‹ä¸æ”¯æŒï¼Œä½¿ç”¨ <code>stream_mode="messages"</code> ä¼šé™çº§ä¸ºæ‰¹é‡è¿”å›ã€‚
                    </p>

                    <h3 class="subsection-subtitle">Q3: å¦‚ä½•åœ¨ Web åº”ç”¨ä¸­å®ç°æµå¼è¾“å‡ºï¼Ÿ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># FastAPI + Server-Sent Events (SSE) ç¤ºä¾‹
from fastapi import FastAPI
from fastapi.responses import StreamingResponse

app = FastAPI()

@app.post("/chat/stream")
async def chat_stream(message: str):
    """æµå¼èŠå¤©ç«¯ç‚¹"""
    async def event_generator():
        for chunk in agent.stream(
            {"messages": [{"role": "user", "content": message}]},
            stream_mode="messages"
        ):
            token, metadata = chunk
            # å‘é€ SSE äº‹ä»¶
            yield f"data: {token}\n\n"

    return StreamingResponse(
        event_generator(),
        media_type="text/event-stream"
    )</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q4: æµå¼è¾“å‡ºå¯ä»¥ä¸­æ–­å—ï¼Ÿ</h3>
                    <p>
                        å¯ä»¥ã€‚åœ¨ Python ä¸­ï¼Œä½¿ç”¨ <code>break</code> é€€å‡ºå¾ªç¯å³å¯ä¸­æ–­æµå¼è¾“å‡ºï¼š
                    </p>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python">for chunk in agent.stream(...):
    if some_condition:
        break  # ä¸­æ–­æµå¼è¾“å‡º
    # å¤„ç† chunk</code></pre>
                    </div>

                    <h3 class="subsection-subtitle">Q5: å¦‚ä½•è®°å½•æµå¼è¾“å‡ºç”¨äºè°ƒè¯•ï¼Ÿ</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># åŒæ—¶æ˜¾ç¤ºå’Œè®°å½•
import json

log_file = open("stream_log.jsonl", "w")

for stream_mode, chunk in agent.stream(..., stream_mode=["updates", "custom"]):
    # è®°å½•åˆ°æ–‡ä»¶
    log_file.write(json.dumps({
        "mode": stream_mode,
        "chunk": str(chunk)
    }) + "\n")
    log_file.flush()

    # åŒæ—¶æ˜¾ç¤º
    print(chunk)

log_file.close()</code></pre>
                    </div>
                </section>

                <!-- æœ€ä½³å®è·µ -->
                <section class="content-section">
                    <h2 class="section-title">âœ¨ æœ€ä½³å®è·µ</h2>

                    <h3 class="subsection-title">1. é€‰æ‹©åˆé€‚çš„ Stream Mode</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>åœºæ™¯</th>
                                <th>æ¨èæ¨¡å¼</th>
                                <th>ç†ç”±</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>èŠå¤©åº”ç”¨</td>
                                <td><code>messages</code></td>
                                <td>æ‰“å­—æœºæ•ˆæœï¼Œç”¨æˆ·ä½“éªŒå¥½</td>
                            </tr>
                            <tr>
                                <td>å¤æ‚ä»»åŠ¡</td>
                                <td><code>updates</code> + <code>custom</code></td>
                                <td>æ˜¾ç¤ºæ­¥éª¤å’Œè¿›åº¦</td>
                            </tr>
                            <tr>
                                <td>åå°ä»»åŠ¡</td>
                                <td><code>custom</code></td>
                                <td>ä»…å‘é€å…³é”®è¿›åº¦ä¿¡å·</td>
                            </tr>
                            <tr>
                                <td>è°ƒè¯•</td>
                                <td>å…¨éƒ¨ç»„åˆ</td>
                                <td>å®Œæ•´çš„æ‰§è¡Œå¯è§†åŒ–</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="subsection-title">2. ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ</h3>
                    <ul>
                        <li><strong>æ˜¾ç¤ºè¿›åº¦</strong>ï¼šå¯¹äºè€—æ—¶æ“ä½œï¼Œå§‹ç»ˆæä¾›è¿›åº¦åé¦ˆ</li>
                        <li><strong>æ˜ç¡®çŠ¶æ€</strong>ï¼šä½¿ç”¨æ¸…æ™°çš„å›¾æ ‡å’Œæ–‡å­—è¯´æ˜å½“å‰æ­¥éª¤</li>
                        <li><strong>å…è®¸ä¸­æ–­</strong>ï¼šæä¾›"åœæ­¢"æŒ‰é’®è®©ç”¨æˆ·å–æ¶ˆé•¿æ—¶é—´ä»»åŠ¡</li>
                        <li><strong>ä¿å­˜å†å²</strong>ï¼šæµå¼è¾“å‡ºç»“æŸåï¼Œä¿ç•™å®Œæ•´å“åº”ä¾›ç”¨æˆ·æŸ¥çœ‹</li>
                    </ul>

                    <h3 class="subsection-title">3. æ€§èƒ½ä¼˜åŒ–</h3>
                    <ul>
                        <li><strong>æ‰¹é‡å‘é€</strong>ï¼šé¿å…æ¯ä¸ª Token éƒ½è§¦å‘ UI æ›´æ–°ï¼ˆç¼“å†² 50-100msï¼‰</li>
                        <li><strong>é™åˆ¶é¢‘ç‡</strong>ï¼šè‡ªå®šä¹‰ä¿¡å·ä¸è¦å‘é€å¤ªé¢‘ç¹ï¼ˆå¦‚æ¯ 100ms ä¸€æ¬¡è¿›åº¦æ›´æ–°ï¼‰</li>
                        <li><strong>æŒ‰éœ€å¯ç”¨</strong>ï¼šä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½éœ€è¦æµå¼ï¼Œç®€å•ä»»åŠ¡ç”¨ <code>invoke</code></li>
                        <li><strong>èµ„æºæ¸…ç†</strong>ï¼šç¡®ä¿æµå¼è¿æ¥æ­£ç¡®å…³é—­ï¼Œé¿å…å†…å­˜æ³„æ¼</li>
                    </ul>

                    <h3 class="subsection-title">4. é”™è¯¯å¤„ç†</h3>
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">Python</span>
                            <button class="copy-button">å¤åˆ¶ä»£ç </button>
                        </div>
                        <pre><code class="language-python"># æµå¼è°ƒç”¨çš„é”™è¯¯å¤„ç†
try:
    for chunk in agent.stream(...):
        process_chunk(chunk)
except Exception as e:
    print(f"æµå¼è¾“å‡ºé”™è¯¯ï¼š{e}")
    # æ¸…ç†èµ„æºã€é€šçŸ¥ç”¨æˆ·
finally:
    # ç¡®ä¿è¿æ¥å…³é—­
    pass</code></pre>
                    </div>
                </section>

                <!-- å‚è€ƒèµ„æº -->
                <section class="content-section">
                    <h2 class="section-title">ğŸ“– å‚è€ƒèµ„æº</h2>
                    <ul>
                        <li>
                            <a href="https://docs.langchain.com/oss/python/langchain/streaming" target="_blank">
                                LangChain å®˜æ–¹ Streaming æ–‡æ¡£
                            </a>
                        </li>
                        <li>
                            <a href="https://langchain-ai.github.io/langgraph/how-tos/stream-updates/" target="_blank">
                                LangGraph Streaming æ•™ç¨‹
                            </a>
                        </li>
                        <li>
                            <a href="https://python.langchain.com/docs/concepts/#streaming" target="_blank">
                                Streaming æ ¸å¿ƒæ¦‚å¿µ
                            </a>
                        </li>
                        <li>
                            <a href="https://platform.openai.com/docs/api-reference/streaming" target="_blank">
                                OpenAI Streaming API æ–‡æ¡£
                            </a>
                        </li>
                    </ul>
                </section>

                <!-- é¡µé¢å¯¼èˆª -->
                                <nav class="page-navigation">
                    <a href="11-checkpointer.html" class="nav-button prev">
                        â† ä¸Šä¸€é¡µï¼šæŒä¹…åŒ–ç³»ç»Ÿ
                    </a>
                    <a href="13-human-in-loop.html" class="nav-button next">
                        ä¸‹ä¸€é¡µï¼šäººå·¥ä»‹å…¥ â†’
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" aria-label="è¿”å›é¡¶éƒ¨">â†‘</button>

    <!-- JavaScript -->
    <script src="assets/js/mermaid-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
